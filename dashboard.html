<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MaiorMargem — Dashboard</title>
  <style>
    :root { color-scheme: dark; }
    body { margin:0; font-family: Arial, sans-serif; background:#121212; color:#fff; padding:20px; }
    header { display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; gap:12px; flex-wrap:wrap; }
    h1 { color:#00b140; margin:0; }
    .userbox { display:flex; gap:12px; align-items:center; position: relative; }
    .chip { font-size:12px; background:#1e1e1e; border:1px solid #333; padding:6px 10px; border-radius:999px; cursor:default; }
    .chip.plan { color:#bfffc1; border-color:#2f5a2f; background:#132313; }
    .btn { background:#00b140; color:#fff; border:none; padding:8px 14px; border-radius:6px; cursor:pointer; }
    .btn:hover { background:#009b38; }
    .userChipWrap { position: relative; display:inline-block; }
    .dropdown { position:absolute; right:0; top:calc(100% + 6px); display:none; min-width:180px; padding:6px; background:#0f0f0f; border:1px solid #2a2a2a; border-radius:10px; box-shadow:0 10px 30px rgba(0,0,0,.5); z-index:50; }
    .userChipWrap:hover .dropdown, .userChipWrap.open .dropdown { display:block; }
    .dd-item { width:100%; background:transparent; border:none; color:#eee; text-align:left; padding:10px 12px; border-radius:8px; cursor:pointer; font-size:14px; }
    .dd-item:hover { background:#1b1b1b; }

    .panel { background:#202020; border:1px solid #2a2a2a; border-radius:12px; padding:12px; margin-bottom:18px; }
    .panel-header { display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .panel-header h2 { margin:0; font-size:18px; color:#d5ffd5; }
    .toggle-btn { background:none; border:1px solid #2a2a2a; color:#ddd; padding:6px 10px; border-radius:8px; cursor:pointer; }
    .toggle-btn:hover { background:#1b1b1b; }

    .filters { display:grid; grid-template-columns: 1fr 1fr auto; gap:12px; margin:16px 0; align-items:center; }
    .filters input { padding:10px 12px; border-radius:6px; border:1px solid #333; background:#1e1e1e; color:#fff; }
    .scope { grid-column: 1 / -1; display:flex; gap:18px; align-items:center; color:#cfd8dc; font-size:13px; flex-wrap:wrap; }
    .scope label { display:flex; align-items:center; gap:6px; cursor:pointer; }
    .scope input[type="radio"] { accent-color:#00b140; }

    .status { margin:10px 0; color:#aaa; font-size:12px; }
    .err { display:none; color:#ff5d5d; margin:8px 0; font-size:13px; }

    .wrap { overflow:auto; border:1px solid #2a2a2a; border-radius:10px; position: relative; }
    #generalWrap { height:55vh; }

    table { width:100%; border-collapse:separate; border-spacing:0; }
    thead { position:sticky; top:0; z-index:3; }
    thead th { position:sticky; top:0; background:#0f0f0f; z-index:4; }
    th, td { border-bottom:1px solid #2a2a2a; padding:10px; text-align:left; font-size:14px; vertical-align:top; }
    tbody tr:hover { background:#1a1a1a; }

    .col-fav { width:40px; text-align:center; }
    .col-sku { width:160px; font-family: ui-monospace,Consolas,monospace; }
    .col-desc { min-width:260px; }
    .col-param { width:140px; }

    .price { font-weight:700; display:inline-block; font-size:16px; vertical-align:middle; color:#fff; }
    @media (min-width:1200px){ .price{ font-size:18px; } }
    .price.min { color:#ff4d4f; }
    .price.max { color:#00d084; }
    .price.param { color:#ffd54f; }

    .muted { color:#9aa0a6; opacity:.8; }

    .end-marker { text-align:center; padding:10px; color:#9aa0a6; }
    .counts { margin-top:10px; font-size:12px; color:#9aa0a6; display:flex; gap:12px; flex-wrap:wrap; }

    .resizer { height:10px; margin-top:6px; border:1px solid #2a2a2a; border-radius:8px; cursor:ns-resize; background:linear-gradient(180deg,#1c1c1c,#111); display:flex; align-items:center; justify-content:center; }
    .resizer:after { content:""; width:40px; height:3px; border-radius:3px; background:#3a3a3a; }
    body.resizing, body.resizing * { cursor: ns-resize !important; user-select: none; }

    th[data-locked="true"] { position: relative; color: #aaa; }
    th[data-locked="true"]::after { content:"🔒"; margin-left:6px; opacity:.8; font-size:14px; }

    td.locked-cell { position: relative; }
    td.locked-cell .price { filter: blur(3px); }
    td.locked-cell .unlock {
      position:absolute; left:50%; top:50%; transform: translate(-50%, -50%);
      padding:6px 10px; border-radius:8px; border:1px solid #2e2e2e;
      background:#141414; color:#ddd; font-size:12px;
      cursor:pointer; opacity:0; pointer-events:none; transition: opacity .15s;
      white-space:nowrap;
    }
    td.locked-cell:hover .unlock { opacity:1; pointer-events:auto; }
    td.locked-cell .unlock:hover { background:#1b1b1b; }

    .chart-btn { margin-left:6px; background:transparent; border:0; padding:0; vertical-align:middle; cursor:pointer; }
    .chart-btn svg { width:18px; height:18px; display:block; }
    .chart-btn:hover svg rect { fill:#373737; }
    .chart-btn:active svg path { opacity:.9; }

    #dbgWrap { display:none; position:fixed; right:16px; bottom:16px; width:520px; max-height:60vh; z-index:9999;
              background:#0f0f0f; border:1px solid #2a2a2a; border-radius:10px; padding:10px; box-shadow:0 10px 30px rgba(0,0,0,.6); }
    #dbgWrap h3 { margin:0 0 8px 0; font-size:14px; color:#bfe3ff; }
    #dbg { white-space:pre-wrap; font-family: ui-monospace,Consolas,monospace; font-size:12px; color:#bfe3ff; max-height:48vh; overflow:auto; }

    #chartPopover { position:fixed; z-index:9998; background:#0f0f0f; border:1px solid #2a2a2a; border-radius:10px; padding:10px; box-shadow:0 10px 30px rgba(0,0,0,.6); }
    #chartPopover header { display:flex; align-items:center; justify-content:space-between; margin-bottom:6px; }
    #chartPopover .close { background:transparent; border:1px solid #333; color:#ddd; padding:2px 8px; border-radius:6px; cursor:pointer; }
    #chartPopover .msg { font-size:12px; color:#9aa0a6; }
  </style>
  <script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <script src="./config.js"></script>
<style>html.mm-no-horizontal-overflow, body.mm-no-horizontal-overflow{overflow-x:hidden;}</style>
</head>
<body>
<header>
  <h1>MaiorMargem — Dashboard</h1>
  <div class="userbox">
    <span id="planChip" class="chip plan">Plano: —</span>
    <div class="userChipWrap">
      <span id="userChip" class="chip">Usuário</span>
      <div class="dropdown" role="menu" aria-hidden="true">
        <button class="dd-item" id="ddMeusDados" type="button">Meus dados</button>
        <button class="dd-item" id="ddPlanos" type="button">Planos</button>
      </div>
    </div>
    <button id="btnSair" class="btn" type="button">Sair</button>
  </div>
</header>

<!-- FILTROS + ESCOPO -->
<div class="panel">
  <div class="filters">
    <input id="eanFilter" placeholder="Filtrar por EAN/GTIN..." />
    <input id="descFilter" placeholder="Filtrar por descrição..." />
    <button id="btnReload" class="btn" type="button">Recarregar</button>
    <div class="scope" id="scopeGroup" role="radiogroup" aria-label="Escopo da pesquisa">
      <span>Filtrar em:</span>
      <label><input type="radio" name="scope" value="both" checked> Ambas</label>
      <label><input type="radio" name="scope" value="favorites"> Favoritos</label>
      <label><input type="radio" name="scope" value="general"> Geral</label>
    </div>
  </div>
  <div class="status"><span id="status"></span></div>
  <div id="err" class="err"></div>
</div>

<!-- FAVORITOS -->
<section id="favPanel" class="panel">
  <div class="panel-header">
    <h2>Favoritos</h2>
    <button id="btnPrintFav" class="toggle-btn" title="Imprimir favoritos" type="button">Imprimir</button>
    <button id="toggleFav" class="toggle-btn" aria-expanded="true" type="button">Minimizar</button>
  </div>
  <div id="favWrap" class="wrap">
    <table id="favTable">
      <thead><tr id="favHeaderRow"></tr></thead>
      <tbody></tbody>
    </table>
  </div>
  <div id="favResizer" class="resizer" title="Arraste para redimensionar. Duplo clique volta ao automático."></div>
</section>

<!-- GERAL -->
<section id="generalPanel" class="panel">
  <div class="panel-header">
    <h2>Geral</h2>
    <button id="toggleGen" class="toggle-btn" aria-expanded="true" type="button">Minimizar</button>
  </div>
  <div id="generalWrap" class="wrap">
    <table id="produtosTable">
      <thead><tr id="generalHeaderRow"></tr></thead>
      <tbody></tbody>
    </table>
    <div id="endMarker" class="end-marker"></div>
  </div>
  <div class="counts">
    <span id="countShown"></span>
    <span id="countTotal"></span>
    <span id="countFavs"></span>
  </div>
</section>

<!-- DEBUG -->
<div id="dbgWrap">
  <h3>Debug</h3>
  <pre id="dbg"></pre>
</div>

<!-- CHART POPOVER -->
<div id="chartPopover" style="display:none;">
  <header>
    <span id="chartTitle">Histórico</span>
    <button class="close" id="chartClose" aria-label="Fechar" type="button">×</button>
  </header>
  <canvas id="spark" width="360" height="240"></canvas>
  <div id="chartMsg" class="msg" style="display:none;"></div>
</div>

<script>
/* ========= Debug ========= */
const dbgWrap = document.getElementById('dbgWrap');
const dbg = document.getElementById('dbg');
function dlog(o){ try{ dbg.textContent += (typeof o==='string' ? o : JSON.stringify(o,null,2)) + "\\n"; dbg.scrollTop = dbg.scrollHeight; }catch{} }
addEventListener('keydown', (e)=>{ if (e.ctrlKey && e.altKey && (e.key==='d'||e.key==='D')) dbgWrap.style.display = (dbgWrap.style.display==='none'||!dbgWrap.style.display)?'block':'none'; });

/* ========= Erros ========= */
const errEl = document.getElementById('err');
function showErr(msg){ errEl.style.display='block'; errEl.textContent=msg; dlog({error:msg}); }
function hideErr(){ errEl.style.display='none'; errEl.textContent=''; }
addEventListener('error', e => showErr('Erro JS: '+e.message));
addEventListener('unhandledrejection', e => showErr('Erro assíncrono: '+(e.reason?.message||e.reason)));

/* ========= Supabase ========= */
const CFG = window.CONFIG || {};
if(!CFG.SUPABASE_URL || !CFG.SUPABASE_ANON_KEY){ showErr('CONFIG ausente (config.js)'); throw new Error('CONFIG ausente'); }
const sb = supabase.createClient(CFG.SUPABASE_URL, CFG.SUPABASE_ANON_KEY, { auth:{ persistSession:true, autoRefreshToken:true, detectSessionInUrl:true }});

/* ========= Elementos ========= */
const statusEl = document.getElementById('status');
const planChip  = document.getElementById('planChip');
const userChip  = document.getElementById('userChip');
const ddMeusDados = document.getElementById('ddMeusDados');
const ddPlanos    = document.getElementById('ddPlanos');
const btnSair     = document.getElementById('btnSair');
const btnReload   = document.getElementById('btnReload');
const eanFilter   = document.getElementById('eanFilter');
const descFilter  = document.getElementById('descFilter');

const favWrap  = document.getElementById('favWrap');
const favBody  = document.querySelector('#favTable tbody');
const favHeaderRow = document.getElementById('favHeaderRow');
const favResizer  = document.getElementById('favResizer');
const toggleFavBtn = document.getElementById('toggleFav');
const btnPrintFav  = document.getElementById('btnPrintFav');

const generalWrap = document.getElementById('generalWrap');
const generalBody = document.querySelector('#produtosTable tbody');
const generalHeaderRow = document.getElementById('generalHeaderRow');
const endMarker   = document.getElementById('endMarker');
const toggleGenBtn = document.getElementById('toggleGen');
const countShown  = document.getElementById('countShown');
const countTotal  = document.getElementById('countTotal');
const countFavs   = document.getElementById('countFavs');
const scopeGroup = document.getElementById('scopeGroup');

const pop=document.getElementById('chartPopover'),
      popTitle=document.getElementById('chartTitle'),
      popClose=document.getElementById('chartClose'),
      popMsg=document.getElementById('chartMsg');
const spark=document.getElementById('spark'), sparkCtx=spark.getContext('2d');

/* ========= Constantes de UI ========= */
const NA = '---'; // marcador padrão para ausências

/* ========= Estado ========= */
const DEFAULT_PLAN_SITE_LIMIT = { trial:2, basico:4, intermediario:6, premium:8 };
const VIEW = 'vw_precos_dinamica';
const PAGE_SIZE = 200, RENDER_CHUNK = 60;
const OUTLIER_TOL = 0.75;

let chosen=[], unlocked=new Set(), locked=new Set();
let produtosMap=new Map(), produtosList=[];
let serverOffset=0, serverExhausted=false, fetching=false;

let generalView=[], itemsRendered=0;

/* ===== FAVORITOS AGORA EM TABELA ===== */
let currentUserId = null;
let favSet = new Set();              // conjunto em memória (espelho da tabela)
let favLoadedOnce = false;           // garante carregamento
let loadingMore=false; const generalChkMap=new Map();

let favHeightUser = Number(localStorage.getItem('mm_fav_height')) || null, favFirstAutoRenderDone=false;

let currentEanQ='', currentDescQ='', searchScope='both';

let sortStateGeneral = { key:'desc', dir:'asc' };
let sortStateFav     = { key:'desc', dir:'asc' };

let columnOrder = [];
const COL_ORDER_KEY = 'mm_col_order';

/* ========= Utils ========= */
function setStatus(t){ statusEl.textContent = t||''; }
function debounce(fn,ms=500){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); } }
function isFav(sku){ return favSet.has(String(sku)); }
function formatBRL(n){ try{ return n.toLocaleString('pt-BR',{style:'currency',currency:'BRL'}) }catch{ return String(n) } }

/* Normalização p/ busca */
function normTokens(s){
  const cleaned = (s||'').toString()
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g,'')
    .toLowerCase()
    .replace(/[^a-z0-9]+/g,' ')
    .trim();
  return cleaned ? cleaned.split(/\s+/) : [];
}
function ensureDescIndex(item){
  if (!item) return;
  if (!item._tokNeeds || item._descCached !== item.desc){
    item._descCached = item.desc || '';
    item._tok = normTokens(item._descCached);
    item._tokNeeds = false;
  }
}

/* ========= Persistência de Favoritos (Supabase) ========= */
async function refreshFavsFromDB(){
  if (!currentUserId) return;
  const { data, error } = await sb.from('favoritos').select('ean').eq('user_id', currentUserId).limit(10000);
  if (error){ dlog({error:'favoritos.select', code:error.code, msg:error.message}); return; }
  favSet = new Set((data||[]).map(r => String(r.ean)));
  favLoadedOnce = true;
  renderFavs();
  updateFavHeight();
  updateCounts();
  // Carrega os dados dos favoritos mesmo sem rolar a lista geral
  try{ await fetchFavsDirect(); }catch(_){}
}
async function addFavorite(ean){
  if (!currentUserId) return;
  const sku = String(ean);
  favSet.add(sku); // otimista
  const { error } = await sb.from('favoritos').upsert(
    [{ user_id: currentUserId, ean: sku }],
    { onConflict: 'user_id,ean', ignoreDuplicates: true }
  );
  if (error){
    favSet.delete(sku); // rollback
    showErr('Falha ao salvar favorito: '+error.message);
  }
  renderFavs(); updateCounts();
}
async function removeFavorite(ean){
  if (!currentUserId) return;
  const sku = String(ean);
  const prevHad = favSet.delete(sku); // otimista
  const { error } = await sb.from('favoritos').delete().eq('user_id', currentUserId).eq('ean', sku);
  if (error){
    if (prevHad) favSet.add(sku); // rollback
    showErr('Falha ao remover favorito: '+error.message);
  }
  renderFavs(); updateCounts();
}

/* ========= Minimizar/Maximizar ========= */
function applyToggle(btn, wrap, extraEl, key){
  const collapsed = localStorage.getItem(key) === '1';
  function setState(isCollapsed){
    btn.setAttribute('aria-expanded', String(!isCollapsed));
    btn.textContent = isCollapsed ? 'Maximizar' : 'Minimizar';
    wrap.style.display = isCollapsed ? 'none' : 'block';
    if (extraEl) extraEl.style.display = isCollapsed ? 'none' : '';
  }
  setState(collapsed);
  btn.addEventListener('click', ()=>{
    const currExpanded = btn.getAttribute('aria-expanded') === 'true';
    const nextCollapsed = currExpanded;
    localStorage.setItem(key, nextCollapsed ? '1' : '0');
    setState(nextCollapsed);
  });
}

/* ========= Cabeçalhos / colunas ========= */
function computeDefaultColumnOrder(){ return ['sku','desc','meu_preco', ...chosen.map(c => 'site:' + c.label)]; }
function loadColumnOrder(){
  const saved = (()=>{ try{ return JSON.parse(localStorage.getItem(COL_ORDER_KEY) || '[]'); }catch{ return []; }})();
  const base = computeDefaultColumnOrder();
  const setBase = new Set(base);
  const filtered = saved.filter(k => setBase.has(k));
  const missing = base.filter(k => !filtered.includes(k));
  columnOrder = filtered.concat(missing);
}
function saveColumnOrder(){ localStorage.setItem(COL_ORDER_KEY, JSON.stringify(columnOrder)); }

function titleForKey(key){ if (key==='sku') return 'EAN'; if (key==='desc') return 'Descrição'; if (key==='meu_preco') return 'Meu preço'; if (key.startsWith('site:')) return key.slice(5); return key; }
function siteInfoByLabel(label){ const c = chosen.find(x=>x.label===label); return c ? { site_id:c.site_id, locked: locked.has(c.site_id) } : { site_id:null, locked:false }; }

function buildHeaders(){
  // Geral
  generalHeaderRow.innerHTML = '';
  const thFav = document.createElement('th'); thFav.className='col-fav'; thFav.textContent='★';
  generalHeaderRow.appendChild(thFav);
  for (const key of columnOrder){
    const th=document.createElement('th');
    th.setAttribute('data-sortkey', key);
    th.classList.add('sortable','reorderable');
    th.draggable = true;
    if (key==='sku') th.classList.add('col-sku');
    if (key==='desc') th.classList.add('col-desc');
    if (key==='meu_preco') th.classList.add('col-param');
    if (key.startsWith('site:')){
      const label=key.slice(5);
      const info=siteInfoByLabel(label);
      th.dataset.siteid = String(info.site_id||'');
      th.setAttribute('data-locked', info.locked ? 'true' : 'false');
    }
    th.textContent = titleForKey(key);
    generalHeaderRow.appendChild(th);
  }

  // Favoritos
  favHeaderRow.innerHTML='';
  const thAcao = document.createElement('th'); thAcao.className='col-fav'; thAcao.textContent='Ação';
  favHeaderRow.appendChild(thAcao);
  for (const key of columnOrder){
    const th=document.createElement('th');
    th.setAttribute('data-sortkey', key);
    th.classList.add('sortable','reorderable');
    th.draggable = true;
    if (key==='sku') th.classList.add('col-sku');
    if (key==='desc') th.classList.add('col-desc');
    if (key==='meu_preco') th.classList.add('col-param');
    if (key.startsWith('site:')){
      const label=key.slice(5);
      const info=siteInfoByLabel(label);
      th.dataset.siteid = String(info.site_id||'');
      th.setAttribute('data-locked', info.locked ? 'true' : 'false');
    }
    th.textContent = titleForKey(key);
    favHeaderRow.appendChild(th);
  }

  setupSortableHeaders(generalHeaderRow, 'general');
  setupSortableHeaders(favHeaderRow, 'fav');
  setupReorderableHeaders(generalHeaderRow);
  setupReorderableHeaders(favHeaderRow);

  if (sortStateGeneral.key) applySortIndicators(generalHeaderRow, sortStateGeneral.key, sortStateGeneral.dir);
  if (sortStateFav.key)     applySortIndicators(favHeaderRow,     sortStateFav.key,     sortStateFav.dir);
}

/* ========= Plano / sites ========= */
async function getSitesLimitForPlan(planKey){
  const k=(planKey||'').toLowerCase();
  try{
    const { data, error } = await sb.from('billing_plans').select('sites_limit, max_sites').eq('plan_key', k).maybeSingle();
    if (!error){
      const v = Number(data?.sites_limit ?? data?.max_sites);
      if (Number.isFinite(v) && v>0) return v;
    }
  }catch(e){ dlog({warn:'fallback site limit', plan:k}); }
  return DEFAULT_PLAN_SITE_LIMIT[k] ?? 2;
}

async function loadUserSelection(userId, planKey){
  dlog({step:'loadUserSelection.start', userId, planKey});

  const rs = await sb.from('user_sites').select('site_id, created_at').eq('user_id', userId);
  if (rs.error){ showErr('Falha ao ler user_sites: '+rs.error.message+' (code: '+rs.error.code+')'); throw rs.error; }
  const rows = rs.data || [];
  rows.sort((a,b)=>{
    const ca=a.created_at?new Date(a.created_at).getTime():0; const cb=b.created_at?new Date(b.created_at).getTime():0;
    return ca-cb;
  });

  const siteIdsText = rows.map(r=>String(r.site_id||'')).filter(x=>x.length>0);
  if (!siteIdsText.length){
    chosen=[]; unlocked=new Set(); locked=new Set();
    loadColumnOrder(); buildHeaders();
    setStatus('Nenhum site selecionado em Meus Dados.');
    dlog({step:'loadUserSelection.none'});
    return;
  }

  if (!siteIdsText.every(v => /^[0-9]+$/.test(v))){ showErr('IDs de site inválidos em user_sites.'); throw new Error('user_sites.site_id not numeric'); }
  const siteIds = siteIdsText.map(v => Number(v));

  const rsSites = await sb.from('sites').select('id, nome, url_pesquisa').in('id', siteIds);
  if (rsSites.error){ showErr('Falha ao ler sites: '+rsSites.error.message+' (code: '+rsSites.error.code+')'); throw rsSites.error; }
  const sites = rsSites.data || [];
  const byId=new Map(sites.map(s=>[s.id,s]));
  const ordered=[]; for (const id of siteIds){ const s=byId.get(id); if(s && !ordered.includes(s)) ordered.push(s); }
  if (!ordered.length){ showErr('Sites não encontrados para os IDs do usuário.'); throw new Error('sites missing'); }

  chosen = ordered.map(s=>({ site_id:s.id, label:(s.nome||('Site '+s.id)).toString().trim(), url:(s.url_pesquisa||'').toString() }));

  const lim = await getSitesLimitForPlan(planKey);
  unlocked=new Set(chosen.slice(0,lim).map(c=>c.site_id));
  locked=new Set(chosen.slice(lim).map(c=>c.site_id));

  loadColumnOrder();
  buildHeaders();
  setStatus('Sites: '+chosen.map(c=>c.label).join(' · '));
  dlog({step:'loadUserSelection.done', chosen, unlocked:[...unlocked], locked:[...locked], columnOrder});
}

/* ========= Outliers / filtros / render ========= */
function analyzeAllItemsOutliers(){
  for (const item of produtosList){
    const nums = [];
    const entries = Object.values(item.sites||{});
    for (const s of entries){ if (Number.isFinite(s.precoNum)) nums.push(s.precoNum); }
    if (nums.length >= 2){
      const mean = nums.reduce((a,b)=>a+b,0)/nums.length;
      const lo = mean*(1-OUTLIER_TOL), hi = mean*(1+OUTLIER_TOL);
      item.analysis = { mean, lo, hi, n:nums.length };
      for (const s of entries){
        if (!Number.isFinite(s.precoNum)){ s.valid = false; continue; }
        s.valid = (s.precoNum >= lo && s.precoNum <= hi);
      }
    } else {
      item.analysis = { mean: null, lo: null, hi: null, n: nums.length };
      for (const s of entries){ s.valid = Number.isFinite(s.precoNum); }
    }
  }
}
function upsertRowsIntoProdutos(rows){
  const allowedById = new Map(chosen.map(c=>[c.site_id, c.label]));
  for (const r of rows){
    if (!allowedById.has(r.site_id)) continue;
    const ean = String(r.ean||'');
    if (!produtosMap.has(ean)) produtosMap.set(ean, { sku:ean, desc:(r.descricao_cliente||r.descricao||''), meu_preco:null, sites:{} });
    const item = produtosMap.get(ean);
    if (!item.desc) item.desc = r.descricao_cliente || r.descricao || '';
    if (item.meu_preco == null && r.meu_preco != null){ const n=Number(r.meu_preco); if (Number.isFinite(n)) item.meu_preco=n; }
    const label = allowedById.get(r.site_id);
    const prev=item.sites[label];
    if (!prev || new Date(r.data) > new Date(prev.data)){
      item.sites[label] = { precoRaw:r.preco, precoNum:r.preco_num, data:r.data, site_id:r.site_id, site_nome:r.site_nome, valid:true };
    }
    item._tokNeeds = true;
  }
  produtosList = Array.from(produtosMap.values());
  for (const it of produtosList){ if (it._tokNeeds) ensureDescIndex(it); }
  analyzeAllItemsOutliers();
}

/* ========= Busca robusta ========= */
function matchesFilters(item){
  const qE = (currentEanQ||'').trim();
  if (qE && !String(item.sku||'').includes(qE)) return false;

  const qTokens = normTokens(currentDescQ);
  if (qTokens.length){
    ensureDescIndex(item);
    const words = item._tok || [];
    for (const qt of qTokens){
      let ok = false;
      for (const w of words){
        if (w.indexOf(qt) !== -1){ ok = true; break; }
      }
      if (!ok) return false;
    }
  }
  return true;
}

/* ========= URL pesquisa por site ========= */
function buildSearchUrlByLabel(label, ean){
  const c = chosen.find(x => x.label === label);
  if (!c || !c.url) return null;
  const tpl = String(c.url);
  const enc = encodeURIComponent(String(ean||''));
  return tpl.replace(/{ean}/gi, enc);
}

/* ========= Células ========= */
function chartButtonSVG(){ return '<svg class="chart-icon" viewBox="0 0 24 24" aria-hidden="true">'
  +'<rect x="3" y="11" width="3" height="7" rx="1" fill="#2d2d2d" stroke="#3b3b3b" stroke-width="1"></rect>'
  +'<rect x="9" y="8"  width="3" height="10" rx="1" fill="#2d2d2d" stroke="#3b3b3b" stroke-width="1"></rect>'
  +'<rect x="15" y="5" width="3" height="13" rx="1" fill="#2d2d2d" stroke="#3b3b3b" stroke-width="1"></rect>'
  +'<path d="M3,18 L7,14 L12,15 L17,8 L21,10" fill="none" stroke="#00d084" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"></path>'
  +'</svg>'; }

function computeMinMaxForRow(item){
  let min={label:null,val:Infinity}, max={label:null,val:-Infinity};
  for (const c of chosen){
    if (locked.has(c.site_id)) continue;
    const d=item.sites[c.label];
    if (!d || !d.valid || !Number.isFinite(d.precoNum)) continue;
    if (d.precoNum<min.val) min={label:c.label,val:d.precoNum};
    if (d.precoNum>max.val) max={label:c.label,val:d.precoNum};
  }
  return { min:min.label, max:max.label };
}
function createPriceCell(item, label, isLocked, minLabel, maxLabel){
  const td=document.createElement('td'); if (isLocked) td.classList.add('locked-cell'); const d=item.sites[label];
  if (d){
    const dtStr=d.data?new Date(d.data).toLocaleString('pt-BR'):'';
    const url = buildSearchUrlByLabel(label, item.sku);

    if (!d.valid){
      const span=document.createElement('span');
      span.className='price';
      if (d.precoRaw === null || d.precoRaw === undefined || String(d.precoRaw).trim() === '') {
      span.title = 'Preço não encontrado (indisponível no site)';
    } else if (item.analysis?.mean!=null) {
      span.title = `Filtrado por discrepância (>±${Math.round(OUTLIER_TOL*100)}% da média ${formatBRL(item.analysis.mean)})`;
    } else {
      span.title = 'Preço indisponível';
    }
      span.textContent=NA;
      td.appendChild(span);
      return td;
    }

    if (Number.isFinite(d.precoNum)){
      const cls = (!isLocked&&label===minLabel?'min':(!isLocked&&label===maxLabel?'max':'')) || '';
      const priceSpan=document.createElement('span'); priceSpan.className='price '+cls;
      priceSpan.title=isLocked?'Excedeu o limite do plano':(dtStr?('Atualizado em '+dtStr):'');
      priceSpan.textContent=formatBRL(d.precoNum);

      if (!isLocked && url){
        const a=document.createElement('a');
        a.href=url; a.target="_blank"; a.rel="noopener noreferrer"; a.className='price-link';
        a.title='Abrir no site';
        a.appendChild(priceSpan);
        td.appendChild(a);
      } else {
        td.appendChild(priceSpan);
      }

      const b=document.createElement('button'); b.className='chart-btn'; b.type='button'; b.title=isLocked?'Disponível no upgrade':'Ver histórico'; b.innerHTML=chartButtonSVG();
      const c=chosen.find(x=>x.label===label); b.addEventListener('click',(ev)=>{ if(isLocked){location.href='planos.html';return;} openChartFor(ev,item.sku,label,c?.site_id,item.meu_preco); }); td.appendChild(b);
      if (isLocked){ const up=document.createElement('button'); up.className='unlock'; up.type='button'; up.textContent='Ver planos'; up.addEventListener('click',()=>location.href='planos.html'); td.appendChild(up); }
    } else {
      const span=document.createElement('span'); span.className='price'; span.title=isLocked?'Excedeu o limite do plano':(dtStr?('Atualizado em '+dtStr):''); span.textContent=(d.precoRaw??'').toString().trim() || NA;

      if (!isLocked && url){
        const a=document.createElement('a');
        a.href=url; a.target="_blank"; a.rel="noopener noreferrer"; a.className='price-link';
        a.title='Abrir no site';
        a.appendChild(span);
        td.appendChild(a);
      } else {
        td.appendChild(span);
      }
    }
  } else {
    const span=document.createElement('span'); span.className='price'; span.textContent=NA; td.appendChild(span);
  }
  return td;
}
function createParamCell(item){
  const td=document.createElement('td'); td.className='col-param';
  const n=(typeof item.meu_preco==='number')?item.meu_preco:null;
  if (n!=null && Number.isFinite(n)){ const span=document.createElement('span'); span.className='price param'; span.title='Meu preço'; span.textContent=formatBRL(n); td.appendChild(span); }
  else { const span=document.createElement('span'); span.className='price param'; span.textContent=NA; td.appendChild(span); }
  return td;
}

/* ========= Ordenação ========= */
function getValueForKey(item, key){
  if (key==='sku') return item.sku || '';
  if (key==='desc') return item.desc || '';
  if (key==='meu_preco') return (typeof item.meu_preco==='number') ? item.meu_preco : null;
  if (key.startsWith('site:')){
    const label = key.slice(5);
    const d = item.sites?.[label];
    return (d && d.valid && Number.isFinite(d.precoNum)) ? d.precoNum : null;
  }
  return null;
}
function makeComparator(key, dir){
  const mul = (dir==='desc') ? -1 : 1;
  const coll = new Intl.Collator('pt-BR',{numeric:true,sensitivity:'base'});
  return (a,b)=>{
    const va = getValueForKey(a, key);
    const vb = getValueForKey(b, key);
    const aNull = (va===null || va===undefined || va==='');
    const bNull = (vb===null || vb===undefined || vb==='');
    if (aNull && bNull) return 0;
    if (aNull) return 1 * mul;
    if (bNull) return -1 * mul;
    if (typeof va === 'number' && typeof vb === 'number'){
      if (va===vb) return 0; return (va<vb ? -1 : 1) * mul;
    }
    const sa = String(va), sb = String(vb);
    if (sa===sb) return 0;
    return coll.compare(sa,sb) * mul;
  };
}
function applySortIndicators(rowEl, activeKey, dir){
  Array.from(rowEl.children).forEach(th=>{
    const ind = th.querySelector('.sort-ind');
    if (ind) ind.remove();
  });
  const th = rowEl.querySelector(`th[data-sortkey="${CSS.escape(activeKey)}"]`);
  if (!th) return;
  const span = document.createElement('span');
  span.className = 'sort-ind';
  span.textContent = dir==='asc' ? '▲' : '▼';
  th.appendChild(span);
}
function setupSortableHeaders(headerRow, tableKind){
  const ths = Array.from(headerRow.children);
  ths.forEach((th, idx)=>{
    if (idx===0) return;
    const key = th.getAttribute('data-sortkey');
    if (!key) return;
    th.classList.add('sortable');
    th.addEventListener('click', ()=>{
      if (tableKind==='general'){
        sortStateGeneral.dir = (sortStateGeneral.key===key && sortStateGeneral.dir==='asc') ? 'desc' : 'asc';
        sortStateGeneral.key = key;
        applySortGeneral();
        applySortIndicators(headerRow, sortStateGeneral.key, sortStateGeneral.dir);
      } else {
        sortStateFav.dir = (sortStateFav.key===key && sortStateFav.dir==='asc') ? 'desc' : 'asc';
        sortStateFav.key = key;
        renderFavs();
        applySortIndicators(headerRow, sortStateFav.key, sortStateFav.dir);
      }
    });
  });
}

/* ========= Reordenar colunas ========= */
function setupReorderableHeaders(headerRow){
  const ths = Array.from(headerRow.children);
  ths.forEach((th, idx)=>{
    if (idx===0) { th.draggable=false; return; }
    th.addEventListener('dragstart', (ev)=>{
      ev.dataTransfer.setData('text/plain', th.getAttribute('data-sortkey') || '');
      headerRow.querySelectorAll('th').forEach(x=>x.classList.remove('drop-left','drop-right'));
    });
    th.addEventListener('dragover', (ev)=>{
      ev.preventDefault();
      const rect = th.getBoundingClientRect();
      const before = (ev.clientX - rect.left) < rect.width/2;
      th.classList.toggle('drop-left', before);
      th.classList.toggle('drop-right', !before);
    });
    th.addEventListener('dragleave', ()=>{ th.classList.remove('drop-left','drop-right'); });
    th.addEventListener('drop', (ev)=>{
      ev.preventDefault();
      const srcKey = ev.dataTransfer.getData('text/plain');
      const destKey = th.getAttribute('data-sortkey');
      th.classList.remove('drop-left','drop-right');
      if (!srcKey || !destKey || srcKey===destKey) return;

      const rect = th.getBoundingClientRect();
      const placeBefore = (ev.clientX - rect.left) < rect.width/2;

      const arr = columnOrder.slice();
      const srcIdx = arr.indexOf(srcKey);
      const destIdx = arr.indexOf(destKey);
      if (srcIdx===-1 || destIdx===-1) return;
      arr.splice(srcIdx,1);
      const insertAt = destIdx + (placeBefore ? 0 : 1) - (srcIdx < destIdx ? 1 : 0);
      arr.splice(Math.max(0,insertAt),0,srcKey);
      columnOrder = arr;
      saveColumnOrder();

      buildHeaders();
      recomputeGeneralView();
      renderFavs();
    });
  });
}

/* ========= View (Geral) ========= */
function recomputeGeneralView(){
  generalView = (searchScope==='both' || searchScope==='general') ? produtosList.filter(matchesFilters) : produtosList.slice();
  if (sortStateGeneral.key){
    generalView.sort(makeComparator(sortStateGeneral.key, sortStateGeneral.dir));
  }
  resetGeneralDom();
  renderGeneralChunk();
}
function renderGeneralChunk(){
  const end=Math.min(itemsRendered+RENDER_CHUNK, generalView.length);
  const frag=document.createDocumentFragment();
  for(let i=itemsRendered;i<end;i++){
    const it=generalView[i];
    const tr=document.createElement('tr');
    renderRowIntoGeneral(tr,it);
    frag.appendChild(tr);
  }
  generalBody.appendChild(frag);
  itemsRendered=end;
  endMarker.textContent=(serverExhausted && itemsRendered>=generalView.length)?'Fim da lista':'';
  updateCounts();
}
function resetGeneralDom(){ generalBody.innerHTML=''; generalChkMap.clear(); itemsRendered=0; endMarker.textContent=''; }
function applySortGeneral(){
  if (sortStateGeneral.key){
    generalView.sort(makeComparator(sortStateGeneral.key, sortStateGeneral.dir));
  }
  resetGeneralDom();
  renderGeneralChunk();
}

/* ========= Scroll / Paginação ========= */
function onGeneralScroll(){
  if (loadingMore) return;
  const nearBottom = generalWrap.scrollTop + generalWrap.clientHeight >= generalWrap.scrollHeight - 100;
  if (nearBottom && itemsRendered < generalView.length){ loadingMore=true; setTimeout(()=>{ renderGeneralChunk(); loadingMore=false; },30); return; }
  if (nearBottom && !serverExhausted && !fetching){ fetchNextPage(); }
}
generalWrap.addEventListener('scroll', onGeneralScroll);

/* ========= Linhas ========= */
function renderRowIntoGeneral(tr,item){
  const tdFav=document.createElement('td'); tdFav.className='col-fav';
  const chk=document.createElement('input'); chk.type='checkbox'; chk.checked=isFav(item.sku);
  chk.addEventListener('change',async ()=>{
    if(chk.checked){ await addFavorite(item.sku); }
    else { await removeFavorite(item.sku); }
    renderFavs(); updateFavHeight(); updateCounts();
  });
  tdFav.appendChild(chk); tr.appendChild(tdFav); generalChkMap.set(item.sku, chk);

  const {min,max}=computeMinMaxForRow(item);

  for (const key of columnOrder){
    if (key==='sku'){ const td=document.createElement('td'); td.className='col-sku'; td.textContent=item.sku; tr.appendChild(td); continue; }
    if (key==='desc'){ const td=document.createElement('td'); td.className='col-desc'; td.innerHTML=(item.desc||'').replace(/</g,'&lt;'); tr.appendChild(td); continue; }
    if (key==='meu_preco'){ tr.appendChild(createParamCell(item)); continue; }
    if (key.startsWith('site:')){
      const label=key.slice(5);
      const c=chosen.find(x=>x.label===label);
      tr.appendChild(createPriceCell(item, label, c?locked.has(c.site_id):false, min, max));
    }
  }
}
function itemMatchesFavScope(item){ if (!(searchScope==='both' || searchScope==='favorites')) return true; return matchesFilters(item); }
function renderFavs(){
  favBody.innerHTML='';
  let favList = produtosList.filter(p=>isFav(p.sku)).filter(itemMatchesFavScope);

  if (sortStateFav.key){
    favList.sort(makeComparator(sortStateFav.key, sortStateFav.dir));
  }

  const frag=document.createDocumentFragment();
  for (const item of favList){
    const tr=document.createElement('tr');

    const tdAct=document.createElement('td'); tdAct.className='col-fav';
    const btn=document.createElement('button'); btn.title='Remover'; btn.innerHTML='🗑️'; btn.type='button';
    btn.addEventListener('click',async ()=>{
      await removeFavorite(item.sku);
      const chk=generalChkMap.get(item.sku); if(chk){ chk.checked=false; }
      renderFavs(); updateFavHeight(); updateCounts();
    });
    tdAct.appendChild(btn); tr.appendChild(tdAct);

    const {min,max}=computeMinMaxForRow(item);

    for (const key of columnOrder){
      if (key==='sku'){ const td=document.createElement('td'); td.className='col-sku'; td.textContent=item.sku; tr.appendChild(td); continue; }
      if (key==='desc'){ const td=document.createElement('td'); td.className='col-desc'; td.innerHTML=(item.desc||'').replace(/</g,'&lt;'); tr.appendChild(td); continue; }
      if (key==='meu_preco'){ tr.appendChild(createParamCell(item)); continue; }
      if (key.startsWith('site:')){
        const label=key.slice(5);
        const c=chosen.find(x=>x.label===label);
        tr.appendChild(createPriceCell(item, label, c?locked.has(c.site_id):false, min, max));
      }
    }

    frag.appendChild(tr);
  }
  favBody.appendChild(frag);
}

/* ========= Contadores ========= */
function updateCounts(){
  countShown.textContent = 'Exibindo ' + itemsRendered + ' de ' + generalView.length + ' no Geral';
  countTotal.textContent = serverExhausted ? ('Total carregado: ' + produtosList.length) : ('Carregando... (' + produtosList.length + '+ )');
  countFavs.textContent  = 'Favoritos: ' + favSet.size;
}

/* ========= Query / paginação ========= */
function buildQuery(){
  let q = sb.from(VIEW).select(
    'ean, site_id, site_nome, preco, data, descricao, preco_num, meu_preco, descricao_cliente',
    { count:'estimated' }
  ).order('descricao', { ascending:true, nullsFirst:false }).order('ean', { ascending:true, nullsFirst:true }).order('site_id', { ascending:true });

  const eanQ  = (currentEanQ||'').trim();
  const descQ = (currentDescQ||'').trim();

  if (eanQ){
    q = q.ilike('ean', `%${eanQ}%`);
  }
  if (descQ){
    q = q.or(`descricao.ilike.%${descQ}%,descricao_cliente.ilike.%${descQ}%`);
  }

  return q;
}
async function fetchNextPage(){
  if (fetching || serverExhausted) return; fetching = true; hideErr(); setStatus('Carregando... (offset ' + serverOffset + ')'); dlog({step:'fetch', offset:serverOffset});
  try{
    const from=serverOffset, to=serverOffset+PAGE_SIZE-1;
    const { data, error, status } = await buildQuery().range(from,to);
    if (error){
      if ((status===416) || /Requested range not satisfiable/i.test(error.message||'')) {
        serverExhausted = true;
        setStatus('Todos os dados carregados.');
        endMarker.textContent = 'Fim da lista';
        return;
      }
      throw error;
    }
    if (!data || data.length===0){
      serverExhausted = true; setStatus('Todos os dados carregados.');
      if (itemsRendered >= generalView.length) endMarker.textContent = 'Fim da lista';
    } else {
      upsertRowsIntoProdutos(data);
      recomputeGeneralView();
      renderFavs();
      if (!favFirstAutoRenderDone){ updateFavHeight(); favFirstAutoRenderDone=true; }
      serverOffset += PAGE_SIZE; setStatus('Carregados (parcial): ' + produtosList.length + ' SKUs');
    }
  }catch(e){
    showErr('Falha ao carregar view: '+(e.message||String(e)));
    serverExhausted = true;
  } finally { fetching=false; updateCounts(); }
}

/* ========= Favoritos: consulta direta (não depende da rolagem) ========= */
async function fetchFavsDirect(){
  try{
    if (!favSet || favSet.size === 0){
      renderFavs(); updateFavHeight(); updateCounts();
      dlog({step:'fav.direct.skip', reason:'no-favs'});
      return;
    }
    const favs = Array.from(favSet).map(String);
    const siteIds = (Array.isArray(chosen)?chosen:[]).map(c => Number(c.site_id)).filter(n => Number.isFinite(n));

    let q = sb.from(VIEW).select(
      'ean, site_id, site_nome, preco, data, descricao, preco_num, meu_preco, descricao_cliente'
    ).in('ean', favs).order('descricao', { ascending:true, nullsFirst:false }).order('ean', { ascending:true, nullsFirst:true }).order('site_id', { ascending:true });

    if (siteIds.length){ q = q.in('site_id', siteIds); }

    const { data, error, status } = await q;
    if (error){
      dlog({error:'fav.direct.query', code:error.code, msg:error.message, status});
      return;
    }
    if (Array.isArray(data) && data.length){
      upsertRowsIntoProdutos(data);
    }
    renderFavs();
    updateFavHeight();
    updateCounts();
    dlog({step:'fav.direct.done', favs:favs.length, rows:(data?data.length:0)});
  }catch(e){
    dlog({error:'fav.direct.exception', detail:String(e)});
  }
}

/* ========= Reset ========= */
function resetAndQuery(){
  dlog({step:'resetAndQuery'});
  produtosMap.clear(); produtosList=[]; serverOffset=0; serverExhausted=false; favFirstAutoRenderDone=false;
  generalView=[]; resetGeneralDom(); renderFavs(); updateFavHeight(); updateCounts();
  try{ if (typeof fetchFavsDirect==='function') fetchFavsDirect(); }catch(_){}
  fetchNextPage();
}

/* ========= LOG DE PESQUISA (sem localização) ========= */
const logSearchDebounced = debounce(doLogSearch, 1200);
async function doLogSearch(){
  try{
    const { data:{ session } } = await sb.auth.getSession();
    if (!session || !session.user) return;

    const eanQ  = (currentEanQ||'').trim();
    const descQ = (currentDescQ||'').trim();
    const scope = searchScope;

    const isEanOk  = eanQ.replace(/\\D/g,'').length >= 8;
    const isDescOk = descQ.length >= 3;
    if (!isEanOk && !isDescOk) return;

    const payload = {
      user_id:   session.user.id,
      email:     session.user.email || null,
      ean_query: isEanOk  ? eanQ  : null,
      desc_query:isDescOk ? descQ : null,
      scope:     scope,
      results_count: generalView?.length ?? null,
      source:    'dashboard',
      user_agent: navigator.userAgent || null
    };

    const { error } = await sb.from('search_logs').insert(payload);
    if (error) { dlog({warn:'search_log.insert.failed', error}); }
    else { dlog({step:'search_log.insert.ok', eanQ, descQ, scope, results: payload.results_count}); }
  }catch(err){
    dlog({warn:'search_log.insert.exception', detail: String(err)});
  }
}

/* ========= Impressão (via iframe oculto) ========= */
function buildPrintHTMLFromFav() {
  const favHeaderRow = document.getElementById('favHeaderRow');
  const headers = Array.from(favHeaderRow?.children || []).map((th,i) => i===0 ? null : th.textContent.trim()).filter(Boolean);
  const favBody = document.querySelector('#favTable tbody'); const rows = Array.from(favBody?.rows || []);
  const thead = '<thead><tr>' + headers.map(h => '<th>'+h+'</th>').join('') + '</tr></thead>';
  let tbody = '';
  for (const tr of rows) {
    const cells = Array.from(tr.cells).slice(1).map(td => { const txt = (td.textContent || '').replace(/\\s+/g, ' ').trim(); return '<td>'+(txt || NA)+'</td>'; });
    tbody += '<tr>'+cells.join('')+'</tr>';
  }
  const css = '*{box-sizing:border-box;} body{font-family:Arial,sans-serif;color:#000;background:#fff;padding:24px;} h1{margin:0 0 4px 0;font-size:18px;} .meta{color:#444;font-size:12px;margin-bottom:14px;} table{width:100%;border-collapse:collapse;} thead th{text-align:left;font-weight:700;padding:6px 0;} tbody td{padding:4px 0;} @media print{body{padding:0;}}';
  const now=new Date(); const meta = now.toLocaleDateString('pt-BR')+' '+now.toLocaleTimeString('pt-BR');
  return '<!DOCTYPE html><html><head><meta charset="utf-8"><title>Relatório — Favoritos</title><style>'+css+'</style></head><body><h1>Relatório — Favoritos</h1><div class="meta">Gerado em '+meta+'</div><table>'+thead+'<tbody>'+tbody+'</tbody></table></body></html>';
}
function printFavReport(){
  const iframe = document.createElement('iframe');
  iframe.style.position='fixed'; iframe.style.right='0'; iframe.style.bottom='0';
  iframe.style.width='0'; iframe.style.height='0'; iframe.style.border='0'; iframe.style.visibility='hidden';
  document.body.appendChild(iframe);
  const doc = iframe.contentWindow || iframe.contentDocument;
  const html = buildPrintHTMLFromFav();
  (doc.document || doc).open();
  (doc.document || doc).write(html + '<script>window.onload=function(){setTimeout(function(){window.focus();window.print();},10)}<\\/script>');
  (doc.document || doc).close();
  setTimeout(()=>{ try{ document.body.removeChild(iframe); }catch{} }, 2000);
}

/* ========= Chart ========= */
popClose.addEventListener('click', ()=> pop.style.display='none');
addEventListener('click', (ev)=>{ if(pop.style.display!=='none' && !pop.contains(ev.target) && !ev.target.closest('.chart-btn')) pop.style.display='none'; });

let lastChart = { points:[], xS:null, yS:null, margins:null, hoverIdx:null, userPrice:null };

function drawGrid(ctx, W, H, m, xTicks=4, yTicks=4, yMin=null, yMax=null, fmtFn=null){
  ctx.save();
  ctx.strokeStyle = '#232323';
  ctx.lineWidth = 1;
  ctx.beginPath();
  for(let i=0;i<=yTicks;i++){
    const y = m.t + i*(H-m.t-m.b)/yTicks;
    ctx.moveTo(m.l, y); ctx.lineTo(W-m.r, y);
    if (yMin!=null && yMax!=null && fmtFn){
      const val = yMax - ((y - m.t) / (H - m.t - m.b)) * (yMax - yMin);
      const label = fmtFn(val);
      ctx.save();
      ctx.fillStyle = '#9aa0a6';
      ctx.font = '11px Arial';
      const tw = ctx.measureText(label).width;
      ctx.fillText(label, Math.max(4, m.l - 8 - tw), Math.round(y) - 2);
      ctx.restore();
    }
  }
  for(let i=0;i<=xTicks;i++){
    const x = m.l + i*(W-m.l-m.r)/xTicks;
    ctx.moveTo(x, m.t); ctx.lineTo(x, H-m.b);
  }
  ctx.stroke();
  ctx.strokeStyle = '#2a2a2a';
  ctx.strokeRect(m.l, m.t, W-m.l-m.r, H-m.t-m.b);
  ctx.restore();
}

function drawSparkFull(points, hoverIdx=null, userPrice=null){
  const ctx=sparkCtx, W=spark.width, H=spark.height; ctx.clearRect(0,0,W,H);
  if(!points || points.length<2){
    popMsg.style.display='block'; popMsg.textContent='Histórico insuficiente (≥2 pontos).'; return;
  }
  popMsg.style.display='none';
  const m={l:46,r:18,t:16,b:34};
  const xs=points.map(p=>p.x.getTime()), ys=points.map(p=>p.y);
  const xMin=Math.min(...xs), xMax=Math.max(...xs);
  const ysAll = (userPrice!=null && isFinite(userPrice)) ? ys.concat([Number(userPrice)]) : ys.slice();
  let yMin=Math.min(...ysAll), yMax=Math.max(...ysAll);
  let span = yMax - yMin;
  if (!isFinite(span) || span <= 0) {
    span = Math.max(1, Math.abs(yMax||0) * 0.1 || 1);
    yMin -= span/2; yMax += span/2;
  }
  const pad = Math.max(span * 0.1, 1e-6);
  yMin = yMin - pad;
  yMax = yMax + pad;
  const xS=v=>m.l+((v-xMin)/(xMax-xMin||1))*(W-m.l-m.r);
  const yR=v=>H-m.b-((v-yMin)/(yMax-yMin||1))*(H-m.t-m.b);
  const yS=v=>Math.max(m.t+6, Math.min(H-m.b-6, yR(v)));

  drawGrid(ctx, W, H, m, 5, 4, yMin, yMax, formatBRL);

  ctx.beginPath();
  ctx.lineWidth=2.5;
  ctx.strokeStyle='#00d084';
  points.forEach((p,i)=>{
    const X=xS(p.x.getTime()), Y=yS(p.y);
    if(i===0) ctx.moveTo(X,Y); else ctx.lineTo(X,Y);
  });
  ctx.stroke();

  ctx.fillStyle='#00d084';
  points.forEach(p=>{ const X=xS(p.x.getTime()), Y=yS(p.y); ctx.beginPath(); ctx.arc(X,Y,3.5,0,Math.PI*2); ctx.fill(); });

  if (userPrice!=null && isFinite(userPrice)){
    const yUser = yS(Number(userPrice));
    ctx.save();
    ctx.setLineDash([6,4]);
    ctx.strokeStyle = '#ffd54f';
    ctx.lineWidth = 1.5;
    ctx.beginPath();
    ctx.moveTo(m.l, yUser); ctx.lineTo(W - m.r, yUser);
    ctx.stroke();
    ctx.setLineDash([]);
    const label = 'Meu preço: ' + formatBRL(Number(userPrice));
    ctx.font='12px Arial';
    const pad = 6;
    const tw = ctx.measureText(label).width;
    let bx = W - m.r - (tw + pad*2) - 6;
    let by = Math.max(m.t+4, Math.min(H - m.b - 22, yUser - 12));
    ctx.fillStyle = 'rgba(0,0,0,0.85)';
    ctx.fillRect(bx, by, tw + pad*2, 18);
    ctx.strokeStyle='#2a2a2a'; ctx.strokeRect(bx, by, tw + pad*2, 18);
    ctx.fillStyle = '#ffd54f';
    ctx.fillText(label, bx + pad, by + 13);
    ctx.restore();
  }

  ctx.fillStyle='#9aa0a6'; ctx.font='11px Arial';
  ctx.fillText(new Date(xMin).toLocaleDateString('pt-BR'), m.l, H-10);
  const rightLabel = new Date(xMax).toLocaleDateString('pt-BR');
  ctx.fillText(rightLabel, W - m.r - ctx.measureText(rightLabel).width, H-10);

  if (hoverIdx!=null && points[hoverIdx]){
    const p = points[hoverIdx];
    const X=xS(p.x.getTime()), Y=yS(p.y);

    ctx.save();
    ctx.strokeStyle='#3a3a3a'; ctx.lineWidth=1;
    ctx.beginPath(); ctx.moveTo(m.l, Y); ctx.lineTo(W-m.r, Y); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(X, m.t); ctx.lineTo(X, H-m.b); ctx.stroke();
    ctx.restore();

    ctx.beginPath(); ctx.arc(X,Y,6,0,Math.PI*2); ctx.fillStyle='#00d084'; ctx.fill();

    const price = formatBRL(p.y);
    const date  = p.x.toLocaleDateString('pt-BR');
    const txt   = price + ' • ' + date;
    ctx.font='12px Arial'; const pad=6;
    const tw = ctx.measureText(txt).width;
    const th = 18;
    let boxX = X + 10, boxY = Y - (th + 10);
    if (boxX + tw + pad*2 > W - m.r) boxX = X - 10 - (tw + pad*2);
    if (boxY < m.t) boxY = Y + 10;
    ctx.fillStyle='rgba(0,0,0,0.85)';
    ctx.fillRect(boxX, boxY, tw + pad*2, th);
    ctx.strokeStyle='#2a2a2a'; ctx.strokeRect(boxX, boxY, tw + pad*2, th);
    ctx.fillStyle='#eaeaea'; ctx.fillText(txt, boxX + pad, boxY + th - 5);
  }

  lastChart.points = points;
  lastChart.xS = xS;
  lastChart.yS = yS;
  lastChart.margins = m;
  lastChart.hoverIdx = hoverIdx;
}

function indexFromMouse(evt){
  const rect = spark.getBoundingClientRect();
  const mx = evt.clientX - rect.left;
  const my = evt.clientY - rect.top;
  const pts = lastChart.points || [];
  if (!pts.length || !lastChart.xS || !lastChart.yS) return null;
  let bestIdx=null, bestDist=1e9;
  pts.forEach((p,i)=>{
    const X=lastChart.xS(p.x.getTime()), Y=lastChart.yS(p.y);
    const dx=mx-X, dy=my-Y; const d=Math.sqrt(dx*dx+dy*dy);
    if (d < bestDist){ bestDist=d; bestIdx=i; }
  });
  return (bestDist<=10) ? bestIdx : null;
}

spark.addEventListener('mousemove', (e)=>{
  const idx = indexFromMouse(e);
  if (idx!==lastChart.hoverIdx){
    lastChart.hoverIdx = idx;
    drawSparkFull(lastChart.points, idx, lastChart.userPrice || null);
  }
});
spark.addEventListener('mouseleave', ()=>{
  if (lastChart.hoverIdx!=null){ lastChart.hoverIdx=null; drawSparkFull(lastChart.points, null, lastChart.userPrice || null); }
});

async function fetchHistory(ean, siteId){
  let pts=[];
  try{
    const { data, error } = await sb.from(VIEW).select('data, preco_num').eq('ean', ean).eq('site_id', siteId).not('preco_num','is',null).order('data',{ascending:true}).limit(180);
    if (!error && data && data.length){ pts = data.map(r=>({ x:new Date(r.data), y:Number(r.preco_num) })).filter(p=>Number.isFinite(p.y)); }
  }catch(e){ dlog({error:'fetchHistory.view', detail:String(e)}); }
  const byTs = new Map(pts.map(p=>[p.x.getTime(), p])); return Array.from(byTs.values()).sort((a,b)=>a.x-b.x);
}
async function openChartFor(ev, ean, label, siteId, userPrice){
  const x = ev.clientX || (ev.touches && ev.touches[0]?.clientX) || 120, y = ev.clientY || (ev.touches && ev.touches[0]?.clientY) || 80;
  pop.style.left = Math.max(12, x - 300) + 'px'; pop.style.top  = Math.max(12, y - 260) + 'px';
  popTitle.textContent = 'Histórico — ' + label + ' • EAN ' + ean; pop.style.display='block'; popMsg.style.display='none';
  const points = await fetchHistory(String(ean), Number(siteId)); lastChart.userPrice = (userPrice!=null && isFinite(userPrice)) ? Number(userPrice) : null; drawSparkFull(points, null, lastChart.userPrice);
}

/* ========= Escopo ========= */
function initScopeRadios(){
  localStorage.setItem('mm_scope','both'); searchScope='both';
  const radios=scopeGroup.querySelectorAll('input[name="scope"]');
  radios.forEach(r=>{
    r.checked=(r.value===searchScope);
    r.addEventListener('change', ()=>{
      if(!r.checked) return;
      searchScope=r.value; localStorage.setItem('mm_scope',searchScope);
      recomputeGeneralView(); renderFavs(); updateFavHeight(); updateCounts();
      dlog({step:'scopeChange', scope:searchScope});
      logSearchDebounced();
    });
  });
}

/* ========= INIT: sessão, plano, sites e favoritos ========= */
async function initUserAndSites(){
  const { data:{ session } } = await sb.auth.getSession();
  if (!session){ location.href = CFG.SITE_URL || 'index.html'; return; }
  currentUserId = session.user?.id || null;
  userChip.textContent = session.user?.email || 'Logado';
  dlog({step:'session', user:session.user?.id, email:session.user?.email});

  let planKey='basico';
  try{
    const rs = await sb.from('profiles').select('plan').eq('id', session.user.id).maybeSingle();
    if (!rs.error){
      const raw = (rs.data?.plan ?? 'basico').toString();
      planKey = raw.toLowerCase();
      planChip.textContent = 'Plano: ' + (raw.charAt(0).toUpperCase()+raw.slice(1));
    }else{
      dlog({warn:'profiles.select.failed', detail: rs.error});
    }
  }catch(e){
    dlog({warn:'profiles.exception', detail:String(e)});
  }

  try{
    await loadUserSelection(session.user.id, planKey);
  }catch(e){
    dlog({fatal:'init user_sites/sites failed', raw:String(e)});
    throw e;
  }

  // Carrega favoritos da TABELA (não mais localStorage)
  await refreshFavsFromDB();
}

/* ========= Busca (EAN + Descrição) ========= */
const SEARCH_DEBOUNCE_MS = 800;
const onFilterInput = debounce(()=>{
  currentEanQ = (eanFilter.value||'').trim();
  currentDescQ = (descFilter.value||'').trim();
  resetAndQuery();
  dlog({step:'filter', ean:currentEanQ, desc:currentDescQ});
  logSearchDebounced();
}, SEARCH_DEBOUNCE_MS);
eanFilter.addEventListener('input', onFilterInput);
descFilter.addEventListener('input', onFilterInput);
function triggerSearchNow(){
  currentEanQ = (eanFilter.value||'').trim();
  currentDescQ = (descFilter.value||'').trim();
  resetAndQuery();
  dlog({step:'filterImmediate', ean:currentEanQ, desc:currentDescQ});
  logSearchDebounced();
}
eanFilter.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); triggerSearchNow(); }});
descFilter.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); triggerSearchNow(); }});

/* ========= UI ========= */
ddMeusDados.addEventListener('click', ()=> location.href='meusdados.html');
ddPlanos.addEventListener('click', ()=> location.href='planos.html');
btnSair.addEventListener('click', async ()=>{ try{ await sb.auth.signOut(); } finally{ localStorage.removeItem('mm_login_date'); location.href = CFG.SITE_URL || 'index.html'; }});
btnReload.addEventListener('click', async ()=>{
  dlog({step:'manualReload.start'});
  await initUserAndSites();
  resetAndQuery();
  dlog({step:'manualReload.end'});
});
btnPrintFav.addEventListener('click', printFavReport);

/* ========= Favoritos: altura/resizer ========= */
function measureRowHeight(){ const row=document.querySelector('#favTable tbody tr'); if(!row) return 44; const h=Math.round(row.getBoundingClientRect().height); return Math.max(36, h||44); }
function measureHeadHeight(){ const head=document.querySelector('#favTable thead'); if(!head) return 40; const h=Math.round(head.getBoundingClientRect().height); return Math.max(32, h||40); }
function applyFavHeight(px){ if(!px||!Number.isFinite(px)) return; const maxPx=Math.round(window.innerHeight*0.85); const clamped=Math.max(120, Math.min(px, maxPx)); favWrap.style.height=clamped+'px'; }
function updateFavHeight(){ if (favHeightUser){ applyFavHeight(favHeightUser); return; } const rowsLen=favBody.children.length; const rows=Math.min(rowsLen,20); const rowH=measureRowHeight(); const headH=measureHeadHeight(); const pad=8; const target=headH + rows*rowH + pad; applyFavHeight(target); }
(function initResizer(){ let startY=0, startH=0;
  function onMove(ev){ const dy=ev.clientY-startY; favHeightUser=startH+dy; localStorage.setItem('mm_fav_height', String(favHeightUser)); applyFavHeight(favHeightUser); }
  function stop(){ removeEventListener('mousemove', onMove); removeEventListener('mouseup', stop); document.body.classList.remove('resizing'); }
  favResizer.addEventListener('mousedown', (ev)=>{ startY=ev.clientY; startH=favWrap.offsetHeight; document.body.classList.add('resizing'); addEventListener('mousemove', onMove); addEventListener('mouseup', stop); });
  favResizer.addEventListener('dblclick', ()=>{ favHeightUser=null; localStorage.removeItem('mm_fav_height'); updateFavHeight(); });
})();

/* ========= Start ========= */
(async function init(){
  try{
    await initUserAndSites();
    initScopeRadios();
    loadColumnOrder(); buildHeaders();

    applyToggle(toggleFavBtn, favWrap, document.getElementById('favResizer'), 'mm_tgl_fav');
    applyToggle(toggleGenBtn, generalWrap, null, 'mm_tgl_gen');

    resetAndQuery();
    generalWrap.dispatchEvent(new Event('scroll'));
  }catch(e){ showErr('Falha na inicialização'); dlog({error:'init', detail:String(e)}); }
})();
</script>

<!-- ===== MaiorMargem: bloco de contexto para salvar link direto por site (fallback sem EAN) ===== -->
<style>
  .mm-na-hint { border-bottom: 1px dotted #6b6b6b; cursor: context-menu; }
</style>
<script>
(function(){
  try{
    // Cliente Supabase
    var sb = (typeof window.sb !== 'undefined' && window.sb) ? window.sb : null;
    if (!sb && typeof supabase !== 'undefined' && window.CONFIG){
      sb = supabase.createClient(window.CONFIG.SUPABASE_URL, window.CONFIG.SUPABASE_ANON_KEY, { auth: { persistSession: true } });
      window.sb = sb;
    }
    if (!sb){ console.warn('[MM] Supabase client não encontrado.'); return; }

    var VIEW = (typeof window.VIEW === 'string' && window.VIEW) ? window.VIEW : 'vw_precos_dinamica';

    function normalizeEanDigits(e){ return String(e||'').replace(/\D+/g,''); }

    async function resolveProdutoIdByEan(ean){
      try{
        const raw = String(ean||'').trim();
        const norm = normalizeEanDigits(raw);

        // 1) ean1 / ean_norm exatos
        let { data, error } = await sb.from('cadastro_produtos')
          .select('id_produto, ean1, ean_norm')
          .or('ean1.eq.'+raw+',ean_norm.eq.'+norm)
          .limit(1);
        if (!error && data && data[0] && data[0].id_produto) return data[0].id_produto;

        // 2) like
        ({ data, error } = await sb.from('cadastro_produtos')
          .select('id_produto, ean1, ean_norm')
          .or('ean1.ilike.%'+raw+'%,ean_norm.ilike.%'+norm+'%')
          .limit(1));
        if (!error && data && data[0] && data[0].id_produto) return data[0].id_produto;

        // 3) tira zeros à esquerda
        const normNoZeros = norm.replace(/^0+/, '');
        if (normNoZeros && normNoZeros !== norm){
          ({ data, error } = await sb.from('cadastro_produtos')
            .select('id_produto, ean1, ean_norm')
            .or('ean1.eq.'+normNoZeros+',ean_norm.eq.'+normNoZeros)
            .limit(1));
          if (!error && data && data[0] && data[0].id_produto) return data[0].id_produto;
        }

        // 4) fallback via view (se expuser id_produto)
        try{
          const vr = await sb.from(VIEW).select('id_produto').eq('ean', raw).limit(1);
          if (!vr.error && vr.data && vr.data[0] && vr.data[0].id_produto) return vr.data[0].id_produto;
        }catch(_){}

        return null;
      }catch(ex){
        console.warn('[MM] resolveProdutoIdByEan ex:', ex);
        return null;
      }
    }

    async 
function upsertProdutoSiteLink(ean, site_id, url, idNoSite = null){ return (async()=>{
  const id_produto = await resolveProdutoIdByEan(ean);
  if (!id_produto){
    throw new Error('Produto não encontrado em cadastro_produtos para o EAN ' + ean);
  }
  const payload = { id_produto: Number(id_produto), site_id: Number(site_id), url: (url==null?null:String(url)) };
  if (idNoSite !== null && idNoSite !== undefined && String(idNoSite).length){
    payload.id_no_site = String(idNoSite);
  }
  const { error } = await sb.from('links_produto_site')
    .upsert(payload, { onConflict: 'id_produto,site_id' });
  if (error) throw new Error(error.message || 'Falha ao salvar link');
})();}

      const payload = { id_produto: Number(id_produto), site_id: Number(site_id), url: String(url) };
      const { error } = await sb.from('links_produto_site')
        .upsert(payload, { onConflict: 'id_produto,site_id' });
      if (error) throw new Error(error.message || 'Falha ao salvar link');
    }

    // Coleta labels das colunas e tenta mapear para site_id
    function collectSiteHeaderLabels(table){
      const thead = table.querySelector('thead');
      if (!thead) return [];
      const ths = Array.from(thead.querySelectorAll('th'));
      const labels = [];
      ths.forEach((th, idx)=>{
        const txt = (th.textContent||'').trim();
        if (!txt) return;
        // pular colunas de controle
        const lower = txt.toLowerCase();
        if (idx===0) return; // estrela/ação
        if (['ean','descrição','descricao','meu preço','meu preco'].includes(lower)) return;
        labels.push({ index: idx, label: txt });
      });
      return labels;
    }

    async function buildSiteColumnMap(table){
      const labels = collectSiteHeaderLabels(table);
      const map = new Map();
      if (!labels.length) return map;

      // 1) tentar via 'chosen' se existir no escopo global
      if (typeof chosen !== 'undefined' && Array.isArray(chosen)){
        const byLabel = new Map();
        chosen.forEach(c=>{ byLabel.set(String(c.label||'').trim().toLowerCase(), Number(c.site_id)); });
        labels.forEach(({index,label})=>{
          const sid = byLabel.get(String(label).trim().toLowerCase());
          if (sid) map.set(index, sid);
        });
      }

      // 2) fallback: consultar sites por nome
      const missing = labels.filter(l => !map.has(l.index));
      if (missing.length){
        const names = Array.from(new Set(missing.map(x => x.label)));
        const { data, error } = await sb.from('sites').select('id, nome').in('nome', names);
        if (!error && Array.isArray(data)){
          const byName = new Map(data.map(r => [String(r.nome||'').trim().toLowerCase(), Number(r.id)]));
          missing.forEach(({index, label})=>{
            const sid = byName.get(String(label).trim().toLowerCase());
            if (sid) map.set(index, sid);
          });
        }
      }

      return map;
    }

    function getRowEan(tr){
      let td = tr.querySelector('.col-sku');
      if (td && td.textContent.trim()) return td.textContent.trim();
      for (const c of Array.from(tr.cells)){
        const txt = (c.textContent||'').trim();
        if ((txt.replace(/\D+/g,'').length)>=8) return txt;
      }
      return null;
    }

    function isNaCell(td){
      const txt = (td.textContent||'').replace(/\s+/g,'').trim();
      return /^-+$/.test(txt); // aceita '---' e variações de número de hifens
    }

    async function attachContextForTable(table){
      const siteMap = await buildSiteColumnMap(table);
      const tbody = table.querySelector('tbody');
      if(!tbody) return;

      tbody.addEventListener('contextmenu', async function(ev){
        const td = ev.target.closest('td');
        const tr = ev.target.closest('tr');
        if (!td || !tr) return;

        const colIndex = Array.prototype.indexOf.call(tr.children, td);
        const site_id = siteMap.get(colIndex);
        if (!site_id) return; // só nas colunas de site

        if (!isNaCell(td)) return; // apenas quando está '---'

        ev.preventDefault();
        try{
          const ean = getRowEan(tr);
          if (!ean){ alert('EAN não identificado na linha.'); return; }

          const url = null; /* prompt removido */ //`Cole a URL da página do produto para o site ${site_id} (EAN ${ean}):`, '');
          if (!url) return;
          try{ const u=new URL(url); if (!/^https?:$/.test(u.protocol)) throw 0; }catch(_){ alert('URL inválida. Use http(s)://'); return; }

          await upsertProdutoSiteLink(ean, site_id, url);
          td.classList.add('mm-na-hint');
          td.title = 'Link salvo para este site';
          alert('Link salvo com sucesso!');

        }catch(ex){
          alert('Não foi possível salvar o link: ' + (ex && ex.message ? ex.message : String(ex)));
        }
      }, { passive:false });
    }

    // Inicializa quando a página estiver pronta e a tabela renderizada
    function whenTableReady(id, cb){
      const el = document.getElementById(id);
      if (el && el.querySelector('thead th')) { cb(el); return; }
      const obs = new MutationObserver(()=>{
        const el2 = document.getElementById(id);
        if (el2 && el2.querySelector('thead th')) { obs.disconnect(); cb(el2); }
      });
      obs.observe(document.documentElement, { childList: true, subtree: true });
      setTimeout(()=>obs.disconnect(), 10000);
    }

    whenTableReady('produtosTable', attachContextForTable);
    whenTableReady('favTable', attachContextForTable);

  }catch(err){
    console.warn('[MM] contexto salvar link - erro de inicialização:', err);
  }
})();
</script>
<!-- ===== Fim do bloco de contexto ===== -->
</body>
</html>

<!-- ===== MaiorMargem: bloco de contexto para salvar link direto por site (fallback sem EAN) ===== -->
<style>
  .mm-na-hint { border-bottom: 1px dotted #6b6b6b; cursor: context-menu; }
  .mm-inline-link { display:flex; gap:8px; align-items:center; }
  .mm-popover{ position:fixed; z-index:9999; width:min(360px, calc(100vw - 24px)); background:#111; color:#eee; border:1px solid #2a2a2a; border-radius:12px; box-shadow:0 8px 30px rgba(0,0,0,.45); padding:12px; backdrop-filter:blur(6px); overflow:hidden; }
  .mm-pop-header{ display:flex; align-items:center; justify-content:space-between; margin-bottom:6px; }
  .mm-pop-header strong{ font-weight:600; }
  .mm-pop-close{ background:transparent; border:0; color:#aaa; font-size:18px; line-height:1; cursor:pointer; }
  .mm-pop-body{ display:flex; flex-direction:column; gap:8px; max-width:100%; }
  .mm-pop-row{ display:flex; gap:6px; align-items:center; font-size:12px; opacity:.9; }
  .mm-pop-row span{ color:#bbb; }
  .mm-pop-row em{ font-style:normal; color:#fff; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:240px; }
  .mm-pop-input{width:100%; box-sizing:border-box; padding:10px 12px; border-radius:10px; border:1px solid #4a4a4a; background:#1b1b1b; color:#f2f2f2; outline:none;}
  .mm-pop-input:focus{ border-color:#8ab4ff; box-shadow:0 0 0 3px rgba(138,180,255,.22); background:#202020; }
  .mm-pop-actions{ display:flex; gap:8px; justify-content:flex-end; margin-top:2px; }
  .mm-pop-actions button{
    padding:8px 12px; border-radius:10px; border:1px solid #2a2a2a; cursor:pointer; background:#1a1a1a; color:#eee;
  }
  .mm-pop-actions .mm-pop-save{ background:#2a63ff; border-color:#2a63ff; color:#fff; }
  .mm-pop-toast{
    position:fixed; bottom:20px; left:50%; transform:translateX(-50%);
    background:#0d4b1f; color:#e6ffe6; padding:10px 16px; border-radius:999px; box-shadow:0 6px 18px rgba(0,0,0,.35);
    z-index:10000; font-weight:600;
  }
</style>
<script>
(function(){
  try{
    // Cliente Supabase
    var sb = (typeof window.sb !== 'undefined' && window.sb) ? window.sb : null;
    if (!sb && typeof supabase !== 'undefined' && window.CONFIG){
      sb = supabase.createClient(window.CONFIG.SUPABASE_URL, window.CONFIG.SUPABASE_ANON_KEY, { auth: { persistSession: true } });
      window.sb = sb;
    }
    if (!sb){ console.warn('[MM] Supabase client não encontrado.'); return; }

    var VIEW = (typeof window.VIEW === 'string' && window.VIEW) ? window.VIEW : 'vw_precos_dinamica';

    function normalizeEanDigits(e){ return String(e||'').replace(/\D+/g,''); }

    async function resolveProdutoIdByEan(ean){
      try{
        const raw = String(ean||'').trim();
        const norm = normalizeEanDigits(raw);

        // 1) ean1 / ean_norm exatos
        let { data, error } = await sb.from('cadastro_produtos')
          .select('id_produto, ean1, ean_norm')
          .or('ean1.eq.'+raw+',ean_norm.eq.'+norm)
          .limit(1);
        if (!error && data && data[0] && data[0].id_produto) return data[0].id_produto;

        // 2) like
        ({ data, error } = await sb.from('cadastro_produtos')
          .select('id_produto, ean1, ean_norm')
          .or('ean1.ilike.%'+raw+'%,ean_norm.ilike.%'+norm+'%')
          .limit(1));
        if (!error && data && data[0] && data[0].id_produto) return data[0].id_produto;

        // 3) tira zeros à esquerda
        const normNoZeros = norm.replace(/^0+/, '');
        if (normNoZeros && normNoZeros !== norm){
          ({ data, error } = await sb.from('cadastro_produtos')
            .select('id_produto, ean1, ean_norm')
            .or('ean1.eq.'+normNoZeros+',ean_norm.eq.'+normNoZeros)
            .limit(1));
          if (!error && data && data[0] && data[0].id_produto) return data[0].id_produto;
        }

        // 4) fallback via view (se expuser id_produto)
        try{
          const vr = await sb.from(VIEW).select('id_produto').eq('ean', raw).limit(1);
          if (!vr.error && vr.data && vr.data[0] && vr.data[0].id_produto) return vr.data[0].id_produto;
        }catch(_){}

        return null;
      }catch(ex){
        console.warn('[MM] resolveProdutoIdByEan ex:', ex);
        return null;
      }
    }

    async function upsertProdutoSiteLink(ean, site_id, site_nome, url, descricao_produto, id_no_site){
      const id_produto = await resolveProdutoIdByEan(ean);
      if (!id_produto){
        throw new Error('Produto não encontrado em cadastro_produtos para o EAN '+ean);
      }
      const payload = {
        id_produto: Number(id_produto),
        site_id: Number(site_id),
        site_nome: String(site_nome || ''),
        url: String(url),
        descricao_produto: String(descricao_produto || ''),
        id_no_site: (id_no_site == null ? null : String(id_no_site))
      };
      const { error } = await sb.from('links_produto_site')
        .upsert(payload, { onConflict: 'id_produto,site_id' });
      if (error) throw new Error(error.message || 'Falha ao salvar link');
    }

    function collectSiteHeaderLabels(table){
      const thead = table.querySelector('thead');
      if (!thead) return [];
      const ths = Array.from(thead.querySelectorAll('th'));
      const labels = [];
      ths.forEach((th, idx)=>{
        const txt = (th.textContent||'').trim();
        if (!txt) return;
        const lower = txt.toLowerCase();
        if (idx===0) return;
        if (['ean','descrição','descricao','meu preço','meu preco'].includes(lower)) return;
        labels.push({ index: idx, label: txt });
      });
      return labels;
    }

    async function buildSiteColumnMap(table){
      const labels = collectSiteHeaderLabels(table);
      const idMap = new Map();
      const nameMap = new Map();

      if (!labels.length) return { idMap, nameMap };

      if (typeof chosen !== 'undefined' && Array.isArray(chosen)){
        const byLabel = new Map();
        chosen.forEach(c=>{ byLabel.set(String(c.label||'').trim().toLowerCase(), { id:Number(c.site_id), nome:String(c.label||'') }); });
        labels.forEach(({index,label})=>{
          const info = byLabel.get(String(label).trim().toLowerCase());
          if (info) { idMap.set(index, info.id); nameMap.set(index, info.nome); }
        });
      }

      const missing = labels.filter(l => !idMap.has(l.index));
      if (missing.length){
        const names = Array.from(new Set(missing.map(x => x.label)));
        const { data, error } = await sb.from('sites').select('id, nome').in('nome', names);
        if (!error && Array.isArray(data)){
          const byName = new Map(data.map(r => [String(r.nome||'').trim().toLowerCase(), { id:Number(r.id), nome:String(r.nome||'') }]));
          missing.forEach(({index, label})=>{
            const info = byName.get(String(label).trim().toLowerCase());
            if (info) { idMap.set(index, info.id); nameMap.set(index, info.nome); }
          });
        }
      }

      return { idMap, nameMap };
    }

    function getRowEan(tr){
      let td = tr.querySelector('.col-sku');
      if (td && td.textContent.trim()) return td.textContent.trim();
      for (const c of Array.from(tr.cells)){
        const txt = (c.textContent||'').trim();
        if ((txt.replace(/\D+/g,'').length)>=8) return txt;
      }
      return null;
    }

    function getRowDesc(tr){
      const td = tr.querySelector('.col-desc');
      if (td) return (td.textContent || '').trim();
      return '';
    }

    function isNaCell(td){
      const txt = (td.textContent||'').replace(/\s+/g,'').trim();
      return /^-+$/.test(txt);
    }

    async function attachContextForTable(table){
      const maps = await buildSiteColumnMap(table);
      const siteIdByCol = maps.idMap;
      const siteNameByCol = maps.nameMap;

      const tbody = table.querySelector('tbody');
      if(!tbody) return;

      tbody.addEventListener('contextmenu', async function(ev){
        const td = ev.target.closest('td');
        const tr = ev.target.closest('tr');
        if (!td || !tr) return;

        const colIndex = Array.prototype.indexOf.call(tr.children, td);
        const site_id = siteIdByCol.get(colIndex);
        const site_nome = siteNameByCol.get(colIndex) || ('Site '+(site_id||''));
        if (!site_id) return;
        if (!isNaCell(td)) return;

        ev.preventDefault();
        try{
          const ean = getRowEan(tr);
          if (!ean){ alert('EAN não identificado na linha.'); return; }
          const descricao_produto = getRowDesc(tr);

          // === Popover flutuante para inserir URL e Código no site ===
          const pop = document.createElement('div');
          pop.className = 'mm-popover';
          pop.innerHTML = `
            <div class="mm-pop-header">
              <strong>${site_nome}</strong>
              <button type="button" class="mm-pop-close" aria-label="Fechar">×</button>
            </div>
            <div class="mm-pop-body">
              <div class="mm-pop-row"><span>Produto:</span><em>${(descricao_produto||'').replace(/`/g,'')}</em></div>
              <div class="mm-pop-row"><span>EAN:</span><code>${ean||''}</code></div>
              <input id="mmUrlInput" class="mm-pop-input" type="url" placeholder="https://exemplo.com/produto" autocomplete="off" />
              <input id="mmIdNoSite" class="mm-pop-input" type="text" placeholder="Código do produto no site (opcional)" autocomplete="off" />
              <div class="mm-pop-actions">
                <button type="button" class="mm-pop-save">Salvar</button>
                <button type="button" class="mm-pop-cancel">Cancelar</button>
              </div>
            </div>`;
          document.body.appendChild(pop);

(async ()=>{
  try{
    const inputEl = pop.querySelector('#mmUrlInput');
    const idNoSiteEl = pop.querySelector('#mmIdNoSite');
    const id_produto = await resolveProdutoIdByEan(ean);
    if (id_produto){
      const { data, error } = await sb
        .from('links_produto_site')
        .select('url, id_no_site')
        .eq('id_produto', Number(id_produto))
        .eq('site_id', Number(site_id))
        .maybeSingle();
      if (!error && data){
        if (data.url && inputEl) inputEl.value = data.url;
        if (data.id_no_site && idNoSiteEl) idNoSiteEl.value = data.id_no_site;
      }
    }
  }catch(e){ console.warn('[MM] prefill link existente falhou:', e); }
})();

          
          
          const x = (ev.clientX || 0) + 8;
          const y = (ev.clientY || 0) + 8;
          pop.style.left = x + 'px';
pop.style.top  = y + 'px';
// Clamp to viewport (avoid overflow right/bottom and horizontal page shift)
requestAnimationFrame(()=>{
  const rect = pop.getBoundingClientRect();
  const vw = window.innerWidth, vh = window.innerHeight;
  let left = rect.left;
  let top  = rect.top;

  // Corrige horizontal: encosta se passar da direita/esquerda
  if (rect.right > vw - 8) left = Math.max(8, vw - rect.width - 8);
  if (left < 8) left = 8;

  // Corrige vertical com flip para cima se exceder a borda inferior
  if (rect.bottom > vh - 8) {
    const above = (ev.clientY || 0) - rect.height - 8;
    top = Math.max(8, above);
  } else {
    top = Math.max(8, top);
  }

  // Como .mm-popover é position:fixed, usamos coordenadas de viewport (sem scroll)
  pop.style.left = left + 'px';
  pop.style.top  = top  + 'px';
});

          const inputEl = pop.querySelector('#mmUrlInput');
          const idNoSiteEl = pop.querySelector('#mmIdNoSite');
          const btnSave = pop.querySelector('.mm-pop-save');
          const btnCancel = pop.querySelector('.mm-pop-cancel');
          const btnClose = pop.querySelector('.mm-pop-close');

          function closePop(){
            document.removeEventListener('keydown', onKey);
            if (pop && pop.parentNode) pop.parentNode.removeChild(pop);
            
            
          }
          function onKey(e){
            if (e.key === 'Escape'){ closePop(); }
            if (e.key === 'Enter'){ btnSave.click(); }
          }
          
try{ if (window.__mmActivePopover && window.__mmActivePopover.parentNode) { window.__mmActivePopover.parentNode.removeChild(window.__mmActivePopover); } }catch(_){}
window.__mmActivePopover = pop;
document.addEventListener('keydown', onKey);
const outsideClose = (e)=>{ if (pop && !pop.contains(e.target)) closePop(); };
setTimeout(()=>document.addEventListener('mousedown', outsideClose), 0);


          btnCancel.addEventListener('click', closePop);
          btnClose.addEventListener('click', closePop);

          
btnSave.addEventListener('click', async function(){
  const inputEl = pop.querySelector('#mmUrlInput');
  const idNoSiteEl = pop.querySelector('#mmIdNoSite');
  let url = (inputEl && inputEl.value || '').trim();
  const idNoSiteRaw = (idNoSiteEl && idNoSiteEl.value ? idNoSiteEl.value.trim() : '');
  const hasUrl = url.length > 0;
  const hasId  = idNoSiteRaw.length > 0;

  if (!hasUrl && !hasId){
    inputEl.setCustomValidity('Informe a URL ou o código do produto no site.');
    inputEl.reportValidity();
    setTimeout(()=>inputEl.setCustomValidity(''), 1200);
    inputEl.focus();
    return;
  }
  if (hasUrl){
    try{
      const u = new URL(url);
      if (!/^https?:$/.test(u.protocol)) throw 0;
    }catch(_){
      inputEl.focus();
      inputEl.select();
      inputEl.setCustomValidity('Informe uma URL válida iniciando com http:// ou https://');
      inputEl.reportValidity();
      setTimeout(()=>inputEl.setCustomValidity(''), 1200);
      return;
    }
  } else {
    url = null;
  }

  const idNoSite = hasId ? idNoSiteRaw : null;

  try{
    await upsertProdutoSiteLink(ean, site_id, url, idNoSite);
    td.classList.add('mm-na-hint');
    td.title = 'Link salvo para este site';
    closePop();
    const ok = document.createElement('div');
    ok.className = 'mm-pop-toast';
    ok.textContent = 'Link salvo!';
    document.body.appendChild(ok);
    setTimeout(()=>{ if (ok.parentNode) ok.parentNode.removeChild(ok); }, 1600);
  }catch(ex){
    closePop();
    alert('Não foi possível salvar o link: ' + (ex && ex.message ? ex.message : String(ex)));
  }
});


          inputEl.focus();
        }catch(ex){
          alert('Não foi possível salvar o link: ' + (ex && ex.message ? ex.message : String(ex)));
        }
      }, { passive:false });
    }

    function whenTableReady(id, cb){
      const el = document.getElementById(id);
      if (el && el.querySelector('thead th')) { cb(el); return; }
      const obs = new MutationObserver(()=>{
        const el2 = document.getElementById(id);
        if (el2 && el2.querySelector('thead th')) { obs.disconnect(); cb(el2); }
      });
      obs.observe(document.documentElement, { childList: true, subtree: true });
      setTimeout(()=>obs.disconnect(), 10000);
    }

    whenTableReady('produtosTable', attachContextForTable);
    whenTableReady('favTable', attachContextForTable);

  }catch(err){
    console.warn('[MM] contexto salvar link - erro de inicialização:', err);
  }
})();
</script>
<!-- ===== Fim do bloco de contexto ===== -->
