<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MaiorMargem - Tabela de Produtos</title>
<style>
  :root { color-scheme: dark; }
  body { margin:0; font-family: Arial, sans-serif; background-color:#121212; color:white; padding:20px; }
  header { display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; gap:12px; flex-wrap:wrap; }
  h1 { color:#00b140; margin:0; }

  .userbox { display:flex; gap:12px; align-items:center; position: relative; }
  .chip { font-size:12px; background:#1e1e1e; border:1px solid #333; padding:6px 10px; border-radius:999px; cursor:default; }
  .chip.plan { color:#bfffc1; border-color:#2f5a2f; background:#132313; }
  .btn { background:#00b140; color:#fff; border:none; padding:8px 14px; border-radius:6px; cursor:pointer; }
  .btn:hover { background:#009b38; }

  /* Dropdown do usuário */
  .userChipWrap { position: relative; display:inline-block; }
  .dropdown {
    position: absolute;
    right: 0;
    top: calc(100% + 6px);
    display: none;
    min-width: 180px;
    padding: 6px;
    background: #0f0f0f;
    border: 1px solid #2a2a2a;
    border-radius: 10px;
    box-shadow: 0 10px 30px rgba(0,0,0,.5);
    z-index: 50;
  }
  .userChipWrap:hover .dropdown,
  .userChipWrap.open .dropdown { display: block; }
  .dd-item {
    width: 100%;
    background: transparent;
    border: none;
    color: #eee;
    text-align: left;
    padding: 10px 12px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
  }
  .dd-item:hover { background: #1b1b1b; }

  .panel { background:#0f0f0f; border:1px solid #2a2a2a; border-radius:12px; padding:12px; margin-bottom:18px; }
  .panel-header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px; }
  .panel-header h2 { margin:0; font-size:18px; color:#d5ffd5; }
  .toggle-btn { background:none; border:1px solid #2a2a2a; color:#ddd; padding:6px 10px; border-radius:8px; cursor:pointer; }
  .toggle-btn:hover { background:#1b1b1b; }

  .filters { display:grid; grid-template-columns: 1fr 1fr auto; gap:12px; margin:16px 0; }
  .filters input { padding:10px 12px; border-radius:6px; border:1px solid #333; background-color:#1e1e1e; color:white; }
  .status { margin:10px 0; color:#aaa; font-size:12px; }
  .err { display:none; color:#ff5d5d; margin:8px 0; font-size:13px; }

  .wrap { overflow:auto; border:1px solid #2a2a2a; border-radius:10px; }
  #generalWrap { height: 55vh; }

  table { width:100%; border-collapse: collapse; }
  thead th { position:sticky; top:0; background:#0f0f0f; z-index:1; }
  th, td { border-bottom:1px solid #2a2a2a; padding:10px; text-align:left; font-size:14px; vertical-align:top; }
  tbody tr:hover { background:#1a1a1a; }

  .col-fav { width:40px; text-align:center; }
  .col-sku { width:160px; font-family: ui-monospace,Consolas,monospace; }
  .col-desc { min-width:260px; }
  .price { font-weight:700; display:block; font-size:16px; }
  @media (min-width: 1200px) { .price { font-size:18px; } }
  .price.min { color:#ff4d4f; }
  .price.max { color:#00d084; }
  .muted { display:none; }
  .end-marker { text-align:center; padding:10px; color:#9aa0a6; }

  .counts { margin-top:10px; font-size:12px; color:#9aa0a6; display:flex; gap:12px; flex-wrap:wrap; }

  .panel.collapsed .wrap { display:none; }
  .panel.collapsed .counts { display:none; }
  .panel.collapsed .resizer { display:none; }

  .resizer {
    height: 10px; margin-top: 6px; border: 1px solid #2a2a2a; border-radius: 8px;
    cursor: ns-resize; background: linear-gradient(180deg, #1c1c1c, #111);
    display:flex; align-items:center; justify-content:center;
  }
  .resizer:after { content: ""; width: 40px; height: 3px; border-radius: 3px; background: #3a3a3a; }
  body.resizing, body.resizing * { cursor: ns-resize !important; user-select: none; }
</style>
<script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<script src="./config.js"></script>
</head>
<body>
<header>
  <h1>MaiorMargem — Dashboard</h1>
  <div class="userbox">
    <span id="planChip" class="chip plan" title="Plano atual">Plano: —</span>
    <div class="userChipWrap">
      <span id="userChip" class="chip">Usuário</span>
      <div id="userDropdown" class="dropdown" role="menu" aria-hidden="true">
        <button class="dd-item" id="ddMeusDados">Meus dados</button>
        <button class="dd-item" id="ddPlanos">Planos</button>
      </div>
    </div>
    <button id="btnSair" class="btn">Sair</button>
  </div>
</header>

<div class="panel">
  <div class="filters">
    <input id="eanFilter" placeholder="Filtrar por EAN/GTIN…" />
    <input id="descFilter" placeholder="Filtrar por descrição…" />
    <button id="btnReload" class="btn">Recarregar</button>
  </div>
  <div class="status"><span id="status"></span></div>
  <div id="err" class="err"></div>
</div>

<section id="favPanel" class="panel">
  <div class="panel-header">
    <h2>Favoritos</h2>
    <button id="toggleFav" class="toggle-btn" aria-expanded="true">Minimizar</button>
  </div>
  <div id="favWrap" class="wrap">
    <table id="favTable">
      <thead>
        <tr>
          <th class="col-fav">Ação</th>
          <th class="col-sku">EAN</th>
          <th class="col-desc">Descrição</th>
          <th>LeroyMerlin</th>
          <th>QueroQuero</th>
          <th>Cassol</th>
          <th>RedeMac</th>
          <th>MestreTinho</th>
          <th>Tumelero</th>
          <th>Supremeinox</th>
          <th>Ghaus</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <div id="favResizer" class="resizer" title="Arraste para redimensionar. Duplo clique: voltar ao auto."></div>
</section>

<section id="generalPanel" class="panel">
  <div class="panel-header">
    <h2>Geral</h2>
    <button id="toggleGen" class="toggle-btn" aria-expanded="true">Minimizar</button>
  </div>
  <div id="generalWrap" class="wrap">
    <table id="produtosTable">
      <thead>
        <tr>
          <th class="col-fav">★</th>
          <th class="col-sku">EAN</th>
          <th class="col-desc">Descrição</th>
          <th>LeroyMerlin</th>
          <th>QueroQuero</th>
          <th>Cassol</th>
          <th>RedeMac</th>
          <th>MestreTinho</th>
          <th>Tumelero</th>
          <th>Supremeinox</th>
          <th>Ghaus</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div id="endMarker" class="end-marker"></div>
  </div>
  <div class="counts">
    <span id="countShown"></span>
    <span id="countTotal"></span>
    <span id="countFavs"></span>
  </div>
</section>

<script>
/* ======== CONFIG / SUPABASE ======== */
const CFG = window.CONFIG || {};
const SUPABASE_URL = CFG.SUPABASE_URL;
const SUPABASE_ANON_KEY = CFG.SUPABASE_ANON_KEY;
if (!SUPABASE_URL || !SUPABASE_ANON_KEY) { alert("Erro de configuração: config.js não carregado."); throw new Error("CONFIG ausente"); }
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true } });

/* ======== CONSTANTES ======== */
const MAX_SESSION_MS = 2 * 60 * 60 * 1000;
const VIEW = "vw_precos_com_desc";

/* Paginação no servidor e chunk de renderização */
const PAGE_SIZE = 200;       // consulta por página no servidor
const RENDER_CHUNK = 60;     // quantidade por “lote” de render no DOM

/* ======== ELEMENTOS ======== */
const statusEl = document.getElementById('status');
const errEl = document.getElementById('err');
const userChip = document.getElementById('userChip');
const planChip = document.getElementById('planChip');
const userChipWrap = document.querySelector('.userChipWrap');
const ddMeusDados = document.getElementById('ddMeusDados');
const ddPlanos = document.getElementById('ddPlanos');
const btnSair = document.getElementById('btnSair');
const btnReload = document.getElementById('btnReload');

const eanFilter = document.getElementById('eanFilter');
const descFilter = document.getElementById('descFilter');

const favPanel = document.getElementById('favPanel');
const toggleFavBtn = document.getElementById('toggleFav');
const favWrap = document.getElementById('favWrap');
const favBody = document.querySelector('#favTable tbody');
const favResizer = document.getElementById('favResizer');

const generalPanel = document.getElementById('generalPanel');
const toggleGenBtn = document.getElementById('toggleGen');
const generalWrap = document.getElementById('generalWrap');
const generalBody = document.querySelector('#produtosTable tbody');
const endMarker = document.getElementById('endMarker');

const countShown = document.getElementById('countShown');
const countTotal = document.getElementById('countTotal');
const countFavs  = document.getElementById('countFavs');

/* ======== ESTADO ======== */
const siteMap = {
  "PrecoLeroyMerlin": "LeroyMerlin",
  "PrecoQueroQuero": "QueroQuero",
  "PrecoCassol": "Cassol",
  "PrecoRedeMac": "RedeMac",
  "PrecoMestreTinho": "MestreTinho",
  "PrecoTumelero": "Tumelero",
  "PrecoSupremeinox": "Supremeinox",
  "PrecoGhaus": "Ghaus"
};
const siteOrder = Object.values(siteMap);

let favSet = new Set(JSON.parse(localStorage.getItem('mm_favs') || '[]'));

/* Produtos agregados: Map<ean, { sku, desc, sites{} }> */
let produtosMap = new Map();
/* Lista para render ordenada por EAN (ou chegada) */
let produtosList = [];
/* Posição de render no DOM */
let itemsRendered = 0;

/* Paginação servidor */
let serverOffset = 0;
let serverExhausted = false;
let fetching = false;

/* Filtros atuais (servidor) */
let currentEanQ = '';
let currentDescQ = '';

/* Controle render */
let loadingMore = false;
let suppressGeneralChange = false;
const generalChkMap = new Map();

/* ======== FUNÇÕES UTIL ======== */
function setStatus(t){ statusEl.textContent = t || ''; }
function showErr(e){ errEl.style.display='block'; errEl.textContent = String(e||'').trim(); }
function hideErr(){ errEl.style.display='none'; errEl.textContent=''; }
function formatBRL(n){ try { return n.toLocaleString('pt-BR', { style:'currency', currency:'BRL' }); } catch { return String(n); } }
function favSave(){ localStorage.setItem('mm_favs', JSON.stringify([...favSet])); }
function isFav(sku){ return favSet.has(String(sku)); }
function computeMinMaxForRow(item){
  let min = { site:null, val: Infinity };
  let max = { site:null, val: -Infinity };
  for (const s of siteOrder) {
    const d = item.sites[s];
    if (!d || !Number.isFinite(d.precoNum)) continue;
    const n = d.precoNum;
    if (n < min.val) { min = { site:s, val:n }; }
    if (n > max.val) { max = { site:s, val:n }; }
  }
  return { minSite: min.site, maxSite: max.site };
}
function debounce(fn, delay=500){
  let t;
  return (...args)=>{
    clearTimeout(t);
    t = setTimeout(()=>fn(...args), delay);
  };
}

/* ======== HEADER / SESSÃO ======== */
function enforceMaxSession(){
  const key = 'mm_login_start';
  const now = Date.now();
  let start = Number(localStorage.getItem(key));
  if (!Number.isFinite(start) || start <= 0) { localStorage.setItem(key, String(now)); start = now; }
  async function check(){
    const s = Number(localStorage.getItem(key));
    const age = Date.now() - (Number.isFinite(s) ? s : now);
    if (age > MAX_SESSION_MS) { await sb.auth.signOut(); localStorage.removeItem(key); window.location.href = CFG.SITE_URL || 'index.html'; }
  }
  setInterval(check, 60 * 1000);
  document.addEventListener('visibilitychange', () => { if (!document.hidden) check(); });
  sb.auth.onAuthStateChange((event) => { if (event === 'SIGNED_IN') localStorage.setItem(key, String(Date.now())); if (event === 'SIGNED_OUT') localStorage.removeItem(key); });
}
ddMeusDados.addEventListener('click', () => { window.location.href = 'meusdados.html'; });
ddPlanos.addEventListener('click', () => { window.location.href = 'planos.html'; });
userChip.addEventListener('click', (e) => { e.stopPropagation(); userChipWrap.classList.toggle('open'); });
document.addEventListener('click', (e) => { if (!userChipWrap.contains(e.target)) userChipWrap.classList.remove('open'); });
document.addEventListener('keydown', (e) => { if (e.key === 'Escape') userChipWrap.classList.remove('open'); });

/* ======== FAV HEIGHT / RESIZER ======== */
function measureRowHeight(){
  const row = document.querySelector('#favTable tbody tr');
  if (!row) return 44;
  const h = Math.round(row.getBoundingClientRect().height);
  return Math.max(36, h || 44);
}
function measureHeadHeight(){
  const head = document.querySelector('#favTable thead');
  if (!head) return 40;
  const h = Math.round(head.getBoundingClientRect().height);
  return Math.max(32, h || 40);
}
let favHeightUser = Number(localStorage.getItem('mm_fav_height')) || null;
function applyFavHeight(px){
  if (!px || !Number.isFinite(px)) return;
  const maxPx = Math.round(window.innerHeight * 0.85);
  const clamped = Math.max(120, Math.min(px, maxPx));
  favWrap.style.height = clamped + 'px';
}
function updateFavHeight(){
  if (favHeightUser) { applyFavHeight(favHeightUser); return; }
  const rowsLen = favBody.children.length;
  const rows = Math.min(rowsLen, 20);
  const rowH = measureRowHeight();
  const headH = measureHeadHeight();
  const pad = 8;
  const target = headH + rows * rowH + pad;
  applyFavHeight(target);
}
(function initResizer(){
  let startY = 0, startH = 0;
  function onMove(ev){
    const dy = ev.clientY - startY;
    favHeightUser = startH + dy;
    localStorage.setItem('mm_fav_height', String(favHeightUser));
    applyFavHeight(favHeightUser);
  }
  function stop(){
    document.removeEventListener('mousemove', onMove);
    document.removeEventListener('mouseup', stop);
    document.body.classList.remove('resizing');
  }
  favResizer.addEventListener('mousedown', (ev)=>{
    startY = ev.clientY;
    startH = favWrap.offsetHeight;
    document.body.classList.add('resizing');
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', stop);
  });
  favResizer.addEventListener('dblclick', ()=>{
    favHeightUser = null;
    localStorage.removeItem('mm_fav_height');
    updateFavHeight();
  });
})();

/* ======== AGREGAÇÃO ======== */
function upsertRowsIntoProdutos(rows){
  for (const row of rows){
    const ean = String(row.ean ?? '');
    const site = String(row.site ?? '');
    const precoRaw = row.preco;
    const precoNum = row.preco_num;
    const dt = row.data;
    const desc = row.descricao || '';

    if (!produtosMap.has(ean)) {
      produtosMap.set(ean, { sku: ean, desc: desc, sites: {} });
    }
    const item = produtosMap.get(ean);
    if (!item.desc && desc) item.desc = desc;

    const htmlSiteName = siteMap[site];
    if (htmlSiteName) {
      const prev = item.sites[htmlSiteName];
      if (!prev || new Date(dt) > new Date(prev.data)) {
        item.sites[htmlSiteName] = { precoRaw, precoNum, data: dt };
      }
    }
  }
  // Atualiza lista ordenável (mantém ordem de inserção)
  produtosList = Array.from(produtosMap.values());
}

/* ======== RENDER ======== */
function renderGeneralChunk(){
  const end = Math.min(itemsRendered + RENDER_CHUNK, produtosList.length);
  const frag = document.createDocumentFragment();

  for (let i = itemsRendered; i < end; i++){
    const item = produtosList[i];
    const tr = document.createElement('tr');

    // Fav
    const tdFav = document.createElement('td');
    tdFav.className = 'col-fav';
    const chk = document.createElement('input');
    chk.type = 'checkbox';
    chk.checked = isFav(item.sku);
    chk.title = 'Marcar como favorito';
    chk.addEventListener('change', () => {
      if (suppressGeneralChange) return;
      if (chk.checked) favSet.add(item.sku); else favSet.delete(item.sku);
      favSave();
      renderFavs();
      updateFavHeight();
      updateCounts();
    });
    tdFav.appendChild(chk);
    tr.appendChild(tdFav);
    generalChkMap.set(item.sku, chk);

    // EAN
    const tdSku = document.createElement('td');
    tdSku.className = 'col-sku';
    tdSku.textContent = item.sku;
    tr.appendChild(tdSku);

    // Descrição
    const tdDesc = document.createElement('td');
    tdDesc.className = 'col-desc';
    tdDesc.innerHTML = (item.desc || '').replace(/</g,'&lt;');
    tr.appendChild(tdDesc);

    // Preços
    const { minSite, maxSite } = computeMinMaxForRow(item);
    for (const s of siteOrder) {
      const td = document.createElement('td');
      const d = item.sites[s];
      if (d) {
        const dataStr = d.data ? new Date(d.data).toLocaleString('pt-BR') : '';
        if (Number.isFinite(d.precoNum)) {
          const display = formatBRL(d.precoNum);
          const cls = (s === minSite) ? 'min' : (s === maxSite ? 'max' : '');
          td.innerHTML = `<span class="price ${cls}" title="Atualizado em ${dataStr}">${display}</span>`;
        } else {
          const raw = (d.precoRaw ?? '').toString().replace(/</g,'&lt;');
          td.innerHTML = `<span class="price" title="${dataStr ? 'Atualizado em ' + dataStr : ''}">${raw}</span>`;
        }
      } else {
        td.innerHTML = `<span class="muted">—</span>`;
      }
      tr.appendChild(td);
    }

    frag.appendChild(tr);
  }

  generalBody.appendChild(frag);
  itemsRendered = end;

  endMarker.textContent = (serverExhausted && itemsRendered >= produtosList.length)
    ? 'Fim da lista'
    : '';
  updateCounts();
}
function resetGeneralDom(){
  generalBody.innerHTML = '';
  generalChkMap.clear();
  itemsRendered = 0;
  endMarker.textContent = '';
}
function onGeneralScroll(){
  if (loadingMore) return;

  const nearBottom = generalWrap.scrollTop + generalWrap.clientHeight >= generalWrap.scrollHeight - 100;

  // Primeiro: render pendências do que já temos na memória
  if (nearBottom && itemsRendered < produtosList.length){
    loadingMore = true;
    setTimeout(()=>{ renderGeneralChunk(); loadingMore = false; }, 30);
    return;
  }

  // Se já renderizou tudo que tem e ainda há servidor a consultar, busca próxima página
  if (nearBottom && !serverExhausted && !fetching){
    fetchNextPage();
  }
}
generalWrap.addEventListener('scroll', onGeneralScroll);

/* ======== FAVORITOS ======== */
function renderFavs(){
  favBody.innerHTML = '';
  const favList = produtosList.filter(p => isFav(p.sku));
  const frag = document.createDocumentFragment();

  for (const item of favList){
    const tr = document.createElement('tr');

    const tdAct = document.createElement('td');
    tdAct.className = 'col-fav';
    const btn = document.createElement('button');
    btn.className = 'trash-btn';
    btn.title = 'Remover dos favoritos';
    btn.innerHTML = `
      <svg class="trash-icon" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" width="16" height="16">
        <path d="M9 3h6a1 1 0 0 1 1 1v1h4v2h-1l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 7H4V5h4V4a1 1 0 0 1 1-1zm2 0v1h2V3h-2zM7 7l1 14h8l1-14H7z"></path>
      </svg>`;
    btn.addEventListener('click', () => {
      favSet.delete(item.sku);
      favSave();
      const chk = generalChkMap.get(item.sku);
      if (chk) {
        suppressGeneralChange = true;
        chk.checked = false;
        suppressGeneralChange = false;
      }
      renderFavs();
      updateFavHeight();
      updateCounts();
    });
    tdAct.appendChild(btn);
    tr.appendChild(tdAct);

    const tdSku = document.createElement('td');
    tdSku.className = 'col-sku';
    tdSku.textContent = item.sku;
    tr.appendChild(tdSku);

    const tdDesc = document.createElement('td');
    tdDesc.className = 'col-desc';
    tdDesc.innerHTML = (item.desc || '').replace(/</g,'&lt;');
    tr.appendChild(tdDesc);

    const { minSite, maxSite } = computeMinMaxForRow(item);
    for (const s of siteOrder) {
      const td = document.createElement('td');
      const d = item.sites[s];
      if (d) {
        const dataStr = d.data ? new Date(d.data).toLocaleString('pt-BR') : '';
        if (Number.isFinite(d.precoNum)) {
          const display = formatBRL(d.precoNum);
          const cls = (s === minSite) ? 'min' : (s === maxSite ? 'max' : '');
          td.innerHTML = `<span class="price ${cls}" title="Atualizado em ${dataStr}">${display}</span>`;
        } else {
          const raw = (d.precoRaw ?? '').toString().replace(/</g,'&lt;');
          td.innerHTML = `<span class="price" title="${dataStr ? 'Atualizado em ' + dataStr : ''}">${raw}</span>`;
        }
      } else {
        td.innerHTML = `<span class="muted">—</span>`;
      }
      tr.appendChild(td);
    }

    frag.appendChild(tr);
  }

  favBody.appendChild(frag);
}

/* ======== TOGGLE SEÇÕES ======== */
function attachToggle(panel, button){
  function setState(expanded){
    panel.classList.toggle('collapsed', !expanded);
    button.textContent = expanded ? 'Minimizar' : 'Maximizar';
    button.setAttribute('aria-expanded', String(expanded));
  }
  button.addEventListener('click', ()=>{
    const isExpanded = button.getAttribute('aria-expanded') === 'true';
    setState(!isExpanded);
  });
  setState(true);
}
attachToggle(favPanel, toggleFavBtn);
attachToggle(generalPanel, toggleGenBtn);

/* ======== CONTADORES ======== */
function updateCounts(){
  const favs = favSet.size;
  countShown.textContent = `Exibindo ${itemsRendered} de ${produtosList.length} no Geral (carregados)`;
  countTotal.textContent = serverExhausted ? `Total de SKUs carregados: ${produtosList.length}` : `Carregando… (${produtosList.length}+ )`;
  countFavs.textContent = `Favoritos: ${favs}`;
}

/* ======== CONSULTA SERVIDOR (PAGINADA) ======== */
function buildQuery(){
  let q = sb
    .from(VIEW)
    .select('ean, site, preco, data, descricao, preco_num', { count: 'estimated' })
    .order('data', { ascending: false });

  if (currentEanQ) {
    // filtro contém/ilike
    q = q.ilike('ean', `%${currentEanQ}%`);
  }
  if (currentDescQ) {
    q = q.ilike('descricao', `%${currentDescQ}%`);
  }
  return q;
}

async function fetchNextPage(){
  if (fetching || serverExhausted) return;
  fetching = true;
  hideErr();
  setStatus(`Carregando dados… (offset ${serverOffset})`);

  try{
    const from = serverOffset;
    const to = serverOffset + PAGE_SIZE - 1;

    const { data, error } = await buildQuery().range(from, to);
    if (error) throw error;

    if (!data || data.length === 0) {
      serverExhausted = true;
      setStatus('Todos os dados carregados.');
      // Só marca fim se também não há nada pendente pra render
      if (itemsRendered >= produtosList.length) {
        endMarker.textContent = 'Fim da lista';
      }
    } else {
      upsertRowsIntoProdutos(data);

      // Renderiza próximo chunk (mantém a rolagem fluida)
      if (itemsRendered < produtosList.length) {
        renderGeneralChunk();
      }

      // Avança offset para a próxima página
      serverOffset += PAGE_SIZE;
      setStatus(`Carregados: ${produtosList.length} SKUs (parcial)`);
    }
  } catch(e){
    console.error(e);
    showErr('Falha ao carregar: ' + (e?.message || e));
    setStatus('Erro ao carregar.');
  } finally {
    fetching = false;
    updateCounts();
  }
}

/* ======== RESET DE CONSULTA ======== */
function resetAndQuery(){
  // Estado de consulta
  produtosMap.clear();
  produtosList = [];
  serverOffset = 0;
  serverExhausted = false;

  // DOM
  resetGeneralDom();
  renderFavs();
  updateFavHeight();
  updateCounts();

  // Dispara primeira página
  fetchNextPage();
}

/* ======== EVENTOS UI ======== */
btnReload.addEventListener('click', () => {
  // Recarrega mantendo filtros atuais
  resetAndQuery();
});

const onFilterInput = debounce(() => {
  currentEanQ = (eanFilter.value || '').trim();
  currentDescQ = (descFilter.value || '').trim();

  // Nova consulta na base respeitando filtros (com debounce 500ms)
  resetAndQuery();
}, 500);

eanFilter.addEventListener('input', onFilterInput);
descFilter.addEventListener('input', onFilterInput);

/* ======== HEADER INFO ======== */
async function loadHeaderInfo(){
  const { data: { session } } = await sb.auth.getSession();
  if (!session) { window.location.href = CFG.SITE_URL || 'index.html'; return null; }
  userChip.textContent = session.user?.email || 'Logado';

  // lê o plano do profiles
  try{
    const { data, error } = await sb
      .from('profiles')
      .select('plan')
      .eq('id', session.user.id)
      .maybeSingle();
    if (error) throw error;
    const planRaw = (data?.plan || 'basico').toString();
    const pretty = planRaw.charAt(0).toUpperCase() + planRaw.slice(1);
    planChip.textContent = `Plano: ${pretty}`;
  }catch(e){
    console.error(e);
    planChip.textContent = 'Plano: —';
  }
  return session;
}

/* ======== INIT ======== */
(async function init(){
  const session = await loadHeaderInfo(); if (!session) return;
  enforceMaxSession();

  // Inicia com filtros vazios
  currentEanQ = '';
  currentDescQ = '';

  // Primeira carga paginada
  resetAndQuery();

  // Garante que ao rolar no início também puxe páginas
  generalWrap.dispatchEvent(new Event('scroll'));
})();
</script>
</body>
</html>
