<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MaiorMargem ‚Äî Dashboard</title>
<style>
  :root { color-scheme: dark; }
  body { margin:0; font-family: Arial, sans-serif; background:#121212; color:#fff; padding:20px; }
  header { display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; gap:12px; flex-wrap:wrap; }
  h1 { color:#00b140; margin:0; }

  .userbox { display:flex; gap:12px; align-items:center; position: relative; }
  .chip { font-size:12px; background:#1e1e1e; border:1px solid #333; padding:6px 10px; border-radius:999px; cursor:default; }
  .chip.plan { color:#bfffc1; border-color:#2f5a2f; background:#132313; }
  .btn { background:#00b140; color:#fff; border:none; padding:8px 14px; border-radius:6px; cursor:pointer; }
  .btn:hover { background:#009b38; }

  /* Dropdown do usu√°rio */
  .userChipWrap { position: relative; display:inline-block; }
  .dropdown {
    position: absolute; right: 0; top: calc(100% + 6px); display: none;
    min-width: 180px; padding: 6px; background: #0f0f0f; border: 1px solid #2a2a2a; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,.5);
    z-index: 50;
  }
  .userChipWrap:hover .dropdown, .userChipWrap.open .dropdown { display: block; }
  .dd-item { width: 100%; background: transparent; border: none; color: #eee; text-align: left; padding: 10px 12px; border-radius: 8px; cursor: pointer; font-size: 14px; }
  .dd-item:hover { background: #1b1b1b; }

  /* Pain√©is */
  .panel { background:#202020; border:1px solid #2a2a2a; border-radius:12px; padding:12px; margin-bottom:18px; }
  .panel-header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px; }
  .panel-header h2 { margin:0; font-size:18px; color:#d5ffd5; }
  .toggle-btn { background:none; border:1px solid #2a2a2a; color:#ddd; padding:6px 10px; border-radius:8px; cursor:pointer; }
  .toggle-btn:hover { background:#1b1b1b; }

  .filters { display:grid; grid-template-columns: 1fr 1fr auto; gap:12px; margin:16px 0; }
  .filters input { padding:10px 12px; border-radius:6px; border:1px solid #333; background:#1e1e1e; color:#fff; }
  .status { margin:10px 0; color:#aaa; font-size:12px; }
  .err { display:none; color:#ff5d5d; margin:8px 0; font-size:13px; }

  /* WRAPS + sticky header */
  .wrap { overflow:auto; border:1px solid #2a2a2a; border-radius:10px; position: relative; }
  #generalWrap { height: 55vh; }

  table { width:100%; border-collapse: separate; border-spacing: 0; }
  thead { position: sticky; top: 0; z-index: 3; }
  thead th { position: sticky; top: 0; background:#0f0f0f; z-index: 4; }
  th, td { border-bottom:1px solid #2a2a2a; padding:10px; text-align:left; font-size:14px; vertical-align:top; }
  tbody tr:hover { background:#1a1a1a; }

  .col-fav { width:40px; text-align:center; }
  .col-sku { width:160px; font-family: ui-monospace,Consolas,monospace; }
  .col-desc { min-width:260px; }
  .price { font-weight:700; display:inline-block; font-size:16px; vertical-align:middle; }
  @media (min-width: 1200px) { .price { font-size:18px; } }
  .price.min { color:#ff4d4f; }
  .price.max { color:#00d084; }
  .muted { display:none; }
  .end-marker { text-align:center; padding:10px; color:#9aa0a6; }

  .counts { margin-top:10px; font-size:12px; color:#9aa0a6; display:flex; gap:12px; flex-wrap:wrap; }

  .panel.collapsed .wrap, .panel.collapsed .counts, .panel.collapsed .resizer { display:none; }

  .resizer { height: 10px; margin-top: 6px; border: 1px solid #2a2a2a; border-radius: 8px; cursor: ns-resize; background: linear-gradient(180deg, #1c1c1c, #111); display:flex; align-items:center; justify-content:center; }
  .resizer:after { content: ""; width: 40px; height: 3px; border-radius: 3px; background: #3a3a3a; }
  body.resizing, body.resizing * { cursor: ns-resize !important; user-select: none; }

  /* Bot√£o do gr√°fico */
  .chart-btn { display:inline-flex; align-items:center; justify-content:center; width:28px; height:28px; margin-left:8px; border-radius:6px; border:1.5px solid #2e2e2e; background:#141414; color:#dcdcdc; cursor:pointer; box-shadow: 0 2px 6px rgba(0,0,0,.35); }
  .chart-btn:hover { background:#1b1b1b; border-color:#3a3a3a; }
  .chart-icon { width:16px; height:16px; display:block; }

  /* Popover do gr√°fico */
  .chart-popover { position:absolute; z-index:1000; width:240px; padding:10px; background:#0f0f0f; border:1px solid #2a2a2a; border-radius:10px; box-shadow: 0 10px 40px rgba(0,0,0,.6); }
  .chart-popover header { font-size:12px; color:#b5b5b5; display:flex; justify-content:space-between; align-items:center; margin-bottom:6px; }
  .chart-popover .close { background:transparent; border:none; color:#aaa; font-size:16px; cursor:pointer; }
  .chart-popover .msg { font-size:12px; color:#bbb; padding:8px; text-align:center; }
  canvas.spark { width:200px; height:180px; display:block; background:#121212; border:1px solid #232323; border-radius:6px; }

  /* Bloqueio por plano */
  th[data-locked="true"] { position: relative; color: #aaa; }
  th[data-locked="true"]::after { content: "üîí"; margin-left: 6px; opacity: .8; font-size: 14px; }
  td.locked-cell .price { filter: blur(3px); }
  td.locked-cell .unlock { display:none; }
  td.locked-cell:hover .unlock {
    display:inline-flex; align-items:center; gap:6px;
    margin-left:8px; padding:4px 8px; border-radius:6px;
    border:1px solid #2e2e2e; background:#141414; color:#ddd; font-size:12px; cursor:pointer;
  }
  td.locked-cell .unlock:hover { background:#1b1b1b; }
</style>
<script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<script src="./config.js"></script>
</head>
<body>
<header>
  <h1>MaiorMargem ‚Äî Dashboard</h1>
  <div class="userbox">
    <span id="planChip" class="chip plan">Plano: ‚Äî</span>
    <div class="userChipWrap">
      <span id="userChip" class="chip">Usu√°rio</span>
      <div id="userDropdown" class="dropdown" role="menu" aria-hidden="true">
        <button class="dd-item" id="ddMeusDados">Meus dados</button>
        <button class="dd-item" id="ddPlanos">Planos</button>
      </div>
    </div>
    <button id="btnSair" class="btn">Sair</button>
  </div>
</header>

<div class="panel">
  <div class="filters">
    <input id="eanFilter" placeholder="Filtrar por EAN/GTIN‚Ä¶" />
    <input id="descFilter" placeholder="Filtrar por descri√ß√£o‚Ä¶" />
    <button id="btnReload" class="btn">Recarregar</button>
  </div>
  <div class="status"><span id="status"></span></div>
  <div id="err" class="err"></div>
</div>

<section id="favPanel" class="panel">
  <div class="panel-header">
    <h2>Favoritos</h2>
    <button id="toggleFav" class="toggle-btn" aria-expanded="true">Minimizar</button>
  </div>
  <div id="favWrap" class="wrap">
    <table id="favTable">
      <thead><tr id="favHeaderRow"></tr></thead>
      <tbody></tbody>
    </table>
  </div>
  <div id="favResizer" class="resizer" title="Arraste para redimensionar. Duplo clique: voltar ao auto."></div>
</section>

<section id="generalPanel" class="panel">
  <div class="panel-header">
    <h2>Geral</h2>
    <button id="toggleGen" class="toggle-btn" aria-expanded="true">Minimizar</button>
  </div>
  <div id="generalWrap" class="wrap">
    <table id="produtosTable">
      <thead><tr id="generalHeaderRow"></tr></thead>
      <tbody></tbody>
    </table>
    <div id="endMarker" class="end-marker"></div>
  </div>
  <div class="counts">
    <span id="countShown"></span>
    <span id="countTotal"></span>
    <span id="countFavs"></span>
  </div>
</section>

<!-- Popover de gr√°fico -->
<div id="chartPopover" class="chart-popover" style="display:none;">
  <header>
    <span id="chartTitle">Hist√≥rico</span>
    <button class="close" id="chartClose" aria-label="Fechar">√ó</button>
  </header>
  <canvas id="spark" class="spark" width="200" height="180"></canvas>
  <div id="chartMsg" class="msg" style="display:none;"></div>
</div>

<script>
/* ===== Erros vis√≠veis ===== */
window.addEventListener('error', e => { const el=document.getElementById('err'); el.style.display='block'; el.textContent='Erro JS: '+e.message; });
window.addEventListener('unhandledrejection', e => { const el=document.getElementById('err'); el.style.display='block'; el.textContent='Erro ass√≠ncrono: '+(e.reason?.message||e.reason); });

/* ===== Config / Supabase ===== */
const CFG = window.CONFIG || {};
const SUPABASE_URL = CFG.SUPABASE_URL;
const SUPABASE_ANON_KEY = CFG.SUPABASE_ANON_KEY;
if (!SUPABASE_URL || !SUPABASE_ANON_KEY) { const el=document.getElementById('err'); el.style.display='block'; el.textContent="Erro de configura√ß√£o: config.js n√£o carregado."; throw new Error("CONFIG ausente"); }
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true } });

/* ===== Constantes ===== */
const VIEW = "vw_precos_com_desc";
const PAGE_SIZE = 200;
const RENDER_CHUNK = 60;

/* ===== Elementos ===== */
const statusEl = document.getElementById('status');
const errEl    = document.getElementById('err');
const userChip = document.getElementById('userChip');
const planChip = document.getElementById('planChip');
const ddMeusDados = document.getElementById('ddMeusDados');
const ddPlanos    = document.getElementById('ddPlanos');
const btnSair     = document.getElementById('btnSair');
const btnReload   = document.getElementById('btnReload');
const eanFilter   = document.getElementById('eanFilter');
const descFilter  = document.getElementById('descFilter');

const favWrap  = document.getElementById('favWrap');
const favBody  = document.querySelector('#favTable tbody');
const favResizer = document.getElementById('favResizer');

const generalWrap = document.getElementById('generalWrap');
const generalBody = document.querySelector('#produtosTable tbody');
const endMarker   = document.getElementById('endMarker');

const countShown  = document.getElementById('countShown');
const countTotal  = document.getElementById('countTotal');
const countFavs   = document.getElementById('countFavs');

const favHeaderRow     = document.getElementById('favHeaderRow');
const generalHeaderRow = document.getElementById('generalHeaderRow');

/* Popover/Canvas */
const pop        = document.getElementById('chartPopover');
const popTitle   = document.getElementById('chartTitle');
const popClose   = document.getElementById('chartClose');
const popMsg     = document.getElementById('chartMsg');
const sparkCanvas= document.getElementById('spark');
const sparkCtx   = sparkCanvas.getContext('2d');

/* ===== Estado com site_id como chave ===== */
const DEFAULT_PLAN_SITE_LIMIT = { trial:2, basico:4, intermediario:5, premium:8 };

let chosenSiteIds = [];            // [site_id] na ordem do user_sites
let idToLabel     = new Map();     // site_id -> label (sites.nome/name/site)
let idToQueryKey  = new Map();     // site_id -> chave para consultar a view (view_key OU "Preco"+nome normalizado)
let keyToSiteId   = new Map();     // √≠ndice: m√∫ltiplas chaves poss√≠veis -> site_id (p/ casar VIEW.site)

let unlockedSiteIds = new Set();   // liberadas pelo plano
let lockedSiteIds   = new Set();   // excedentes

let favSet = new Set(JSON.parse(localStorage.getItem('mm_favs') || '[]'));
let produtosMap = new Map();       // Map<ean,{ sku, desc, sites: { [site_id]: { precoRaw, precoNum, data } } }>
let produtosList = [];
let itemsRendered = 0;

let serverOffset = 0;
let serverExhausted = false;
let fetching = false;

let currentEanQ = '';
let currentDescQ = '';

let loadingMore = false;
let suppressGeneralChange = false;
const generalChkMap = new Map();

let favFirstAutoRenderDone = false;

/* ===== Helpers ===== */
function setStatus(t){ statusEl.textContent = t || ''; }
function showErr(e){ errEl.style.display='block'; errEl.textContent = String(e||'').trim(); }
function hideErr(){ errEl.style.display='none'; errEl.textContent=''; }
function formatBRL(n){ try { return n.toLocaleString('pt-BR', { style:'currency', currency:'BRL' }); } catch { return String(n); } }
function debounce(fn, delay=500){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args),delay); }; }
function favSave(){ localStorage.setItem('mm_favs', JSON.stringify([...favSet])); }
function isFav(sku){ return favSet.has(String(sku)); }

/* ===== Normaliza√ß√£o de chaves ===== */
function norm(s){
  return (s||'').toString()
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')   // remove acentos
    .replace(/\s+/g,'')                                // remove espa√ßos
    .replace(/[^a-zA-Z0-9]/g,'')                       // s√≥ alfanum
    .toLowerCase();
}
function withPrecoPrefix(baseNorm){
  // Garante que a maioria dos view_keys tipo "PrecoLeroyMerlin" ser√£o cobertos
  return 'preco' + baseNorm;
}

/* ===== Cabe√ßalhos ===== */
function buildHeaders(){
  const favHeadFixed = `<th class="col-fav">A√ß√£o</th><th class="col-sku">EAN</th><th class="col-desc">Descri√ß√£o</th>`;
  const genHeadFixed = `<th class="col-fav">‚òÖ</th><th class="col-sku">EAN</th><th class="col-desc">Descri√ß√£o</th>`;

  const sitesTh = chosenSiteIds.map(id => {
    const label = idToLabel.get(id) || `Site ${id}`;
    const locked = lockedSiteIds.has(id) ? ' data-locked="true"' : ' data-locked="false"';
    return `<th data-siteid="${id}"${locked}>${label}</th>`;
  }).join('');

  favHeaderRow.innerHTML = favHeadFixed + sitesTh;
  generalHeaderRow.innerHTML = genHeadFixed + sitesTh;

  document.querySelectorAll('thead th[data-siteid]').forEach(th=>{
    const id = Number(th.getAttribute('data-siteid'));
    const locked = lockedSiteIds.has(id);
    th.setAttribute('data-locked', locked ? 'true' : 'false');
    th.style.opacity = locked ? '0.4' : '1';
  });
}

/* ===== Limite do plano ===== */
async function getSitesLimitForPlan(planKey){
  const key = (planKey || '').toString().trim().toLowerCase();
  try {
    const { data, error } = await sb.from('billing_plans')
      .select('sites_limit, max_sites')
      .eq('plan_key', key)
      .maybeSingle();
    if (error) throw error;
    const lim = Number(data?.sites_limit ?? data?.max_sites);
    if (Number.isFinite(lim) && lim > 0) return lim;
  } catch(e) { console.warn('billing_plans sem valor; usando fallback.', e); }
  return DEFAULT_PLAN_SITE_LIMIT[key] ?? 2;
}

/* ===== Monta √≠ndice din√¢mico de chaves p/ casar com VIEW.site ===== */
function buildKeyIndexForSites(siteRows){
  keyToSiteId.clear();
  idToQueryKey.clear();

  // Para estabilidade, se duas chaves apontarem para sites diferentes,
  // priorizamos o que aparece primeiro em chosenSiteIds.
  const priorityIndex = new Map(chosenSiteIds.map((id, i)=>[id, i]));

  for (const s of siteRows){
    const id = s.id;
    const label = (s.nome || s.name || s.site || `Site ${id}`).toString();
    idToLabel.set(id, label);

    const candidates = new Set();

    // 1) view_key direto
    if (s.view_key) {
      candidates.add(norm(s.view_key));
      // tamb√©m salvo a melhor chave para query
      idToQueryKey.set(id, s.view_key);
    }

    // 2) Varia√ß√µes a partir de nome/name/site
    const bases = [s.nome, s.name, s.site, label].filter(Boolean).map(x=>norm(x));
    for (const b of bases){
      // "Preco" + nome normalizado
      candidates.add(withPrecoPrefix(b));
      // s√≥ o base (caso a VIEW n√£o use "Preco")
      candidates.add(b);

      // Heur√≠stica: algumas bases v√™m com palavras extras ("centerlar","superbem","loja","lojas")
      const simplified = b
        .replace(/centerlar/g,'')
        .replace(/superbem/g,'')
        .replace(/lojas?/g,'')
        .replace(/rede/g,''); // ex.: "redemac" vs "mac"
      if (simplified && simplified !== b){
        candidates.add(withPrecoPrefix(simplified));
        candidates.add(simplified);
      }
    }

    // Registra candidatos ‚Üí site_id respeitando prioridade do user_sites
    for (const c of candidates){
      const existing = keyToSiteId.get(c);
      if (existing == null) {
        keyToSiteId.set(c, id);
      } else {
        // se j√° existe, decide por prioridade
        const curP = priorityIndex.get(existing) ?? 1e9;
        const newP = priorityIndex.get(id) ?? 1e9;
        if (newP < curP) keyToSiteId.set(c, id);
      }
    }

    // Se ainda n√£o definimos queryKey, gera com "Preco"+label normalizado
    if (!idToQueryKey.has(id)){
      const base = norm(label);
      idToQueryKey.set(id, 'Preco' + base);
    }
  }
}

/* ===== user_sites ‚Üí colunas ===== */
async function loadUserSitesAndLocks(userId, planKey){
  const maxSites = await getSitesLimitForPlan(planKey);

  // 1) L√™ user_sites
  let userRows = [];
  try{
    const { data, error } = await sb.from('user_sites')
      .select('site_id, created_at, id')
      .eq('user_id', userId)
      .order('created_at', { ascending: true, nullsFirst: true })
      .order('id', { ascending: true });
    if (error) throw error;
    userRows = data || [];
  }catch(e){
    console.warn('user_sites: falha', e);
  }

  if (!userRows.length){
    setStatus('Nenhum site selecionado em Meus Dados.');
    chosenSiteIds = [];
    unlockedSiteIds = new Set();
    lockedSiteIds = new Set();
    idToLabel.clear(); idToQueryKey.clear(); keyToSiteId.clear();
    buildHeaders();
    return;
  }

  // 2) Busca dados dos sites referenciados
  const ids = userRows.map(r=>r.site_id).filter(x=>x!=null);
  let siteRows = [];
  try{
    const { data, error } = await sb.from('sites')
      .select('id, view_key, nome, name, site')
      .in('id', ids);
    if (error) throw error;
    siteRows = data || [];
  }catch(e){
    console.warn('sites: falha', e);
  }

  // 3) Define ordem final (sem duplicar) e indexa nomes/keys
  idToLabel.clear();
  const byId = new Map(siteRows.map(s => [s.id, s]));
  const order = [];
  const seen = new Set();
  for (const r of userRows){
    const s = byId.get(r.site_id);
    if (!s) continue;
    if (seen.has(s.id)) continue;
    seen.add(s.id);
    order.push(s.id);
  }
  chosenSiteIds = order;

  // 4) Monta √≠ndice de chaves poss√≠veis para casar com VIEW.site
  buildKeyIndexForSites(order.map(id => byId.get(id)).filter(Boolean));

  // 5) Bloqueios do plano
  unlockedSiteIds = new Set(chosenSiteIds.slice(0, maxSites));
  lockedSiteIds   = new Set(chosenSiteIds.slice(maxSites));

  // 6) Cabe√ßalhos
  buildHeaders();

  setStatus(`Sites selecionados (ordem do usu√°rio): ${chosenSiteIds.map(id=>idToLabel.get(id)).join(' ¬∑ ')}`);
}

/* ===== Agrega√ß√£o (usa site_id como chave) ===== */
function upsertRowsIntoProdutos(rows){
  let matched = 0;
  for (const row of rows){
    const ean = String(row.ean ?? '');
    const siteField = String(row.site ?? ''); // ex.: "PrecoLeroyMerlin"
    if (!ean || !siteField) continue;

    // mapeia VIEW.site ‚Üí site_id com √≠ndice din√¢mico
    const key = norm(siteField);
    let siteId = keyToSiteId.get(key);

    // fallback: se vier com "preco" e n√£o achou, tenta sem prefixo
    if (!siteId && key.startsWith('preco')) {
      siteId = keyToSiteId.get(key.slice(5));
    }

    if (!siteId || !chosenSiteIds.includes(siteId)) continue;

    matched++;

    if (!produtosMap.has(ean)) {
      produtosMap.set(ean, { sku: ean, desc: row.descricao || '', sites: {} });
    }
    const item = produtosMap.get(ean);
    if (!item.desc && row.descricao) item.desc = row.descricao;

    const prev = item.sites[siteId];
    if (!prev || new Date(row.data) > new Date(prev.data)) {
      item.sites[siteId] = { precoRaw: row.preco, precoNum: row.preco_num, data: row.data };
    }
  }

  produtosList = Array.from(produtosMap.values());

  // Se nada casou na primeira p√°gina, avisa no status para facilitar debug
  if (serverOffset === 0 && matched === 0) {
    setStatus('Nenhum pre√ßo encontrado para os sites selecionados. Verifique se os sites da VIEW correspondem aos sites escolhidos em Meus Dados.');
  }
}

/* ===== Render ===== */
function chartButtonSVG(){
  return `
    <svg class="chart-icon" viewBox="0 0 24 24" aria-hidden="true">
      <rect x="3" y="11" width="3" height="7" rx="1" fill="#2d2d2d" stroke="#3b3b3b" stroke-width="1"></rect>
      <rect x="9" y="8"  width="3" height="10" rx="1" fill="#2d2d2d" stroke="#3b3b3b" stroke-width="1"></rect>
      <rect x="15" y="5" width="3" height="13" rx="1" fill="#2d2d2d" stroke="#3b3b3b" stroke-width="1"></rect>
      <path d="M3,18 L7,14 L12,15 L17,8 L21,10" fill="none" stroke="#00d084" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>`;
}
function computeMinMaxForRow(item){
  let min = { id:null, val: Infinity }, max = { id:null, val: -Infinity };
  for (const id of chosenSiteIds) {
    if (lockedSiteIds.has(id)) continue;
    const d = item.sites[id];
    if (!d || !Number.isFinite(d.precoNum)) continue;
    if (d.precoNum < min.val) { min = { id:id, val:d.precoNum }; }
    if (d.precoNum > max.val) { max = { id:id, val:d.precoNum }; }
  }
  return { minId: min.id, maxId: max.id };
}
function createPriceCell(item, siteId, minId, maxId){
  const td = document.createElement('td');
  const d = item.sites[siteId];
  const isLocked = lockedSiteIds.has(siteId);
  if (isLocked) td.classList.add('locked-cell');

  if (d) {
    const dataStr = d.data ? new Date(d.data).toLocaleString('pt-BR') : '';
    if (Number.isFinite(d.precoNum)) {
      const span = document.createElement('span');
      span.className = `price ${!isLocked && siteId===minId ? 'min' : (!isLocked && siteId===maxId ? 'max':'')}`;
      span.title = isLocked ? 'Excedeu o limite do plano' : (dataStr ? `Atualizado em ${dataStr}` : '');
      span.textContent = formatBRL(d.precoNum);
      td.appendChild(span);

      const b = document.createElement('button');
      b.className='chart-btn'; b.type='button';
      b.title = isLocked ? 'Dispon√≠vel no upgrade' : 'Ver hist√≥rico';
      b.innerHTML = chartButtonSVG();
      b.addEventListener('click', (ev)=>{
        if (isLocked){ window.location.href='planos.html'; return; }
        openChartFor(ev, item.sku, siteId);
      });
      td.appendChild(b);

      if (isLocked){
        const up = document.createElement('button');
        up.className='unlock'; up.type='button'; up.title='Excedeu o limite do plano. Ver planos.'; up.textContent='Ver planos';
        up.addEventListener('click', ()=> window.location.href='planos.html');
        td.appendChild(up);
      }
    } else {
      const span = document.createElement('span');
      span.className='price';
      span.title = isLocked ? 'Excedeu o limite do plano' : (dataStr ? `Atualizado em ${dataStr}` : '');
      span.textContent = (d.precoRaw??'').toString();
      td.appendChild(span);
    }
  } else {
    td.innerHTML = `<span class="muted">‚Äî</span>`;
  }
  return td;
}
function renderRowInto(tr, item){
  const tdFav = document.createElement('td'); tdFav.className='col-fav';
  const chk = document.createElement('input'); chk.type='checkbox'; chk.checked=isFav(item.sku); chk.title='Marcar como favorito';
  chk.addEventListener('change', ()=>{ if (suppressGeneralChange) return; if (chk.checked) favSet.add(item.sku); else favSet.delete(item.sku); favSave(); renderFavs(); updateFavHeight(); updateCounts(); });
  tdFav.appendChild(chk); tr.appendChild(tdFav); generalChkMap.set(item.sku, chk);

  const tdSku = document.createElement('td'); tdSku.className='col-sku'; tdSku.textContent=item.sku; tr.appendChild(tdSku);
  const tdDesc= document.createElement('td'); tdDesc.className='col-desc'; tdDesc.innerHTML=(item.desc||'').replace(/</g,'&lt;'); tr.appendChild(tdDesc);

  const {minId,maxId} = computeMinMaxForRow(item);
  for (const id of chosenSiteIds){ tr.appendChild(createPriceCell(item, id, minId, maxId)); }
}
function renderGeneralChunk(){
  const end = Math.min(itemsRendered + RENDER_CHUNK, produtosList.length);
  const frag = document.createDocumentFragment();
  for (let i=itemsRendered;i<end;i++){ const it = produtosList[i]; const tr = document.createElement('tr'); renderRowInto(tr, it); frag.appendChild(tr); }
  generalBody.appendChild(frag);
  itemsRendered = end;
  endMarker.textContent = (serverExhausted && itemsRendered >= produtosList.length) ? 'Fim da lista' : '';
  updateCounts();
}
function resetGeneralDom(){ generalBody.innerHTML=''; generalChkMap.clear(); itemsRendered=0; endMarker.textContent=''; }
function onGeneralScroll(){
  if (loadingMore) return;
  const nearBottom = generalWrap.scrollTop + generalWrap.clientHeight >= generalWrap.scrollHeight - 100;
  if (nearBottom && itemsRendered < produtosList.length){ loadingMore=true; setTimeout(()=>{ renderGeneralChunk(); loadingMore=false; }, 30); return; }
  if (nearBottom && !serverExhausted && !fetching){ fetchNextPage(); }
}
generalWrap.addEventListener('scroll', onGeneralScroll);

/* ===== Favoritos ===== */
function renderFavs(){
  favBody.innerHTML='';
  const favList = produtosList.filter(p=>isFav(p.sku));
  const frag = document.createDocumentFragment();
  for (const item of favList){
    const tr = document.createElement('tr');

    const tdAct=document.createElement('td'); tdAct.className='col-fav';
    const btn=document.createElement('button'); btn.className='trash-btn'; btn.title='Remover'; btn.innerHTML='üóëÔ∏è';
    btn.addEventListener('click', ()=>{ favSet.delete(item.sku); favSave(); const chk=generalChkMap.get(item.sku); if (chk){ suppressGeneralChange=true; chk.checked=false; suppressGeneralChange=false; } renderFavs(); updateFavHeight(); updateCounts(); });
    tdAct.appendChild(btn); tr.appendChild(tdAct);

    const tdSku=document.createElement('td'); tdSku.className='col-sku'; tdSku.textContent=item.sku; tr.appendChild(tdSku);
    const tdDesc=document.createElement('td'); tdDesc.className='col-desc'; tdDesc.innerHTML=(item.desc||'').replace(/</g,'&lt;'); tr.appendChild(tdDesc);

    const {minId,maxId}=computeMinMaxForRow(item);
    for (const id of chosenSiteIds){ tr.appendChild(createPriceCell(item, id, minId, maxId)); }

    frag.appendChild(tr);
  }
  favBody.appendChild(frag);
}

/* ===== Contadores ===== */
function updateCounts(){
  const favs=favSet.size;
  countShown.textContent = `Exibindo ${itemsRendered} de ${produtosList.length} no Geral (carregados)`;
  countTotal.textContent = serverExhausted ? `Total de SKUs carregados: ${produtosList.length}` : `Carregando‚Ä¶ (${produtosList.length}+ )`;
  countFavs.textContent  = `Favoritos: ${favs}`;
}

/* ===== Consulta paginada ===== */
function buildQuery(){
  let q = sb.from(VIEW).select('ean, site, preco, data, descricao, preco_num', { count: 'estimated' }).order('data', { ascending: false });
  if (currentEanQ) q = q.ilike('ean', `%${currentEanQ}%`);
  if (currentDescQ) q = q.ilike('descricao', `%${currentDescQ}%`);
  return q;
}
async function fetchNextPage(){
  if (fetching || serverExhausted) return;
  fetching = true; hideErr(); setStatus(`Carregando dados‚Ä¶ (offset ${serverOffset})`);
  try{
    const from = serverOffset, to = serverOffset + PAGE_SIZE - 1;
    const { data, error } = await buildQuery().range(from, to);
    if (error) throw error;

    if (!data || data.length === 0) {
      serverExhausted = true; setStatus('Todos os dados carregados.');
      if (itemsRendered >= produtosList.length) endMarker.textContent = 'Fim da lista';
    } else {
      upsertRowsIntoProdutos(data);
      if (itemsRendered < produtosList.length) renderGeneralChunk();
      renderFavs();
      if (!favFirstAutoRenderDone) { updateFavHeight(); favFirstAutoRenderDone = true; }
      serverOffset += PAGE_SIZE;
      setStatus(`Carregados: ${produtosList.length} SKUs (parcial)`);
    }
  } catch(e){ console.error(e); showErr('Falha ao carregar: ' + (e?.message || e)); setStatus('Erro ao carregar.'); }
  finally { fetching = false; updateCounts(); }
}

/* ===== Reset ===== */
function resetAndQuery(){
  produtosMap.clear(); produtosList=[]; serverOffset=0; serverExhausted=false; favFirstAutoRenderDone=false;
  resetGeneralDom();
  renderFavs(); updateFavHeight(); updateCounts();
  fetchNextPage();
}

/* ===== Navega√ß√£o / filtros ===== */
ddMeusDados.addEventListener('click', () => { window.location.href = 'meusdados.html'; });
ddPlanos.addEventListener('click', () => { window.location.href = 'planos.html'; });
btnSair.addEventListener('click', async () => {
  try { await sb.auth.signOut(); } catch (e) { console.error('Erro ao sair:', e); }
  finally { localStorage.removeItem('mm_login_date'); window.location.href = CFG.SITE_URL || 'index.html'; }
});
const onFilterInput = debounce(() => {
  currentEanQ = (eanFilter.value || '').trim();
  currentDescQ = (descFilter.value || '').trim();
  resetAndQuery();
}, 500);
eanFilter.addEventListener('input', onFilterInput);
descFilter.addEventListener('input', onFilterInput);

btnReload.addEventListener('click', async () => {
  const session = (await sb.auth.getSession()).data.session;
  if (session?.user?.id) {
    let planKey = 'basico';
    try{
      const { data, error } = await sb.from('profiles').select('plan').eq('id', session.user.id).maybeSingle();
      if (!error) planKey = (data?.plan || 'basico').toString().toLowerCase();
      planChip.textContent = `Plano: ${planKey.charAt(0).toUpperCase()+planKey.slice(1)}`;
    }catch(e){}
    await loadUserSitesAndLocks(session.user.id, planKey);
  }
  resetAndQuery();
});

/* ===== Favoritos: altura e resizer ===== */
function measureRowHeight(){ const row = document.querySelector('#favTable tbody tr'); if (!row) return 44; const h = Math.round(row.getBoundingClientRect().height); return Math.max(36, h || 44); }
function measureHeadHeight(){ const head = document.querySelector('#favTable thead'); if (!head) return 40; const h = Math.round(head.getBoundingClientRect().height); return Math.max(32, h || 40); }
let favHeightUser = Number(localStorage.getItem('mm_fav_height')) || null;
function applyFavHeight(px){ if (!px || !Number.isFinite(px)) return; const maxPx = Math.round(window.innerHeight * 0.85); const clamped = Math.max(120, Math.min(px, maxPx)); favWrap.style.height = clamped + 'px'; }
function updateFavHeight(){
  if (favHeightUser) { applyFavHeight(favHeightUser); return; }
  const rowsLen = favBody.children.length;
  const rows = Math.min(rowsLen, 20);
  const rowH = measureRowHeight();
  const headH = measureHeadHeight();
  const pad = 8;
  const target = headH + rows * rowH + pad;
  applyFavHeight(target);
}
(function initResizer(){
  let startY = 0, startH = 0;
  function onMove(ev){ const dy = ev.clientY - startY; favHeightUser = startH + dy; localStorage.setItem('mm_fav_height', String(favHeightUser)); applyFavHeight(favHeightUser); }
  function stop(){ document.removeEventListener('mousemove', onMove); document.removeEventListener('mouseup', stop); document.body.classList.remove('resizing'); }
  favResizer.addEventListener('mousedown', (ev)=>{ startY = ev.clientY; startH = favWrap.offsetHeight; document.body.classList.add('resizing'); document.addEventListener('mousemove', onMove); document.addEventListener('mouseup', stop); });
  favResizer.addEventListener('dblclick', ()=>{ favHeightUser = null; localStorage.removeItem('mm_fav_height'); updateFavHeight(); });
})();

/* ===== Mini-gr√°fico ===== */
function closePopover(){ pop.style.display='none'; }
function positionPopover(x, y){
  const pad = 12; const vw = window.innerWidth, vh = window.innerHeight;
  let left = x + pad, top = y + pad; const rectW = 240, rectH = 260;
  if (left + rectW > vw) left = x - rectW - pad;
  if (top + rectH > vh) top = y - rectH - pad;
  pop.style.left = Math.max(8, left) + 'px';
  pop.style.top  = Math.max(8, top) + 'px';
}
document.addEventListener('click', (ev) => { if (pop.style.display !== 'none' && !pop.contains(ev.target)) closePopover(); });
document.addEventListener('keydown', (ev) => { if (ev.key === 'Escape') closePopover(); });
document.getElementById('chartClose').addEventListener('click', closePopover);

function drawSparkline(points){
  const ctx = sparkCtx; const W = sparkCanvas.width, H = sparkCanvas.height; ctx.clearRect(0,0,W,H);
  if (!points || points.length < 3){ popMsg.style.display='block'; popMsg.textContent = 'Hist√≥rico insuficiente (precisa de 3 pre√ßos).'; return; }
  popMsg.style.display='none';
  const m = { l: 40, r: 14, t: 12, b: 28 };
  const xs = points.map(p=>p.x.getTime()); const ys = points.map(p=>p.y);
  const xMin = Math.min(...xs), xMax = Math.max(...xs); const yMin = Math.min(...ys), yMax = Math.max(...ys);
  const xScale = v => m.l + ((v - xMin) / (xMax - xMin || 1)) * (W - m.l - m.r);
  const yScaleRaw = v => H - m.b - ((v - yMin) / (yMax - yMin || 1)) * (H - m.t - m.b);
  const yScale = v => Math.max(m.t+6, Math.min(H - m.b - 6, yScaleRaw(v)));
  ctx.strokeStyle = '#232323'; ctx.lineWidth = 1; ctx.beginPath();
  for (let i=0;i<=3;i++){ const yy = m.t + i*(H - m.t - m.b)/3; ctx.moveTo(m.l, yy); ctx.lineTo(W - m.r, yy); }
  ctx.stroke();
  ctx.beginPath(); ctx.lineWidth = 3; ctx.strokeStyle = '#00d084';
  points.forEach((p, i)=>{ const x = xScale(p.x.getTime()), y = yScale(p.y); if (i === 0) ctx.moveTo(x,y); else ctx.lineTo(x,y); });
  ctx.stroke();
  ctx.fillStyle = '#bfffc1';
  for (const p of points){ const x = xScale(p.x.getTime()), y = yScale(p.y); ctx.beginPath(); ctx.arc(x,y,3.2,0,Math.PI*2); ctx.fill(); }
  ctx.fillStyle = '#9aa0a6'; ctx.font = '11px Arial'; ctx.textAlign = 'right';
  const yMaxY = yScale(yMax), yMinY = yScale(yMin);
  ctx.fillText(formatBRL(yMax), m.l-6, Math.max(m.t+10, yMaxY-6));
  ctx.fillText(formatBRL(yMin), m.l-6, Math.min(H - m.b - 2, yMinY+12));
  const fmt = (d)=> d.toLocaleDateString('pt-BR', { day:'2-digit', month:'2-digit' });
  ctx.textAlign = 'center'; ctx.fillText(fmt(points[0].x), Math.max(m.l, 24), H-8); ctx.fillText(fmt(points[points.length-1].x), Math.min(W - m.r, W-24), H-8);
}
async function openChartFor(ev, ean, siteId){
  ev.stopPropagation();
  const rect = ev.currentTarget.getBoundingClientRect();
  positionPopover(rect.right, rect.bottom);
  const label = idToLabel.get(siteId) || `Site ${siteId}`;
  popTitle.textContent = `${label} ‚Ä¢ ${ean}`;
  popMsg.style.display='block'; popMsg.textContent = 'Carregando hist√≥rico‚Ä¶';
  sparkCtx.clearRect(0,0,sparkCanvas.width,sparkCanvas.height);
  pop.style.display='block';
  try{
    const key = idToQueryKey.get(siteId) || '';
    if (!key) { popMsg.style.display='block'; popMsg.textContent = 'Site sem chave de consulta definida.'; return; }
    const { data, error } = await sb.from(VIEW).select('data, preco_num')
      .eq('ean', ean)
      .eq('site', key)
      .not('preco_num', 'is', null)
      .order('data', { ascending: true })
      .limit(60);
    if (error) throw error;
    const points = (data||[]).filter(r => typeof r.preco_num === 'number' && Number.isFinite(r.preco_num)).map(r => ({ x: new Date(r.data), y: r.preco_num }));
    drawSparkline(points);
  } catch(e){ console.error(e); popMsg.style.display='block'; popMsg.textContent = 'Falha ao carregar hist√≥rico.'; }
}

/* ===== Init ===== */
(async function init(){
  const { data: { session } } = await sb.auth.getSession();
  if (!session) { window.location.href = CFG.SITE_URL || 'index.html'; return; }

  userChip.textContent = session.user?.email || 'Logado';

  let planKey = 'basico';
  try{
    const { data, error } = await sb.from('profiles').select('plan').eq('id', session.user.id).maybeSingle();
    if (!error){
      const raw = (data?.plan || 'basico').toString();
      planKey = raw.toLowerCase();
      planChip.textContent = `Plano: ${raw.charAt(0).toUpperCase()+raw.slice(1)}`;
    }
  }catch(e){ console.warn(e); }

  await loadUserSitesAndLocks(session.user.id, planKey);

  currentEanQ = ''; currentDescQ = '';
  resetAndQuery();
  generalWrap.dispatchEvent(new Event('scroll'));
})();
</script>
</body>
</html>
