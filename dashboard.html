<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MaiorMargem - Tabela de Produtos</title>
<style>
  :root { color-scheme: dark; }
  body { margin:0; font-family: Arial, sans-serif; background-color:#121212; color:white; padding:20px; }
  header { display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; gap:12px; flex-wrap:wrap; }
  h1 { color:#00b140; margin:0; }
  .userbox { display:flex; gap:12px; align-items:center; }
  .chip { font-size:12px; background:#1e1e1e; border:1px solid #333; padding:6px 10px; border-radius:999px; }
  .btn { background:#00b140; color:#fff; border:none; padding:8px 14px; border-radius:6px; cursor:pointer; }
  .btn:hover { background:#009b38; }

  .panel { background:#0f0f0f; border:1px solid #2a2a2a; border-radius:12px; padding:12px; margin-bottom:18px; }
  .panel-header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px; }
  .panel-header h2 { margin:0; font-size:18px; color:#d5ffd5; }
  .toggle-btn { background:none; border:1px solid #2a2a2a; color:#ddd; padding:6px 10px; border-radius:8px; cursor:pointer; }
  .toggle-btn:hover { background:#1b1b1b; }

  .filters { display:grid; grid-template-columns: 1fr 1fr auto; gap:12px; margin:16px 0; }
  .filters input { padding:10px 12px; border-radius:6px; border:1px solid #333; background-color:#1e1e1e; color:white; }
  .status { margin:10px 0; color:#aaa; font-size:12px; }
  .err { display:none; color:#ff5d5d; margin:8px 0; font-size:13px; }

  .wrap { overflow:auto; border:1px solid #2a2a2a; border-radius:10px; }
  /* Geral: altura fixa com scroll interno */
  #generalWrap { height: 55vh; }

  table { width:100%; border-collapse: collapse; }
  thead th { position:sticky; top:0; background:#0f0f0f; z-index:1; }
  th, td { border-bottom:1px solid #2a2a2a; padding:10px; text-align:left; font-size:14px; vertical-align:top; }
  tbody tr:hover { background:#1a1a1a; }

  .col-fav { width:40px; text-align:center; }
  .col-sku { width:160px; font-family: ui-monospace,Consolas,monospace; }
  .col-desc { min-width:260px; }
  .price { font-weight:700; display:block; }
  .price.min { color:#ff4d4f; }       /* vermelho: mais barato */
  .price.max { color:#00d084; }       /* verde: mais caro */
  .muted { display:none; }            /* data oculta; só via tooltip title */
  .end-marker { text-align:center; padding:10px; color:#9aa0a6; }

  .counts { margin-top:10px; font-size:12px; color:#9aa0a6; display:flex; gap:12px; flex-wrap:wrap; }

  /* Painel colapsado: esconde conteúdo rolável e contadores */
  .panel.collapsed .wrap { display:none; }
  .panel.collapsed .counts { display:none; }
  .panel.collapsed .resizer { display:none; }

  /* Barra de redimensionar (abaixo dos favoritos) */
  .resizer {
    height: 10px;
    margin-top: 6px;
    border: 1px solid #2a2a2a;
    border-radius: 8px;
    cursor: ns-resize;
    background: linear-gradient(180deg, #1c1c1c, #111);
    display:flex; align-items:center; justify-content:center;
  }
  .resizer:after {
    content: "";
    width: 40px; height: 3px; border-radius: 3px;
    background: #3a3a3a;
  }
  body.resizing, body.resizing * { cursor: ns-resize !important; user-select: none; }

  /* === Menu do usuário (dropdown) === */
  .userbox { position: relative; }
  .user-menu { position: relative; }
  .chip-btn { display:flex; align-items:center; gap:6px; cursor:pointer; }
  .chip-btn:focus { outline: 2px solid #2a2a2a; outline-offset: 2px; }
  .caret { transition: transform .15s ease; }
  .chip-btn[aria-expanded="true"] .caret { transform: rotate(180deg); }
  .menu {
    position: absolute;
    top: calc(100% + 6px);
    right: 0;
    background: #1e1e1e;
    border: 1px solid #333;
    border-radius: 10px;
    min-width: 180px;
    padding: 6px;
    box-shadow: 0 8px 24px rgba(0,0,0,.4);
    display: none;
    z-index: 1000;
  }
  .menu.open { display: block; }
  .menu-item {
    display: block;
    padding: 10px 12px;
    border-radius: 8px;
    color: #fff;
    text-decoration: none;
    font-size: 14px;
  }
  .menu-item:hover { background: #2a2a2a; }
</style>
<script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<script src="./config.js"></script>
</head>
<body>
<header>
  <h1>MaiorMargem — Dashboard</h1>
  <div class="userbox">
    <div class="user-menu">
      <button id="userMenuBtn" class="chip chip-btn" aria-haspopup="menu" aria-expanded="false">
        <span id="userChip">Usuário</span>
        <svg class="caret" viewBox="0 0 24 24" width="14" height="14" aria-hidden="true">
          <path d="M7 10l5 5 5-5H7z"></path>
        </svg>
      </button>
      <div id="userMenu" class="menu" role="menu" aria-hidden="true">
        <a href="meusdados.html" class="menu-item" role="menuitem">Meus dados</a>
      </div>
    </div>
    <button id="btnSair" class="btn">Sair</button>
  </div>
</header>

<!-- Filtros/Status -->
<div class="panel">
  <div class="filters">
    <input id="eanFilter" placeholder="Filtrar por EAN/GTIN…" />
    <input id="descFilter" placeholder="Filtrar por descrição…" />
    <button id="btnReload" class="btn">Recarregar</button>
  </div>
  <div id="status" class="status"></div>
  <div id="err" class="err"></div>
</div>

<!-- Favoritos -->
<section id="favPanel" class="panel">
  <div class="panel-header">
    <h2>Favoritos</h2>
    <button id="toggleFav" class="toggle-btn" aria-expanded="true">Minimizar</button>
  </div>
  <div id="favWrap" class="wrap">
    <table id="favTable">
      <thead>
        <tr>
          <th class="col-fav">Fav</th>
          <th class="col-sku">EAN/GTIN</th>
          <th class="col-desc">Descrição</th>
          <th>Cassol</th>
          <th>Ghaus</th>
          <th>Leroy</th>
          <th>MestreTinho</th>
          <th>QueroQuero</th>
          <th>RedeMac</th>
          <th>Supremeinox</th>
          <th>Tumelero</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <!-- Barra de redimensionar (drag) -->
  <div id="favResizer" class="resizer" title="Arraste para redimensionar"></div>
  <div class="counts">
    <div><strong>Favoritos:</strong> <span id="countFavs">0</span></div>
  </div>
</section>

<!-- Geral -->
<section id="generalPanel" class="panel">
  <div class="panel-header">
    <h2>Geral</h2>
    <button id="toggleGen" class="toggle-btn" aria-expanded="true">Minimizar</button>
  </div>
  <div id="generalWrap" class="wrap">
    <table id="produtosTable">
      <thead>
        <tr>
          <th class="col-fav">Fav</th>
          <th class="col-sku">EAN/GTIN</th>
          <th class="col-desc">Descrição</th>
          <th>Cassol</th>
          <th>Ghaus</th>
          <th>Leroy</th>
          <th>MestreTinho</th>
          <th>QueroQuero</th>
          <th>RedeMac</th>
          <th>Supremeinox</th>
          <th>Tumelero</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div id="endMarker" class="end-marker">— Fim —</div>
  </div>
  <div class="counts">
    <div><strong>Exibindo:</strong> <span id="countShown">0</span></div>
    <div><strong>Total:</strong> <span id="countTotal">0</span></div>
  </div>
</section>

<script>
/* ====== Config ====== */
const CFG = window.CONFIG || {};
const SUPABASE_URL = CFG.SUPABASE_URL;
const SUPABASE_ANON_KEY = CFG.SUPABASE_ANON_KEY;
if (!SUPABASE_URL || !SUPABASE_ANON_KEY) { alert("Erro de config...config.js não carregado."); throw new Error("CONFIG ausente"); }
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true } });

/** Ajustes UI **/
const PRICE_MARKUP_PCT = 0.02;
const MAX_SESSION_MS = 2 * 60 * 60 * 1000; // 2h
const FAV_AUTO_ROWS_MAX = 20;
const FAV_MIN_PX = 120;

/* ====== UI refs ====== */
const statusEl = document.getElementById('status');
const errEl = document.getElementById('err');
const userChip = document.getElementById('userChip');
const btnSair = document.getElementById('btnSair');
const btnReload = document.getElementById('btnReload');

const eanFilter = document.getElementById('eanFilter');
const descFilter = document.getElementById('descFilter');

const favPanel = document.getElementById('favPanel');
const toggleFavBtn = document.getElementById('toggleFav');
const favWrap = document.getElementById('favWrap');
const favBody = document.querySelector('#favTable tbody');
const favResizer = document.getElementById('favResizer');

const generalPanel = document.getElementById('generalPanel');
const toggleGenBtn = document.getElementById('toggleGen');
const generalWrap = document.getElementById('generalWrap');
const generalBody = document.querySelector('#produtosTable tbody');
const endMarker = document.getElementById('endMarker');

const countShown = document.getElementById('countShown');
const countTotal = document.getElementById('countTotal');
const countFavs  = document.getElementById('countFavs');

function setStatus(t){ statusEl.textContent = t || ''; }
function showErr(e){ errEl.style.display='block'; errEl.textContent = String(e||'').trim(); }
function hideErr(){ errEl.style.display='none'; errEl.textContent=''; }

/* ====== Menu do Usuário (dropdown) ====== */
const userMenuBtn = document.getElementById('userMenuBtn');
const userMenu    = document.getElementById('userMenu');

function toggleUserMenu(force) {
  const wantOpen = (typeof force === 'boolean') ? force : !userMenu.classList.contains('open');
  userMenu.classList.toggle('open', wantOpen);
  userMenuBtn.setAttribute('aria-expanded', String(wantOpen));
  userMenu.setAttribute('aria-hidden', String(!wantOpen));
}
if (userMenuBtn && userMenu) {
  userMenuBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    toggleUserMenu();
  });
  document.addEventListener('click', (e) => {
    if (!userMenu.contains(e.target) && e.target !== userMenuBtn) {
      toggleUserMenu(false);
    }
  });
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') toggleUserMenu(false);
  });
}

/* ====== Sessão: 2h ====== */
function enforceMaxSession(){
  const key = 'mm_login_start';
  const now = Date.now();
  let start = Number(localStorage.getItem(key));
  if (!Number.isFinite(start) || start <= 0) { localStorage.setItem(key, String(now)); start = now; }
  async function check(){
    const s = Number(localStorage.getItem(key));
    const age = Date.now() - (Number.isFinite(s) ? s : now);
    if (age > MAX_SESSION_MS) { await sb.auth.signOut(); localStorage.removeItem(key); window.location.href = CFG.SITE_URL || 'index.html'; }
  }
  setInterval(check, 60 * 1000);
}

/* ====== Helpers ====== */
function formatBRL(num){ try{ return num.toLocaleString('pt-BR', { style:'currency', currency:'BRL' }); }catch{ return String(num); } }
function sanitizeNumber(str){
  if (typeof str === 'number') return str;
  if (!str) return NaN;
  const only = String(str).replace(/[^\d,.-]/g,'').replace(/\.(?=\d{3}(?:\D|$))/g,'');
  const norm = only.replace(',', '.');
  const n = Number(norm);
  return Number.isFinite(n) ? n : NaN;
}
function withMarkup(price){ return Math.round((price * (1 + PRICE_MARKUP_PCT)) * 100) / 100; }

/* ====== Mock: ordem dos sites (use a mesma do seu backend) ====== */
const siteOrder = ["Cassol","Ghaus","Leroy","MestreTinho","QueroQuero","RedeMac","Supremeinox","Tumelero"];

/* ====== Dados ====== */
let allRows = [];            // [{sku, desc, sites: {Cassol:{precoNum, precoRaw, url, data}, ...}}]
let favSet = new Set(JSON.parse(localStorage.getItem('mm_favs') || '[]'));
let generalChkMap = new Map(); // sku -> checkbox (na tabela geral)

/* ====== Fetch do Supabase ====== */
async function buscarDados(){
  hideErr(); setStatus('Carregando...');
  try {
    // Exemplo: ajuste para sua estrutura/tabela real
    const { data, error } = await sb
      .from('vw_precos_com_desc') // ou sua view/tabela agregada
      .select('*')
      .limit(5000);       // ajuste conforme necessário

    if (error) throw error;
    const rows = Array.isArray(data) ? data : [];
    allRows = mapRows(rows);
    renderAll();
    setStatus(`Carregado: ${rows.length} linhas`);
  } catch(err) {
    showErr(err.message || err); setStatus('');
  }
}

/* ====== Transformação ====== */
function mapRows(rows){
  // Este mapeamento deve refletir o formato da sua view/tabela
  // Aqui fica um exemplo genérico; adapte as chaves conforme seu schema
  const map = new Map();
  for (const r of rows){
    const sku = r.ean || r.sku || r.EAN || r.GTIN || '';
    if (!sku) continue;
    const desc = r.descricao || r.desc || r.Descricao || '';
    const site = r.site || r.Site || '';
    const url  = r.url  || r.Url  || '';
    const precoRaw = r.preco || r.Preco || r.preco_raw || r.precoRaw || '';
    const precoNum = sanitizeNumber(r.preco_num || r.precoNum || r.preco || r.Preco);

    const key = sku;
    if (!map.has(key)){
      map.set(key, { sku, desc, sites: {} });
    }
    const obj = map.get(key);
    obj.sites[site] = {
      precoNum: Number.isFinite(precoNum) ? precoNum : NaN,
      precoRaw, url,
      data: r.data || r.updated_at || r.atualizado_em || null
    };
  }
  return Array.from(map.values());
}

/* ====== Render ====== */
function computeMinMaxForRow(item){
  let minV = Infinity, maxV = -Infinity, minSite=null, maxSite=null;
  for (const s of siteOrder){
    const d = item.sites[s];
    if (!d || !Number.isFinite(d.precoNum)) continue;
    if (d.precoNum < minV){ minV = d.precoNum; minSite = s; }
    if (d.precoNum > maxV){ maxV = d.precoNum; maxSite = s; }
  }
  return { minSite, maxSite, minV, maxV };
}

function renderAll(){
  renderFavs();
  renderGeneral();
  aplicarFiltros(); // atualiza contadores
}

function renderFavs(){
  favBody.innerHTML = '';
  const frag = document.createDocumentFragment();
  let count = 0;

  for (const item of allRows){
    if (!favSet.has(item.sku)) continue;
    count++;
    const tr = document.createElement('tr');

    // Fav (checkbox)
    const tdFav = document.createElement('td');
    tdFav.className = 'col-fav';
    const btnRemove = document.createElement('button');
    btnRemove.className = 'btn';
    btnRemove.textContent = '🗑';
    btnRemove.title = 'Remover dos favoritos';
    btnRemove.addEventListener('click', ()=>{
      favSet.delete(item.sku);
      localStorage.setItem('mm_favs', JSON.stringify(Array.from(favSet)));
      renderAll();
    });
    tdFav.appendChild(btnRemove);
    tr.appendChild(tdFav);

    // SKU
    const tdSku = document.createElement('td');
    tdSku.className = 'col-sku';
    tdSku.textContent = item.sku;
    tr.appendChild(tdSku);

    // Descrição
    const tdDesc = document.createElement('td');
    tdDesc.className = 'col-desc';
    tdDesc.innerHTML = (item.desc || '').replace(/</g,'&lt;');
    tr.appendChild(tdDesc);

    // Preços
    const { minSite, maxSite } = computeMinMaxForRow(item);
    for (const s of siteOrder) {
      const td = document.createElement('td');
      const d = item.sites[s];
      if (d) {
        const dataStr = d.data ? new Date(d.data).toLocaleString('pt-BR') : '';
        if (Number.isFinite(d.precoNum)) {
          const marked = withMarkup(d.precoNum);
          const cls = (s === minSite) ? 'min' : (s === maxSite ? 'max' : '');
          td.innerHTML = `<span class="price ${cls}" title="Atualizado em ${dataStr}">${formatBRL(marked)}</span>`;
        } else {
          const raw = (d.precoRaw ?? '').toString().replace(/</g,'&lt;');
          td.innerHTML = raw ? `<span title="Atualizado em ${dataStr}">${raw}</span>` : `<span class="muted">—</span>`;
        }
      } else {
        td.innerHTML = `<span class="muted">—</span>`;
      }
      tr.appendChild(td);
    }

    frag.appendChild(tr);
  }

  favBody.appendChild(frag);
  countFavs.textContent = String(count);
  updateFavHeight();
}

function renderGeneral(){
  generalBody.innerHTML = '';
  generalChkMap.clear();
  const frag = document.createDocumentFragment();

  for (const item of allRows){
    const tr = document.createElement('tr');

    // Fav (checkbox)
    const tdFav = document.createElement('td');
    tdFav.className = 'col-fav';
    const chk = document.createElement('input');
    chk.type = 'checkbox';
    chk.checked = favSet.has(item.sku);
    chk.title = 'Marcar como favorito';
    chk.addEventListener('change', ()=>{
      if (chk.checked) favSet.add(item.sku); else favSet.delete(item.sku);
      localStorage.setItem('mm_favs', JSON.stringify(Array.from(favSet)));
      renderAll();
    });
    tdFav.appendChild(chk);
    tr.appendChild(tdFav);
    generalChkMap.set(item.sku, chk);

    // SKU
    const tdSku = document.createElement('td');
    tdSku.className = 'col-sku';
    tdSku.textContent = item.sku;
    tr.appendChild(tdSku);

    // Descrição
    const tdDesc = document.createElement('td');
    tdDesc.className = 'col-desc';
    tdDesc.innerHTML = (item.desc || '').replace(/</g,'&lt;');
    tr.appendChild(tdDesc);

    // Preços
    const { minSite, maxSite } = computeMinMaxForRow(item);
    for (const s of siteOrder) {
      const td = document.createElement('td');
      const d = item.sites[s];
      if (d) {
        const dataStr = d.data ? new Date(d.data).toLocaleString('pt-BR') : '';
        if (Number.isFinite(d.precoNum)) {
          const marked = withMarkup(d.precoNum);
          const cls = (s === minSite) ? 'min' : (s === maxSite ? 'max' : '');
          td.innerHTML = `<span class="price ${cls}" title="Atualizado em ${dataStr}">${formatBRL(marked)}</span>`;
        } else {
          const raw = (d.precoRaw ?? '').toString().replace(/</g,'&lt;');
          td.innerHTML = raw ? `<span title="Atualizado em ${dataStr}">${raw}</span>` : `<span class="muted">—</span>`;
        }
      } else {
        td.innerHTML = `<span class="muted">—</span>`;
      }
      tr.appendChild(td);
    }

    frag.appendChild(tr);
  }

  generalBody.appendChild(frag);
  aplicarFiltros();
  endMarker.style.display = 'block';
}

/* ====== Filtros ====== */
function aplicarFiltros(updateCountsOnly){
  const ean = (eanFilter.value || '').trim().toLowerCase();
  const desc = (descFilter.value || '').trim().toLowerCase();

  let shown = 0;
  for (const tr of generalBody.children){
    const sku = (tr.children[1]?.textContent || '').toLowerCase();
    const dsc = (tr.children[2]?.textContent || '').toLowerCase();
    const ok = (!ean || sku.includes(ean)) && (!desc || dsc.includes(desc));
    tr.style.display = ok ? '' : 'none';
    if (ok) shown++;
  }
  countShown.textContent = String(shown);
  countTotal.textContent = String(generalBody.children.length);
}

/* ====== Redimensionar Favoritos (drag) ====== */
(function initResizer(){
  let startY = 0, startH = 0;
  function onMove(ev){
    const dy = ev.clientY - startY;
    favHeightUser = startH + dy;
    localStorage.setItem('mm_fav_height', String(favHeightUser));
    applyFavHeight(favHeightUser);
  }
  function stop(){
    document.body.classList.remove('resizing');
    window.removeEventListener('mousemove', onMove);
    window.removeEventListener('mouseup', stop);
  }
  favResizer.addEventListener('mousedown', (ev)=>{
    document.body.classList.add('resizing');
    startY = ev.clientY;
    startH = favWrap.getBoundingClientRect().height;
    window.addEventListener('mousemove', onMove);
    window.addEventListener('mouseup', stop);
  });
})();

let favHeightUser = Number(localStorage.getItem('mm_fav_height')) || null;

function applyFavHeight(px){
  if (!px || !Number.isFinite(px)) return;
  const maxPx = Math.round(window.innerHeight * 0.85);
  const clamped = Math.max(FAV_MIN_PX, Math.min(px, maxPx));
  favWrap.style.height = clamped + 'px';
}
function updateFavHeight(){
  if (favHeightUser) { applyFavHeight(favHeightUser); return; }
  const rowsLen = favBody.children.length;
  const rows = Math.min(rowsLen, FAV_AUTO_ROWS_MAX);
  const rowH = measureRowHeight();
  const headH = measureHeadHeight();
  const pad = 8;
  const target = headH + rows * rowH + pad;
  applyFavHeight(target);
}

function measureRowHeight(){
  const probe = document.createElement('tr');
  probe.innerHTML = '<td class="col-fav"></td><td class="col-sku">0000000000000</td><td class="col-desc">X</td>' + '<td></td>'.repeat(siteOrder.length);
  favBody.appendChild(probe);
  const h = Math.max(36, probe.getBoundingClientRect().height);
  favBody.removeChild(probe);
  return h;
}
function measureHeadHeight(){
  const thead = document.querySelector('#favTable thead');
  return Math.max(36, thead.getBoundingClientRect().height);
}

/* ====== Colapsar / Expandir painéis ====== */
function attachToggle(panel, button){
  function setState(expanded){
    panel.classList.toggle('collapsed', !expanded);
    button.textContent = expanded ? 'Minimizar' : 'Maximizar';
    button.setAttribute('aria-expanded', String(expanded));
  }
  button.addEventListener('click', ()=>{
    const isExpanded = button.getAttribute('aria-expanded') === 'true';
    setState(!isExpanded);
  });
  setState(true);
}
attachToggle(favPanel, toggleFavBtn);
attachToggle(generalPanel, toggleGenBtn);

/* ====== Botões ====== */
btnReload.addEventListener('click', async ()=>{ await buscarDados(); });
btnSair.addEventListener('click', async ()=>{
  try { await sb.auth.signOut(); } finally { localStorage.removeItem('mm_login_start'); window.location.href = CFG.SITE_URL || 'index.html'; }
});

eanFilter.addEventListener('input', ()=>aplicarFiltros(true));
descFilter.addEventListener('input', ()=>aplicarFiltros(true));

/* ====== Init ====== */
(async function init(){
  const { data: { session } } = await sb.auth.getSession();
  if (!session) { window.location.href = CFG.SITE_URL || 'index.html'; return; }
  userChip.textContent = session.user?.email || 'Logado';
  enforceMaxSession();
  await buscarDados();
})();
</script>
</body>
</html>
