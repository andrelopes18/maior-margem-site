<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MaiorMargem — Dashboard</title>
<style>
  :root { color-scheme: dark; }
  body { margin:0; font-family: Arial, sans-serif; background:#121212; color:#fff; padding:20px; }
  header { display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; gap:12px; flex-wrap:wrap; }
  h1 { color:#00b140; margin:0; }
  .userbox { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
  .chip { font-size:12px; background:#1e1e1e; border:1px solid #333; padding:6px 10px; border-radius:999px; cursor:default; }
  .chip.plan { color:#bfffc1; border-color:#2f5a2f; background:#132313; }
  .chip.build { color:#bfe3ff; border-color:#2a3b5a; background:#101522; }
  .btn { background:#00b140; color:#fff; border:none; padding:8px 14px; border-radius:6px; cursor:pointer; }
  .btn:hover { background:#009b38; }

  .panel { background:#202020; border:1px solid #2a2a2a; border-radius:12px; padding:12px; margin-bottom:18px; }
  .panel-header { display:flex; align-items:center; justify-content:space-between; gap:12px; }
  .panel-header h2 { margin:0; font-size:18px; color:#d5ffd5; }

  .filters { display:grid; grid-template-columns: 1fr 1fr auto; gap:12px; margin:16px 0; align-items:center; }
  .filters input { padding:10px 12px; border-radius:6px; border:1px solid #333; background:#1e1e1e; color:#fff; }
  .scope { grid-column: 1 / -1; display:flex; gap:18px; align-items:center; color:#cfd8dc; font-size:13px; flex-wrap:wrap; }
  .scope label { display:flex; align-items:center; gap:6px; cursor:pointer; }
  .scope input[type="radio"] { accent-color:#00b140; }

  .status { margin:10px 0; color:#aaa; font-size:12px; }
  .err { display:none; color:#ff5d5d; margin:8px 0; font-size:13px; }

  .wrap { overflow:auto; border:1px solid #2a2a2a; border-radius:10px; position: relative; }
  #generalWrap { height:55vh; }

  .loadbar { position: sticky; top:0; left:0; right:0; height:4px; background:#121212; z-index:5; }
  .loadbar .bar { height:100%; width:0%; background: linear-gradient(90deg,#00b140,#00d084); transition: width .25s ease; }
  .loadbar .bar.done { background:#2f2f2f; }

  table { width:100%; border-collapse:separate; border-spacing:0; }
  thead { position:sticky; top:0; z-index:3; }
  thead th { position:sticky; top:0; background:#0f0f0f; z-index:4; }
  th, td { border-bottom:1px solid #2a2a2a; padding:10px; text-align:left; font-size:14px; vertical-align:top; }
  tbody tr:hover { background:#1a1a1a; }

  .col-fav { width:40px; text-align:center; }
  .col-sku { width:160px; font-family: ui-monospace,Consolas,monospace; }
  .col-desc { min-width:260px; }
  .col-param { width:140px; }

  .price { font-weight:700; display:inline-block; font-size:16px; vertical-align:middle; color:#fff; }
  @media (min-width:1200px){ .price{ font-size:18px; } }
  .price.min { color:#ff4d4f; }
  .price.max { color:#00d084; }
  .price.param { color:#ffd54f; }

  .muted { color:#666; }
  .end-marker { text-align:center; padding:10px; color:#9aa0a6; }
  .counts { margin-top:10px; font-size:12px; color:#9aa0a6; display:flex; gap:12px; flex-wrap:wrap; }

  th[data-locked="true"] { position: relative; color: #aaa; }
  th[data-locked="true"]::after { content:"🔒"; margin-left:6px; opacity:.8; font-size:14px; }

  td.locked-cell { position: relative; }
  td.locked-cell .price { filter: blur(3px); }
  td.locked-cell .unlock {
    position:absolute; left:50%; top:50%; transform: translate(-50%, -50%);
    padding:6px 10px; border-radius:8px; border:1px solid #2e2e2e;
    background:#141414; color:#ddd; font-size:12px;
    cursor:pointer; opacity:0; pointer-events:none; transition: opacity .15s;
    white-space:nowrap;
  }
  td.locked-cell:hover .unlock { opacity:1; pointer-events:auto; }
  td.locked-cell .unlock:hover { background:#1b1b1b; }

  .chart-btn { margin-left:6px; background:transparent; border:0; padding:0; vertical-align:middle; cursor:pointer; }
  .chart-btn svg { width:18px; height:18px; display:block; }
  .chart-btn:hover svg rect { fill:#373737; }
  .chart-btn:active svg path { opacity:.9; }
</style>
<script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<script src="./config.js"></script>
</head>
<body>
<header>
  <h1>MaiorMargem — Dashboard</h1>
  <div class="userbox">
    <span id="buildChip" class="chip build" title="Versão do build">Build: —</span>
    <span id="planChip" class="chip plan">Plano: —</span>
    <span id="userChip" class="chip">Usuário</span>
    <button id="btnSair" class="btn" type="button">Sair</button>
  </div>
</header>

<div class="panel">
  <div class="filters">
    <input id="eanFilter" placeholder="Filtrar por EAN/GTIN…" />
    <input id="descFilter" placeholder="Filtrar por descrição…" />
    <button id="btnReload" class="btn" type="button">Recarregar</button>
    <div class="scope" id="scopeGroup" role="radiogroup" aria-label="Escopo da pesquisa">
      <span>Filtrar em:</span>
      <label><input type="radio" name="scope" value="both" checked> Ambas</label>
      <label><input type="radio" name="scope" value="favorites"> Favoritos</label>
      <label><input type="radio" name="scope" value="general"> Geral</label>
    </div>
  </div>
  <div class="status"><span id="status"></span></div>
  <div id="err" class="err"></div>
</div>

<section id="favPanel" class="panel">
  <div class="panel-header">
    <h2>Favoritos</h2>
    <button id="btnPrintFav" class="toggle-btn" title="Imprimir favoritos" type="button">Imprimir</button>
    <button id="toggleFav" class="toggle-btn" aria-expanded="true" type="button">Minimizar</button>
  </div>
  <div id="favWrap" class="wrap" style="height:280px;">
    <table id="favTable">
      <thead><tr id="favHeaderRow"></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</section>

<section id="generalPanel" class="panel">
  <div class="panel-header">
    <h2>Geral</h2>
    <button id="toggleGen" class="toggle-btn" aria-expanded="true" type="button">Minimizar</button>
  </div>
  <div class="loadbar"><div id="loadBar" class="bar"></div></div>
  <div id="generalWrap" class="wrap">
    <table id="produtosTable">
      <thead><tr id="generalHeaderRow"></tr></thead>
      <tbody></tbody>
    </table>
    <div id="endMarker" class="end-marker"></div>
  </div>
  <div class="counts">
    <span id="countShown"></span>
    <span id="countTotal"></span>
    <span id="countFavs"></span>
  </div>
</section>

<div id="chartPopover" style="display:none; position:fixed; z-index:9998; background:#0f0f0f; border:1px solid #2a2a2a; border-radius:10px; padding:10px; box-shadow:0 10px 30px rgba(0,0,0,.6);">
  <header style="display:flex; align-items:center; justify-content:space-between; margin-bottom:6px;">
    <span id="chartTitle">Histórico</span>
    <button class="btn" id="chartClose" type="button" style="background:#222;">×</button>
  </header>
  <canvas id="spark" width="220" height="180"></canvas>
  <div id="chartMsg" class="msg" style="display:none; font-size:12px; color:#9aa0a6;"></div>
</div>

<script>
/* ========= Build ========= */
const BUILD_VERSION = '2025-09-30 17:20 BRT';
const qBuild = new URLSearchParams(location.search).get('build');

/* ========= Debug ========= */
function dlog(o){ try{ const el=document.getElementById('status'); if(el){ el.textContent=(typeof o==='string'?o:JSON.stringify(o)); } }catch{} }

/* ========= Erros ========= */
const errEl = document.getElementById('err');
function showErr(msg){ errEl.style.display='block'; errEl.textContent=msg; }
function hideErr(){ errEl.style.display='none'; errEl.textContent=''; }

/* ========= Supabase ========= */
const CFG = window.CONFIG || {};
if(!CFG.SUPABASE_URL || !CFG.SUPABASE_ANON_KEY){ showErr('CONFIG ausente (config.js)'); throw new Error('CONFIG ausente'); }
const sb = supabase.createClient(CFG.SUPABASE_URL, CFG.SUPABASE_ANON_KEY, { auth:{ persistSession:true, autoRefreshToken:true, detectSessionInUrl:true }});

/* ========= Elementos ========= */
const buildChip = document.getElementById('buildChip');
const planChip  = document.getElementById('planChip');
const userChip  = document.getElementById('userChip');
const btnSair   = document.getElementById('btnSair');
const btnReload = document.getElementById('btnReload');
const eanFilter = document.getElementById('eanFilter');
const descFilter= document.getElementById('descFilter');
const scopeGroup= document.getElementById('scopeGroup');

const loadBar     = document.getElementById('loadBar');
const generalWrap = document.getElementById('generalWrap');
const generalBody = document.querySelector('#produtosTable tbody');
const generalHeaderRow = document.getElementById('generalHeaderRow');
const endMarker   = document.getElementById('endMarker');

const favBody  = document.querySelector('#favTable tbody');
const favHeaderRow = document.getElementById('favHeaderRow');
const countShown  = document.getElementById('countShown');
const countTotal  = document.getElementById('countTotal');
const countFavs   = document.getElementById('countFavs');

/* ========= Estado ========= */
const DEFAULT_PLAN_SITE_LIMIT = { trial:2, basico:4, intermediario:6, premium:8 };
const VIEW_TABLE    = 'latest_prices_view';   // <- AQUI: lê a VIEW com descrição
const HISTORY_TABLE = 'latest_prices';        // <- gráfico busca no histórico simples
const PAGE_SIZE = 200, RENDER_CHUNK = 60;
const OUTLIER_TOL = 0.50;

/* Escala (se banco veio x1000) */
const qs = new URLSearchParams(location.search);
const PRICE_DIVISOR = (()=>{
  const qd = Number(qs.get('div'));
  const v = Number.isFinite(qd) ? qd : Number(CFG.PRICE_DIVISOR ?? 1000);
  return (Number.isFinite(v) && v>0) ? v : 1;
})();
function scale(n){ return (typeof n==='number' && Number.isFinite(n)) ? (n/PRICE_DIVISOR) : n; }

/* Limite de linhas totais */
const MAX_ROWS = (()=>{
  const qm = Number(qs.get('max'));
  const v = Number.isFinite(qm) ? qm : Number(CFG.MAX_ROWS ?? 1500);
  return (Number.isFinite(v) && v>0) ? v : 1500;
})();

let sessionUserId = null;
let chosen=[], unlocked=new Set(), locked=new Set();

let produtosMap=new Map(), produtosList=[];
let serverOffset=0, serverExhausted=false, fetching=false;
let totalEstimated = null;

let generalView=[], itemsRendered=0;
let favSet = new Set(JSON.parse(localStorage.getItem('mm_favs') || '[]'));
let currentEanQ='', currentDescQ='', searchScope='both';
let sortStateGeneral = { key:'desc', dir:'asc' };
let sortStateFav     = { key:'desc', dir:'asc' };
let columnOrder = [];
const COL_ORDER_KEY = 'mm_col_order';
const generalChkMap=new Map();

/* ========= Utils ========= */
function setStatus(t){ const el=document.getElementById('status'); if(el) el.textContent = t||''; }
function debounce(fn,ms=500){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); } }
function favSave(){ localStorage.setItem('mm_favs', JSON.stringify([...favSet])); }
function isFav(sku){ return favSet.has(String(sku)); }
function formatBRL(n){ try{ return n.toLocaleString('pt-BR',{style:'currency',currency:'BRL'}) }catch{ return String(n) } }
function toNumberFromAny(v){
  if (typeof v === 'number') return Number.isFinite(v) ? v : null;
  if (v == null) return null;
  let s = String(v).trim();
  if (!s) return null;
  s = s.replace(/[^\d.,-]+/g,'');
  const hasComma = s.includes(',');
  if (hasComma){ s = s.replace(/\./g,'').replace(',','.'); }
  const n = Number(s);
  return Number.isFinite(n) ? n : null;
}
function normTokens(s){
  const cleaned = (s||'').toString().normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().replace(/[^a-z0-9]+/g,' ').trim();
  return cleaned ? cleaned.split(/\s+/) : [];
}
function ensureDescIndex(item){
  if (!item) return;
  if (item._descCached === item.desc && item._tok && !item._tokNeeds) return;
  item._descCached = item.desc || '';
  item._tok = normTokens(item._descCached);
  item._tokNeeds = false;
}

/* ========= Cabeçalhos ========= */
function computeDefaultColumnOrder(){ return ['sku','desc','meu_preco', ...chosen.map(c => 'site:' + c.label)]; }
function loadColumnOrder(){
  const saved = (()=>{ try{ return JSON.parse(localStorage.getItem(COL_ORDER_KEY) || '[]'); }catch{ return []; }})();
  const base = computeDefaultColumnOrder();
  const setBase = new Set(base);
  const filtered = saved.filter(k => setBase.has(k));
  const missing = base.filter(k => !filtered.includes(k));
  columnOrder = filtered.concat(missing);
}
function saveColumnOrder(){ localStorage.setItem(COL_ORDER_KEY, JSON.stringify(columnOrder)); }
function titleForKey(key){ if (key==='sku') return 'EAN'; if (key==='desc') return 'Descrição'; if (key==='meu_preco') return 'Meu preço'; if (key.startsWith('site:')) return key.slice(5); return key; }
function siteInfoByLabel(label){ const c = chosen.find(x=>x.label===label); return c ? { site_id:c.site_id, locked: locked.has(c.site_id) } : { site_id:null, locked:false }; }

function buildHeaders(){
  // Geral
  generalHeaderRow.innerHTML = '';
  const thFav = document.createElement('th'); thFav.className='col-fav'; thFav.textContent='★';
  generalHeaderRow.appendChild(thFav);
  for (const key of columnOrder){
    const th=document.createElement('th');
    th.setAttribute('data-sortkey', key);
    th.classList.add('sortable','reorderable');
    th.draggable = true;
    if (key==='sku') th.classList.add('col-sku');
    if (key==='desc') th.classList.add('col-desc');
    if (key==='meu_preco') th.classList.add('col-param');
    if (key.startsWith('site:')){
      const label=key.slice(5);
      const info=siteInfoByLabel(label);
      th.dataset.siteid = String(info.site_id||'');
      th.setAttribute('data-locked', info.locked ? 'true' : 'false');
    }
    th.textContent = titleForKey(key);
    generalHeaderRow.appendChild(th);
  }

  // Favoritos
  favHeaderRow.innerHTML='';
  const thAcao = document.createElement('th'); thAcao.className='col-fav'; thAcao.textContent='Ação';
  favHeaderRow.appendChild(thAcao);
  for (const key of columnOrder){
    const th=document.createElement('th');
    th.setAttribute('data-sortkey', key);
    th.classList.add('sortable','reorderable');
    th.draggable = true;
    if (key==='sku') th.classList.add('col-sku');
    if (key==='desc') th.classList.add('col-desc');
    if (key==='meu_preco') th.classList.add('col-param');
    th.textContent = titleForKey(key);
    favHeaderRow.appendChild(th);
  }

  setupSortableHeaders(generalHeaderRow, 'general');
  setupSortableHeaders(favHeaderRow, 'fav');
  setupReorderableHeaders(generalHeaderRow);
  setupReorderableHeaders(favHeaderRow);
}
function setupSortableHeaders(headerRow, tableKind){
  const ths = Array.from(headerRow.children);
  ths.forEach((th, idx)=>{
    if (idx===0) return;
    const key = th.getAttribute('data-sortkey');
    if (!key) return;
    th.classList.add('sortable');
    th.addEventListener('click', ()=>{
      if (tableKind==='general'){
        sortStateGeneral.dir = (sortStateGeneral.key===key && sortStateGeneral.dir==='asc') ? 'desc' : 'asc';
        sortStateGeneral.key = key;
        applySortGeneral();
        applySortIndicators(headerRow, sortStateGeneral.key, sortStateGeneral.dir);
      } else {
        sortStateFav.dir = (sortStateFav.key===key && sortStateFav.dir==='asc') ? 'desc' : 'asc';
        sortStateFav.key = key;
        renderFavs();
        applySortIndicators(headerRow, sortStateFav.key, sortStateFav.dir);
      }
    });
  });
}
function setupReorderableHeaders(headerRow){
  const ths = Array.from(headerRow.children);
  ths.forEach((th, idx)=>{
    if (idx===0) { th.draggable=false; return; }
    th.addEventListener('dragstart', (ev)=>{
      ev.dataTransfer.setData('text/plain', th.getAttribute('data-sortkey') || '');
      headerRow.querySelectorAll('th').forEach(x=>x.classList.remove('drop-left','drop-right'));
    });
    th.addEventListener('dragover', (ev)=>{
      ev.preventDefault();
      const rect = th.getBoundingClientRect();
      const before = (ev.clientX - rect.left) < rect.width/2;
      th.classList.toggle('drop-left', before);
      th.classList.toggle('drop-right', !before);
    });
    th.addEventListener('dragleave', ()=>{ th.classList.remove('drop-left','drop-right'); });
    th.addEventListener('drop', (ev)=>{
      ev.preventDefault();
      const srcKey = ev.dataTransfer.getData('text/plain');
      const destKey = th.getAttribute('data-sortkey');
      th.classList.remove('drop-left','drop-right');
      if (!srcKey || !destKey || srcKey===destKey) return;

      const rect = th.getBoundingClientRect();
      const placeBefore = (ev.clientX - rect.left) < rect.width/2;

      const arr = columnOrder.slice();
      const srcIdx = arr.indexOf(srcKey);
      const destIdx = arr.indexOf(destKey);
      if (srcIdx===-1 || destIdx===-1) return;
      arr.splice(srcIdx,1);
      const insertAt = destIdx + (placeBefore ? 0 : 1) - (srcIdx < destIdx ? 1 : 0);
      arr.splice(Math.max(0,insertAt),0,srcKey);
      columnOrder = arr;
      saveColumnOrder();

      buildHeaders();
      recomputeGeneralView();
      renderFavs();
    });
  });
}
function applySortIndicators(rowEl, activeKey, dir){
  Array.from(rowEl.children).forEach(th=>{ const ind = th.querySelector('.sort-ind'); if (ind) ind.remove(); });
  const th = rowEl.querySelector(`th[data-sortkey="${CSS.escape(activeKey)}"]`);
  if (!th) return;
  const span = document.createElement('span'); span.className = 'sort-ind'; span.textContent = dir==='asc' ? '▲' : '▼'; th.appendChild(span);
}

/* ========= Plano / sites ========= */
async function getSitesLimitForPlan(planKey){
  const k=(planKey||'').toLowerCase();
  try{
    const { data, error } = await sb.from('billing_plans').select('sites_limit, max_sites').eq('plan_key', k).maybeSingle();
    if (!error){
      const v = Number(data?.sites_limit ?? data?.max_sites);
      if (Number.isFinite(v) && v>0) return v;
    }
  }catch(_){}
  return DEFAULT_PLAN_SITE_LIMIT[k] ?? 2;
}
async function loadUserSelection(userId, planKey){
  dlog({step:'loadUserSelection.start', userId, planKey});

  const rs = await sb.from('user_sites').select('site_id, created_at').eq('user_id', userId);
  if (rs.error){ showErr('Falha ao ler user_sites: '+rs.error.message); throw rs.error; }
  const rows = rs.data || [];
  rows.sort((a,b)=>{
    const ca=a.created_at?new Date(a.created_at).getTime():0; const cb=b.created_at?new Date(b.created_at).getTime():0;
    return ca-cb;
  });

  const siteIdsText = rows.map(r=>String(r.site_id||'')).filter(x=>x.length>0);
  if (!siteIdsText.length){
    chosen=[]; unlocked=new Set(); locked=new Set();
    loadColumnOrder(); buildHeaders();
    setStatus('Nenhum site selecionado em Meus Dados.');
    dlog({step:'loadUserSelection.none'});
    return;
  }

  const siteIds = siteIdsText.map(v => Number(v));
  const rsSites = await sb.from('sites').select('id, nome, url_pesquisa').in('id', siteIds);
  if (rsSites.error){ showErr('Falha ao ler sites: '+rsSites.error.message); throw rsSites.error; }
  const sites = rsSites.data || [];
  const byId=new Map(sites.map(s=>[s.id,s]));
  const ordered=[]; for (const id of siteIds){ const s=byId.get(id); if(s && !ordered.includes(s)) ordered.push(s); }
  if (!ordered.length){ showErr('Sites não encontrados para os IDs do usuário.'); throw new Error('sites missing'); }

  chosen = ordered.map(s=>({ site_id:s.id, label:(s.nome||('Site '+s.id)).toString().trim(), url:(s.url_pesquisa||'').toString() }));

  const lim = await getSitesLimitForPlan(planKey);
  unlocked=new Set(chosen.slice(0,lim).map(c=>c.site_id));
  locked=new Set(chosen.slice(lim).map(c=>c.site_id));

  loadColumnOrder();
  buildHeaders();
  setStatus('Sites: '+chosen.map(c=>c.label).join(' · '));
  dlog({step:'loadUserSelection.done', chosen, unlocked:[...unlocked], locked:[...locked], columnOrder});
}

/* ========= Outliers / filtros ========= */
function analyzeAllItemsOutliers(){
  for (const item of produtosList){
    const nums = [];
    const entries = Object.values(item.sites||{});
    for (const s of entries){
      let v = Number.isFinite(s.precoNum) ? s.precoNum : toNumberFromAny(s.precoRaw);
      if (Number.isFinite(v)) nums.push(scale(v));
    }
    if (nums.length >= 2){
      const mean = nums.reduce((a,b)=>a+b,0)/nums.length;
      const lo = mean*(1-OUTLIER_TOL), hi = mean*(1+OUTLIER_TOL);
      item.analysis = { mean, lo, hi, n:nums.length };
      for (const s of entries){
        let v = Number.isFinite(s.precoNum) ? s.precoNum : toNumberFromAny(s.precoRaw);
        v = Number.isFinite(v) ? scale(v) : NaN;
        s.valid = Number.isFinite(v) && (v >= lo && v <= hi);
      }
    } else {
      item.analysis = { mean: null, lo: null, hi: null, n: nums.length };
      for (const s of entries){
        let v = Number.isFinite(s.precoNum) ? s.precoNum : toNumberFromAny(s.precoRaw);
        s.valid = Number.isFinite(v);
      }
    }
  }
}
function upsertRowsIntoProdutos(rows){
  const allowedById = new Map(chosen.map(c=>[c.site_id, c.label]));
  for (const r of rows){
    if (!allowedById.has(r.site_id)) continue;
    const ean = String(r.ean||'');
    if (!produtosMap.has(ean)) produtosMap.set(ean, { sku:ean, desc:'', meu_preco:null, sites:{} });
    const item = produtosMap.get(ean);
    // Descrição da própria VIEW
    if (!item.desc && r.descricao){ item.desc = String(r.descricao); item._tokNeeds = true; }
    const label = allowedById.get(r.site_id);
    const prev=item.sites[label];
    if (!prev || new Date(r.data) > new Date(prev.data)){
      item.sites[label] = { precoRaw:r.preco, precoNum:r.preco_num, data:r.data, site_id:r.site_id, site_nome:r.site_nome, valid:true };
    }
  }
  produtosList = Array.from(produtosMap.values());
  for (const it of produtosList){ ensureDescIndex(it); }
  analyzeAllItemsOutliers();
}
function matchesFilters(item){
  const qE = (currentEanQ||'').trim();
  if (qE && !String(item.sku||'').includes(qE)) return false;
  const qTokens = normTokens(currentDescQ);
  if (qTokens.length){
    ensureDescIndex(item);
    const words = item._tok || [];
    for (const qt of qTokens){
      let ok = false;
      for (const w of words){ if (w.indexOf(qt) !== -1){ ok = true; break; } }
      if (!ok) return false;
    }
  }
  return true;
}

/* ========= URL por site ========= */
function buildSearchUrlByLabel(label, ean){
  const c = chosen.find(x => x.label === label);
  if (!c || !c.url) return null;
  const tpl = String(c.url);
  const enc = encodeURIComponent(String(ean||''));
  return tpl.replace(/{ean}/gi, enc);
}

/* ========= Células ========= */
function chartButtonSVG(){ return '<svg class="chart-icon" viewBox="0 0 24 24" aria-hidden="true">'
  +'<rect x="3" y="11" width="3" height="7" rx="1" fill="#2d2d2d" stroke="#3b3b3b" stroke-width="1"></rect>'
  +'<rect x="9" y="8"  width="3" height="10" rx="1" fill="#2d2d2d" stroke="#3b3b3b" stroke-width="1"></rect>'
  +'<rect x="15" y="5" width="3" height="13" rx="1" fill="#2d2d2d" stroke="#3b3b3b" stroke-width="1"></rect>'
  +'<path d="M3,18 L7,14 L12,15 L17,8 L21,10" fill="none" stroke="#00d084" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"></path>'
  +'</svg>'; }
function computeMinMaxForRow(item){
  let min={label:null,val:Infinity}, max={label:null,val:-Infinity};
  for (const c of chosen){
    if (locked.has(c.site_id)) continue;
    const d=item.sites[c.label];
    if (!d || !d.valid) continue;
    let v = Number.isFinite(d.precoNum) ? d.precoNum : toNumberFromAny(d.precoRaw);
    if (!Number.isFinite(v)) continue;
    v = scale(v);
    if (v<min.val) min={label:c.label,val:v};
    if (v>max.val) max={label:c.label,val:v};
  }
  return { min:min.label, max:max.label };
}
function createPriceCell(item, label, isLocked, minLabel, maxLabel){
  const td=document.createElement('td'); if (isLocked) td.classList.add('locked-cell'); const d=item.sites[label];
  if (!d){ td.innerHTML='<span class="muted">—</span>'; return td; }
  const dtStr=d.data?new Date(d.data).toLocaleString('pt-BR'):'';
  const url = buildSearchUrlByLabel(label, item.sku);
  if (!d.valid){ td.innerHTML='<span class="price" title="Fora de faixa">—</span>'; return td; }
  let valueNum = Number.isFinite(d.precoNum) ? d.precoNum : toNumberFromAny(d.precoRaw);
  if (Number.isFinite(valueNum)) valueNum = scale(valueNum);
  const cls = (!isLocked&&label===minLabel?'min':(!isLocked&&label===maxLabel?'max':'')) || '';
  const priceSpan=document.createElement('span'); priceSpan.className='price '+cls;
  priceSpan.title=isLocked?'Excedeu o limite do plano':(dtStr?('Atualizado em '+dtStr):'');
  priceSpan.textContent = Number.isFinite(valueNum) ? formatBRL(valueNum) : String(d.precoRaw ?? '—');
  if (!isLocked && url){ const a=document.createElement('a'); a.href=url; a.target="_blank"; a.rel="noopener noreferrer"; a.className='price-link'; a.title='Abrir no site'; a.appendChild(priceSpan); td.appendChild(a); }
  else td.appendChild(priceSpan);
  const b=document.createElement('button'); b.className='chart-btn'; b.type='button'; b.title=isLocked?'Disponível no upgrade':'Ver histórico'; b.innerHTML=chartButtonSVG();
  const c=chosen.find(x=>x.label===label); b.addEventListener('click',(ev)=>{ if(isLocked){location.href='planos.html';return;} openChartFor(ev,item.sku,label,c?.site_id); }); td.appendChild(b);
  if (isLocked){ const up=document.createElement('button'); up.className='unlock'; up.type='button'; up.textContent='Ver planos'; up.addEventListener('click',()=>location.href='planos.html'); td.appendChild(up); }
  return td;
}
function createParamCell(item){
  const td=document.createElement('td'); td.className='col-param';
  const n=(typeof item.meu_preco==='number')?item.meu_preco:null;
  if (n!=null && Number.isFinite(n)){ const span=document.createElement('span'); span.className='price param'; span.title='Meu preço'; span.textContent=formatBRL(n); td.appendChild(span); }
  else { td.innerHTML='<span class="muted">—</span>'; }
  return td;
}

/* ========= Ordenação ========= */
function getValueForKey(item, key){
  if (key==='sku') return item.sku || '';
  if (key==='desc') return item.desc || '';
  if (key==='meu_preco') return (typeof item.meu_preco==='number') ? item.meu_preco : null;
  if (key.startsWith('site:')){
    const label = key.slice(5);
    const d = item.sites?.[label];
    let v = d ? (Number.isFinite(d.precoNum) ? d.precoNum : toNumberFromAny(d.precoRaw)) : null;
    v = Number.isFinite(v) ? scale(v) : null;
    return v;
  }
  return null;
}
function makeComparator(key, dir){
  const mul = (dir==='desc') ? -1 : 1;
  const coll = new Intl.Collator('pt-BR',{numeric:true,sensitivity:'base'});
  return (a,b)=>{
    const va = getValueForKey(a, key);
    const vb = getValueForKey(b, key);
    const aNull = (va==null || va==='');
    const bNull = (vb==null || vb==='');
    if (aNull && bNull) return 0;
    if (aNull) return 1 * mul;
    if (bNull) return -1 * mul;
    if (typeof va === 'number' && typeof vb === 'number') return (va===vb?0: (va<vb?-1:1)) * mul;
    return coll.compare(String(va), String(vb)) * mul;
  };
}
function applySortGeneral(){ if (sortStateGeneral.key){ generalView.sort(makeComparator(sortStateGeneral.key, sortStateGeneral.dir)); } resetGeneralDom(); renderGeneralChunk(); }
function applySortIndicators(rowEl, activeKey, dir){
  Array.from(rowEl.children).forEach(th=>{ const ind = th.querySelector('.sort-ind'); if (ind) ind.remove(); });
  const th = rowEl.querySelector(`th[data-sortkey="${CSS.escape(activeKey)}"]`);
  if (!th) return;
  const span = document.createElement('span'); span.className = 'sort-ind'; span.textContent = dir==='asc' ? '▲' : '▼'; th.appendChild(span);
}

/* ========= View (Geral) ========= */
function recomputeGeneralView(){
  generalView = (searchScope==='both' || searchScope==='general') ? produtosList.filter(matchesFilters) : produtosList.slice();
  if (sortStateGeneral.key){ generalView.sort(makeComparator(sortStateGeneral.key, sortStateGeneral.dir)); }
  resetGeneralDom();
  renderGeneralChunk();
}
function renderGeneralChunk(){
  const end=Math.min(itemsRendered+RENDER_CHUNK, generalView.length);
  const frag=document.createDocumentFragment();
  for(let i=itemsRendered;i<end;i++){
    const it=generalView[i];
    const tr=document.createElement('tr');
    renderRowIntoGeneral(tr,it);
    frag.appendChild(tr);
  }
  generalBody.appendChild(frag);
  itemsRendered=end;
  endMarker.textContent=(serverExhausted && itemsRendered>=generalView.length)?'Fim da lista':'';
  updateCounts();
}
function resetGeneralDom(){ generalBody.innerHTML=''; itemsRendered=0; endMarker.textContent=''; }

/* ========= Scroll / Paginação/limite ========= */
generalWrap.addEventListener('scroll', ()=>{
  const nearBottom = generalWrap.scrollTop + generalWrap.clientHeight >= generalWrap.scrollHeight - 100;
  if (nearBottom && itemsRendered < generalView.length){ renderGeneralChunk(); }
  if (nearBottom && !serverExhausted && !fetching){ fetchNextPage(); }
});

/* ========= Linhas ========= */
function renderRowIntoGeneral(tr,item){
  const tdFav=document.createElement('td'); tdFav.className='col-fav';
  const chk=document.createElement('input'); chk.type='checkbox'; chk.checked=isFav(item.sku);
  chk.addEventListener('change',()=>{ if(chk.checked){ favSet.add(item.sku); } else { favSet.delete(item.sku); } favSave(); renderFavs(); updateCounts(); });
  tdFav.appendChild(chk); tr.appendChild(tdFav); generalChkMap.set(item.sku, chk);

  const {min,max}=computeMinMaxForRow(item);

  for (const key of columnOrder){
    if (key==='sku'){ const td=document.createElement('td'); td.className='col-sku'; td.textContent=item.sku; tr.appendChild(td); continue; }
    if (key==='desc'){ const td=document.createElement('td'); td.className='col-desc'; td.textContent=item.desc || '—'; tr.appendChild(td); continue; }
    if (key==='meu_preco'){ tr.appendChild(createParamCell(item)); continue; }
    if (key.startsWith('site:')){
      const label=key.slice(5);
      const c=chosen.find(x=>x.label===label);
      tr.appendChild(createPriceCell(item, label, c?locked.has(c.site_id):false, min, max));
    }
  }
}
function itemMatchesFavScope(item){ if (!(searchScope==='both' || searchScope==='favorites')) return true; return matchesFilters(item); }
function renderFavs(){
  favBody.innerHTML='';
  let favList = produtosList.filter(p=>isFav(p.sku)).filter(itemMatchesFavScope);
  if (sortStateFav.key){ favList.sort(makeComparator(sortStateFav.key, sortStateFav.dir)); }
  const frag=document.createDocumentFragment();
  for (const item of favList){
    const tr=document.createElement('tr');
    const tdAct=document.createElement('td'); tdAct.className='col-fav';
    const btn=document.createElement('button'); btn.title='Remover'; btn.textContent='🗑️'; btn.type='button';
    btn.addEventListener('click',()=>{ favSet.delete(item.sku); favSave(); const chk=generalChkMap.get(item.sku); if(chk){ chk.checked=false; } renderFavs(); updateCounts(); });
    tdAct.appendChild(btn); tr.appendChild(tdAct);
    const {min,max}=computeMinMaxForRow(item);
    for (const key of columnOrder){
      if (key==='sku'){ const td=document.createElement('td'); td.className='col-sku'; td.textContent=item.sku; tr.appendChild(td); continue; }
      if (key==='desc'){ const td=document.createElement('td'); td.className='col-desc'; td.textContent=item.desc || '—'; tr.appendChild(td); continue; }
      if (key==='meu_preco'){ tr.appendChild(createParamCell(item)); continue; }
      if (key.startsWith('site:')){
        const label=key.slice(5);
        const c=chosen.find(x=>x.label===label);
        tr.appendChild(createPriceCell(item, label, c?locked.has(c.site_id):false, min, max));
      }
    }
    frag.appendChild(tr);
  }
  favBody.appendChild(frag);
}

/* ========= Contadores & Progresso ========= */
function updateCounts(){
  const loaded = produtosList.length;
  countShown.textContent = 'Exibindo ' + itemsRendered + ' de ' + generalView.length + ' no Geral';
  if (serverExhausted){ countTotal.textContent = 'Total carregado: ' + loaded; loadBar.style.width = '100%'; loadBar.classList.add('done'); }
  else {
    if (typeof totalEstimated === 'number' && totalEstimated > 0){
      const pct = Math.min(1, loaded / Math.max(totalEstimated, MAX_ROWS));
      loadBar.style.width = (pct*100).toFixed(1) + '%'; loadBar.classList.remove('done');
      countTotal.textContent  = 'Carregando… (' + loaded + ' de ~' + Math.min(totalEstimated, MAX_ROWS) + ')';
    } else { loadBar.style.width = '35%'; loadBar.classList.remove('done'); countTotal.textContent  = 'Carregando… (' + loaded + '+ )'; }
  }
  countFavs.textContent  = 'Favoritos: ' + favSet.size;
}

/* ========= Query / paginação ========= */
function buildQuery(){
  const SITE_IDS = chosen.map(c=>c.site_id);
  return sb.from(VIEW_TABLE).select('ean, site_id, site_nome, preco, data, preco_num, descricao', { count:'estimated' })
           .in('site_id', SITE_IDS.length ? SITE_IDS : [-1])
           .order('ean', { ascending:true });
}

/* ========= Fetch ========= */
async function fetchNextPage(){
  if (fetching || serverExhausted) return; fetching = true; hideErr();
  setStatus('Carregando… (offset ' + serverOffset + ')');
  try{
    // respeita o limite máximo
    if (serverOffset >= MAX_ROWS){ serverExhausted = true; setStatus('Limite de itens atingido ('+MAX_ROWS+').'); updateCounts(); return; }

    const from=serverOffset, to=Math.min(serverOffset+PAGE_SIZE-1, MAX_ROWS-1);
    const { data, error, status, count } = await buildQuery().range(from,to);
    if (typeof count === 'number' && count >= 0 && totalEstimated == null){ totalEstimated = count; }

    if (error){
      if ((status===416) || /Requested range not satisfiable/i.test(error.message||'')) {
        serverExhausted = true; setStatus('Todos os dados carregados.'); endMarker.textContent='Fim da lista'; updateCounts(); return;
      }
      showErr('Falha ao carregar dados: '+(error.message||String(error))+' [code: '+(error.code||status||'?')+']');
      serverExhausted = true;
      return;
    }
    if (!data || data.length===0){
      serverExhausted = true; setStatus('Todos os dados carregados.');
      if (itemsRendered >= generalView.length) endMarker.textContent = 'Fim da lista';
    } else {
      upsertRowsIntoProdutos(data);
      recomputeGeneralView();
      renderFavs();
      serverOffset += (to-from+1);
      setStatus('Carregados (parcial): ' + produtosList.length + ' SKUs');
    }
  }catch(e){
    showErr('Falha ao carregar dados: '+(e.message||String(e)));
    serverExhausted = true;
  } finally { fetching=false; updateCounts(); }
}

/* ========= Reset ========= */
function resetAndQuery(){
  produtosMap.clear(); produtosList=[]; serverOffset=0; serverExhausted=false;
  totalEstimated=null; generalView=[]; generalBody.innerHTML=''; endMarker.textContent='';
  renderFavs(); updateCounts(); fetchNextPage();
}

/* ========= Gráfico ========= */
const spark=document.getElementById('spark'), sparkCtx=spark.getContext('2d');
document.getElementById('chartClose').addEventListener('click', ()=> document.getElementById('chartPopover').style.display='none');
addEventListener('click', (ev)=>{ const pop=document.getElementById('chartPopover'); if(pop.style.display!=='none' && !pop.contains(ev.target) && !ev.target.closest('.chart-btn')) pop.style.display='none'; });
function drawSpark(points){
  const ctx=sparkCtx,W=spark.width,H=spark.height; ctx.clearRect(0,0,W,H);
  if(!points || points.length<3){ document.getElementById('chartMsg').style.display='block'; document.getElementById('chartMsg').textContent='Histórico insuficiente (≥3 pontos).'; return; }
  document.getElementById('chartMsg').style.display='none';
  const m={l:40,r:14,t:12,b:28}, xs=points.map(p=>p.x.getTime()), ys=points.map(p=>p.y);
  const xMin=Math.min(...xs), xMax=Math.max(...xs), yMin=Math.min(...ys), yMax=Math.max(...ys);
  const xS=v=>m.l+((v-xMin)/(xMax-xMin||1))*(W-m.l-m.r);
  const yR=v=>H-m.b-((v-yMin)/(yMax-yMin||1))*(H-m.t-m.b);
  const yS=v=>Math.max(m.t+6, Math.min(H-m.b-6, yR(v)));
  ctx.strokeStyle='#232323'; ctx.lineWidth=1; ctx.beginPath();
  for(let i=0;i<=3;i++){ const yy=m.t+i*(H-m.t-m.b)/3; ctx.moveTo(m.l,yy); ctx.lineTo(W-m.r,yy); } ctx.stroke();
  ctx.beginPath(); ctx.lineWidth=3; ctx.strokeStyle='#00d084';
  points.forEach((p,i)=>{ const X=xS(p.x.getTime()), Y=yS(p.y); if(i===0) ctx.moveTo(X,Y); else ctx.lineTo(X,Y); }); ctx.stroke();
  ctx.fillStyle='#00d084'; points.forEach(p=>{ const X=xS(p.x.getTime()), Y=yS(p.y); ctx.beginPath(); ctx.arc(X,Y,2.5,0,Math.PI*2); ctx.fill(); });
  ctx.fillStyle='#9aa0a6'; ctx.font='10px Arial'; ctx.fillText(new Date(xMin).toLocaleDateString('pt-BR'), m.l, H-8); ctx.fillText(new Date(xMax).toLocaleDateString('pt-BR'), W-m.r-64, H-8);
}
async function fetchHistory(ean, siteId){
  let pts=[];
  try{
    const { data } = await sb.from(HISTORY_TABLE).select('data, preco_num').eq('ean', ean).eq('site_id', siteId).not('preco_num','is',null).order('data',{ascending:true}).limit(180);
    if (data && data.length){ pts = data.map(r=>({ x:new Date(r.data), y: scale(Number(r.preco_num)) })).filter(p=>Number.isFinite(p.y)); }
  }catch(_){}
  const byTs = new Map(pts.map(p=>[p.x.getTime(), p])); return Array.from(byTs.values()).sort((a,b)=>a.x-b.x);
}
async function openChartFor(ev, ean, label, siteId){
  const pop=document.getElementById('chartPopover');
  const x = ev.clientX || 120, y = ev.clientY || 80;
  pop.style.left = Math.max(12, x - 260) + 'px'; pop.style.top  = Math.max(12, y - 200) + 'px';
  document.getElementById('chartTitle').textContent = 'Histórico — ' + label + ' • EAN ' + ean; pop.style.display='block'; document.getElementById('chartMsg').style.display='none';
  const points = await fetchHistory(String(ean), Number(siteId)); drawSpark(points);
}

/* ========= Filtros / escopo ========= */
function initScopeRadios(){
  const radios=scopeGroup.querySelectorAll('input[name="scope"]');
  radios.forEach(r=>{
    r.addEventListener('change', ()=>{
      if(!r.checked) return;
      searchScope=r.value; recomputeGeneralView(); renderFavs(); updateCounts();
    });
  });
}
const onFilterInput = debounce(()=>{
  currentEanQ = (eanFilter.value||'').trim();
  currentDescQ = (descFilter.value||'').trim();
  recomputeGeneralView(); renderFavs(); updateCounts();
}, 300);
eanFilter.addEventListener('input', onFilterInput);
descFilter.addEventListener('input', onFilterInput);

/* ========= Sessão ========= */
async function initUserAndSites(){
  const { data:{ session } } = await sb.auth.getSession();
  if (!session){ location.href = CFG.SITE_URL || 'index.html'; return; }
  sessionUserId = session.user?.id || null;
  userChip.textContent = session.user?.email || 'Logado';
  buildChip.textContent = 'Build: ' + (qBuild || BUILD_VERSION);

  let planKey='basico';
  try{
    const rs = await sb.from('profiles').select('plan').eq('id', session.user.id).maybeSingle();
    if (!rs.error){
      const raw = (rs.data?.plan ?? 'basico').toString();
      planKey = raw.toLowerCase();
      planChip.textContent = 'Plano: ' + (raw.charAt(0).toUpperCase()+raw.slice(1));
    }
  }catch(_){}

  await loadUserSelection(session.user.id, planKey);
}

/* ========= UI ========= */
btnSair.addEventListener('click', async ()=>{ try{ await sb.auth.signOut(); } finally{ localStorage.removeItem('mm_login_date'); location.href = CFG.SITE_URL || 'index.html'; }});
btnReload.addEventListener('click', async ()=>{ await initUserAndSites(); resetAndQuery(); });

/* ========= Start ========= */
(async function init(){
  try{
    await initUserAndSites();
    initScopeRadios();
    loadColumnOrder(); buildHeaders();
    resetAndQuery();
  }catch(e){ showErr('Falha na inicialização'); }
})();
</script>
</body>
</html>
