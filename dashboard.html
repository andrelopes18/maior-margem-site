<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MaiorMargem - Tabela de Produtos</title>
<style>
  body { margin:0; font-family: Arial, sans-serif; background-color:#121212; color:white; padding:20px; }
  header { display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; }
  h1 { color:#00b140; margin:0; }
  .userbox { display:flex; gap:12px; align-items:center; }
  .chip { font-size:12px; background:#1e1e1e; border:1px solid #333; padding:6px 10px; border-radius:999px; }
  .btn { background:#00b140; color:#fff; border:none; padding:8px 14px; border-radius:6px; cursor:pointer; }
  .btn:hover { background:#009b38; }
  .filters { display:flex; gap:20px; margin:16px 0; }
  .filters input { padding:8px; border-radius:5px; border:1px solid #333; background-color:#1e1e1e; color:white; flex:1; }
  table { width:100%; border-collapse:collapse; background-color:#1e1e1e; }
  th, td { padding:10px; border-bottom:1px solid #333; text-align:center; }
  th { background-color:#222; color:#00b140; position:sticky; top:0; z-index:2; }
  tr:hover { background-color:#2a2a2a; }
  .checkbox-container { display:flex; justify-content:center; align-items:center; }
  .checkbox-container input { appearance:none; width:18px; height:18px; border:2px solid #00b140; border-radius:4px; background:transparent; cursor:pointer; position:relative; }
  .checkbox-container input:checked { background:#00b140; }
  .checkbox-container input:checked::after { content:'✔'; color:white; font-size:14px; position:absolute; top:-2px; left:2px; }
  .status { font-size:12px; color:#aaa; margin:10px 0 0; }
  .error { color:#ff7b7b; white-space:pre-wrap; font-size:12px; margin:8px 0 0; }
</style>
</head>
<body>

<header>
  <h1>Produtos Monitorados</h1>
  <div class="userbox">
    <span id="userChip" class="chip">Autenticando…</span>
    <button id="btnSair" class="btn">Sair</button>
  </div>
</header>

<div class="filters">
  <input type="text" id="eanFilter" placeholder="Pesquisar por EAN">
  <input type="text" id="descFilter" placeholder="Pesquisar por Descrição">
</div>

<table id="produtosTable">
  <thead>
    <tr>
      <th>Selecionar</th>
      <th>SKU</th>
      <th>Descrição</th>
      <th>LeroyMerlin</th>
      <th>QueroQuero</th>
      <th>Cassol</th>
      <th>RedeMac</th>
      <th>MestreTinho</th>
      <th>Tumelero</th>
      <th>Supremeinox</th>
      <th>Ghaus</th>
    </tr>
  </thead>
  <tbody>
    <!-- Linhas via JS -->
  </tbody>
</table>

<p id="status" class="status"></p>
<pre id="err" class="error" style="display:none;"></pre>

<!-- 1) Config central (sem barra, mesmo nível) -->
<script src="config.js?v=5"></script>
<!-- 2) Supabase -->
<script src="https://unpkg.com/@supabase/supabase-js"></script>
<script>
/* ====== CONFIG ====== */
const CFG = window.CONFIG || {};
const SUPABASE_URL = CFG.SUPABASE_URL;
const SUPABASE_ANON_KEY = CFG.SUPABASE_ANON_KEY;
if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
  alert("Erro de configuração: config.js não carregado.");
  throw new Error("CONFIG ausente");
}
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
});

/* ====== UI ====== */
const statusEl = document.getElementById('status');
const errEl = document.getElementById('err');
const userChip = document.getElementById('userChip');
const btnSair = document.getElementById('btnSair');
const tableBody = document.querySelector("#produtosTable tbody");
const eanFilter = document.getElementById("eanFilter");
const descFilter = document.getElementById("descFilter");

function setStatus(t){ statusEl.textContent = t || ''; }
function showErr(e){ errEl.style.display='block'; errEl.textContent = String(e||'').trim(); }
function hideErr(){ errEl.style.display='none'; errEl.textContent=''; }

/* ====== MAPAS E ESTADO ====== */
const NOME_TABELA = "Precos";
const siteMap = {
  "PrecoLeroyMerlin": "LeroyMerlin",
  "PrecoQueroQuero": "QueroQuero",
  "PrecoCassol": "Cassol",
  "PrecoRedeMac": "RedeMac",
  "PrecoMestreTinho": "MestreTinho",
  "PrecoTumelero": "Tumelero",
  "PrecoSupremeinox": "Supremeinox",
  "PrecoGhaus": "Ghaus"
};
let produtos = [];
let produtosFiltrados = [];
let itemsPerLoad = 30;
let itemsLoaded = 0;

/* ====== PROTEÇÃO: exigir login ====== */
async function ensureAuth() {
  setStatus('Verificando autenticação…');
  const { data: { session }, error } = await sb.auth.getSession();
  if (error) { showErr('auth.getSession: ' + error.message); }
  if (!session || !session.user) {
    // não logado: volta para a home/login
    window.location.href = (CFG.SITE_URL || 'index.html');
    return null;
  }
  userChip.textContent = `Logado: ${session.user.email || 'usuário'}`;
  setStatus('');
  return session;
}

/* ====== BUSCA (via supabase-js, respeita RLS) ====== */
async function buscarDados() {
  setStatus('Carregando dados…');
  hideErr();
  // Busca os campos necessários; RLS precisa permitir SELECT para "authenticated"
  const { data, error } = await sb
    .from(NOME_TABELA)
    .select('ean, site, preco, data')         // ajuste se houver outros campos
    .order('data', { ascending: false })
    .limit(5000); // sanidade (ajuste se necessário)

  if (error) {
    showErr('select Precos: ' + error.message);
    setStatus('Falha ao carregar.');
    return;
  }
  const agrupado = {};
  for (const reg of data) {
    const ean = String(reg.ean ?? '');
    const site = String(reg.site ?? '');
    const preco = reg.preco;
    const data = reg.data;

    if (!agrupado[ean]) agrupado[ean] = { sku: ean, desc: "", sites: {} };

    const htmlSiteName = siteMap[site];
    if (htmlSiteName) {
      const prev = agrupado[ean].sites[htmlSiteName];
      if (!prev || new Date(data) > new Date(prev.data)) {
        agrupado[ean].sites[htmlSiteName] = { preco, data };
      }
    }
  }
  produtos = Object.values(agrupado);
  produtosFiltrados = [...produtos];
  renderTable(true);
  setStatus(`Carregado: ${produtos.length} SKUs`);
}

/* ====== RENDER ====== */
function renderTable(reset=false) {
  if (reset) {
    tableBody.innerHTML = "";
    itemsLoaded = 0;
  }
  const nextItems = produtosFiltrados.slice(itemsLoaded, itemsLoaded + itemsPerLoad);
  const rows = nextItems.map(prod => `
    <tr>
      <td class="checkbox-container"><input type="checkbox"></td>
      <td>${prod.sku}</td>
      <td>${prod.desc}</td>
      <td>${prod.sites["LeroyMerlin"]?.preco ?? ""}</td>
      <td>${prod.sites["QueroQuero"]?.preco ?? ""}</td>
      <td>${prod.sites["Cassol"]?.preco ?? ""}</td>
      <td>${prod.sites["RedeMac"]?.preco ?? ""}</td>
      <td>${prod.sites["MestreTinho"]?.preco ?? ""}</td>
      <td>${prod.sites["Tumelero"]?.preco ?? ""}</td>
      <td>${prod.sites["Supremeinox"]?.preco ?? ""}</td>
      <td>${prod.sites["Ghaus"]?.preco ?? ""}</td>
    </tr>
  `).join('');
  tableBody.insertAdjacentHTML('beforeend', rows);
  itemsLoaded += nextItems.length;
}

/* ====== FILTROS ====== */
function filterTable() {
  const eanVal = eanFilter.value.trim().toLowerCase();
  const descVal = descFilter.value.trim().toLowerCase();
  produtosFiltrados = produtos.filter(prod =>
    String(prod.sku).toLowerCase().includes(eanVal) &&
    String(prod.desc).toLowerCase().includes(descVal)
  );
  renderTable(true);
}
eanFilter.addEventListener("input", filterTable);
descFilter.addEventListener("input", filterTable);

/* ====== SCROLL INFINITO ====== */
window.addEventListener("scroll", () => {
  if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 200) {
    if (itemsLoaded < produtosFiltrados.length) renderTable();
  }
});

/* ====== Logout ====== */
btnSair.addEventListener('click', async ()=>{
  await sb.auth.signOut();
  window.location.href = CFG.SITE_URL || 'index.html';
});

/* ====== Init ====== */
(async function init(){
  const session = await ensureAuth();
  if (!session) return;
  await buscarDados();
})();
</script>
</body>
</html>
