<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MaiorMargem - Tabela de Produtos</title>
<style>
  :root { color-scheme: dark; }
  body { margin:0; font-family: Arial, sans-serif; background-color:#121212; color:white; padding:20px; }
  header { display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; gap:12px; flex-wrap:wrap; }
  h1 { color:#00b140; margin:0; }

  .userbox { display:flex; gap:12px; align-items:center; position: relative; }
  .chip { font-size:12px; background:#1e1e1e; border:1px solid #333; padding:6px 10px; border-radius:999px; cursor:default; }
  .chip.plan { color:#bfffc1; border-color:#2f5a2f; background:#132313; }
  .btn { background:#00b140; color:#fff; border:none; padding:8px 14px; border-radius:6px; cursor:pointer; }
  .btn:hover { background:#009b38; }

  /* Dropdown do usu√°rio */
  .userChipWrap { position: relative; display:inline-block; }
  .dropdown {
    position: absolute;
    right: 0;
    top: calc(100% + 6px);
    display: none;
    min-width: 180px;
    padding: 6px;
    background: #0f0f0f;
    border: 1px solid #2a2a2a;
    border-radius: 10px;
    box-shadow: 0 10px 30px rgba(0,0,0,.5);
    z-index: 50;
  }
  .userChipWrap:hover .dropdown,
  .userChipWrap.open .dropdown { display: block; }
  .dd-item {
    width: 100%;
    background: transparent;
    border: none;
    color: #eee;
    text-align: left;
    padding: 10px 12px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
  }
  .dd-item:hover { background: #1b1b1b; }

  /* Pain√©is */
  .panel { background:#202020; border:1px solid #2a2a2a; border-radius:12px; padding:12px; margin-bottom:18px; }
  .panel-header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px; }
  .panel-header h2 { margin:0; font-size:18px; color:#d5ffd5; }
  .toggle-btn { background:none; border:1px solid #2a2a2a; color:#ddd; padding:6px 10px; border-radius:8px; cursor:pointer; }
  .toggle-btn:hover { background:#1b1b1b; }

  .filters { display:grid; grid-template-columns: 1fr 1fr auto; gap:12px; margin:16px 0; }
  .filters input { padding:10px 12px; border-radius:6px; border:1px solid #333; background-color:#1e1e1e; color:white; }
  .status { margin:10px 0; color:#aaa; font-size:12px; }
  .err { display:none; color:#ff5d5d; margin:8px 0; font-size:13px; }

  .wrap { overflow:auto; border:1px solid #2a2a2a; border-radius:10px; }
  #generalWrap { height: 55vh; }

  table { width:100%; border-collapse: collapse; }
  thead th { position:sticky; top:0; background:#0f0f0f; z-index:1; }
  th, td { border-bottom:1px solid #2a2a2a; padding:10px; text-align:left; font-size:14px; vertical-align:top; }
  tbody tr:hover { background:#1a1a1a; }

  .col-fav { width:40px; text-align:center; }
  .col-sku { width:160px; font-family: ui-monospace,Consolas,monospace; }
  .col-desc { min-width:260px; }
  .price { font-weight:700; display:inline-block; font-size:16px; vertical-align:middle; }
  @media (min-width: 1200px) { .price { font-size:18px; } }
  .price.min { color:#ff4d4f; }
  .price.max { color:#00d084; }
  .muted { display:none; }
  .end-marker { text-align:center; padding:10px; color:#9aa0a6; }

  .counts { margin-top:10px; font-size:12px; color:#9aa0a6; display:flex; gap:12px; flex-wrap:wrap; }

  .panel.collapsed .wrap { display:none; }
  .panel.collapsed .counts { display:none; }
  .panel.collapsed .resizer { display:none; }

  .resizer {
    height: 10px; margin-top: 6px; border: 1px solid #2a2a2a; border-radius: 8px;
    cursor: ns-resize; background: linear-gradient(180deg, #1c1c1c, #111);
    display:flex; align-items:center; justify-content:center;
  }
  .resizer:after { content: ""; width: 40px; height: 3px; border-radius: 3px; background: #3a3a3a; }
  body.resizing, body.resizing * { cursor: ns-resize !important; user-select: none; }

  /* Bot√£o do gr√°fico ‚Äì mais encorpado/vis√≠vel */
  .chart-btn {
    display:inline-flex; align-items:center; justify-content:center;
    width:28px; height:28px; margin-left:8px; border-radius:6px;
    border:1.5px solid #2e2e2e; background:#141414; color:#dcdcdc;
    cursor:pointer; box-shadow: 0 2px 6px rgba(0,0,0,.35);
  }
  .chart-btn:hover { background:#1b1b1b; border-color:#3a3a3a; }
  .chart-btn:active { transform: translateY(1px); }

  .chart-icon { width:16px; height:16px; display:block; }

  /* Popover do gr√°fico */
  .chart-popover {
    position:absolute; z-index:1000; width:240px; padding:10px;
    background:#0f0f0f; border:1px solid #2a2a2a; border-radius:10px;
    box-shadow: 0 10px 40px rgba(0,0,0,.6);
  }
  .chart-popover header {
    font-size:12px; color:#b5b5b5; display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;
  }
  .chart-popover .close {
    background:transparent; border:none; color:#aaa; font-size:16px; cursor:pointer;
  }
  .chart-popover .msg {
    font-size:12px; color:#bbb; padding:8px; text-align:center;
  }
  /* Canvas um pouco menor para abrir espa√ßo aos r√≥tulos */
  canvas.spark {
    width:200px; height:180px; display:block; background:#121212; border:1px solid #232323; border-radius:6px;
  }

  /* ===== Bloqueio por plano ===== */
  th[data-locked="true"] {
    position: relative;
    color: #aaa;
  }
  th[data-locked="true"]::after {
    content: "üîí";
    margin-left: 6px;
    opacity: .8;
    font-size: 14px;
  }
  td.locked-cell .price {
    filter: blur(6px);           /* modo padr√£o: desfocar */
  }
  td.locked-cell .masked {
    letter-spacing: 1px;         /* usado se optar por m√°scara em vez de blur */
  }
  td.locked-cell .unlock {
    display:inline-flex; align-items:center; gap:6px;
    margin-left:8px; padding:4px 8px; border-radius:6px;
    border:1px solid #2e2e2e; background:#141414; color:#ddd; font-size:12px; cursor:pointer;
  }
  td.locked-cell .unlock:hover { background:#1b1b1b; }
</style>
<script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<script src="./config.js"></script>
</head>
<body>
<header>
  <h1>MaiorMargem ‚Äî Dashboard</h1>
  <div class="userbox">
    <span id="planChip" class="chip plan" title="Plano atual">Plano: ‚Äî</span>
    <div class="userChipWrap">
      <span id="userChip" class="chip">Usu√°rio</span>
      <div id="userDropdown" class="dropdown" role="menu" aria-hidden="true">
        <button class="dd-item" id="ddMeusDados">Meus dados</button>
        <button class="dd-item" id="ddPlanos">Planos</button>
      </div>
    </div>
    <button id="btnSair" class="btn">Sair</button>
  </div>
</header>

<div class="panel">
  <div class="filters">
    <input id="eanFilter" placeholder="Filtrar por EAN/GTIN‚Ä¶" />
    <input id="descFilter" placeholder="Filtrar por descri√ß√£o‚Ä¶" />
    <button id="btnReload" class="btn">Recarregar</button>
  </div>
  <div class="status"><span id="status"></span></div>
  <div id="err" class="err"></div>
</div>

<section id="favPanel" class="panel">
  <div class="panel-header">
    <h2>Favoritos</h2>
    <button id="toggleFav" class="toggle-btn" aria-expanded="true">Minimizar</button>
  </div>
  <div id="favWrap" class="wrap">
    <table id="favTable">
      <thead>
        <tr>
          <th class="col-fav">A√ß√£o</th>
          <th class="col-sku">EAN</th>
          <th class="col-desc">Descri√ß√£o</th>
          <th data-site="LeroyMerlin">LeroyMerlin</th>
          <th data-site="QueroQuero">QueroQuero</th>
          <th data-site="Cassol">Cassol</th>
          <th data-site="RedeMac">RedeMac</th>
          <th data-site="MestreTinho">MestreTinho</th>
          <th data-site="Tumelero">Tumelero</th>
          <th data-site="Supremeinox">Supremeinox</th>
          <th data-site="Ghaus">Ghaus</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <div id="favResizer" class="resizer" title="Arraste para redimensionar. Duplo clique: voltar ao auto."></div>
</section>

<section id="generalPanel" class="panel">
  <div class="panel-header">
    <h2>Geral</h2>
    <button id="toggleGen" class="toggle-btn" aria-expanded="true">Minimizar</button>
  </div>
  <div id="generalWrap" class="wrap">
    <table id="produtosTable">
      <thead>
        <tr>
          <th class="col-fav">‚òÖ</th>
          <th class="col-sku">EAN</th>
          <th class="col-desc">Descri√ß√£o</th>
          <th data-site="LeroyMerlin">LeroyMerlin</th>
          <th data-site="QueroQuero">QueroQuero</th>
          <th data-site="Cassol">Cassol</th>
          <th data-site="RedeMac">RedeMac</th>
          <th data-site="MestreTinho">MestreTinho</th>
          <th data-site="Tumelero">Tumelero</th>
          <th data-site="Supremeinox">Supremeinox</th>
          <th data-site="Ghaus">Ghaus</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div id="endMarker" class="end-marker"></div>
  </div>
  <div class="counts">
    <span id="countShown"></span>
    <span id="countTotal"></span>
    <span id="countFavs"></span>
  </div>
</section>

<!-- Popover global para gr√°ficos (1 inst√¢ncia, reusada) -->
<div id="chartPopover" class="chart-popover" style="display:none;">
  <header>
    <span id="chartTitle">Hist√≥rico</span>
    <button class="close" id="chartClose" aria-label="Fechar">√ó</button>
  </header>
  <canvas id="spark" class="spark" width="200" height="180"></canvas>
  <div id="chartMsg" class="msg" style="display:none;"></div>
</div>

<script>
/* ======== CONFIG / SUPABASE ======== */
const CFG = window.CONFIG || {};
const SUPABASE_URL = CFG.SUPABASE_URL;
const SUPABASE_ANON_KEY = CFG.SUPABASE_ANON_KEY;
if (!SUPABASE_URL || !SUPABASE_ANON_KEY) { alert("Erro de configura√ß√£o: config.js n√£o carregado."); throw new Error("CONFIG ausente"); }
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true } });

/* ======== MODO DE BLOQUEIO ======== */
/** "blur" (padr√£o) para desfocar, "mask" para mostrar R$ ‚Ä¢‚Ä¢‚Ä¢,‚Ä¢‚Ä¢ */
const LOCK_STYLE = (CFG.LOCK_STYLE || 'blur').toLowerCase();

/* ======== CONSTANTES ======== */
const VIEW = "vw_precos_com_desc";

/* Pagina√ß√£o no servidor e chunk de renderiza√ß√£o */
const PAGE_SIZE = 200;       // consulta por p√°gina no servidor
const RENDER_CHUNK = 60;     // quantidade por ‚Äúlote‚Äù de render no DOM

/* ======== ELEMENTOS ======== */
const statusEl = document.getElementById('status');
const errEl = document.getElementById('err');
const userChip = document.getElementById('userChip');
const planChip = document.getElementById('planChip');
const userChipWrap = document.querySelector('.userChipWrap');
const ddMeusDados = document.getElementById('ddMeusDados');
const ddPlanos = document.getElementById('ddPlanos');
const btnSair = document.getElementById('btnSair');
const btnReload = document.getElementById('btnReload');

const eanFilter = document.getElementById('eanFilter');
const descFilter = document.getElementById('descFilter');

const favPanel = document.getElementById('favPanel');
const toggleFavBtn = document.getElementById('toggleFav');
const favWrap = document.getElementById('favWrap');
const favBody = document.querySelector('#favTable tbody');
const favResizer = document.getElementById('favResizer');

const generalPanel = document.getElementById('generalPanel');
const toggleGenBtn = document.getElementById('toggleGen');
const generalWrap = document.getElementById('generalWrap');
const generalBody = document.querySelector('#produtosTable tbody');
const endMarker = document.getElementById('endMarker');

const countShown = document.getElementById('countShown');
const countTotal = document.getElementById('countTotal');
const countFavs  = document.getElementById('countFavs');

/* Popover/Canvas */
const pop = document.getElementById('chartPopover');
const popTitle = document.getElementById('chartTitle');
const popClose = document.getElementById('chartClose');
const popMsg = document.getElementById('chartMsg');
const sparkCanvas = document.getElementById('spark');
const sparkCtx = sparkCanvas.getContext('2d');

/* ======== ESTADO ======== */
const siteMap = {
  "PrecoLeroyMerlin": "LeroyMerlin",
  "PrecoQueroQuero": "QueroQuero",
  "PrecoCassol": "Cassol",
  "PrecoRedeMac": "RedeMac",
  "PrecoMestreTinho": "MestreTinho",
  "PrecoTumelero": "Tumelero",
  "PrecoSupremeinox": "Supremeinox",
  "PrecoGhaus": "Ghaus"
};
const siteOrder = Object.values(siteMap);

/** Ordem real a exibir: sites selecionados pelo usu√°rio (cai em siteOrder se vazio) */
let chosenSitesAll = [...siteOrder];
/** Subconjunto destravado (primeiros N do plano) */
let unlockedSites = new Set(siteOrder);
/** Subconjunto bloqueado (excedentes) */
let lockedSites = new Set();

/** Favoritos/local state */
let favSet = new Set(JSON.parse(localStorage.getItem('mm_favs') || '[]'));

/* Produtos agregados: Map<ean, { sku, desc, sites{} }> */
let produtosMap = new Map();
let produtosList = [];
let itemsRendered = 0;

/* Pagina√ß√£o servidor */
let serverOffset = 0;
let serverExhausted = false;
let fetching = false;

/* Filtros atuais (servidor) */
let currentEanQ = '';
let currentDescQ = '';

/* Controle render */
let loadingMore = false;
let suppressGeneralChange = false;
const generalChkMap = new Map();

/* Aux para favoritos */
let favFirstAutoRenderDone = false;

/* ======== LIMITES DO PLANO ======== */
const DEFAULT_PLAN_SITE_LIMIT = {
  trial: 2,
  basico: 3,
  intermediario: 5,
  premium: 8
};

function normalizeSiteLabel(x){
  if (!x) return "";
  return x.toString()
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .replace(/\s+/g,'')
    .replace(/[^a-zA-Z0-9]/g,'')
    .toLowerCase();
}
function toDashboardLabel(raw){
  const n = normalizeSiteLabel(raw);
  for (const lbl of siteOrder){
    if (normalizeSiteLabel(lbl) === n) return lbl;
  }
  if (n === 'leroymerlin') return 'LeroyMerlin';
  if (n === 'queroquero') return 'QueroQuero';
  if (n === 'cassol') return 'Cassol';
  if (n === 'redemac' || n === 'redemacsuperbem' || n === 'superbem') return 'RedeMac';
  if (n === 'mestretinho' || n === 'mestrettinho') return 'MestreTinho';
  if (n === 'tumelero') return 'Tumelero';
  if (n === 'supremeinox') return 'Supremeinox';
  if (n === 'ghaus' || n === 'gh√°us') return 'Ghaus';
  return '';
}

async function getSitesLimitForPlan(planKey){
  const key = (planKey || '').toString().trim().toLowerCase();
  try {
    const { data, error } = await sb
      .from('billing_plans')
      .select('sites_limit, max_sites')
      .eq('plan_key', key)
      .maybeSingle();
    if (error) throw error;
    const lim = Number(data?.sites_limit ?? data?.max_sites);
    if (Number.isFinite(lim) && lim > 0) return lim;
  } catch(e) {
    console.warn('billing_plans n√£o encontrado/sem campo sites_limit. Usando fallback.', e);
  }
  return DEFAULT_PLAN_SITE_LIMIT[key] ?? 2;
}

/** L√™ sele√ß√£o do usu√°rio e calcula locked/unlocked (sem ocultar colunas) */
async function loadUserSitesAndLocks(userId, planKey){
  const maxSites = await getSitesLimitForPlan(planKey);

  // 1) user_sites -> ids habilitados
  let siteIds = [];
  try{
    const { data: us, error } = await sb
      .from('user_sites')
      .select('site_id, enabled')
      .eq('user_id', userId);
    if (error) throw error;
    siteIds = (us || [])
      .filter(r => (r.enabled === true || r.enabled === null || typeof r.enabled === 'undefined'))
      .map(r => r.site_id)
      .filter(x => x !== null && x !== undefined);
  }catch(e){
    console.warn('Tabela user_sites ausente? Prosseguindo sem ela.', e);
  }

  // 2) sites -> nomes (na ordem escolhida pelo usu√°rio)
  let chosenLabels = [];
  if (siteIds.length){
    try{
      const { data: st, error } = await sb
        .from('sites')
        .select('id, nome, name, site')
        .in('id', siteIds);
      if (error) throw error;
      const orderedByUser = siteIds.map(id => (st||[]).find(s => s.id === id)).filter(Boolean);
      chosenLabels = orderedByUser.map(s => {
        const raw = s?.nome || s?.name || s?.site || '';
        const lbl = toDashboardLabel(raw);
        return lbl;
      }).filter(lbl => !!lbl && siteOrder.includes(lbl));
    } catch(e){
      console.warn('Falha ao ler sites por id. Usando todos por padr√£o.', e);
    }
  }
  if (chosenLabels.length === 0) chosenLabels = [...siteOrder];

  chosenSitesAll = [...new Set(chosenLabels)];       // evita duplicados mantendo ordem
  unlockedSites = new Set(chosenSitesAll.slice(0, maxSites));
  lockedSites = new Set(chosenSitesAll.slice(maxSites));

  // Atualiza cabe√ßalhos (cadeado nas bloqueadas)
  markLockedHeaders();
  setStatus(buildSitesStatusMessage());
}

/* Cabe√ßalho: marca colunas bloqueadas com data-locked=true  */
function markLockedHeaders(){
  const tables = [document.getElementById('produtosTable'), document.getElementById('favTable')];
  for (const table of tables){
    const ths = table?.querySelectorAll('thead th[data-site]');
    if (!ths) continue;
    ths.forEach(th=>{
      const s = th.getAttribute('data-site');
      const locked = lockedSites.has(s);
      th.setAttribute('data-locked', locked ? 'true' : 'false');
      th.title = locked ? 'Excedeu o limite do plano' : '';
    });
  }
}

function buildSitesStatusMessage(){
  const total = chosenSitesAll.length;
  const lockedCount = lockedSites.size;
  const unlockedCount = unlockedSites.size;
  const extra = lockedCount > 0 ? ` ‚Ä¢ ${lockedCount} bloqueado${lockedCount>1?'s':''}` : '';
  return `Sites selecionados: ${unlockedCount}/${total} liberados${extra}`;
}

/* ======== FUN√á√ïES UTIL ======== */
function setStatus(t){ statusEl.textContent = t || ''; }
function showErr(e){ errEl.style.display='block'; errEl.textContent = String(e||'').trim(); }
function hideErr(){ errEl.style.display='none'; errEl.textContent=''; }
function formatBRL(n){ try { return n.toLocaleString('pt-BR', { style:'currency', currency:'BRL' }); } catch { return String(n); } }
function favSave(){ localStorage.setItem('mm_favs', JSON.stringify([...favSet])); }
function isFav(sku){ return favSet.has(String(sku)); }

/** min/max ignorando colunas bloqueadas */
function computeMinMaxForRow(item){
  let min = { site:null, val: Infinity };
  let max = { site:null, val: -Infinity };
  for (const s of chosenSitesAll) {
    if (lockedSites.has(s)) continue; // ignora bloqueadas
    const d = item.sites[s];
    if (!d || !Number.isFinite(d.precoNum)) continue;
    const n = d.precoNum;
    if (n < min.val) { min = { site:s, val:n }; }
    if (n > max.val) { max = { site:s, val:n }; }
  }
  return { minSite: min.site, maxSite: max.site };
}
function debounce(fn, delay=500){
  let t;
  return (...args)=>{ clearTimeout(t); t = setTimeout(()=>fn(...args), delay); };
}

/* ======== LOGOUT POR VIRADA DE DIA ======== */
function enforceDayBoundaryLogout() {
  const key = 'mm_login_date';
  function getLocalDateStr() {
    const now = new Date();
    const fmt = new Intl.DateTimeFormat('pt-BR', { timeZone: 'America/Sao_Paulo' });
    const [d, m, y] = fmt.format(now).split('/');
    return `${y}-${m.padStart(2,'0')}-${d.padStart(2,'0')}`;
  }
  if (!localStorage.getItem(key)) localStorage.setItem(key, getLocalDateStr());

  async function check() {
    const current = getLocalDateStr();
    const stored = localStorage.getItem(key);
    if (stored && stored !== current) {
      try { await sb.auth.signOut(); } catch {}
      localStorage.removeItem('mm_login_date');
      window.location.href = CFG.SITE_URL || 'index.html';
    }
  }
  setInterval(check, 60 * 1000);
  document.addEventListener('visibilitychange', () => { if (!document.hidden) check(); });
  window.addEventListener('focus', check);
}

/* ======== HEADER / MENU ======== */
ddMeusDados.addEventListener('click', () => { window.location.href = 'meusdados.html'; });
ddPlanos.addEventListener('click', () => { window.location.href = 'planos.html'; });
userChip.addEventListener('click', (e) => { e.stopPropagation(); userChipWrap.classList.toggle('open'); });
document.addEventListener('click', (e) => { if (!userChipWrap.contains(e.target)) userChipWrap.classList.remove('open'); });
document.addEventListener('keydown', (e) => { if (e.key === 'Escape') userChipWrap.classList.remove('open'); });

/* ======== FAV HEIGHT / RESIZER ======== */
function measureRowHeight(){
  const row = document.querySelector('#favTable tbody tr');
  if (!row) return 44;
  const h = Math.round(row.getBoundingClientRect().height);
  return Math.max(36, h || 44);
}
function measureHeadHeight(){
  const head = document.querySelector('#favTable thead');
  if (!head) return 40;
  const h = Math.round(head.getBoundingClientRect().height);
  return Math.max(32, h || 40);
}
let favHeightUser = Number(localStorage.getItem('mm_fav_height')) || null;
function applyFavHeight(px){
  if (!px || !Number.isFinite(px)) return;
  const maxPx = Math.round(window.innerHeight * 0.85);
  const clamped = Math.max(120, Math.min(px, maxPx));
  favWrap.style.height = clamped + 'px';
}
function updateFavHeight(){
  if (favHeightUser) { applyFavHeight(favHeightUser); return; }
  const rowsLen = favBody.children.length;
  const rows = Math.min(rowsLen, 20);
  const rowH = measureRowHeight();
  const headH = measureHeadHeight();
  const pad = 8;
  const target = headH + rows * rowH + pad;
  applyFavHeight(target);
}
(function initResizer(){
  let startY = 0, startH = 0;
  function onMove(ev){
    const dy = ev.clientY - startY;
    favHeightUser = startH + dy;
    localStorage.setItem('mm_fav_height', String(favHeightUser));
    applyFavHeight(favHeightUser);
  }
  function stop(){
    document.removeEventListener('mousemove', onMove);
    document.removeEventListener('mouseup', stop);
    document.body.classList.remove('resizing');
  }
  favResizer.addEventListener('mousedown', (ev)=>{
    startY = ev.clientY; startH = favWrap.offsetHeight;
    document.body.classList.add('resizing');
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', stop);
  });
  favResizer.addEventListener('dblclick', ()=>{
    favHeightUser = null;
    localStorage.removeItem('mm_fav_height');
    updateFavHeight();
  });
})();

/* ======== AGREGA√á√ÉO ======== */
function upsertRowsIntoProdutos(rows){
  for (const row of rows){
    const ean = String(row.ean ?? '');
    const site = String(row.site ?? '');
    const precoRaw = row.preco;
    const precoNum = row.preco_num;
    const dt = row.data;
    const desc = row.descricao || '';

    if (!produtosMap.has(ean)) {
      produtosMap.set(ean, { sku: ean, desc: desc, sites: {} });
    }
    const item = produtosMap.get(ean);
    if (!item.desc && desc) item.desc = desc;

    const htmlSiteName = siteMap[site];
    if (htmlSiteName) {
      const prev = item.sites[htmlSiteName];
      if (!prev || new Date(dt) > new Date(prev.data)) {
        item.sites[htmlSiteName] = { precoRaw, precoNum, data: dt };
      }
    }
  }
  produtosList = Array.from(produtosMap.values());
}

/* ======== RENDER ======== */
function chartButtonSVG(){
  return `
    <svg class="chart-icon" viewBox="0 0 24 24" aria-hidden="true">
      <rect x="3" y="11" width="3" height="7" rx="1" fill="#2d2d2d" stroke="#3b3b3b" stroke-width="1"></rect>
      <rect x="9" y="8"  width="3" height="10" rx="1" fill="#2d2d2d" stroke="#3b3b3b" stroke-width="1"></rect>
      <rect x="15" y="5" width="3" height="13" rx="1" fill="#2d2d2d" stroke="#3b3b3b" stroke-width="1"></rect>
      <path d="M3,18 L7,14 L12,15 L17,8 L21,10" fill="none" stroke="#00d084" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>`;
}

/** Cria TD de pre√ßo para um site, aplicando bloqueio quando necess√°rio */
function createPriceCell(item, siteName, minSite, maxSite){
  const td = document.createElement('td');
  const d = item.sites[siteName];

  const isLocked = lockedSites.has(siteName);
  if (isLocked) td.classList.add('locked-cell');

  if (d) {
    const dataStr = d.data ? new Date(d.data).toLocaleString('pt-BR') : '';
    if (Number.isFinite(d.precoNum)) {
      // conte√∫do do pre√ßo (real, mas estiliza√ß√£o/mascara depende do modo)
      const display = formatBRL(d.precoNum);
      const cls = (!isLocked && siteName === minSite) ? 'min'
                 : (!isLocked && siteName === maxSite) ? 'max' : '';
      const priceSpan = document.createElement('span');
      priceSpan.className = `price ${cls}`;
      priceSpan.title = isLocked ? 'Excedeu o limite do plano' : (dataStr ? `Atualizado em ${dataStr}` : '');

      if (isLocked && LOCK_STYLE === 'mask') {
        priceSpan.textContent = 'R$ ‚Ä¢‚Ä¢‚Ä¢,‚Ä¢‚Ä¢';
        priceSpan.classList.add('masked');
      } else {
        priceSpan.textContent = display; // texto real; blur via CSS se 'blur'
      }

      td.appendChild(priceSpan);

      // bot√£o gr√°fico (ainda dispon√≠vel ‚Äì hist√≥rico pode abrir, mas a linha ficar√° com dados reais/blur)
      const btn = document.createElement('button');
      btn.className = 'chart-btn';
      btn.type = 'button';
      btn.title = isLocked ? 'Dispon√≠vel no upgrade' : 'Ver gr√°fico do hist√≥rico';
      btn.innerHTML = chartButtonSVG();
      btn.addEventListener('click', (ev) => {
        if (isLocked) {
          window.location.href = 'planos.html';
          return;
        }
        openChartFor(ev, item.sku, siteName, item.desc);
      });
      td.appendChild(btn);

      // CTA de upgrade nas bloqueadas
      if (isLocked) {
        const up = document.createElement('button');
        up.className = 'unlock';
        up.type = 'button';
        up.title = 'Excedeu o limite do plano. Ver planos.';
        up.innerHTML = 'Ver planos';
        up.addEventListener('click', ()=> window.location.href = 'planos.html');
        td.appendChild(up);
      }

    } else {
      const raw = (d.precoRaw ?? '').toString().replace(/</g,'&lt;');
      const span = document.createElement('span');
      span.className = 'price';
      span.title = isLocked ? 'Excedeu o limite do plano' : (dataStr ? `Atualizado em ${dataStr}` : '');
      span.textContent = isLocked && LOCK_STYLE === 'mask' ? '‚Äî' : raw;
      td.appendChild(span);
    }
  } else {
    td.innerHTML = `<span class="muted">‚Äî</span>`;
  }
  return td;
}

function renderGeneralChunk(){
  const end = Math.min(itemsRendered + RENDER_CHUNK, produtosList.length);
  const frag = document.createDocumentFragment();

  for (let i = itemsRendered; i < end; i++){
    const item = produtosList[i];
    const tr = document.createElement('tr');

    // Fav
    const tdFav = document.createElement('td');
    tdFav.className = 'col-fav';
    const chk = document.createElement('input');
    chk.type = 'checkbox';
    chk.checked = isFav(item.sku);
    chk.title = 'Marcar como favorito';
    chk.addEventListener('change', () => {
      if (suppressGeneralChange) return;
      if (chk.checked) favSet.add(item.sku); else favSet.delete(item.sku);
      favSave();
      renderFavs();
      updateFavHeight();
      updateCounts();
    });
    tdFav.appendChild(chk);
    tr.appendChild(tdFav);
    generalChkMap.set(item.sku, chk);

    // EAN
    const tdSku = document.createElement('td');
    tdSku.className = 'col-sku';
    tdSku.textContent = item.sku;
    tr.appendChild(tdSku);

    // Descri√ß√£o
    const tdDesc = document.createElement('td');
    tdDesc.className = 'col-desc';
    tdDesc.innerHTML = (item.desc || '').replace(/</g,'&lt;');
    tr.appendChild(tdDesc);

    // Pre√ßos de cada site selecionado (todos), aplicando locks quando necess√°rio
    const { minSite, maxSite } = computeMinMaxForRow(item);
    for (const s of chosenSitesAll) {
      tr.appendChild(createPriceCell(item, s, minSite, maxSite));
    }

    frag.appendChild(tr);
  }

  generalBody.appendChild(frag);
  itemsRendered = end;
  endMarker.textContent = (serverExhausted && itemsRendered >= produtosList.length) ? 'Fim da lista' : '';
  updateCounts();
}

function resetGeneralDom(){
  generalBody.innerHTML = '';
  generalChkMap.clear();
  itemsRendered = 0;
  endMarker.textContent = '';
}

function onGeneralScroll(){
  if (loadingMore) return;
  const nearBottom = generalWrap.scrollTop + generalWrap.clientHeight >= generalWrap.scrollHeight - 100;

  if (nearBottom && itemsRendered < produtosList.length){
    loadingMore = true;
    setTimeout(()=>{ renderGeneralChunk(); loadingMore = false; }, 30);
    return;
  }
  if (nearBottom && !serverExhausted && !fetching){
    fetchNextPage();
  }
}
generalWrap.addEventListener('scroll', onGeneralScroll);

/* ======== FAVORITOS ======== */
function renderFavs(){
  favBody.innerHTML = '';
  const favList = produtosList.filter(p => isFav(p.sku));
  const frag = document.createDocumentFragment();

  for (const item of favList){
    const tr = document.createElement('tr');

    const tdAct = document.createElement('td');
    tdAct.className = 'col-fav';
    const btn = document.createElement('button');
    btn.className = 'trash-btn';
    btn.title = 'Remover dos favoritos';
    btn.innerHTML = `
      <svg class="trash-icon" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" width="16" height="16">
        <path d="M9 3h6a1 1 0 0 1 1 1v1h4v2h-1l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 7H4V5h4V4a1 1 0 0 1 1-1zm2 0v1h2V3h-2zM7 7l1 14h8l1-14H7z"></path>
      </svg>`;
    btn.addEventListener('click', () => {
      favSet.delete(item.sku);
      favSave();
      const chk = generalChkMap.get(item.sku);
      if (chk) {
        suppressGeneralChange = true;
        chk.checked = false;
        suppressGeneralChange = false;
      }
      renderFavs();
      updateFavHeight();
      updateCounts();
    });
    tdAct.appendChild(btn);
    tr.appendChild(tdAct);

    const tdSku = document.createElement('td');
    tdSku.className = 'col-sku';
    tdSku.textContent = item.sku;
    tr.appendChild(tdSku);

    const tdDesc = document.createElement('td');
    tdDesc.className = 'col-desc';
    tdDesc.innerHTML = (item.desc || '').replace(/</g,'&lt;');
    tr.appendChild(tdDesc);

    const { minSite, maxSite } = computeMinMaxForRow(item);
    for (const s of chosenSitesAll) {
      tr.appendChild(createPriceCell(item, s, minSite, maxSite));
    }

    frag.appendChild(tr);
  }

  favBody.appendChild(frag);
}

/* ======== TOGGLE SE√á√ïES ======== */
function attachToggle(panel, button){
  function setState(expanded){
    panel.classList.toggle('collapsed', !expanded);
    button.textContent = expanded ? 'Minimizar' : 'Maximizar';
    button.setAttribute('aria-expanded', String(expanded));
  }
  button.addEventListener('click', ()=>{
    const isExpanded = button.getAttribute('aria-expanded') === 'true';
    setState(!isExpanded);
  });
  setState(true);
}
attachToggle(favPanel, toggleFavBtn);
attachToggle(generalPanel, toggleGenBtn);

/* ======== CONTADORES ======== */
function updateCounts(){
  const favs = favSet.size;
  countShown.textContent = `Exibindo ${itemsRendered} de ${produtosList.length} no Geral (carregados)`;
  countTotal.textContent = serverExhausted ? `Total de SKUs carregados: ${produtosList.length}` : `Carregando‚Ä¶ (${produtosList.length}+ )`;
  countFavs.textContent = `Favoritos: ${favs}`;
}

/* ======== CONSULTA SERVIDOR (PAGINADA) ======== */
function buildQuery(){
  let q = sb
    .from(VIEW)
    .select('ean, site, preco, data, descricao, preco_num', { count: 'estimated' })
    .order('data', { ascending: false });

  if (currentEanQ) q = q.ilike('ean', `%${currentEanQ}%`);
  if (currentDescQ) q = q.ilike('descricao', `%${currentDescQ}%`);
  return q;
}

async function fetchNextPage(){
  if (fetching || serverExhausted) return;
  fetching = true;
  hideErr();
  setStatus(`Carregando dados‚Ä¶ (offset ${serverOffset})`);

  try{
    const from = serverOffset;
    const to = serverOffset + PAGE_SIZE - 1;

    const { data, error } = await buildQuery().range(from, to);
    if (error) throw error;

    if (!data || data.length === 0) {
      serverExhausted = true;
      setStatus('Todos os dados carregados.');
      if (itemsRendered >= produtosList.length) endMarker.textContent = 'Fim da lista';
    } else {
      upsertRowsIntoProdutos(data);

      if (itemsRendered < produtosList.length) renderGeneralChunk();

      renderFavs();
      if (!favFirstAutoRenderDone) { updateFavHeight(); favFirstAutoRenderDone = true; }

      serverOffset += PAGE_SIZE;
      setStatus(`Carregados: ${produtosList.length} SKUs (parcial)`);
    }
  } catch(e){
    console.error(e);
    showErr('Falha ao carregar: ' + (e?.message || e));
    setStatus('Erro ao carregar.');
  } finally {
    fetching = false;
    updateCounts();
  }
}

/* ======== RESET DE CONSULTA ======== */
function resetAndQuery(){
  produtosMap.clear();
  produtosList = [];
  serverOffset = 0;
  serverExhausted = false;
  favFirstAutoRenderDone = false;

  resetGeneralDom();
  renderFavs();
  updateFavHeight();
  updateCounts();

  fetchNextPage();
}

/* ======== EVENTOS UI ======== */
btnReload.addEventListener('click', async () => {
  const session = (await sb.auth.getSession()).data.session;
  if (session?.user?.id) {
    const planKey = await loadHeaderInfoPlanOnly();
    await loadUserSitesAndLocks(session.user.id, planKey);
  }
  resetAndQuery();
});

const onFilterInput = debounce(() => {
  currentEanQ = (eanFilter.value || '').trim();
  currentDescQ = (descFilter.value || '').trim();
  resetAndQuery();
}, 500);

eanFilter.addEventListener('input', onFilterInput);
descFilter.addEventListener('input', onFilterInput);

/* ======== HEADER / SESS√ÉO ======== */
async function loadHeaderInfo(){
  const { data: { session } } = await sb.auth.getSession();
  if (!session) { window.location.href = CFG.SITE_URL || 'index.html'; return null; }
  userChip.textContent = session.user?.email || 'Logado';

  let planKey = 'basico';
  try{
    const { data, error } = await sb
      .from('profiles')
      .select('plan')
      .eq('id', session.user.id)
      .maybeSingle();
    if (error) throw error;
    const planRaw = (data?.plan || 'basico').toString();
    planKey = planRaw.toLowerCase();
    const pretty = planRaw.charAt(0).toUpperCase() + planRaw.slice(1);
    planChip.textContent = `Plano: ${pretty}`;
  }catch(e){
    console.error(e);
    planChip.textContent = 'Plano: ‚Äî';
  }

  await loadUserSitesAndLocks(session.user.id, planKey);
  return session;
}

async function loadHeaderInfoPlanOnly(){
  try{
    const { data: { session } } = await sb.auth.getSession();
    if (!session) return 'basico';
    const { data, error } = await sb
      .from('profiles')
      .select('plan')
      .eq('id', session.user.id)
      .maybeSingle();
    if (error) throw error;
    return (data?.plan || 'basico').toString().toLowerCase();
  }catch(e){
    console.error(e);
    return 'basico';
  }
}

/* ======== SAIR ======== */
btnSair.addEventListener('click', async () => {
  try {
    await sb.auth.signOut();
  } catch (e) {
    console.error('Erro ao sair:', e);
  } finally {
    localStorage.removeItem('mm_login_date');
    window.location.href = CFG.SITE_URL || 'index.html';
  }
});

/* ======== MINI-GR√ÅFICO (Spark) ======== */
function closePopover(){ pop.style.display='none'; }
function positionPopover(x, y){
  const pad = 12;
  const vw = window.innerWidth, vh = window.innerHeight;
  let left = x + pad, top = y + pad;
  const rectW = 240, rectH = 260;
  if (left + rectW > vw) left = x - rectW - pad;
  if (top + rectH > vh) top = y - rectH - pad;
  pop.style.left = Math.max(8, left) + 'px';
  pop.style.top = Math.max(8, top) + 'px';
}
document.addEventListener('click', (ev) => {
  if (pop.style.display !== 'none' && !pop.contains(ev.target)) closePopover();
});
document.addEventListener('keydown', (ev) => { if (ev.key === 'Escape') closePopover(); });
popClose.addEventListener('click', closePopover);

/* Desenha sparkline com margens maiores e textos "clampados" */
function drawSparkline(points){
  const ctx = sparkCtx;
  const W = sparkCanvas.width, H = sparkCanvas.height;
  ctx.clearRect(0,0,W,H);

  if (!points || points.length < 3){
    popMsg.style.display='block';
    popMsg.textContent = 'Hist√≥rico insuficiente (precisa de 3 pre√ßos).';
    return;
  }
  popMsg.style.display='none';

  const m = { l: 40, r: 14, t: 12, b: 28 };

  const xs = points.map(p=>p.x.getTime());
  const ys = points.map(p=>p.y);
  const xMin = Math.min(...xs), xMax = Math.max(...xs);
  const yMin = Math.min(...ys), yMax = Math.max(...ys);
  const xScale = v => m.l + ( (v - xMin) / (xMax - xMin || 1) ) * (W - m.l - m.r);
  const yScaleRaw = v => H - m.b - ( (v - yMin) / (yMax - yMin || 1) ) * (H - m.t - m.b);
  const yScale = v => Math.max(m.t+6, Math.min(H - m.b - 6, yScaleRaw(v)));

  ctx.strokeStyle = '#232323';
  ctx.lineWidth = 1;
  ctx.beginPath();
  for (let i=0;i<=3;i++){
    const yy = m.t + i*(H - m.t - m.b)/3;
    ctx.moveTo(m.l, yy); ctx.lineTo(W - m.r, yy);
  }
  ctx.stroke();

  ctx.beginPath();
  ctx.lineWidth = 3;
  ctx.strokeStyle = '#00d084';
  points.forEach((p, i)=>{
    const x = xScale(p.x.getTime()), y = yScale(p.y);
    if (i === 0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.stroke();

  ctx.fillStyle = '#bfffc1';
  for (const p of points){
    const x = xScale(p.x.getTime()), y = yScale(p.y);
    ctx.beginPath(); ctx.arc(x,y,3.2,0,Math.PI*2); ctx.fill();
  }

  ctx.fillStyle = '#9aa0a6';
  ctx.font = '11px Arial';
  ctx.textAlign = 'right';
  const yMaxY = yScale(yMax), yMinY = yScale(yMin);
  ctx.fillText(formatBRL(yMax), m.l-6, Math.max(m.t+10, yMaxY-6));
  ctx.fillText(formatBRL(yMin), m.l-6, Math.min(H - m.b - 2, yMinY+12));

  const fmt = (d)=> d.toLocaleDateString('pt-BR', { day:'2-digit', month:'2-digit' });
  ctx.textAlign = 'center';
  ctx.fillText(fmt(points[0].x), Math.max(m.l, 24), H-8);
  ctx.fillText(fmt(points[points.length-1].x), Math.min(W - m.r, W-24), H-8);
}

async function openChartFor(ev, ean, siteName, descText){
  ev.stopPropagation();
  const rect = ev.currentTarget.getBoundingClientRect();
  positionPopover(rect.right, rect.bottom);

  popTitle.textContent = `${siteName} ‚Ä¢ ${ean}`;
  popMsg.style.display='block';
  popMsg.textContent = 'Carregando hist√≥rico‚Ä¶';
  sparkCtx.clearRect(0,0,sparkCanvas.width,sparkCanvas.height);
  pop.style.display='block';

  try{
    const { data, error } = await sb
      .from(VIEW)
      .select('data, preco_num')
      .eq('ean', ean)
      .eq('site', Object.keys(siteMap).find(k => siteMap[k] === siteName))
      .not('preco_num', 'is', null)
      .order('data', { ascending: true })
      .limit(60);
    if (error) throw error;

    const points = (data||[])
      .filter(r => typeof r.preco_num === 'number' && Number.isFinite(r.preco_num))
      .map(r => ({ x: new Date(r.data), y: r.preco_num }));

    drawSparkline(points);
  } catch(e){
    console.error(e);
    popMsg.style.display='block';
    popMsg.textContent = 'Falha ao carregar hist√≥rico.';
  }
}

/* ======== INIT ======== */
(async function init(){
  const session = await loadHeaderInfo(); if (!session) return;

  enforceDayBoundaryLogout();

  currentEanQ = '';
  currentDescQ = '';

  resetAndQuery();
  generalWrap.dispatchEvent(new Event('scroll'));
})();
</script>
</body>
</html>
