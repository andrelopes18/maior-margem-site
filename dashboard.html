<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MaiorMargem â€” Dashboard</title>
<style>
  :root { color-scheme: dark; }
  body { margin:0; font-family: Arial, sans-serif; background:#121212; color:#fff; padding:20px; }
  header { display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; gap:12px; flex-wrap:wrap; }
  h1 { color:#00b140; margin:0; }
  .userbox { display:flex; gap:12px; align-items:center; position: relative; }
  .chip { font-size:12px; background:#1e1e1e; border:1px solid #333; padding:6px 10px; border-radius:999px; cursor:default; }
  .chip.plan { color:#bfffc1; border-color:#2f5a2f; background:#132313; }
  .btn { background:#00b140; color:#fff; border:none; padding:8px 14px; border-radius:6px; cursor:pointer; }
  .btn:hover { background:#009b38; }
  .userChipWrap { position: relative; display:inline-block; }
  .dropdown { position:absolute; right:0; top:calc(100% + 6px); display:none; min-width:180px; padding:6px; background:#0f0f0f; border:1px solid #2a2a2a; border-radius:10px; box-shadow:0 10px 30px rgba(0,0,0,.5); z-index:50; }
  .userChipWrap:hover .dropdown, .userChipWrap.open .dropdown { display:block; }
  .dd-item { width:100%; background:transparent; border:none; color:#eee; text-align:left; padding:10px 12px; border-radius:8px; cursor:pointer; font-size:14px; }
  .dd-item:hover { background:#1b1b1b; }
  .panel { background:#202020; border:1px solid #2a2a2a; border-radius:12px; padding:12px; margin-bottom:18px; }
  .panel-header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px; }
  .panel-header h2 { margin:0; font-size:18px; color:#d5ffd5; }
  .toggle-btn { background:none; border:1px solid #2a2a2a; color:#ddd; padding:6px 10px; border-radius:8px; cursor:pointer; }
  .toggle-btn:hover { background:#1b1b1b; }
  .filters { display:grid; grid-template-columns: 1fr 1fr auto; gap:12px; margin:16px 0; align-items:center; }
  .filters input { padding:10px 12px; border-radius:6px; border:1px solid #333; background:#1e1e1e; color:#fff; }
  .scope { grid-column: 1 / -1; display:flex; gap:18px; align-items:center; color:#cfd8dc; font-size:13px; flex-wrap:wrap; }
  .scope label { display:flex; align-items:center; gap:6px; cursor:pointer; }
  .scope input[type="radio"] { accent-color:#00b140; }
  .status { margin:10px 0; color:#aaa; font-size:12px; }
  .err { display:none; color:#ff5d5d; margin:8px 0; font-size:13px; }
  .wrap { overflow:auto; border:1px solid #2a2a2a; border-radius:10px; position: relative; }
  #generalWrap { height:55vh; }
  table { width:100%; border-collapse:separate; border-spacing:0; }
  thead { position:sticky; top:0; z-index:3; }
  thead th { position:sticky; top:0; background:#0f0f0f; z-index:4; }
  th, td { border-bottom:1px solid #2a2a2a; padding:10px; text-align:left; font-size:14px; vertical-align:top; }
  tbody tr:hover { background:#1a1a1a; }
  .col-fav { width:40px; text-align:center; }
  .col-sku { width:160px; font-family: ui-monospace,Consolas,monospace; }
  .col-desc { min-width:260px; }
  .col-param { width:140px; }
  .price { font-weight:700; display:inline-block; font-size:16px; vertical-align:middle; }
  @media (min-width:1200px){ .price{ font-size:18px; } }
  .price.min { color:#ff4d4f; }
  .price.max { color:#00d084; }
  .price.param { color:#ffd54f; } /* amarelo */
  .muted { display:none; }
  .end-marker { text-align:center; padding:10px; color:#9aa0a6; }
  .counts { margin-top:10px; font-size:12px; color:#9aa0a6; display:flex; gap:12px; flex-wrap:wrap; }
  .resizer { height:10px; margin-top:6px; border:1px solid #2a2a2a; border-radius:8px; cursor:ns-resize; background:linear-gradient(180deg,#1c1c1c,#111); display:flex; align-items:center; justify-content:center; }
  .resizer:after { content:""; width:40px; height:3px; border-radius:3px; background:#3a3a3a; }
  body.resizing, body.resizing * { cursor: ns-resize !important; user-select: none; }
  th[data-locked="true"] { position: relative; color: #aaa; }
  th[data-locked="true"]::after { content:"ðŸ”’"; margin-left:6px; opacity:.8; font-size:14px; }
  td.locked-cell { position: relative; }
  td.locked-cell .price { filter: blur(3px); }
  td.locked-cell .unlock {
    position:absolute; left:50%; top:50%; transform: translate(-50%, -50%);
    padding:6px 10px; border-radius:8px; border:1px solid #2e2e2e;
    background:#141414; color:#ddd; font-size:12px;
    cursor:pointer; opacity:0; pointer-events:none; transition: opacity .15s;
    white-space:nowrap;
  }
  td.locked-cell:hover .unlock { opacity:1; pointer-events:auto; }
  td.locked-cell .unlock:hover { background:#1b1b1b; }
  .chart-btn { margin-left:6px; background:transparent; border:0; padding:0; vertical-align:middle; cursor:pointer; }
  .chart-btn svg { width:18px; height:18px; display:block; }
  .chart-btn:hover svg rect { fill:#373737; }
  .chart-btn:active svg path { opacity:.9; }
  #dbgWrap { display:none; position:fixed; right:16px; bottom:16px; width:460px; max-height:60vh; z-index:9999;
             background:#0f0f0f; border:1px solid #2a2a2a; border-radius:10px; padding:10px; box-shadow:0 10px 30px rgba(0,0,0,.6); }
  #dbgWrap h3 { margin:0 0 8px 0; font-size:14px; color:#bfe3ff; }
  #dbg { white-space:pre-wrap; font-family: ui-monospace,Consolas,monospace; font-size:12px; color:#bfe3ff; max-height:48vh; overflow:auto; }
  #chartPopover { position:fixed; z-index:9998; background:#0f0f0f; border:1px solid #2a2a2a; border-radius:10px; padding:10px; box-shadow:0 10px 30px rgba(0,0,0,.6); }
  #chartPopover header { display:flex; align-items:center; justify-content:space-between; margin-bottom:6px; }
  #chartPopover .close { background:transparent; border:1px solid #333; color:#ddd; padding:2px 8px; border-radius:6px; cursor:pointer; }
  #chartPopover .msg { font-size:12px; color:#9aa0a6; }
</style>
<script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<script src="./config.js"></script>
</head>
<body>
<header>
  <h1>MaiorMargem â€” Dashboard</h1>
  <div class="userbox">
    <span id="planChip" class="chip plan">Plano: â€”</span>
    <div class="userChipWrap">
      <span id="userChip" class="chip">UsuÃ¡rio</span>
      <div class="dropdown" role="menu" aria-hidden="true">
        <button class="dd-item" id="ddMeusDados">Meus dados</button>
        <button class="dd-item" id="ddPlanos">Planos</button>
      </div>
    </div>
    <button id="btnSair" class="btn">Sair</button>
  </div>
</header>

<div class="panel">
  <div class="filters">
    <input id="eanFilter" placeholder="Filtrar por EAN/GTINâ€¦" />
    <input id="descFilter" placeholder="Filtrar por descriÃ§Ã£oâ€¦" />
    <button id="btnReload" class="btn">Recarregar</button>
    <div class="scope" id="scopeGroup" role="radiogroup" aria-label="Escopo da pesquisa">
      <span>Filtrar em:</span>
      <label><input type="radio" name="scope" value="both" checked> Ambas</label>
      <label><input type="radio" name="scope" value="favorites"> Favoritos</label>
      <label><input type="radio" name="scope" value="general"> Geral</label>
    </div>
  </div>
  <div class="status"><span id="status"></span></div>
  <div id="err" class="err"></div>
</div>

<section id="favPanel" class="panel">
  <div class="panel-header">
    <h2>Favoritos</h2>
    <button id="btnPrintFav" class="toggle-btn" title="Imprimir favoritos">Imprimir</button>
    <button id="toggleFav" class="toggle-btn" aria-expanded="true">Minimizar</button>
  </div>
  <div id="favWrap" class="wrap">
    <table id="favTable">
      <thead><tr id="favHeaderRow"></tr></thead>
      <tbody></tbody>
    </table>
  </div>
  <div id="favResizer" class="resizer" title="Arraste para redimensionar. Duplo clique volta ao automÃ¡tico."></div>
</section>

<section id="generalPanel" class="panel">
  <div class="panel-header">
    <h2>Geral</h2>
    <button id="toggleGen" class="toggle-btn" aria-expanded="true">Minimizar</button>
  </div>
  <div id="generalWrap" class="wrap">
    <table id="produtosTable">
      <thead><tr id="generalHeaderRow"></tr></thead>
      <tbody></tbody>
    </table>
    <div id="endMarker" class="end-marker"></div>
  </div>
  <div class="counts">
    <span id="countShown"></span>
    <span id="countTotal"></span>
    <span id="countFavs"></span>
  </div>
</section>

<div id="dbgWrap">
  <h3>Debug</h3>
  <pre id="dbg"></pre>
</div>

<div id="chartPopover" style="display:none;">
  <header>
    <span id="chartTitle">HistÃ³rico</span>
    <button class="close" id="chartClose" aria-label="Fechar">Ã—</button>
  </header>
  <canvas id="spark" width="220" height="180"></canvas>
  <div id="chartMsg" class="msg" style="display:none;"></div>
</div>

<script>
/* ========= Debug ========= */
const dbgWrap = document.getElementById('dbgWrap');
const dbg = document.getElementById('dbg');
function dlog(o){ try{ dbg.textContent += (typeof o==='string' ? o : JSON.stringify(o,null,2)) + "\\n"; dbg.scrollTop = dbg.scrollHeight; }catch{} }
addEventListener('keydown', (e)=>{ if (e.ctrlKey && e.altKey && (e.key==='d'||e.key==='D')) dbgWrap.style.display = (dbgWrap.style.display==='none'||!dbgWrap.style.display)?'block':'none'; });

/* ========= Erros ========= */
const errEl = document.getElementById('err');
function showErr(msg){ errEl.style.display='block'; errEl.textContent=msg; dlog({error:msg}); }
addEventListener('error', e => showErr('Erro JS: '+e.message));
addEventListener('unhandledrejection', e => showErr('Erro assÃ­ncrono: '+(e.reason?.message||e.reason)));

/* ========= Supabase ========= */
const CFG = window.CONFIG || {};
if(!CFG.SUPABASE_URL || !CFG.SUPABASE_ANON_KEY){ showErr('CONFIG ausente (config.js)'); throw new Error('CONFIG ausente'); }
const sb = supabase.createClient(CFG.SUPABASE_URL, CFG.SUPABASE_ANON_KEY, { auth:{ persistSession:true, autoRefreshToken:true, detectSessionInUrl:true }});

/* ========= Elementos ========= */
const statusEl = document.getElementById('status');
const planChip  = document.getElementById('planChip');
const userChip  = document.getElementById('userChip');
const ddMeusDados = document.getElementById('ddMeusDados');
const ddPlanos    = document.getElementById('ddPlanos');
const btnSair     = document.getElementById('btnSair');
const btnReload   = document.getElementById('btnReload');
const eanFilter   = document.getElementById('eanFilter');
const descFilter  = document.getElementById('descFilter');
const favWrap  = document.getElementById('favWrap');
const favBody  = document.querySelector('#favTable tbody');
const favHeaderRow = document.getElementById('favHeaderRow');
const favResizer  = document.getElementById('favResizer');
const toggleFavBtn = document.getElementById('toggleFav');
const btnPrintFav  = document.getElementById('btnPrintFav');
const generalWrap = document.getElementById('generalWrap');
const generalBody = document.querySelector('#produtosTable tbody');
const generalHeaderRow = document.getElementById('generalHeaderRow');
const endMarker   = document.getElementById('endMarker');
const toggleGenBtn = document.getElementById('toggleGen');
const countShown  = document.getElementById('countShown');
const countTotal  = document.getElementById('countTotal');
const countFavs   = document.getElementById('countFavs');
const scopeGroup = document.getElementById('scopeGroup');

/* ========= Estado ========= */
const DEFAULT_PLAN_SITE_LIMIT = { trial:2, basico:4, intermediario:6, premium:8 };
const VIEW = 'vw_precos_dinamica'; /* <<< usa a view nova dinÃ¢mica */
const PAGE_SIZE = 200, RENDER_CHUNK = 60;

let chosen=[], unlocked=new Set(), locked=new Set();
let produtosMap=new Map(), produtosList=[], serverOffset=0, serverExhausted=false, fetching=false;
let generalView=[], itemsRendered=0;
let favSet = new Set(JSON.parse(localStorage.getItem('mm_favs') || '[]'));
let loadingMore=false; const generalChkMap=new Map();
let favHeightUser = Number(localStorage.getItem('mm_fav_height')) || null, favFirstAutoRenderDone=false;
let currentEanQ='', currentDescQ='', searchScope='both';

/* ========= Helpers ========= */
function setStatus(t){ statusEl.textContent = t||''; }
function hideErr(){ errEl.style.display='none'; errEl.textContent=''; }
function debounce(fn,ms=500){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); } }
function favSave(){ localStorage.setItem('mm_favs', JSON.stringify([...favSet])); }
function isFav(sku){ return favSet.has(String(sku)); }
function formatBRL(n){ try{ return n.toLocaleString('pt-BR',{style:'currency',currency:'BRL'}) }catch{ return String(n) } }
function norm(s){ return (s||'').toString().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-zA-Z0-9]/g,'').toLowerCase(); }
function shouldFilterGeneral(){ return searchScope==='both' || searchScope==='general'; }
function shouldFilterFavs(){ return searchScope==='both' || searchScope==='favorites'; }

/* ========= CabeÃ§alhos (usa sites.nome e bloqueios por plano) ========= */
function buildHeaders(){
  const base = '<th class="col-fav">â˜…</th><th class="col-sku">EAN</th><th class="col-desc">DescriÃ§Ã£o</th><th class="col-param">Meu preÃ§o</th>';
  const ths = chosen.map(c=>{
    const lockAttr = locked.has(c.site_id) ? ' data-locked="true"' : ' data-locked="false"';
    return `<th data-siteid="${c.site_id}"${lockAttr}>${(c.label||('Site '+c.site_id)).replace(/</g,'&lt;')}</th>`;
  }).join('');
  generalHeaderRow.innerHTML = base + ths;

  const favBase = '<th class="col-fav">AÃ§Ã£o</th><th class="col-sku">EAN</th><th class="col-desc">DescriÃ§Ã£o</th><th class="col-param">Meu preÃ§o</th>';
  favHeaderRow.innerHTML = favBase + ths;
}

/* ========= Plano ========= */
async function getSitesLimitForPlan(planKey){
  const k=(planKey||'').toLowerCase();
  try{
    const { data, error } = await sb.from('billing_plans').select('sites_limit, max_sites').eq('plan_key', k).maybeSingle();
    if (!error){
      const v = Number(data?.sites_limit ?? data?.max_sites);
      if (Number.isFinite(v) && v>0) return v;
    }
  }catch(e){ dlog({warn:'fallback site limit', plan:k}); }
  return DEFAULT_PLAN_SITE_LIMIT[k] ?? 2;
}

/* ========= user_sites -> chosen ========= */
async function loadUserSelection(userId, planKey){
  dlog({step:'loadUserSelection.start', userId, planKey});
  let rows=[];
  try{
    const { data, error } = await sb.from('user_sites').select('site_id, created_at, position, id, user_id').eq('user_id', userId);
    if (error) throw error;
    rows = data||[];
  }catch(e){ rows = []; showErr('Falha ao ler user_sites'); dlog({error:'user_sites', detail:String(e)}); }

  rows.sort((a,b)=>{
    const pa=a.position??null, pb=b.position??null; if(pa!=null && pb!=null && pa!==pb) return pa-pb;
    const ca=a.created_at?new Date(a.created_at).getTime():0; const cb=b.created_at?new Date(b.created_at).getTime():0;
    if(ca!==cb) return ca-cb; return (a.id||0)-(b.id||0);
  });

  const siteIds=rows.map(r=>r.site_id).filter(x=>x!=null);
  if (!siteIds.length){ chosen=[]; unlocked=new Set(); locked=new Set(); buildHeaders(); setStatus('Nenhum site selecionado em Meus Dados.'); dlog({step:'loadUserSelection.none'}); return; }

  let sites=[];
  try{ const { data, error } = await sb.from('sites').select('id, nome').in('id', siteIds); if (error) throw error; sites=data||[]; }
  catch(e){ showErr('Falha ao ler sites'); dlog({error:'sites', detail:String(e)}); }

  const byId=new Map(sites.map(s=>[s.id,s])); const ordered=[]; for (const id of siteIds){ const s=byId.get(id); if(s && !ordered.includes(s)) ordered.push(s); }
  chosen = ordered.map(s=>({ site_id:s.id, label:(s.nome||('Site '+s.id)).toString().trim() }));

  const lim = await getSitesLimitForPlan(planKey);
  unlocked=new Set(chosen.slice(0,lim).map(c=>c.site_id));
  locked=new Set(chosen.slice(lim).map(c=>c.site_id));

  buildHeaders();
  setStatus('Sites: '+chosen.map(c=>c.label).join(' Â· '));
  dlog({step:'loadUserSelection.done', chosen, unlocked:[...unlocked], locked:[...locked]});
}

/* ========= Agrega linhas vindas da VIEW ========= */
function upsertRowsIntoProdutos(rows){
  const allowedById = new Map(chosen.map(c=>[c.site_id, c.label]));
  for (const r of rows){
    if (!allowedById.has(r.site_id)) continue;
    const ean = String(r.ean||'');
    if (!produtosMap.has(ean)) produtosMap.set(ean, { sku:ean, desc:(r.descricao_cliente||r.descricao||''), meu_preco:null, sites:{} });
    const item = produtosMap.get(ean);

    if (!item.desc) item.desc = r.descricao_cliente || r.descricao || '';
    if (item.meu_preco == null && r.meu_preco != null){ const n=Number(r.meu_preco); if (Number.isFinite(n)) item.meu_preco=n; }

    const label = allowedById.get(r.site_id);      // exibe exatamente sites.nome
    const prev=item.sites[label];
    if (!prev || new Date(r.data) > new Date(prev.data)){
      item.sites[label] = { precoRaw:r.preco, precoNum:r.preco_num, data:r.data, site_id:r.site_id, site_nome:r.site_nome };
    }
  }
  produtosList = Array.from(produtosMap.values());
}

/* ========= Filtros ========= */
function matchesFilters(item){
  const qE=(currentEanQ||'').trim(), qD=norm(currentDescQ||'');
  if (qE && !String(item.sku||'').includes(qE)) return false;
  if (qD && !norm(item.desc||'').includes(qD)) return false;
  return true;
}

/* ========= Render ========= */
function chartButtonSVG(){ return '<svg class="chart-icon" viewBox="0 0 24 24" aria-hidden="true">'
  +'<rect x="3" y="11" width="3" height="7" rx="1" fill="#2d2d2d" stroke="#3b3b3b" stroke-width="1"></rect>'
  +'<rect x="9" y="8"  width="3" height="10" rx="1" fill="#2d2d2d" stroke="#3b3b3b" stroke-width="1"></rect>'
  +'<rect x="15" y="5" width="3" height="13" rx="1" fill="#2d2d2d" stroke="#3b3b3b" stroke-width="1"></rect>'
  +'<path d="M3,18 L7,14 L12,15 L17,8 L21,10" fill="none" stroke="#00d084" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"></path>'
  +'</svg>'; }
function computeMinMaxForRow(item){
  let min={label:null,val:Infinity}, max={label:null,val:-Infinity};
  for (const c of chosen){ if (locked.has(c.site_id)) continue; const d=item.sites[c.label]; if (!d||!Number.isFinite(d.precoNum)) continue; if (d.precoNum<min.val) min={label:c.label,val:d.precoNum}; if (d.precoNum>max.val) max={label:c.label,val:d.precoNum}; }
  return { min:min.label, max:max.label };
}
function createPriceCell(item, label, isLocked, minLabel, maxLabel){
  const td=document.createElement('td'); if (isLocked) td.classList.add('locked-cell'); const d=item.sites[label];
  if (d){
    const dtStr=d.data?new Date(d.data).toLocaleString('pt-BR'):'';
    if (Number.isFinite(d.precoNum)){
      const span=document.createElement('span'); span.className='price '+(!isLocked&&label===minLabel?'min':(!isLocked&&label===maxLabel?'max':''));
      span.title=isLocked?'Excedeu o limite do plano':(dtStr?('Atualizado em '+dtStr):''); span.textContent=formatBRL(d.precoNum); td.appendChild(span);
      const b=document.createElement('button'); b.className='chart-btn'; b.type='button'; b.title=isLocked?'DisponÃ­vel no upgrade':'Ver histÃ³rico'; b.innerHTML=chartButtonSVG();
      const c=chosen.find(x=>x.label===label); b.addEventListener('click',(ev)=>{ if(isLocked){location.href='planos.html';return;} openChartFor(ev,item.sku,label,c?.site_id); }); td.appendChild(b);
      if (isLocked){ const up=document.createElement('button'); up.className='unlock'; up.type='button'; up.textContent='Ver planos'; up.addEventListener('click',()=>location.href='planos.html'); td.appendChild(up); }
    } else {
      const span=document.createElement('span'); span.className='price'; span.title=isLocked?'Excedeu o limite do plano':(dtStr?('Atualizado em '+dtStr):''); span.textContent=(d.precoRaw??'').toString(); td.appendChild(span);
    }
  } else { td.innerHTML='<span class="muted">â€”</span>'; }
  return td;
}
function createParamCell(item){
  const td=document.createElement('td'); td.className='col-param';
  const n=(typeof item.meu_preco==='number')?item.meu_preco:null;
  if (n!=null && Number.isFinite(n)){ const span=document.createElement('span'); span.className='price param'; span.title='Meu preÃ§o'; span.textContent=formatBRL(n); td.appendChild(span); }
  else { td.innerHTML='<span class="muted">â€”</span>'; }
  return td;
}
function renderRowInto(tr,item){
  const tdFav=document.createElement('td'); tdFav.className='col-fav';
  const chk=document.createElement('input'); chk.type='checkbox'; chk.checked=isFav(item.sku);
  chk.addEventListener('change',()=>{ if(chk.checked) favSet.add(item.sku); else favSet.delete(item.sku); favSave(); renderFavs(); updateFavHeight(); updateCounts(); });
  tdFav.appendChild(chk); tr.appendChild(tdFav); generalChkMap.set(item.sku, chk);
  const tdSku=document.createElement('td'); tdSku.className='col-sku'; tdSku.textContent=item.sku; tr.appendChild(tdSku);
  const tdDesc=document.createElement('td'); tdDesc.className='col-desc'; tdDesc.innerHTML=(item.desc||'').replace(/</g,'&lt;'); tr.appendChild(tdDesc);
  tr.appendChild(createParamCell(item));
  const {min,max}=computeMinMaxForRow(item);
  for (const c of chosen){ tr.appendChild(createPriceCell(item, c.label, locked.has(c.site_id), min, max)); }
}

/* ========= View (Geral) ========= */
function recomputeGeneralView(){ generalView = shouldFilterGeneral() ? produtosList.filter(matchesFilters) : produtosList.slice(); resetGeneralDom(); renderGeneralChunk(); }
function renderGeneralChunk(){
  const end=Math.min(itemsRendered+RENDER_CHUNK, generalView.length);
  const frag=document.createDocumentFragment();
  for(let i=itemsRendered;i<end;i++){ const it=generalView[i]; const tr=document.createElement('tr'); renderRowInto(tr,it); frag.appendChild(tr); }
  generalBody.appendChild(frag); itemsRendered=end; endMarker.textContent=(serverExhausted && itemsRendered>=generalView.length)?'Fim da lista':''; updateCounts();
}
function resetGeneralDom(){ generalBody.innerHTML=''; generalChkMap.clear(); itemsRendered=0; endMarker.textContent=''; }

/* ========= Scroll / PaginaÃ§Ã£o ========= */
function onGeneralScroll(){
  if (loadingMore) return;
  const nearBottom = generalWrap.scrollTop + generalWrap.clientHeight >= generalWrap.scrollHeight - 100;
  if (nearBottom && itemsRendered < generalView.length){ loadingMore=true; setTimeout(()=>{ renderGeneralChunk(); loadingMore=false; },30); return; }
  if (nearBottom && !serverExhausted && !fetching){ fetchNextPage(); }
}
generalWrap.addEventListener('scroll', onGeneralScroll);

/* ========= Favoritos ========= */
function itemMatchesFavScope(item){ if (!shouldFilterFavs()) return true; return matchesFilters(item); }
function renderFavs(){
  favBody.innerHTML='';
  const favList = produtosList.filter(p=>isFav(p.sku)).filter(itemMatchesFavScope);
  const frag=document.createDocumentFragment();
  for (const item of favList){
    const tr=document.createElement('tr');
    const tdAct=document.createElement('td'); tdAct.className='col-fav';
    const btn=document.createElement('button'); btn.title='Remover'; btn.innerHTML='ðŸ—‘ï¸';
    btn.addEventListener('click',()=>{ favSet.delete(item.sku); favSave(); const chk=generalChkMap.get(item.sku); if(chk){ chk.checked=false; } renderFavs(); updateFavHeight(); updateCounts(); });
    tdAct.appendChild(btn); tr.appendChild(tdAct);
    const tdSku=document.createElement('td'); tdSku.className='col-sku'; tdSku.textContent=item.sku; tr.appendChild(tdSku);
    const tdDesc=document.createElement('td'); tdDesc.className='col-desc'; tdDesc.innerHTML=(item.desc||'').replace(/</g,'&lt;'); tr.appendChild(tdDesc);
    tr.appendChild(createParamCell(item));
    const {min,max}=computeMinMaxForRow(item);
    for (const c of chosen){ tr.appendChild(createPriceCell(item, c.label, locked.has(c.site_id), min, max)); }
    frag.appendChild(tr);
  }
  favBody.appendChild(frag);
}

/* ========= Contadores ========= */
function updateCounts(){
  countShown.textContent = 'Exibindo ' + itemsRendered + ' de ' + generalView.length + ' no Geral';
  countTotal.textContent = serverExhausted ? ('Total carregado: ' + produtosList.length) : ('Carregandoâ€¦ (' + produtosList.length + '+ )');
  countFavs.textContent  = 'Favoritos: ' + favSet.size;
}

/* ========= Query ========= */
function buildQuery(){
  // LÃª direto da view dinÃ¢mica
  return sb.from(VIEW).select(
    'ean, site_id, site_nome, preco, data, descricao, preco_num, meu_preco, descricao_cliente',
    { count:'estimated' }
  ).order('data', { ascending:false });
}
async function fetchNextPage(){
  if (fetching || serverExhausted) return; fetching = true; hideErr(); setStatus('Carregandoâ€¦ (offset ' + serverOffset + ')'); dlog({step:'fetch', offset:serverOffset});
  try{
    const from=serverOffset, to=serverOffset+PAGE_SIZE-1;
    const { data, error, count } = await buildQuery().range(from,to);
    if (error) throw error;
    dlog({fetched: data?.length||0, count});
    if (!data || data.length===0){
      serverExhausted = true; setStatus('Todos os dados carregados.');
      if (itemsRendered >= generalView.length) endMarker.textContent = 'Fim da lista';
    } else {
      upsertRowsIntoProdutos(data); recomputeGeneralView(); renderFavs();
      if (!favFirstAutoRenderDone){ updateFavHeight(); favFirstAutoRenderDone=true; }
      serverOffset += PAGE_SIZE; setStatus('Carregados (parcial): ' + produtosList.length + ' SKUs');
    }
  }catch(e){ console.error(e); showErr('Falha ao carregar: '+(e?.message||e)); setStatus('Erro ao carregar.'); }
  finally{ fetching=false; updateCounts(); }
}

/* ========= Reset ========= */
function resetAndQuery(){
  dlog({step:'resetAndQuery'});
  produtosMap.clear(); produtosList=[]; serverOffset=0; serverExhausted=false; favFirstAutoRenderDone=false;
  generalView=[]; resetGeneralDom(); renderFavs(); updateFavHeight(); updateCounts(); fetchNextPage();
}

/* ========= UI ========= */
ddMeusDados.addEventListener('click', ()=> location.href='meusdados.html');
ddPlanos.addEventListener('click', ()=> location.href='planos.html');
btnSair.addEventListener('click', async ()=>{ try{ await sb.auth.signOut(); } finally{ localStorage.removeItem('mm_login_date'); location.href = CFG.SITE_URL || 'index.html'; }});

const onFilterInput = debounce(()=>{ currentEanQ=(eanFilter.value||'').trim(); currentDescQ=(descFilter.value||'').trim();
  recomputeGeneralView(); renderFavs(); updateFavHeight(); updateCounts(); dlog({step:'filter', ean:currentEanQ, desc:currentDescQ}); },400);
eanFilter.addEventListener('input', onFilterInput); descFilter.addEventListener('input', onFilterInput);

btnReload.addEventListener('click', async ()=>{
  dlog({step:'manualReload.start'});
  const s=(await sb.auth.getSession()).data.session;
  if (s?.user?.id){
    let planKey='basico';
    try{
      const { data, error } = await sb.from('profiles').select('plan').eq('id', s.user.id).maybeSingle();
      if (!error){
        const raw=(data?.plan||'basico').toString(); planKey=raw.toLowerCase();
        planChip.textContent = 'Plano: ' + (raw.charAt(0).toUpperCase()+raw.slice(1));
      }
    }catch(e){ dlog({warn:'get plan failed', detail:String(e)}); }
    await loadUserSelection(s.user.id, planKey);
  }
  resetAndQuery();
  dlog({step:'manualReload.end'});
});

function initScopeRadios(){
  localStorage.setItem('mm_scope','both'); searchScope='both';
  const radios=scopeGroup.querySelectorAll('input[name="scope"]');
  radios.forEach(r=>{
    r.checked=(r.value===searchScope);
    r.addEventListener('change', ()=>{
      if(!r.checked) return;
      searchScope=r.value; localStorage.setItem('mm_scope',searchScope);
      recomputeGeneralView(); renderFavs(); updateFavHeight(); updateCounts();
      dlog({step:'scopeChange', scope:searchScope});
    });
  });
}

/* ========= Favoritos: altura/resizer ========= */
function measureRowHeight(){ const row=document.querySelector('#favTable tbody tr'); if(!row) return 44; const h=Math.round(row.getBoundingClientRect().height); return Math.max(36, h||44); }
function measureHeadHeight(){ const head=document.querySelector('#favTable thead'); if(!head) return 40; const h=Math.round(head.getBoundingClientRect().height); return Math.max(32, h||40); }
function applyFavHeight(px){ if(!px||!Number.isFinite(px)) return; const maxPx=Math.round(window.innerHeight*0.85); const clamped=Math.max(120, Math.min(px, maxPx)); favWrap.style.height=clamped+'px'; }
function updateFavHeight(){ if (favHeightUser){ applyFavHeight(favHeightUser); return; } const rowsLen=favBody.children.length; const rows=Math.min(rowsLen,20); const rowH=measureRowHeight(); const headH=measureHeadHeight(); const pad=8; const target=headH + rows*rowH + pad; applyFavHeight(target); }
(function initResizer(){ let startY=0, startH=0;
  function onMove(ev){ const dy=ev.clientY-startY; favHeightUser=startH+dy; localStorage.setItem('mm_fav_height', String(favHeightUser)); applyFavHeight(favHeightUser); }
  function stop(){ removeEventListener('mousemove', onMove); removeEventListener('mouseup', stop); document.body.classList.remove('resizing'); }
  favResizer.addEventListener('mousedown', (ev)=>{ startY=ev.clientY; startH=favWrap.offsetHeight; document.body.classList.add('resizing'); addEventListener('mousemove', onMove); addEventListener('mouseup', stop); });
  favResizer.addEventListener('dblclick', ()=>{ favHeightUser=null; localStorage.removeItem('mm_fav_height'); updateFavHeight(); });
})();

/* ========= GrÃ¡fico simples ========= */
const pop=document.getElementById('chartPopover'), popTitle=document.getElementById('chartTitle'), popClose=document.getElementById('chartClose'), popMsg=document.getElementById('chartMsg');
const spark=document.getElementById('spark'), sparkCtx=spark.getContext('2d');
popClose.addEventListener('click', ()=> pop.style.display='none');
addEventListener('click', (ev)=>{ if(pop.style.display!=='none' && !pop.contains(ev.target) && !ev.target.closest('.chart-btn')) pop.style.display='none'; });

function drawSparkFull(points){
  const ctx=sparkCtx,W=spark.width,H=spark.height; ctx.clearRect(0,0,W,H);
  if(!points || points.length<3){ popMsg.style.display='block'; popMsg.textContent='HistÃ³rico insuficiente (â‰¥3 pontos).'; return; }
  popMsg.style.display='none';
  const m={l:40,r:14,t:12,b:28}, xs=points.map(p=>p.x.getTime()), ys=points.map(p=>p.y);
  const xMin=Math.min(...xs), xMax=Math.max(...xs), yMin=Math.min(...ys), yMax=Math.max(...ys);
  const xS=v=>m.l+((v-xMin)/(xMax-xMin||1))*(W-m.l-m.r);
  const yR=v=>H-m.b-((v-yMin)/(yMax-yMin||1))*(H-m.t-m.b);
  const yS=v=>Math.max(m.t+6, Math.min(H-m.b-6, yR(v)));
  ctx.strokeStyle='#232323'; ctx.lineWidth=1; ctx.beginPath();
  for(let i=0;i<=3;i++){ const yy=m.t+i*(H-m.t-m.b)/3; ctx.moveTo(m.l,yy); ctx.lineTo(W-m.r,yy); } ctx.stroke();
  ctx.beginPath(); ctx.lineWidth=3; ctx.strokeStyle='#00d084';
  points.forEach((p,i)=>{ const X=xS(p.x.getTime()), Y=yS(p.y); if(i===0) ctx.moveTo(X,Y); else ctx.lineTo(X,Y); }); ctx.stroke();
  ctx.fillStyle='#00d084'; points.forEach(p=>{ const X=xS(p.x.getTime()), Y=yS(p.y); ctx.beginPath(); ctx.arc(X,Y,2.5,0,Math.PI*2); ctx.fill(); });
  ctx.fillStyle='#9aa0a6'; ctx.font='10px Arial'; ctx.fillText(new Date(xMin).toLocaleDateString('pt-BR'), m.l, H-8); ctx.fillText(new Date(xMax).toLocaleDateString('pt-BR'), W-m.r-64, H-8);
}
async function fetchHistory(ean, siteId){
  let pts=[];
  try{
    // histÃ³rico direto da view, filtrando por site_id
    const { data, error } = await sb.from(VIEW).select('data, preco_num').eq('ean', ean).eq('site_id', siteId).not('preco_num','is',null).order('data',{ascending:true}).limit(180);
    if (!error && data && data.length){ pts = data.map(r=>({ x:new Date(r.data), y:Number(r.preco_num) })).filter(p=>Number.isFinite(p.y)); }
  }catch(e){ dlog({error:'fetchHistory.view', detail:String(e)}); }
  // dedup & sort
  const byTs = new Map(pts.map(p=>[p.x.getTime(), p])); return Array.from(byTs.values()).sort((a,b)=>a.x-b.x);
}
async function openChartFor(ev, ean, label, siteId){
  const x = ev.clientX || (ev.touches && ev.touches[0]?.clientX) || 120, y = ev.clientY || (ev.touches && ev.touches[0]?.clientY) || 80;
  pop.style.left = Math.max(12, x - 260) + 'px'; pop.style.top  = Math.max(12, y - 200) + 'px';
  popTitle.textContent = 'HistÃ³rico â€” ' + label + ' â€¢ EAN ' + ean; pop.style.display='block'; popMsg.style.display='none';
  const points = await fetchHistory(String(ean), Number(siteId)); drawSparkFull(points);
}

/* ========= Minimizar/Maximizar painÃ©is ========= */
function applyToggle(btn, wrap, extraEl, key){
  const collapsed = localStorage.getItem(key) === '1';
  function setState(isCollapsed){ btn.setAttribute('aria-expanded', String(!isCollapsed)); btn.textContent = isCollapsed ? 'Maximizar' : 'Minimizar'; wrap.style.display = isCollapsed ? 'none' : 'block'; if (extraEl) extraEl.style.display = isCollapsed ? 'none' : ''; }
  setState(collapsed);
  btn.addEventListener('click', ()=>{ const curr = btn.getAttribute('aria-expanded') === 'true'; const nextCollapsed = curr; localStorage.setItem(key, nextCollapsed ? '1' : '0'); setState(nextCollapsed); });
}
applyToggle(toggleFavBtn, favWrap, document.getElementById('favResizer'), 'mm_tgl_fav');
applyToggle(toggleGenBtn, generalWrap, null, 'mm_tgl_gen');

/* ========= ImpressÃ£o de Favoritos ========= */
function buildPrintHTMLFromFav() {
  const favHeaderRow = document.getElementById('favHeaderRow');
  const headers = Array.from(favHeaderRow?.children || []).map(th => th.textContent.trim()).filter((_, i) => i !== 0);
  const favBody = document.querySelector('#favTable tbody'); const rows = Array.from(favBody?.rows || []);
  const thead = '<thead><tr>' + headers.map(h => '<th>'+h+'</th>').join('') + '</tr></thead>';
  let tbody = ''; for (const tr of rows) { const cells = Array.from(tr.cells).slice(1).map(td => { const txt = (td.textContent || '').replace(/\s+/g, ' ').trim(); return '<td>'+(txt || 'â€”')+'</td>'; }); tbody += '<tr>'+cells.join('')+'</tr>'; }
  const css = '*{box-sizing:border-box;} body{font-family:Arial,sans-serif;color:#000;background:#fff;padding:24px;} h1{margin:0 0 4px 0;font-size:18px;} .meta{color:#444;font-size:12px;margin-bottom:14px;} table{width:100%;border-collapse:collapse;} thead th{text-align:left;font-weight:700;padding:6px 0;} tbody td{padding:4px 0;} @media print{body{padding:0;}}';
  const now=new Date(); const meta = now.toLocaleDateString('pt-BR')+' '+now.toLocaleTimeString('pt-BR');
  return '<!DOCTYPE html><html><head><meta charset="utf-8"><title>RelatÃ³rio â€” Favoritos</title><style>'+css+'</style></head><body><h1>RelatÃ³rio â€” Favoritos</h1><div class="meta">Gerado em '+meta+'</div><table>'+thead+'<tbody>'+tbody+'</tbody></table><script>window.onload=()=>{window.print()}<\/script></body></html>';
}
function printFavReport(){ const win=window.open('', '_blank'); if(!win){ alert('Permita pop-ups para imprimir.'); return; } win.document.open(); win.document.write(buildPrintHTMLFromFav()); win.document.close(); }
btnPrintFav && btnPrintFav.addEventListener('click', printFavReport);

/* ========= Init ========= */
(async function init(){
  try{
    const { data:{ session } } = await sb.auth.getSession();
    if (!session){ location.href = CFG.SITE_URL || 'index.html'; return; }
    userChip.textContent = session.user?.email || 'Logado';
    dlog({step:'session', user:session.user?.id, email:session.user?.email});

    let planKey='basico';
    try{
      const { data, error } = await sb.from('profiles').select('plan').eq('id', session.user.id).maybeSingle();
      if (!error){
        const raw=(data?.plan||'basico').toString(); planKey=raw.toLowerCase();
        planChip.textContent='Plano: '+(raw.charAt(0).toUpperCase()+raw.slice(1));
      }
    }catch(e){ dlog({warn:'get plan failed', detail:String(e)}); }

    await loadUserSelection(session.user.id, planKey);
    initScopeRadios();

    currentEanQ=''; currentDescQ='';
    resetAndQuery();
    generalWrap.dispatchEvent(new Event('scroll'));
  }catch(e){ showErr('Falha na inicializaÃ§Ã£o'); dlog({error:'init', detail:String(e)}); }
})();

/* ========= Status helper ========= */
function setStatus(t){ statusEl.textContent = t||''; }

</script>
</body>
</html>
