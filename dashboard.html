<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MaiorMargem — Dashboard</title>
<style>
  :root { color-scheme: dark; }
  body { margin:0; font-family: Arial, sans-serif; background:#121212; color:#fff; padding:20px; }
  header { display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; margin-bottom:16px; }
  h1 { margin:0; color:#00b140; }

  .chip { font-size:12px; background:#1e1e1e; border:1px solid #333; padding:6px 10px; border-radius:999px; }
  .chip.plan { color:#bfffc1; border-color:#2f5a2f; background:#132313; }
  .btn { background:#00b140; color:#fff; border:none; padding:8px 14px; border-radius:6px; cursor:pointer; }
  .btn:hover { background:#009b38; }

  .userbox { display:flex; gap:12px; align-items:center; position:relative; }
  .userChipWrap { position:relative; display:inline-block; }
  .dropdown { position:absolute; right:0; top:calc(100% + 6px); display:none; min-width:180px; padding:6px; background:#0f0f0f; border:1px solid #2a2a2a; border-radius:10px; box-shadow:0 10px 30px rgba(0,0,0,.5); z-index:50; }
  .userChipWrap:hover .dropdown, .userChipWrap.open .dropdown { display:block; }
  .dd-item { width:100%; background:transparent; border:none; color:#eee; text-align:left; padding:10px 12px; border-radius:8px; cursor:pointer; font-size:14px; }
  .dd-item:hover { background:#1b1b1b; }

  .panel { background:#202020; border:1px solid #2a2a2a; border-radius:12px; padding:12px; margin-bottom:18px; }
  .panel-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:10px; }
  .panel-header h2 { margin:0; font-size:18px; color:#d5ffd5; }
  .toggle-btn { background:none; border:1px solid #2a2a2a; color:#ddd; padding:6px 10px; border-radius:8px; cursor:pointer; }
  .toggle-btn:hover { background:#1b1b1b; }

  .filters { display:grid; grid-template-columns: 1fr 1fr auto; gap:12px; margin:16px 0; }
  .filters input { padding:10px 12px; border-radius:6px; border:1px solid #333; background:#1e1e1e; color:#fff; }

  .status { margin:10px 0; color:#9aa0a6; font-size:12px; }
  .err { display:none; color:#ff6b6b; font-size:13px; }

  .wrap { overflow:auto; border:1px solid #2a2a2a; border-radius:10px; position:relative; }
  #generalWrap { height:55vh; }

  table { width:100%; border-collapse:separate; border-spacing:0; }
  thead { position:sticky; top:0; z-index:3; }
  thead th { position:sticky; top:0; background:#0f0f0f; z-index:4; }
  th,td { border-bottom:1px solid #2a2a2a; padding:10px; text-align:left; font-size:14px; vertical-align:top; }
  tbody tr:hover { background:#1a1a1a; }

  .col-fav { width:40px; text-align:center; }
  .col-sku { width:160px; font-family:ui-monospace,Consolas,monospace; }
  .col-desc { min-width:260px; }

  .price { font-weight:700; display:inline-block; font-size:16px; vertical-align:middle; }
  @media (min-width:1200px) { .price { font-size:18px; } }
  .price.min { color:#ff4d4f; }
  .price.max { color:#00d084; }
  .muted { display:none; }
  .end-marker { text-align:center; padding:10px; color:#9aa0a6; }
  .counts { margin-top:10px; font-size:12px; color:#9aa0a6; display:flex; gap:12px; flex-wrap:wrap; }

  .resizer { height:10px; margin-top:6px; border:1px solid #2a2a2a; border-radius:8px; cursor:ns-resize; background:linear-gradient(180deg,#1c1c1c,#111); display:flex; align-items:center; justify-content:center; }
  .resizer:after { content:""; width:40px; height:3px; border-radius:3px; background:#3a3a3a; }
  body.resizing, body.resizing * { cursor:ns-resize!important; user-select:none; }

  /* Bloqueio por plano */
  th[data-locked="true"] { color:#aaa; position:relative; }
  th[data-locked="true"]::after { content:"🔒"; margin-left:6px; opacity:.8; font-size:14px; }
  td.locked-cell .price { filter:blur(3px); }
  td.locked-cell .unlock { display:none; }
  td.locked-cell:hover .unlock {
    display:inline-flex; align-items:center; gap:6px;
    margin-left:8px; padding:4px 8px; border-radius:6px;
    border:1px solid #2e2e2e; background:#141414; color:#ddd; font-size:12px; cursor:pointer;
  }
  td.locked-cell .unlock:hover { background:#1b1b1b; }

  .chart-btn { display:inline-flex; align-items:center; justify-content:center; width:28px; height:28px; margin-left:8px; border-radius:6px; border:1.5px solid #2e2e2e; background:#141414; color:#dcdcdc; cursor:pointer; box-shadow:0 2px 6px rgba(0,0,0,.35); }
  .chart-btn:hover { background:#1b1b1b; border-color:#3a3a3a; }
  .chart-icon { width:16px; height:16px; display:block; }

  .chart-popover { position:absolute; z-index:1000; width:240px; padding:10px; background:#0f0f0f; border:1px solid #2a2a2a; border-radius:10px; box-shadow:0 10px 40px rgba(0,0,0,.6); }
  .chart-popover header { font-size:12px; color:#b5b5b5; display:flex; justify-content:space-between; align-items:center; margin-bottom:6px; }
  .chart-popover .close { background:transparent; border:none; color:#aaa; font-size:16px; cursor:pointer; }
  .chart-popover .msg { font-size:12px; color:#bbb; padding:8px; text-align:center; }
  canvas.spark { width:200px; height:180px; display:block; background:#121212; border:1px solid #232323; border-radius:6px; }
</style>
<script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<script src="./config.js"></script>
</head>
<body>
<header>
  <h1>MaiorMargem — Dashboard</h1>
  <div class="userbox">
    <span id="planChip" class="chip plan">Plano: —</span>
    <div class="userChipWrap">
      <span id="userChip" class="chip">Usuário</span>
      <div id="userDropdown" class="dropdown" role="menu" aria-hidden="true">
        <button class="dd-item" id="ddMeusDados">Meus dados</button>
        <button class="dd-item" id="ddPlanos">Planos</button>
      </div>
    </div>
    <button id="btnSair" class="btn">Sair</button>
  </div>
</header>

<div class="panel">
  <div class="filters">
    <input id="eanFilter" placeholder="Filtrar por EAN/GTIN…"/>
    <input id="descFilter" placeholder="Filtrar por descrição…"/>
    <button id="btnReload" class="btn">Recarregar</button>
  </div>
  <div class="status"><span id="status"></span></div>
  <div id="err" class="err"></div>
</div>

<section id="favPanel" class="panel">
  <div class="panel-header">
    <h2>Favoritos</h2>
    <button id="toggleFav" class="toggle-btn" aria-expanded="true">Minimizar</button>
  </div>
  <div id="favWrap" class="wrap">
    <table id="favTable">
      <thead><tr id="favHeaderRow"></tr></thead>
      <tbody></tbody>
    </table>
  </div>
  <div id="favResizer" class="resizer" title="Arraste p/ redimensionar. Duplo clique: auto."></div>
</section>

<section id="generalPanel" class="panel">
  <div class="panel-header">
    <h2>Geral</h2>
    <button id="toggleGen" class="toggle-btn" aria-expanded="true">Minimizar</button>
  </div>
  <div id="generalWrap" class="wrap">
    <table id="produtosTable">
      <thead><tr id="generalHeaderRow"></tr></thead>
      <tbody></tbody>
    </table>
    <div id="endMarker" class="end-marker"></div>
  </div>
  <div class="counts">
    <span id="countShown"></span>
    <span id="countTotal"></span>
    <span id="countFavs"></span>
  </div>
</section>

<!-- Popover único do gráfico -->
<div id="chartPopover" class="chart-popover" style="display:none;">
  <header>
    <span id="chartTitle">Histórico</span>
    <button class="close" id="chartClose" aria-label="Fechar">×</button>
  </header>
  <canvas id="spark" class="spark" width="200" height="180"></canvas>
  <div id="chartMsg" class="msg" style="display:none;"></div>
</div>

<script>
/* ================== CONFIG / SUPABASE ================== */
const CFG = window.CONFIG || {};
const sb = supabase.createClient(CFG.SUPABASE_URL, CFG.SUPABASE_ANON_KEY, { auth:{ persistSession:true, autoRefreshToken:true, detectSessionInUrl:true } });

/* ================== CONSTANTES ================== */
const VIEW = 'vw_precos_com_desc';
const PAGE_SIZE = 200;
const RENDER_CHUNK = 60;

/* ================== ELEMENTOS ================== */
const statusEl   = document.getElementById('status');
const errEl      = document.getElementById('err');
const userChip   = document.getElementById('userChip');
const planChip   = document.getElementById('planChip');
const ddMeusDados= document.getElementById('ddMeusDados');
const ddPlanos   = document.getElementById('ddPlanos');
const btnSair    = document.getElementById('btnSair');
const btnReload  = document.getElementById('btnReload');
const eanFilter  = document.getElementById('eanFilter');
const descFilter = document.getElementById('descFilter');

const favHeaderRow    = document.getElementById('favHeaderRow');
const favBody         = document.querySelector('#favTable tbody');
const favResizer      = document.getElementById('favResizer');

const generalHeaderRow= document.getElementById('generalHeaderRow');
const generalBody     = document.querySelector('#produtosTable tbody');
const generalWrap     = document.getElementById('generalWrap');
const endMarker       = document.getElementById('endMarker');

const countShown = document.getElementById('countShown');
const countTotal = document.getElementById('countTotal');
const countFavs  = document.getElementById('countFavs');

/* Popover gráfico */
const pop        = document.getElementById('chartPopover');
const popTitle   = document.getElementById('chartTitle');
const popClose   = document.getElementById('chartClose');
const popMsg     = document.getElementById('chartMsg');
const sparkCanvas= document.getElementById('spark');
const sparkCtx   = sparkCanvas.getContext('2d');

/* ================== HELPERS / MAPAS ================== */
/** O campo "site" na VIEW usa chaves como "PrecoLeroyMerlin". Este mapa resolve display label. */
const labelByViewKey = {
  "PrecoLeroyMerlin":"LeroyMerlin",
  "PrecoQueroQuero":"QueroQuero",
  "PrecoCassol":"Cassol",
  "PrecoRedeMac":"RedeMac",
  "PrecoMestreTinho":"MestreTinho",
  "PrecoTumelero":"Tumelero",
  "PrecoSupremeinox":"Supremeinox",
  "PrecoGhaus":"Ghaus"
};
/** inverso: display label -> view key */
const viewKeyByLabel = Object.fromEntries(Object.entries(labelByViewKey).map(([k,v])=>[v,k]));

/** Normalizador robusto para nomes vindos da tabela SITES */
function normalize(s){
  return (s||'').toString()
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .replace(/\s+/g,'').replace(/[^a-zA-Z0-9]/g,'')
    .toLowerCase();
}
/** Mapeia qualquer variação textual do banco (nome/name/site) para o label padrão do dashboard */
function toLabel(raw){
  const n = normalize(raw);
  if (n==='leroymerlin') return 'LeroyMerlin';
  if (n==='queroquero') return 'QueroQuero';
  if (n==='cassol'||n==='cassolcenterlar') return 'Cassol';
  if (n==='redemac'||n==='redemacsuperbem'||n==='superbem'||n==='redemacsuperbem') return 'RedeMac';
  if (n==='mestretinho'||n==='mestrettinho') return 'MestreTinho';
  if (n==='tumelero') return 'Tumelero';
  if (n==='supremeinox'||n==='supreme'||n==='supremeinoxcombr') return 'Supremeinox';
  if (n==='ghaus'||n==='g-haus') return 'Ghaus';
  // fallback: tenta casar com labels já conhecidos
  for (const lbl of Object.values(labelByViewKey)){
    if (normalize(lbl)===n) return lbl;
  }
  return ''; // desconhecido (não exibimos)
}

/* ================== ESTADO ================== */
const DEFAULT_PLAN_SITE_LIMIT = { trial:2, basico:4, intermediario:5, premium:8 };

let chosenLabels = [];          // labels exatamente como selecionados em user_sites
let unlockedSites = new Set();  // subset liberado (<= limite do plano)
let lockedSites   = new Set();  // subset excedente

let favSet = new Set(JSON.parse(localStorage.getItem('mm_favs') || '[]'));
let produtosMap = new Map();  // Map<ean, { sku, desc, sites: { [label]: {precoRaw, precoNum, data} } }>
let produtosList = [];
let itemsRendered = 0;

let serverOffset = 0;
let serverExhausted = false;
let fetching = false;

let currentEanQ = '';
let currentDescQ = '';

let loadingMore = false;
let suppressGeneralChange = false;
const generalChkMap = new Map();

let favFirstAutoRenderDone = false;

/* ================== UTILS ================== */
function setStatus(t){ statusEl.textContent = t||''; }
function showErr(e){ errEl.style.display='block'; errEl.textContent = String(e||'').trim(); }
function hideErr(){ errEl.style.display='none'; errEl.textContent=''; }
function formatBRL(n){ try{return n.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}catch{return String(n)} }
function debounce(fn,delay=500){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),delay) } }
function favSave(){ localStorage.setItem('mm_favs', JSON.stringify([...favSet])); }
function isFav(sku){ return favSet.has(String(sku)); }

/* ================== CABEÇALHOS DINÂMICOS ================== */
function buildHeaders(){
  // colunas fixas:
  const fixedFav = `<th class="col-fav">★</th>`;
  const fixedSku = `<th class="col-sku">EAN</th>`;
  const fixedDesc= `<th class="col-desc">Descrição</th>`;

  // sites selecionados na ordem de user_sites:
  const sitesTh = chosenLabels.map(lbl => {
    const locked = lockedSites.has(lbl) ? ' data-locked="true"' : ' data-locked="false"';
    return `<th data-site="${lbl}"${locked}>${lbl}</th>`;
  }).join('');

  favHeaderRow.innerHTML     = `<th class="col-fav">Ação</th>${fixedSku}${fixedDesc}${sitesTh}`;
  generalHeaderRow.innerHTML = `${fixedFav}${fixedSku}${fixedDesc}${sitesTh}`;
}

/* Atualiza opacidade/cadeado caso muda bloqueio */
function refreshHeaderLocks(){
  const headerThs = document.querySelectorAll('thead th[data-site]');
  headerThs.forEach(th=>{
    const s = th.getAttribute('data-site');
    const locked = lockedSites.has(s);
    th.setAttribute('data-locked', locked ? 'true':'false');
    th.style.opacity = locked ? '0.4':'1';
  });
}

/* ================== LIMITE DO PLANO (dinâmico) ================== */
async function getSitesLimitForPlan(planKey){
  const key = (planKey||'').toLowerCase();
  try{
    const { data, error } = await sb.from('billing_plans')
      .select('sites_limit, max_sites')
      .eq('plan_key', key)
      .maybeSingle();
    if (error) throw error;
    const lim = Number(data?.sites_limit ?? data?.max_sites);
    if (Number.isFinite(lim) && lim>0) return lim;
  }catch(e){ console.warn('billing_plans sem valor, usando fallback', e); }
  return DEFAULT_PLAN_SITE_LIMIT[key] ?? 2;
}

/* ================== LER SELEÇÃO EM user_sites (ORDEM REAL) ================== */
async function loadUserSelectionAndLocks(userId, planKey){
  const limit = await getSitesLimitForPlan(planKey);

  // 1) user_sites -> lista de IDs (na ordem criada/explicitada por id)
  let userSiteRows = [];
  try{
    const { data, error } = await sb.from('user_sites')
      .select('site_id, enabled, position, id')
      .eq('user_id', userId)
      .order('position', { ascending: true, nullsFirst: false })
      .order('id', { ascending: true });
    if (error) throw error;
    userSiteRows = (data||[]).filter(r => r.enabled !== false);
  }catch(e){ console.warn('Falha lendo user_sites:', e); }

  // 2) Se não há seleção, vamos exibir nada (ou todas como fallback?). Aqui: fallback = TODAS existentes
  let labels = [];
  if (userSiteRows.length){
    const ids = userSiteRows.map(r=>r.site_id).filter(x=>x!=null);
    try{
      const { data: sites, error } = await sb.from('sites').select('id, nome, name, site').in('id', ids);
      if (error) throw error;
      // preserva ordem de user_sites
      labels = ids.map(id => {
        const s = (sites||[]).find(x=>x.id===id);
        return toLabel(s?.nome || s?.name || s?.site || '');
      }).filter(lbl => !!lbl && viewKeyByLabel[lbl]); // só labels que sabemos mapear para a view
    }catch(e){ console.warn('Falha lendo sites:', e); }
  }

  if (!labels.length){
    // Fallback: todas as que temos mapeadas (ordem alfabética)
    labels = Object.values(labelByViewKey).sort((a,b)=>a.localeCompare(b,'pt-BR'));
  }

  // 3) aplica limite
  const uniqueLabels = [...new Set(labels)];
  chosenLabels = uniqueLabels;
  unlockedSites = new Set(uniqueLabels.slice(0, limit));
  lockedSites   = new Set(uniqueLabels.slice(limit));

  // 4) refaz cabeçalhos dinâmicos
  buildHeaders();
  refreshHeaderLocks();

  setStatus(`Sites selecionados: ${unlockedSites.size}/${chosenLabels.length} liberados${lockedSites.size?` • ${lockedSites.size} bloqueado(s)`:''}`);
}

/* ================== AGREGAÇÃO DOS DADOS ================== */
function upsertRowsIntoProdutos(rows){
  for (const r of rows){
    const ean = String(r.ean??'');
    const viewKey = String(r.site??'');
    const lbl = labelByViewKey[viewKey]; // converte para label que usamos no dashboard
    if (!lbl) continue; // se chegou algum site não mapeado, ignora

    if (!produtosMap.has(ean)) produtosMap.set(ean, { sku: ean, desc: r.descricao||'', sites:{} });
    const item = produtosMap.get(ean);
    if (!item.desc && r.descricao) item.desc = r.descricao;

    const prev = item.sites[lbl];
    if (!prev || new Date(r.data) > new Date(prev.data)){
      item.sites[lbl] = { precoRaw:r.preco, precoNum:r.preco_num, data:r.data };
    }
  }
  produtosList = Array.from(produtosMap.values());
}

/* ================== RENDER ================== */
function chartButtonSVG(){
  return `<svg class="chart-icon" viewBox="0 0 24 24" aria-hidden="true">
    <rect x="3" y="11" width="3" height="7" rx="1" fill="#2d2d2d" stroke="#3b3b3b" stroke-width="1"></rect>
    <rect x="9" y="8"  width="3" height="10" rx="1" fill="#2d2d2d" stroke="#3b3b3b" stroke-width="1"></rect>
    <rect x="15" y="5" width="3" height="13" rx="1" fill="#2d2d2d" stroke="#3b3b3b" stroke-width="1"></rect>
    <path d="M3,18 L7,14 L12,15 L17,8 L21,10" fill="none" stroke="#00d084" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
  </svg>`;
}
function computeMinMaxForRow(item){
  let min = { site:null, val:Infinity }, max={ site:null, val:-Infinity };
  for (const s of chosenLabels){
    if (lockedSites.has(s)) continue;
    const d = item.sites[s];
    if (!d || !Number.isFinite(d.precoNum)) continue;
    if (d.precoNum < min.val) { min={site:s, val:d.precoNum}; }
    if (d.precoNum > max.val) { max={site:s, val:d.precoNum}; }
  }
  return { minSite:min.site, maxSite:max.site };
}
function createPriceCell(item, label, minSite, maxSite){
  const td = document.createElement('td');
  if (!chosenLabels.includes(label)) return td; // segurança

  const d = item.sites[label];
  const isLocked = lockedSites.has(label);
  if (isLocked) td.classList.add('locked-cell');

  if (d){
    const dtStr = d.data ? new Date(d.data).toLocaleString('pt-BR') : '';
    if (Number.isFinite(d.precoNum)){
      const span = document.createElement('span');
      span.className = `price ${!isLocked && label===minSite ? 'min' : (!isLocked && label===maxSite ? 'max':'')}`;
      span.title = isLocked ? 'Excedeu o limite do plano' : (dtStr ? `Atualizado em ${dtStr}` : '');
      span.textContent = formatBRL(d.precoNum);
      td.appendChild(span);

      const b = document.createElement('button');
      b.className='chart-btn'; b.type='button';
      b.title = isLocked ? 'Disponível no upgrade' : 'Ver histórico';
      b.innerHTML = chartButtonSVG();
      b.addEventListener('click', (ev)=>{
        if (isLocked){ window.location.href='planos.html'; return; }
        openChartFor(ev, item.sku, label);
      });
      td.appendChild(b);

      if (isLocked){
        const up = document.createElement('button');
        up.className='unlock'; up.type='button'; up.title='Excedeu o limite. Ver planos.'; up.textContent='Ver planos';
        up.addEventListener('click', ()=> window.location.href='planos.html');
        td.appendChild(up);
      }
    }else{
      const span = document.createElement('span');
      span.className='price';
      span.title = isLocked ? 'Excedeu o limite do plano' : (dtStr ? `Atualizado em ${dtStr}` : '');
      span.textContent = (d.precoRaw??'').toString();
      td.appendChild(span);
    }
  }else{
    td.innerHTML = `<span class="muted">—</span>`;
  }
  return td;
}
function renderRowInto(tr, item){
  // fav
  const tdFav = document.createElement('td'); tdFav.className='col-fav';
  const chk = document.createElement('input'); chk.type='checkbox'; chk.checked=isFav(item.sku);
  chk.addEventListener('change', ()=>{ if (chk.checked) favSet.add(item.sku); else favSet.delete(item.sku); favSave(); renderFavs(); updateFavHeight(); updateCounts(); });
  tdFav.appendChild(chk); tr.appendChild(tdFav); generalChkMap.set(item.sku, chk);

  // sku + desc
  const tdSku = document.createElement('td'); tdSku.className='col-sku'; tdSku.textContent=item.sku; tr.appendChild(tdSku);
  const tdDesc= document.createElement('td'); tdDesc.className='col-desc'; tdDesc.innerHTML=(item.desc||'').replace(/</g,'&lt;'); tr.appendChild(tdDesc);

  // colunas de sites (somente as selecionadas e em ordem)
  const {minSite,maxSite} = computeMinMaxForRow(item);
  for (const lbl of chosenLabels){
    tr.appendChild(createPriceCell(item, lbl, minSite, maxSite));
  }
}
function renderGeneralChunk(){
  const end = Math.min(itemsRendered + RENDER_CHUNK, produtosList.length);
  const frag = document.createDocumentFragment();
  for (let i=itemsRendered;i<end;i++){ const it = produtosList[i]; const tr = document.createElement('tr'); renderRowInto(tr, it); frag.appendChild(tr); }
  generalBody.appendChild(frag);
  itemsRendered = end;
  endMarker.textContent = (serverExhausted && itemsRendered >= produtosList.length) ? 'Fim da lista' : '';
  updateCounts();
}
function resetGeneralDom(){
  generalBody.innerHTML=''; itemsRendered=0; endMarker.textContent='';
}
function onGeneralScroll(){
  if (loadingMore) return;
  const nearBottom = generalWrap.scrollTop + generalWrap.clientHeight >= generalWrap.scrollHeight - 100;
  if (nearBottom && itemsRendered < produtosList.length){ loadingMore=true; setTimeout(()=>{ renderGeneralChunk(); loadingMore=false; }, 30); return; }
  if (nearBottom && !serverExhausted && !fetching){ fetchNextPage(); }
}
generalWrap.addEventListener('scroll', onGeneralScroll);

/* ================== FAVORITOS ================== */
function renderFavs(){
  favBody.innerHTML='';
  const favList = produtosList.filter(p=>isFav(p.sku));
  const frag = document.createDocumentFragment();
  for (const item of favList){
    const tr = document.createElement('tr');

    // ação
    const tdAct=document.createElement('td'); tdAct.className='col-fav';
    const btn=document.createElement('button'); btn.title='Remover'; btn.innerHTML='🗑️';
    btn.addEventListener('click', ()=>{ favSet.delete(item.sku); favSave(); const chk=generalChkMap.get(item.sku); if (chk){ suppressGeneralChange=true; chk.checked=false; suppressGeneralChange=false; } renderFavs(); updateFavHeight(); updateCounts(); });
    tdAct.appendChild(btn); tr.appendChild(tdAct);

    // sku + desc
    const tdSku=document.createElement('td'); tdSku.className='col-sku'; tdSku.textContent=item.sku; tr.appendChild(tdSku);
    const tdDesc=document.createElement('td'); tdDesc.className='col-desc'; tdDesc.innerHTML=(item.desc||'').replace(/</g,'&lt;'); tr.appendChild(tdDesc);

    const {minSite,maxSite}=computeMinMaxForRow(item);
    for (const lbl of chosenLabels){ tr.appendChild(createPriceCell(item, lbl, minSite, maxSite)); }

    frag.appendChild(tr);
  }
  favBody.appendChild(frag);
}

/* ================== CONTADORES ================== */
function updateCounts(){
  const favs=favSet.size;
  countShown.textContent = `Exibindo ${itemsRendered} de ${produtosList.length}`;
  countTotal.textContent = serverExhausted ? `Total de SKUs: ${produtosList.length}` : `Carregando… (${produtosList.length}+ )`;
  countFavs.textContent  = `Favoritos: ${favs}`;
}

/* ================== CONSULTA PAGINADA ================== */
function buildQuery(){
  let q = sb.from(VIEW).select('ean, site, preco, data, descricao, preco_num', { count:'estimated' }).order('data', { ascending:false });
  if (currentEanQ)  q = q.ilike('ean', `%${currentEanQ}%`);
  if (currentDescQ) q = q.ilike('descricao', `%${currentDescQ}%`);
  return q;
}
async function fetchNextPage(){
  if (fetching || serverExhausted) return;
  fetching = true; hideErr(); setStatus(`Carregando… (offset ${serverOffset})`);
  try{
    const from = serverOffset, to = serverOffset + PAGE_SIZE - 1;
    const { data, error } = await buildQuery().range(from, to);
    if (error) throw error;

    if (!data || data.length===0){
      serverExhausted = true; setStatus('Todos os dados carregados.');
      if (itemsRendered >= produtosList.length) endMarker.textContent = 'Fim da lista';
    }else{
      upsertRowsIntoProdutos(data);
      if (itemsRendered < produtosList.length) renderGeneralChunk();
      renderFavs();
      if (!favFirstAutoRenderDone){ updateFavHeight(); favFirstAutoRenderDone=true; }
      serverOffset += PAGE_SIZE;
      setStatus(`Carregados: ${produtosList.length} SKUs (parcial)`);
    }
  }catch(e){ console.error(e); showErr('Falha ao carregar: ' + (e?.message || e)); setStatus('Erro ao carregar.'); }
  finally { fetching=false; updateCounts(); }
}

/* ================== RESET / RELOAD ================== */
function resetAndQuery(){
  produtosMap.clear(); produtosList=[]; serverOffset=0; serverExhausted=false; favFirstAutoRenderDone=false;
  resetGeneralDom();
  renderFavs(); updateFavHeight(); updateCounts();
  fetchNextPage();
}

/* ================== EVENTOS UI ================== */
ddMeusDados.addEventListener('click', ()=> location.href='meusdados.html');
ddPlanos.addEventListener('click', ()=> location.href='planos.html');
btnSair.addEventListener('click', async ()=>{ try{ await sb.auth.signOut(); }finally{ localStorage.removeItem('mm_login_date'); location.href = CFG.SITE_URL || 'index.html'; } });
btnReload.addEventListener('click', async ()=>{
  const session = (await sb.auth.getSession()).data.session;
  if (session?.user?.id){
    const planKey = await getUserPlanKey(session.user.id);
    await loadUserSelectionAndLocks(session.user.id, planKey);
  }
  resetAndQuery();
});
const onFilterInput = debounce(()=>{ currentEanQ=(eanFilter.value||'').trim(); currentDescQ=(descFilter.value||'').trim(); resetAndQuery(); }, 500);
eanFilter.addEventListener('input', onFilterInput);
descFilter.addEventListener('input', onFilterInput);

/* ================== GRÁFICO MINI ================== */
function closePopover(){ pop.style.display='none'; }
function positionPopover(x,y){
  const pad=12, vw=innerWidth, vh=innerHeight; let left=x+pad, top=y+pad; const W=240, H=260;
  if (left+W>vw) left=x-W-pad; if (top+H>vh) top=y-H-pad;
  pop.style.left=Math.max(8,left)+'px'; pop.style.top=Math.max(8,top)+'px';
}
document.addEventListener('click', (ev)=>{ if(pop.style.display!=='none' && !pop.contains(ev.target)) closePopover(); });
document.addEventListener('keydown', (ev)=>{ if(ev.key==='Escape') closePopover(); });
popClose.addEventListener('click', closePopover);

function drawSparkline(points){
  const ctx=sparkCtx, W=sparkCanvas.width, H=sparkCanvas.height; ctx.clearRect(0,0,W,H);
  if(!points||points.length<3){ popMsg.style.display='block'; popMsg.textContent='Histórico insuficiente (≥3 pontos).'; return; }
  popMsg.style.display='none';
  const m={l:40,r:14,t:12,b:28};
  const xs=points.map(p=>p.x.getTime()), ys=points.map(p=>p.y);
  const xMin=Math.min(...xs), xMax=Math.max(...xs), yMin=Math.min(...ys), yMax=Math.max(...ys);
  const xS=v=>m.l+((v-xMin)/(xMax-xMin||1))*(W-m.l-m.r);
  const yR=v=>H-m.b-((v-yMin)/(yMax-yMin||1))*(H-m.t-m.b);
  const yS=v=>Math.max(m.t+6, Math.min(H-m.b-6, yR(v)));
  ctx.strokeStyle='#232323'; ctx.lineWidth=1; ctx.beginPath();
  for(let i=0;i<=3;i++){ const yy=m.t+i*(H-m.t-m.b)/3; ctx.moveTo(m.l,yy); ctx.lineTo(W-m.r,yy); }
  ctx.stroke();
  ctx.beginPath(); ctx.lineWidth=3; ctx.strokeStyle='#00d084';
  points.forEach((p,i)=>{ const x=xS(p.x.getTime()), y=yS(p.y); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); }); ctx.stroke();
  ctx.fillStyle='#bfffc1'; for(const p of points){ const x=xS(p.x.getTime()), y=yS(p.y); ctx.beginPath(); ctx.arc(x,y,3.2,0,Math.PI*2); ctx.fill(); }
  ctx.fillStyle='#9aa0a6'; ctx.font='11px Arial'; ctx.textAlign='right';
  const yMaxY=yS(yMax), yMinY=yS(yMin); ctx.fillText(formatBRL(yMax), m.l-6, Math.max(m.t+10, yMaxY-6)); ctx.fillText(formatBRL(yMin), m.l-6, Math.min(H-m.b-2, yMinY+12));
  const fmt=d=>d.toLocaleDateString('pt-BR',{day:'2-digit',month:'2-digit'}); ctx.textAlign='center'; ctx.fillText(fmt(points[0].x), Math.max(m.l,24), H-8); ctx.fillText(fmt(points.at(-1).x), Math.min(W-14,W-24), H-8);
}
async function openChartFor(ev, ean, label){
  ev.stopPropagation();
  const rect = ev.currentTarget.getBoundingClientRect(); positionPopover(rect.right, rect.bottom);
  popTitle.textContent = `${label} • ${ean}`;
  popMsg.style.display='block'; popMsg.textContent='Carregando…'; sparkCtx.clearRect(0,0,sparkCanvas.width,sparkCanvas.height); pop.style.display='block';
  try{
    const viewKey = viewKeyByLabel[label];
    const { data, error } = await sb.from(VIEW).select('data, preco_num')
      .eq('ean', ean).eq('site', viewKey).not('preco_num','is',null)
      .order('data', { ascending:true }).limit(60);
    if (error) throw error;
    const pts = (data||[]).filter(r=>typeof r.preco_num==='number'&&Number.isFinite(r.preco_num)).map(r=>({x:new Date(r.data), y:r.preco_num}));
    drawSparkline(pts);
  }catch(e){ console.error(e); popMsg.style.display='block'; popMsg.textContent='Falha ao carregar histórico.'; }
}

/* ================== FAV ALTURA ================== */
function measureRowHeight(){ const tr=document.querySelector('#favTable tbody tr'); const h=Math.round(tr?.getBoundingClientRect().height||44); return Math.max(36,h); }
function measureHeadHeight(){ const head=document.querySelector('#favTable thead'); const h=Math.round(head?.getBoundingClientRect().height||40); return Math.max(32,h); }
let favHeightUser = Number(localStorage.getItem('mm_fav_height')) || null;
function applyFavHeight(px){ if(!px||!Number.isFinite(px)) return; const maxPx=Math.round(innerHeight*0.85); const clamped=Math.max(120, Math.min(px, maxPx)); document.getElementById('favWrap').style.height=clamped+'px'; }
function updateFavHeight(){
  if (favHeightUser){ applyFavHeight(favHeightUser); return; }
  const rowsLen=favBody.children.length; const rows=Math.min(rowsLen,20);
  applyFavHeight(measureHeadHeight() + rows*measureRowHeight() + 8);
}
(function initResizer(){
  let startY=0, startH=0;
  function onMove(ev){ const dy=ev.clientY-startY; favHeightUser=startH+dy; localStorage.setItem('mm_fav_height', String(favHeightUser)); applyFavHeight(favHeightUser); }
  function stop(){ removeEventListener('mousemove', onMove); removeEventListener('mouseup', stop); document.body.classList.remove('resizing'); }
  favResizer.addEventListener('mousedown',(ev)=>{ startY=ev.clientY; startH=document.getElementById('favWrap').offsetHeight; document.body.classList.add('resizing'); addEventListener('mousemove', onMove); addEventListener('mouseup', stop); });
  favResizer.addEventListener('dblclick', ()=>{ favHeightUser=null; localStorage.removeItem('mm_fav_height'); updateFavHeight(); });
})();

/* ================== LOGIN/PLANO ================== */
async function getUserPlanKey(userId){
  try{
    const { data, error } = await sb.from('profiles').select('plan').eq('id', userId).maybeSingle();
    if (error) throw error;
    return (data?.plan || 'basico').toString().toLowerCase();
  }catch(e){ console.error(e); return 'basico'; }
}

/* ================== INIT ================== */
(async function init(){
  const { data:{ session } } = await sb.auth.getSession();
  if (!session){ location.href = CFG.SITE_URL || 'index.html'; return; }
  userChip.textContent = session.user?.email || 'Logado';

  const planKey = await getUserPlanKey(session.user.id);
  planChip.textContent = `Plano: ${planKey.charAt(0).toUpperCase()+planKey.slice(1)}`;

  // carrega seleção do usuário (ORDEM do user_sites) + limite do plano e constrói cabeçalhos
  await loadUserSelectionAndLocks(session.user.id, planKey);

  // primeira busca
  resetAndQuery();

  // eventos de navegação
  ddMeusDados.onclick = ()=> location.href='meusdados.html';
  ddPlanos.onclick    = ()=> location.href='planos.html';
  btnSair.onclick     = async ()=>{ try{ await sb.auth.signOut(); }finally{ localStorage.removeItem('mm_login_date'); location.href = CFG.SITE_URL || 'index.html'; } };

  // infinite scroll kick
  generalWrap.dispatchEvent(new Event('scroll'));
})();

/* ================== RELOAD FILTROS ================== */
const onFilterInput = debounce(()=>{ currentEanQ=(eanFilter.value||'').trim(); currentDescQ=(descFilter.value||'').trim(); resetAndQuery(); }, 500);
eanFilter.addEventListener('input', onFilterInput);
descFilter.addEventListener('input', onFilterInput);
btnReload.addEventListener('click', async ()=>{
  const s=(await sb.auth.getSession()).data.session;
  if (s?.user?.id){
    const planKey = await getUserPlanKey(s.user.id);
    await loadUserSelectionAndLocks(s.user.id, planKey);
  }
  resetAndQuery();
});
</script>
</body>
</html>
