<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Pagamento (Transparente • Sandbox)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://unpkg.com/imask"></script>
  <!-- Mercado Pago JS v2 -->
  <script src="https://sdk.mercadopago.com/js/v2"></script>
  <!-- Supabase JS -->
  <script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <style>
    :root{color-scheme:dark}
    body{background:#0f1115;color:#ddd;font:14px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;padding:32px}
    .container{max-width:820px;margin:0 auto}
    .card{background:#151923;border:1px solid #22283a;border-radius:12px;padding:20px}
    h1{font-weight:700;letter-spacing:.2px;margin:0 0 16px}
    label{font-size:12px;opacity:.9}
    input,select{width:100%;padding:10px 12px;margin:6px 0 14px;border-radius:8px;border:1px solid #2b3246;background:#0e1220;color:#e5e7eb}
    input[disabled]{opacity:.7}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .btn{display:inline-flex;gap:8px;align-items:center;border:1px solid #2b3246;background:#0e1322;color:#e5e7eb;padding:10px 14px;border-radius:10px;cursor:pointer}
    .btn.primary{background:#0d6efd;border-color:#0d6efd}
    .btn.warning{background:#44463a}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .muted{opacity:.85}
    .log{white-space:pre-wrap;background:#0b0f1a;border:1px solid #1b2133;padding:12px;border-radius:8px;min-height:120px;max-height:260px;overflow:auto}
    .header{margin-bottom:12px}
    .stack{display:flex;gap:8px;flex-wrap:wrap}
    .badge{font-size:12px;border:1px solid #2b3246;background:#0e1220;padding:4px 8px;border-radius:999px}
    .ok{color:#6ef06e}
    .err{color:#ff8080}
    .sep{height:1px;background:#22283a;margin:18px 0}
  </style>
</head>
<body>
<div class="container">
  <h1>Pagamento (Transparente • Sandbox)</h1>

  <div class="card">
    <div class="header">
      <div class="muted">
        <b>Plano:</b> <span id="planoNome">Básico</span> •
        <b>Valor:</b> R$ <span id="planoValor">29,90</span><br/>
        <b>Conta:</b> <span id="contaEmail">lopes18@gmail.com</span>
      </div>
      <div class="stack" id="badges"></div>
    </div>

    <div class="sep"></div>

    <div class="row">
      <div>
        <label>Nome impresso no cartão</label>
        <input id="cardholder" value="APRO" disabled />
      </div>
      <div>
        <label>E-mail do pagador</label>
        <input id="payerEmail" value="comprador@sandbox.local" disabled />
      </div>
    </div>

    <div class="row">
      <div>
        <label>CPF</label>
        <input id="payerCPF" value="19119119100" disabled />
      </div>
      <div>
        <label>Parcelas</label>
        <select id="installments" disabled>
          <option value="1" selected>1x</option>
          <option value="2">2x</option>
          <option value="3">3x</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Número do cartão (teste aprovado)</label>
        <input id="cardNumber" value="5031 4332 1540 6351" disabled />
      </div>
      <div>
        <label>Validade (MM/AAAA)</label>
        <input id="cardExp" value="11/2029" disabled />
      </div>
    </div>

    <div class="row">
      <div>
        <label>CVV</label>
        <input id="cardCVV" value="123" disabled />
      </div>
      <div style="display:flex;align-items:end;gap:8px">
        <button id="btnPagar" class="btn primary">Pagar (teste)</button>
        <button id="btnUnlock" class="btn">Desbloquear campos</button>
        <button id="btnPing" class="btn warning">Ping função</button>
        <a class="btn" href="/planos.html">↩ Voltar</a>
      </div>
    </div>

    <div class="sep"></div>

    <h3>Logs</h3>
    <div class="log" id="logs"></div>

    <div class="sep"></div>

    <h3>Resposta da função</h3>
    <div class="log" id="resp"></div>
  </div>
</div>

<script>
/** ============================
 *  CONFIG — TROQUE PARA O TEU PROJETO
 *  ============================ */
window.CONFIG = {
  // Supabase
  SUPABASE_URL: "https://maprezivxfitqyifmepq.supabase.co",
  SUPABASE_ANON_KEY: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1hcHJleml2eGZpdHF5aWZtZXBxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM2MTc4OTcsImV4cCI6MjA2OTE5Mzg5N30.qz8iMEZY0mkh5QgeBKh8lYLITRjcAADb",

  // Mercado Pago (SANDBOX)
  MP_PUBLIC_KEY:  "TEST-COLE_SUA_PUBLIC_KEY_AQUI",
  MP_ACCESS_TOKEN:"TEST-COLE_SEU_ACCESS_TOKEN_AQUI", // usado só no backend

  // Nome da Edge Function que processa o pagamento transparente
  EDGE_FUNCTION_NAME: "mercado-pago-transparent",

  // Plano atual da tela
  PLANO_KEY: "basic",
  PLANO_NAME: "Básico",
  PLANO_AMOUNT_CENTS: 2990
};
</script>

<script>
/* ========= Helpers ========= */
const $ = (sel)=>document.querySelector(sel);
const logs = $("#logs");
const resp = $("#resp");
function log(...args){
  const line = args.map(a=>{
    try{ return typeof a==='string'? a : JSON.stringify(a,null,2); }
    catch(_){ return String(a); }
  }).join(" ");
  logs.textContent += (logs.textContent? "\n" : "") + line;
  logs.scrollTop = logs.scrollHeight;
}
function showResp(obj){
  try{ resp.textContent = JSON.stringify(obj,null,2); }
  catch(_){ resp.textContent = String(obj); }
}

function addBadge(text, ok=false){
  const b = document.createElement('span');
  b.className = 'badge ' + (ok?'ok':'');
  b.textContent = text;
  $("#badges").appendChild(b);
}

/* ========= Máscaras/validação básica ========= */
IMask($("#cardExp"), { mask: '00/0000' });
IMask($("#cardNumber"), { mask: '0000 0000 0000 0000' });
IMask($("#cardCVV"), { mask: '000[0]' });
IMask($("#payerCPF"), { mask: '00000000000' });

/* ========= Supabase client ========= */
const supabaseClient = supabase.createClient(window.CONFIG.SUPABASE_URL, window.CONFIG.SUPABASE_ANON_KEY);

/* ========= Mercado Pago ========= */
let mp;
try{
  mp = new MercadoPago(window.CONFIG.MP_PUBLIC_KEY, { locale: 'pt-BR' });
  addBadge("MP_PUBLIC_KEY: OK", true);
}catch(e){
  addBadge("MP_PUBLIC_KEY: FALHOU", false);
  log("Erro MP init:", e);
}

/* ========= UI ========= */
$("#btnUnlock").onclick = ()=>{
  for (const id of ["cardholder","payerEmail","payerCPF","installments","cardNumber","cardExp","cardCVV"]) {
    $(("#"+id)).disabled = false;
  }
}

$("#btnPing").onclick = async ()=>{
  logs.textContent = ""; resp.textContent = "";
  log("Pingando função:", window.CONFIG.EDGE_FUNCTION_NAME);

  const { data, error } = await supabaseClient.functions.invoke(window.CONFIG.EDGE_FUNCTION_NAME, {
    body: { ping: true }
  });

  if (error){
    addBadge("invoke: ERRO", false);
    log("invoke error:", safeErr(error));
    showResp(error);
  } else {
    addBadge("invoke: OK", true);
    showResp(data);
  }
};

$("#btnPagar").onclick = async ()=>{
  logs.textContent = ""; resp.textContent = "";
  addBadge("Config carregado? " + (!!window.CONFIG), true);
  addBadge("SRX? " + (!!mp), !!mp);
  addBadge("Plano " + window.CONFIG.PLANO_NAME + " R$ " + (window.CONFIG.PLANO_AMOUNT_CENTS/100).toFixed(2), true);

  try{
    const cardData = collectCardData();
    log("Tokenizando cartão…");
    const token = await tokenizeCard(cardData);
    addBadge("Card token OK", true);
    log("Card token OK:", token);

    const session = await supabaseClient.auth.getSession();
    const accessToken
