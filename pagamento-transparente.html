<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Pagamento (Transparente • Sandbox)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Supabase JS -->
  <script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <!-- IMask p/ formatação dos campos -->
  <script src="https://unpkg.com/imask"></script>
  <!-- Suas chaves/config ficam no config.js -->
  <script src="./config.js"></script>

  <style>
    :root{color-scheme:dark}
    body{background:#0f1115;color:#ddd;font:14px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;padding:32px}
    .container{max-width:880px;margin:0 auto}
    .card{background:#151923;border:1px solid #22283a;border-radius:12px;padding:20px}
    h1{font-weight:700;letter-spacing:.2px;margin:0 0 16px}
    label{font-size:12px;opacity:.9}
    input,select{width:100%;padding:10px 12px;margin:6px 0 14px;border-radius:8px;border:1px solid #2b3246;background:#0e1220;color:#e5e7eb}
    input[disabled]{opacity:.7}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .btn{display:inline-flex;gap:8px;align-items:center;border:1px solid #2b3246;background:#0e1322;color:#e5e7eb;padding:10px 14px;border-radius:10px;cursor:pointer}
    .btn.primary{background:#0d6efd;border-color:#0d6efd}
    .btn.warning{background:#44463a}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .log{white-space:pre-wrap;background:#0b0f1a;border:1px solid #1b2133;padding:12px;border-radius:8px;min-height:120px;max-height:260px;overflow:auto}
    .header{margin-bottom:12px}
    .stack{display:flex;gap:8px;flex-wrap:wrap}
    .badge{font-size:12px;border:1px solid #2b3246;background:#0e1220;padding:4px 8px;border-radius:999px}
    .ok{color:#6ef06e}
    .err{color:#ff8080}
    .sep{height:1px;background:#22283a;margin:18px 0}
    .banner{border:1px solid #2a2a2a;border-radius:10px;padding:10px 12px;margin-bottom:14px;background:#111}
    .banner.warn{border-color:#5c3f00;background:#1b1300;color:#ffc966}
    .banner.ok{border-color:#214d21;background:#0e1a0e;color:#b7fbb7}
    .banner.err{border-color:#5c1e1e;background:#190d0d;color:#ff9a9a}
  </style>
</head>
<body>
<div class="container">
  <h1>Pagamento (Transparente • Sandbox)</h1>

  <div class="card">
    <div id="banner" class="banner" style="display:none"></div>

    <div class="header">
      <div>
        <b>Plano:</b> <span id="planoNome">—</span> •
        <b>Valor:</b> R$ <span id="planoValor">—</span><br/>
        <b>Conta:</b> <span id="contaEmail">—</span>
      </div>
      <div class="stack" id="badges"></div>
    </div>

    <div class="sep"></div>

    <div class="row">
      <div>
        <label>Nome impresso no cartão</label>
        <input id="cardholder" value="APRO" disabled />
      </div>
      <div>
        <label>E-mail do pagador</label>
        <input id="payerEmail" value="comprador@sandbox.local" disabled />
      </div>
    </div>

    <div class="row">
      <div>
        <label>CPF</label>
        <input id="payerCPF" value="19119119100" disabled />
      </div>
      <div>
        <label>Parcelas</label>
        <select id="installments" disabled>
          <option value="1" selected>1x</option>
          <option value="2">2x</option>
          <option value="3">3x</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Número do cartão (teste aprovado)</label>
        <input id="cardNumber" value="5031 4332 1540 6351" disabled />
      </div>
      <div>
        <label>Validade (MM/AAAA)</label>
        <input id="cardExp" value="11/2029" disabled />
      </div>
    </div>

    <div class="row">
      <div>
        <label>CVV</label>
        <input id="cardCVV" value="123" disabled />
      </div>
      <div style="display:flex;align-items:end;gap:8px;flex-wrap:wrap">
        <button id="btnPagar" class="btn primary">Pagar (teste)</button>
        <button id="btnUnlock" class="btn">Desbloquear campos</button>
        <button id="btnPing" class="btn warning">Ping função (invoke)</button>
        <button id="btnPingRaw" class="btn">Ping direto (fetch)</button>
        <button id="btnPingAuthorized" class="btn">Ping direto (com Authorization)</button>
        <a class="btn" href="./planos.html">↩ Voltar</a>
      </div>
    </div>

    <div class="sep"></div>

    <h3>Logs</h3>
    <div class="log" id="logs"></div>

    <div class="sep"></div>

    <h3>Resposta da função</h3>
    <div class="log" id="resp"></div>
  </div>
</div>

<script>
/* ================= Config (lendo tudo do config.js) ================= */
const CFG = (window.CONFIG || {});
if (!CFG.SUPABASE_URL || !CFG.SUPABASE_ANON_KEY || !CFG.MP_PUBLIC_KEY || !CFG.EDGE_FUNCTION_NAME) {
  alert("Erro de configuração: verifique SUPABASE_URL, SUPABASE_ANON_KEY, MP_PUBLIC_KEY e EDGE_FUNCTION_NAME no config.js");
  throw new Error("CONFIG ausente/incompleta");
}

// FUNCTIONS_URL explícito (recomendado). Se não tiver no config.js, tenta deduzir:
let FUNCTIONS_URL = CFG.FUNCTIONS_URL;
if (!FUNCTIONS_URL) {
  try {
    const host = new URL(CFG.SUPABASE_URL).host; // ex.: SEU_REF.supabase.co
    const ref = host.split(".")[0];
    FUNCTIONS_URL = `https://${ref}.functions.supabase.co`;
  } catch {
    console.warn("Não foi possível deduzir FUNCTIONS_URL; informe FUNCTIONS_URL no config.js");
  }
}

/* ================= Helpers/UI ================= */
const $ = (sel)=>document.querySelector(sel);
const logs = $("#logs");
const resp = $("#resp");
const bannerEl = document.getElementById('banner');

function showBanner(text, type = 'ok') {
  bannerEl.textContent = text;
  bannerEl.className = 'banner ' + (type === 'warn' ? 'warn' : (type === 'err' ? 'err' : 'ok'));
  bannerEl.style.display = 'block';
  setTimeout(() => { bannerEl.style.display = 'none'; }, 4200);
}
function log(...args){
  const line = args.map(a=>{
    try{ return typeof a==='string'? a : JSON.stringify(a,null,2); }
    catch(_){ return String(a); }
  }).join(" ");
  logs.textContent += (logs.textContent? "\n" : "") + line;
  logs.scrollTop = logs.scrollHeight;
}
function showResp(obj){
  try{ resp.textContent = JSON.stringify(obj,null,2); }
  catch(_){ resp.textContent = String(obj); }
}
function addBadge(text, ok=false){
  const b = document.createElement('span');
  b.className = 'badge ' + (ok?'ok':'');
  b.textContent = text;
  $("#badges").appendChild(b);
}
function digitsOnly(s){ return (s||'').replace(/\D+/g,""); }

IMask($("#cardExp"), { mask: '00/0000' });
IMask($("#cardNumber"), { mask: '0000 0000 0000 0000' });
IMask($("#cardCVV"), { mask: '000[0]' });

/* ================= Supabase client (p/ auth) ================= */
const supabaseClient = supabase.createClient(CFG.SUPABASE_URL, CFG.SUPABASE_ANON_KEY, {
  functions: FUNCTIONS_URL ? { url: FUNCTIONS_URL } : undefined
});

(async function init(){
  // Plano
  const planoName = CFG.PLANO_NAME || "—";
  const planoCents = Number(CFG.PLANO_AMOUNT_CENTS || 0);
  $("#planoNome").textContent = planoName;
  $("#planoValor").textContent = planoCents > 0 ? (planoCents/100).toFixed(2) : "—";

  // Se amount_cents <= 0, avisa e bloqueia o botão pagar (foi o seu caso no log)
  if (!planoCents || planoCents <= 0) {
    addBadge("Valor do plano inválido (0)", false);
    showBanner("Defina PLANO_AMOUNT_CENTS > 0 no config.js (ex.: 2990 para R$ 29,90).", "warn");
    document.getElementById('btnPagar').disabled = true;
  }

  // Sessão
  try{
    const { data: { session } } = await supabaseClient.auth.getSession();
    const user = session?.user || null;
    $("#contaEmail").textContent = user?.email || "—";
    addBadge("Sessão supabase: " + (user? "ON" : "OFF"), !!user);
  }catch(e){
    log("Erro init:", e.message||e);
  }

  addBadge("MP_PUBLIC_KEY: " + (CFG.MP_PUBLIC_KEY?.startsWith("TEST-") ? "OK (teste)" : "⚠ verifique"), !!CFG.MP_PUBLIC_KEY);
  if (FUNCTIONS_URL) addBadge("Functions URL: OK", true);
  else addBadge("Functions URL: ausente (defina em config.js)", false);
})();

/* ================= Botões ================= */
$("#btnUnlock").onclick = ()=>{
  for (const id of ["cardholder","payerEmail","payerCPF","installments","cardNumber","cardExp","cardCVV"]) {
    $(("#"+id)).disabled = false;
  }
};

$("#btnPing").onclick = async ()=>{
  logs.textContent = ""; resp.textContent = "";
  log("Pingando (invoke):", CFG.EDGE_FUNCTION_NAME);

  // Mesmo que o invoke falhe em alguns cenários, deixei para diagnóstico
  const { data, error } = await supabaseClient.functions.invoke(CFG.EDGE_FUNCTION_NAME, {
    body: { ping: true }
  });

  if (error){
    addBadge("invoke: ERRO", false);
    log("invoke error:", safeErr(error));
    showResp(error);
  } else {
    addBadge("invoke: OK", true);
    showResp(data);
  }
};

$("#btnPingRaw").onclick = async ()=>{
  logs.textContent = ""; resp.textContent = "";
  const url = `${FUNCTIONS_URL}/${CFG.EDGE_FUNCTION_NAME}`;
  log("Ping direto (sem auth):", url);
  try{
    const r = await fetch(url, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ ping:true })
    });
    const t = await r.text();
    let j = null; try{ j = JSON.parse(t) }catch{ j = { raw:t } }
    showResp({ status:r.status, data:j });
  }catch(e){
    showResp({ name:e.name, message:e.message, stack:e.stack });
  }
};

$("#btnPingAuthorized").onclick = async ()=>{
  logs.textContent = ""; resp.textContent = "";
  const { data: { session } } = await supabaseClient.auth.getSession();
  if (!session) { addBadge("Sem sessão. Faça login.", false); showResp({error:"Sem sessão"}); return; }
  const url = `${FUNCTIONS_URL}/${CFG.EDGE_FUNCTION_NAME}`;
  log("Ping direto (com Authorization):", url);

  try{
    const r = await fetch(url, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${session.access_token}`,
        "apikey": CFG.SUPABASE_ANON_KEY
      },
      body: JSON.stringify({ ping: true })
    });
    const t = await r.text();
    let j = null; try{ j = JSON.parse(t) }catch{ j = { raw:t } }
    showResp({ status:r.status, data:j });
  }catch(e){
    showResp({ name:e.name, message:e.message, stack:e.stack });
  }
};

$("#btnPagar").onclick = async ()=>{
  logs.textContent = ""; resp.textContent = "";

  const cents = Number(CFG.PLANO_AMOUNT_CENTS || 0);
  if (!cents || cents <= 0) {
    showBanner("Defina PLANO_AMOUNT_CENTS > 0 no config.js (ex.: 2990).", "warn");
    return;
  }

  addBadge("Plano " + (CFG.PLANO_NAME||"") + " R$ " + (cents/100).toFixed(2), true);

  try{
    const cardData = collectCardData();
    log("Tokenizando cartão via API card_tokens…");
    const token = await tokenizeCard(cardData, $("#payerCPF").value.trim());
    addBadge("Card token OK", true);
    log("Card token:", token);

    // Sessão obrigatória p/ Authorization
    const { data: { session } } = await supabaseClient.auth.getSession();
    if (!session) {
      addBadge("Sessão supabase: OFF", false);
      showBanner("Faça login antes de pagar (Authorization é obrigatório).", "warn");
      return;
    }
    addBadge("Sessão supabase: ON", true);

    const body = {
      mode: "card",
      plan_key: CFG.PLANO_KEY || "basic",
      amount_cents: cents,
      card_token: token.id || token,
      payer: {
        name: $("#cardholder").value.trim(),
        email: $("#payerEmail").value.trim(),
        cpf: $("#payerCPF").value.trim()
      },
      installments: Number($("#installments").value || 1)
    };

    log("Enviando para Edge Function (fetch + Authorization):", body);

    const url = `${FUNCTIONS_URL}/${CFG.EDGE_FUNCTION_NAME}`;
    const r = await fetch(url, {
      method: "POST",
      headers: {
        "Content-Type":"application/json",
        "Authorization": `Bearer ${session.access_token}`,
        "apikey": CFG.SUPABASE_ANON_KEY
      },
      body: JSON.stringify(body)
    });

    const t = await r.text();
    let j = null; try{ j = JSON.parse(t) }catch{ j = { raw:t } }

    if (!r.ok){
      addBadge("Pagamento: ERRO", false);
      showResp({ status:r.status, data:j });
      return;
    }

    addBadge("Pagamento criado", true);
    showResp({ status:r.status, data:j });
  }catch(err){
    addBadge("Falha geral", false);
    log("catch:", safeErr(err));
    showResp(err);
  }
};

/* ================= Auxiliares ================= */
function collectCardData(){
  const [mm,yyyy] = ($("#cardExp").value||"").split("/");
  return {
    cardNumber: digitsOnly($("#cardNumber").value),
    cardholderName: $("#cardholder").value.trim(),
    cardExpirationMonth: (mm||"").padStart(2,"0"),
    cardExpirationYear: yyyy,
    securityCode: $("#cardCVV").value.trim()
  };
}

async function tokenizeCard(cardData, cpf){
  // Tokenização direta pela API pública do MP usando a PUBLIC KEY (do config.js)
  const url = "https://api.mercadopago.com/v1/card_tokens?public_key=" + encodeURIComponent(CFG.MP_PUBLIC_KEY);
  const payload = {
    card_number: cardData.cardNumber,
    expiration_month: Number(cardData.cardExpirationMonth),
    expiration_year: Number(cardData.cardExpirationYear),
    security_code: cardData.securityCode,
    cardholder: {
      name: cardData.cardholderName,
      identification: { type: "CPF", number: digitsOnly(cpf) }
    }
  };

  const res = await fetch(url, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  const text = await res.text();
  let data = null; try { data = text ? JSON.parse(text) : null; } catch{ data = { raw:text }; }

  if (!res.ok){
    const err = new Error("Erro tokenização");
    err.name = "TokenizationError";
    err.status = res.status;
    err.response = { status: res.status, statusText: res.statusText, body: data };
    throw err;
  }
  if (!data?.id){
    const err = new Error("Resposta de token inválida");
    err.response = { body: data };
    throw err;
  }
  return data; // contém .id
}

function safeErr(e){
  const out = { name: e?.name || 'Error' };
  if ('message' in e) out.message = e.message;
  if ('status' in e) out.status = e.status;
  if (e?.response) out.response = e.response;
  else if (e?.context) out.context = e.context;
  return out;
}
</script>
</body>
</html>
