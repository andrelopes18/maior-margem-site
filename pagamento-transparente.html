<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Pagamento (Transparente • DEV)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <script src="https://unpkg.com/imask"></script>
  <script src="./config.js"></script>
  <style>
    :root{color-scheme:dark}
    body{background:#0f1115;color:#e5e7eb;font:14px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;padding:32px}
    .container{max-width:980px;margin:0 auto}
    .card{background:#141823;border:1px solid #232a3d;border-radius:14px;padding:20px}
    h1{font-weight:700;margin:0 0 16px}
    label{font-size:12px;opacity:.9}
    input,select{width:100%;padding:10px 12px;margin:6px 0 14px;border-radius:10px;border:1px solid #2a3350;background:#0f1428;color:#e5e7eb}
    input[disabled]{opacity:.75}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .btn{display:inline-flex;gap:8px;align-items:center;border:1px solid #2a3350;background:#111a33;color:#e5e7eb;padding:10px 14px;border-radius:10px;cursor:pointer}
    .btn.primary{background:#0d6efd;border-color:#0d6efd}
    .btn.warning{background:#473f22}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .stack{display:flex;gap:8px;flex-wrap:wrap}
    .badge{font-size:12px;border:1px solid #2a3350;background:#0e1322;padding:4px 8px;border-radius:999px}
    .ok{color:#6ef06e}
    .err{color:#ff8b8b}
    .sep{height:1px;background:#232a3d;margin:18px 0}
    .log{white-space:pre-wrap;background:#0b0f1a;border:1px solid #1b2133;padding:12px;border-radius:8px;min-height:140px;max-height:300px;overflow:auto}
    .banner{border:1px solid #2a2a2a;border-radius:10px;padding:10px 12px;margin-bottom:14px;background:#111}
    .banner.warn{border-color:#5c3f00;background:#1b1300;color:#ffc966}
    .banner.ok{border-color:#214d21;background:#0e1a0e;color:#b7fbb7}
    .banner.err{border-color:#5c1e1e;background:#190d0d;color:#ff9a9a}
    .buttons{display:flex;flex-wrap:wrap;gap:8px}
    small.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;opacity:.85}
  </style>
</head>
<body>
<div class="container">
  <h1>Pagamento (Transparente • DEV)</h1>

  <div class="card">
    <div id="banner" class="banner" style="display:none"></div>

    <div class="stack" style="justify-content:space-between;align-items:center">
      <div>
        <div><b>Plano:</b> <span id="planoNome">—</span> • <b>Valor:</b> R$ <span id="planoValor">—</span></div>
        <div><b>Conta:</b> <span id="contaEmail">—</span></div>
      </div>
      <div class="stack" id="badges"></div>
    </div>

    <div class="sep"></div>

    <div class="row">
      <div>
        <label>Nome impresso no cartão</label>
        <input id="cardholder" value="APRO" disabled />
      </div>
      <div>
        <label>E-mail do pagador</label>
        <input id="payerEmail" value="comprador@test.com" disabled />
      </div>
    </div>

    <div class="row">
      <div>
        <label>CPF</label>
        <input id="payerCPF" value="19119119100" disabled />
      </div>
      <div>
        <label>Parcelas</label>
        <select id="installments" disabled>
          <option value="1" selected>1x</option>
          <option value="2">2x</option>
          <option value="3">3x</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Número do cartão (teste aprovado)</label>
        <input id="cardNumber" value="5031 4332 1540 6351" disabled />
      </div>
      <div>
        <label>Validade (MM/AAAA)</label>
        <input id="cardExp" value="11/2029" disabled />
      </div>
    </div>

    <div class="row">
      <div>
        <label>CVV</label>
        <input id="cardCVV" value="123" disabled />
      </div>
      <div>
        <div class="buttons" style="margin-top:6px">
          <button id="btnPagar" class="btn primary" disabled>Pagar (fetch + Authorization)</button>
          <button id="btnUnlock" class="btn">Desbloquear campos</button>
          <button id="btnPingInvoke" class="btn warning">Ping (invoke)</button>
          <button id="btnPingRaw" class="btn">Ping (fetch sem auth)</button>
          <button id="btnPingAuth" class="btn">Ping (fetch com auth)</button>
        </div>
        <div style="margin-top:6px">
          <small class="mono">EDGE_FUNCTION_NAME: <span id="fnName">—</span></small><br/>
          <small class="mono">FUNCTIONS_URL: <span id="fnUrl">—</span></small>
        </div>
      </div>
    </div>

    <div class="sep"></div>
    <h3>Logs</h3>
    <div class="log" id="logs"></div>
    <div class="sep"></div>
    <h3>Resposta da função</h3>
    <div class="log" id="resp"></div>
  </div>
</div>

<script>
const CFG = (window.CONFIG || {});
let FUNCTIONS_URL = CFG.FUNCTIONS_URL;
if (!FUNCTIONS_URL) { try { const ref = new URL(CFG.SUPABASE_URL).host.split(".")[0]; FUNCTIONS_URL = `https://${ref}.functions.supabase.co`; } catch {} }

const $ = s=>document.querySelector(s);
const logs = $("#logs");
const resp = $("#resp");
const banner = $("#banner");
function addBadge(text, ok=false){ const b=document.createElement('span'); b.className='badge '+(ok?'ok':''); b.textContent=text; $("#badges").appendChild(b); }
function showBanner(text, type='ok'){ banner.textContent=text; banner.className='banner '+(type==='warn'?'warn':type==='err'?'err':'ok'); banner.style.display='block'; setTimeout(()=>banner.style.display='none',4200); }
function log(...args){ const line=args.map(a=>{try{return typeof a==='string'?a:JSON.stringify(a,null,2);}catch{ return String(a);}}).join(" "); logs.textContent+=(logs.textContent? "\n":"")+line; logs.scrollTop=logs.scrollHeight; }
function showResp(obj){ try{ resp.textContent=JSON.stringify(obj,null,2);}catch{ resp.textContent=String(obj);} }
function digitsOnly(s){ return (s||'').replace(/\D+/g,""); }
function detectBrand(num){ const n=digitsOnly(num); if(n.startsWith('4'))return'visa'; if(n.startsWith('5'))return'master'; if(n.startsWith('34')||n.startsWith('37'))return'amex'; return undefined; }

IMask($("#cardExp"), { mask: '00/0000' });
IMask($("#cardNumber"), { mask: '0000 0000 0000 0000' });
IMask($("#cardCVV"), { mask: '000[0]' });

const sb = supabase.createClient(CFG.SUPABASE_URL, CFG.SUPABASE_ANON_KEY, {
  functions: FUNCTIONS_URL ? { url: FUNCTIONS_URL } : undefined
});

// Plano carregado do banco
let CURRENT_PLAN = null;

async function fetchPlan() {
  const qp = new URLSearchParams(location.search);
  const planKeyParam = qp.get('plan') || qp.get('plan_key');

  // 1) tenta por plan_key específico
  if (planKeyParam) {
    const { data, error } = await sb
      .from('billing_plans')
      .select('id,plan_key,name,price_cents,currency,active,sort_order')
      .eq('plan_key', planKeyParam)
      .eq('active', true)
      .maybeSingle();
    if (!error && data) return data;
  }

  // 2) fallback: primeiro ativo por sort_order
  const { data, error } = await sb
    .from('billing_plans')
    .select('id,plan_key,name,price_cents,currency,active,sort_order')
    .eq('active', true)
    .order('sort_order', { ascending: true })
    .limit(1);
  if (error || !data?.length) return null;
  return data[0];
}

(async function init(){
  $("#fnName").textContent = CFG.EDGE_FUNCTION_NAME || "—";
  $("#fnUrl").textContent = FUNCTIONS_URL || "(não deduzida)";

  const { data: { session } } = await sb.auth.getSession();
  const emailSessao = session?.user?.email || "";
  $("#contaEmail").textContent = emailSessao || "—";
  if (emailSessao) { document.getElementById('payerEmail').value = emailSessao; }
  addBadge("Sessão: " + (emailSessao ? "ON" : "OFF"), !!emailSessao);
  addBadge("MP_PUBLIC_KEY: " + (CFG.MP_PUBLIC_KEY?.startsWith("TEST-") ? "OK (teste)" : "⚠ verifique"), !!CFG.MP_PUBLIC_KEY);
  addBadge("Functions URL: " + (FUNCTIONS_URL ? "OK" : "ausente"), !!FUNCTIONS_URL);

  // Busca plano no DB
  try {
    CURRENT_PLAN = await fetchPlan();
    if (!CURRENT_PLAN) {
      showBanner("Plano não encontrado ou inativo.", "err");
      addBadge("Plano: N/A", false);
      return; // mantém botão pagar desabilitado
    }
    $("#planoNome").textContent = CURRENT_PLAN.name || CURRENT_PLAN.plan_key;
    $("#planoValor").textContent = (Number(CURRENT_PLAN.price_cents || 0)/100).toFixed(2);
    addBadge("Plano: " + (CURRENT_PLAN.plan_key || "?"), true);
    document.getElementById('btnPagar').disabled = false;
  } catch (e) {
    console.error(e);
    showBanner("Erro ao carregar planos (verifique RLS da tabela billing_plans).", "err");
  }
})();

function buildHeaders(sessionAccessToken){
  const h = {
    "Content-Type":"application/json",
    "apikey": CFG.SUPABASE_ANON_KEY,
    "x-supabase-url": CFG.SUPABASE_URL,
    "x-supabase-anon-key": CFG.SUPABASE_ANON_KEY
  };
  if (sessionAccessToken) h["Authorization"] = `Bearer ${sessionAccessToken}`;
  if (CFG.DEV_SEND_CONFIG_TO_FUNCTION && CFG.DEV_MP_ACCESS_TOKEN) h["x-mp-token"] = CFG.DEV_MP_ACCESS_TOKEN; // DEV
  return h;
}

/* ---- Botões ---- */
document.getElementById('btnUnlock').onclick = ()=>{
  for (const id of ["cardholder","payerEmail","payerCPF","installments","cardNumber","cardExp","cardCVV"])
    document.getElementById(id).disabled = false;
  showBanner("Campos desbloqueados.", "ok");
};

document.getElementById('btnPingInvoke').onclick = async ()=>{
  logs.textContent = ""; resp.textContent = "";
  const { data, error } = await sb.functions.invoke(CFG.EDGE_FUNCTION_NAME, {
    body: { ping: true },
    headers: buildHeaders(null)
  });
  showResp(error || data);
};

document.getElementById('btnPingRaw').onclick = async ()=>{
  logs.textContent = ""; resp.textContent = "";
  const url = `${FUNCTIONS_URL}/${CFG.EDGE_FUNCTION_NAME}`;
  const r = await fetch(url, { method:"POST", headers: buildHeaders(null), body: JSON.stringify({ ping:true }) });
  const t = await r.text(); let j=null; try{ j=JSON.parse(t)}catch{ j={raw:t} } ; showResp({ status:r.status, data:j });
};

document.getElementById('btnPingAuth').onclick = async ()=>{
  logs.textContent = ""; resp.textContent = "";
  const { data: { session } } = await sb.auth.getSession();
  if (!session){ showResp({error:"Sem sessão"}); return; }
  const url = `${FUNCTIONS_URL}/${CFG.EDGE_FUNCTION_NAME}`;
  const r = await fetch(url, { method:"POST", headers: buildHeaders(session.access_token), body: JSON.stringify({ ping:true }) });
  const t = await r.text(); let j=null; try{ j=JSON.parse(t)}catch{ j={raw:t} } ; showResp({ status:r.status, data:j });
};

document.getElementById('btnPagar').onclick = async ()=>{
  logs.textContent = ""; resp.textContent = "";
  if (!CURRENT_PLAN){ showBanner("Plano não carregado.", "warn"); return; }

  const cents = Number(CURRENT_PLAN.price_cents || 0);
  if (!cents || cents<=0) showBanner("amount_cents=0 — a função deve responder 400. (ok para teste)","warn");

  try{
    // Tokenização
    const [mm,yyyy] = (document.getElementById('cardExp').value||"").split("/");
    const payloadToken = {
      card_number: digitsOnly(document.getElementById('cardNumber').value),
      expiration_month: Number((mm||"").padStart(2,"0")),
      expiration_year: Number(yyyy),
      security_code: document.getElementById('cardCVV').value.trim(),
      cardholder: {
        name: document.getElementById('cardholder').value.trim(),
        identification: { type: "CPF", number: digitsOnly(document.getElementById('payerCPF').value) }
      }
    };
    log("Tokenizando cartão via API card_tokens…");
    const tokRes = await fetch("https://api.mercadopago.com/v1/card_tokens?public_key=" + encodeURIComponent(CFG.MP_PUBLIC_KEY), {
      method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payloadToken)
    });
    const tokTxt = await tokRes.text(); let token=null; try{ token = tokTxt?JSON.parse(tokTxt):null; }catch{ token={raw:tokTxt}; }
    if (!tokRes.ok || !token?.id){ showResp({ status: tokRes.status, data: token }); return; }
    log("Card token:", token);

    // Chamada à função
    const { data: { session } } = await sb.auth.getSession();
    if (!session){ showBanner("Faça login antes de pagar.", "warn"); return; }

    const body = {
      mode: "card",
      plan_key: CURRENT_PLAN.plan_key,
      amount_cents: cents,
      card_token: token.id,
      payer: {
        name: document.getElementById('cardholder').value.trim(),
        email: document.getElementById('payerEmail').value.trim(),
        cpf: document.getElementById('payerCPF').value.trim()
      },
      installments: Number(document.getElementById('installments').value || 1),
      payment_method_id: detectBrand(document.getElementById('cardNumber').value)
    };

    const r = await fetch(`${FUNCTIONS_URL}/${CFG.EDGE_FUNCTION_NAME}`, {
      method:"POST",
      headers: buildHeaders(session.access_token),
      body: JSON.stringify(body)
    });
    const t = await r.text(); let j=null; try{ j=JSON.parse(t)}catch{ j={raw:t} };
    showResp({ status:r.status, data:j });
  }catch(e){ showResp({ name:e.name, message:e.message, stack:e.stack }); }
};
</script>
</body>
</html>
