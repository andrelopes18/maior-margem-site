<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Pagamento (Transparente • Sandbox)</title>
<style>
  :root{color-scheme:dark}
  body{background:#121212;color:#fff;font-family:Arial,sans-serif;margin:0;padding:24px}
  .container{max-width:860px;margin:0 auto}
  .card{background:#0f0f0f;border:1px solid #2a2a2a;border-radius:14px;padding:18px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  label{font-size:13px;color:#cfcfcf}
  input,select{width:100%;padding:10px;border-radius:10px;border:1px solid #2a2a2a;background:#0b0b0b;color:#fff}
  input[readonly]{opacity:.75}
  .btn{display:inline-flex;align-items:center;gap:8px;background:#00b140;border:none;color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer}
  .btn:hover{background:#009b38}
  .btn.gray{background:#333}
  .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
  pre{background:#0b0b0b;border:1px solid #2a2a2a;border-radius:10px;padding:10px;max-height:320px;overflow:auto}
</style>
<script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<script src="/config.js?v=px3"></script>
</head>
<body>
<main class="container">
  <h1>Pagamento (Transparente • Sandbox)</h1>
  <div class="card">
    <div id="resume" style="color:#9aa0a6">Carregando…</div>

    <!-- Formulário com DADOS DE TESTE já preenchidos -->
    <form id="form" style="margin-top:12px">
      <div class="grid">
        <div>
          <label>Nome impresso no cartão</label>
          <input id="holderName" value="APRO" readonly>
        </div>
        <div>
          <label>E-mail do pagador</label>
          <input id="payerEmail" value="comprador@sandbox.local" readonly>
        </div>

        <div>
          <label>CPF</label>
          <input id="payerDoc" value="19119119100" readonly>
        </div>
        <div>
          <label>Parcelas</label>
          <select id="installments"><option value="1" selected>1x</option></select>
        </div>

        <div>
          <label>Número do cartão (teste aprovado)</label>
          <input id="cardNumber" value="5031 4332 1540 6351" readonly>
        </div>
        <div>
          <label>Validade (MM/AAAA)</label>
          <input id="exp" value="11/2029" readonly>
        </div>
        <div>
          <label>CVV</label>
          <input id="cvv" value="123" readonly>
        </div>
      </div>

      <div class="row">
        <button class="btn" type="submit" id="btnPay">Pagar (teste)</button>
        <button class="btn gray" type="button" id="btnUnlock">Desbloquear campos</button>
        <a class="btn gray" href="planos.html" type="button">← Voltar</a>
      </div>
    </form>

    <h3 style="margin:14px 0 6px">Logs</h3>
    <pre id="log"></pre>
    <h3 style="margin:14px 0 6px">Resposta da função</h3>
    <pre id="raw"></pre>
  </div>
</main>

<script>
const CFG = window.CONFIG || {};
const sb  = supabase.createClient(CFG.SUPABASE_URL, CFG.SUPABASE_ANON_KEY, { auth:{persistSession:true,autoRefreshToken:true,detectSessionInUrl:true} });
const planKey = new URLSearchParams(location.search).get('plan') || 'basico';

const logEl = document.getElementById('log'), rawEl = document.getElementById('raw'), resume = document.getElementById('resume');
function log(...a){ logEl.textContent += a.map(x=>typeof x==='object'?JSON.stringify(x,null,2):String(x)).join(' ')+"\n"; logEl.scrollTop=logEl.scrollHeight; }
function money(c){ return (c/100).toLocaleString('pt-BR',{style:'currency',currency:'BRL'}) }

// Desbloquear campos se quiser editar
document.getElementById('btnUnlock').onclick = () => {
  ['holderName','payerEmail','payerDoc','cardNumber','exp','cvv'].forEach(id=>{
    const el=document.getElementById(id); el.readOnly=false;
  });
};

// Cria Card Token na API pública usando a PUBLIC_KEY (somente sandbox!)
async function createCardToken({cardNumber, exp, cvv, holderName, cpf}) {
  const [mm,yyyy] = exp.split('/').map(s=>s.trim());
  const payload = {
    card_number: cardNumber.replace(/\s+/g,''),
    expiration_month: Number(mm),
    expiration_year: Number(yyyy),
    security_code: cvv,
    cardholder: { name: holderName, identification: { type: "CPF", number: cpf } }
  };
  const url = `https://api.mercadopago.com/v1/card_tokens?public_key=${encodeURIComponent(CFG.MP_PUBLIC_KEY)}`;
  const r = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
  const data = await r.json().catch(()=> ({}));
  if(!r.ok){ throw new Error(`tokenização falhou: ${JSON.stringify(data)}`); }
  return data.id;
}

let user=null, plan=null;

(async function init(){
  log('Config carregado?', !!window.CONFIG, ' • MP_PUBLIC_KEY:', (CFG.MP_PUBLIC_KEY||'').slice(0,6)+'…', ' • SRK?', !!CFG.SERVICE_ROLE_KEY);
  const {data:{session}} = await sb.auth.getSession(); if(!session){ location.href=CFG.SITE_URL; return; }
  user = session.user;

  const r = await sb.from('billing_plans')
    .select('id,name,price_cents,plan_key,active,created_at')
    .eq('plan_key', planKey).eq('active', true)
    .order('created_at', {ascending:false}).limit(1);
  if(r.error || !r.data?.length){ resume.textContent='Plano não encontrado.'; log('Erro buscar plano:', r.error||'0 linhas'); return; }
  plan = r.data[0];
  resume.innerHTML = `Plano: <b>${plan.name}</b> • Valor: ${money(plan.price_cents)}<br>Conta: ${user.email}`;
})();

document.getElementById('form').addEventListener('submit', async (e)=>{
  e.preventDefault();
  rawEl.textContent='';
  try{
    // coleta dos campos (já vêm preenchidos)
    const holderName = document.getElementById('holderName').value.trim();
    const payerEmail = document.getElementById('payerEmail').value.trim();
    const payerDoc   = document.getElementById('payerDoc').value.trim();
    const cardNumber = document.getElementById('cardNumber').value.trim();
    const exp        = document.getElementById('exp').value.trim(); // MM/AAAA
    const cvv        = document.getElementById('cvv').value.trim();
    const installments = Number(document.getElementById('installments').value || 1);

    // 1) Tokenizar o cartão usando a PUBLIC_KEY
    log('Tokenizando cartão…');
    const card_token = await createCardToken({cardNumber, exp, cvv, holderName, cpf: payerDoc});
    log('Card token OK:', card_token);

    // 2) Chamar a Edge Function que cria o pagamento
    const body = {
      srk: CFG.SERVICE_ROLE_KEY,
      mp_token: CFG.MP_ACCESS_TOKEN,
      user_id: (await sb.auth.getUser()).data.user.id,
      plan_key: planKey,
      card_token,
      payment_method_id: 'master',
      installments,
      payer_email: payerEmail,
      id_type: 'CPF',
      id_number: payerDoc,
      holder_name: holderName
    };

    const { data, error } = await sb.functions.invoke('mp-card-pay', { body });
    if(error){ log('invoke error:', error); rawEl.textContent = JSON.stringify(error, null, 2); alert('Falha ao processar o pagamento.'); return; }

    rawEl.textContent = JSON.stringify(data, null, 2);
    if (data?.final === 'approved'){
      alert('Pagamento aprovado! Voltando aos planos.');
      location.href = 'planos.html';
    }else if (data?.final === 'pending'){
      alert('Pagamento pendente/analise.');
      location.href = 'planos.html';
    }else{
      alert('Pagamento não aprovado: ' + (data?.status_detail || data?.status || 'ver detalhes abaixo'));
    }
  }catch(ex){
    log('Erro no submit:', ex?.message || String(ex));
    alert('Erro ao pagar: ' + (ex?.message || String(ex)));
  }
});
</script>
</body>
</html>
