<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Retorno do Pagamento</title>
<style>
  :root { color-scheme: dark; }
  *{ box-sizing: border-box }
  body{ background:#121212; color:#fff; font-family: Arial, sans-serif; margin:0; padding:24px }
  .container{ max-width:720px; margin:0 auto }
  .card{ background:#0f0f0f; border:1px solid #2a2a2a; border-radius:16px; padding:20px; display:flex; flex-direction:column; gap:14px }
  .btn{ display:inline-flex; align-items:center; gap:8px; background:#00b140; color:#fff; border:none; padding:12px 16px; border-radius:10px; cursor:pointer; font-size:16px }
  .btn:hover{ background:#009b38 }
  .muted{ color:#9aa0a6; font-size:13px }
  .ok{ color:#b7fbb7 }
  .err{ color:#ff9a9a }
</style>
<script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<script src="./config.js"></script>
</head>
<body>
<main class="container">
  <h1>Confirmação do Pagamento</h1>
  <div class="card">
    <div id="status">Verificando…</div>
    <div id="detail" class="muted"></div>
    <div style="display:flex; gap:8px; flex-wrap:wrap">
      <a href="planos.html" class="btn">← Ir para Planos</a>
      <a href="dashboard.html" class="btn" style="background:#333">Dashboard</a>
    </div>
  </div>
</main>

<script>
const CFG = window.CONFIG || {};
const sb  = supabase.createClient(CFG.SUPABASE_URL, CFG.SUPABASE_ANON_KEY, {
  auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
});

const statusEl = document.getElementById('status');
const detailEl = document.getElementById('detail');

let sessionUser = null;
let statusParam = (new URLSearchParams(location.search).get('status') || '').toLowerCase();

function ucfirstBR(s){ const m = {trial:'Trial', basico:'Básico', intermediario:'Intermediário', premium:'Premium'}; return m[s] || s; }
function brl(c){ return (c/100).toLocaleString('pt-BR',{style:'currency',currency:'BRL'}) }

async function ensureSession(){
  const { data:{ session } } = await sb.auth.getSession();
  if (!session){ statusEl.textContent = 'Você não está logado.'; statusEl.className='err'; return null; }
  sessionUser = session.user; return session;
}

async function readPlanByKey(key){
  const { data, error } = await sb
    .from('billing_plans')
    .select('id,name,price_cents,plan_key')
    .eq('plan_key', key).maybeSingle();
  if (error || !data) return null;
  return data;
}

async function applyPlan(planKey){
  const planRow = await readPlanByKey(planKey);
  if (!planRow){ statusEl.textContent = 'Plano não encontrado.'; statusEl.className='err'; return false; }
  const { error } = await sb.from('profiles').update({
    plan: planRow.plan_key,
    plan_id: planRow.id,
    plan_name: planRow.name,
    plan_price_cents: planRow.price_cents,
    plan_status: 'active',
    subscription_status: 'active',
    updated_at: new Date().toISOString()
  }).eq('id', sessionUser.id);
  if (error){ statusEl.textContent = 'Falha ao aplicar o plano no perfil.'; statusEl.className='err'; detailEl.textContent = error.message; return false; }
  statusEl.innerHTML = `✅ Plano aplicado: <span class="ok">${ucfirstBR(planRow.plan_key)}</span>`;
  detailEl.textContent = `Valor: ${brl(planRow.price_cents||0)} • Conta: ${sessionUser.email}`;
  return true;
}

(async function init(){
  const s = await ensureSession(); if (!s) return;

  // IMPORTANTE (homologação): usamos o plano salvo localmente na hora do clique
  const planKey = localStorage.getItem('mm_selected_plan');
  const paid    = ['success','approved','succeeded','ok'].includes(statusParam);

  if (!paid){
    statusEl.textContent = 'Pagamento não confirmado (status diferente de sucesso).';
    statusEl.className = 'err';
    detailEl.textContent = 'Se você concluiu o pagamento, aguarde alguns instantes e tente novamente.';
    return;
  }
  if (!planKey){
    statusEl.textContent = 'Não foi possível identificar o plano selecionado.';
    statusEl.className = 'err';
    detailEl.textContent = 'Volte para a página de planos e tente novamente.';
    return;
  }
  await applyPlan(planKey);

  // Limpeza (opcional)
  localStorage.removeItem('mm_selected_plan');
  localStorage.removeItem('mm_selected_at');
})();
</script>
</body>
</html>
