<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Retorno do Pagamento</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Seu arquivo com SUPABASE_URL e SUPABASE_ANON_KEY -->
  <script src="config.js"></script>
  <!-- supabase-js v2 (ESM) -->
  <script type="module" src="https://esm.sh/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --bg: #f6f7fb;
      --card: #ffffff;
      --ok: #0e8f3b;
      --muted: #727b86;
      --danger: #c62828;
      --primary: #0069d9;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 24px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
      background: var(--bg); color: #111;
    }
    .wrap {
      max-width: 860px; margin: 0 auto;
    }
    .card {
      background: var(--card);
      border-radius: 14px;
      padding: 20px;
      box-shadow: 0 6px 24px rgba(0,0,0,.06);
    }
    h1 { margin: 0 0 6px; font-size: 24px; }
    p.lead { color: var(--muted); margin: 0 0 16px; }
    .row { display: grid; grid-template-columns: 1fr auto; gap: 12px; align-items: center; }
    .actions { display: flex; gap: 8px; }
    button {
      padding: 10px 14px; border-radius: 10px; border: 0; cursor: pointer;
      background: var(--primary); color: #fff; font-weight: 600;
    }
    button.secondary { background: #e9eef7; color: #1a2b4b; }
    button.danger { background: var(--danger); }
    pre#log {
      margin-top: 14px; background: #0f172a; color: #c7f7c7;
      border-radius: 10px; padding: 12px; max-height: 340px; overflow: auto;
      line-height: 1.35; font-size: 13px;
    }
    .status {
      margin-top: 10px; display: inline-block; padding: 6px 10px; border-radius: 999px;
      font-size: 12px; font-weight: 700; letter-spacing: .3px;
      color: #fff; background: #8892a6;
    }
    .status.ok { background: var(--ok); }
    .status.err { background: var(--danger); }
    .hint { color: var(--muted); font-size: 12px; margin-top: 6px; }
    a.link { color: var(--primary); text-decoration: none; font-weight: 600; }
    a.link:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="row">
        <div>
          <h1>Finalizando sua assinatura</h1>
          <p class="lead">Validando o pagamento e atualizando seu acesso…</p>
        </div>
        <div>
          <span id="pill" class="status">INICIALIZANDO</span>
        </div>
      </div>

      <div class="actions">
        <button id="btnRepetir">Repetir atualização</button>
        <button id="btnIrDashboard" class="secondary">Ir para o Dashboard</button>
      </div>
      <div class="hint">Se houver algum atraso de rede, aguarde alguns segundos. Você também pode clicar em <b>Repetir atualização</b>.</div>

      <pre id="log"></pre>
      <div class="hint">
        Problemas? Confira se o usuário está logado e se a política RLS permite atualizar o próprio perfil.
        <br/>Se preferir, retorne à <a href="/planos.html" class="link">página de planos</a>.
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // === Configuração & utilitários ===
    const TARGET_PLAN = "intermediario"; // plano que queremos aplicar
    const REDIRECT_OK = "/dashboard.html"; // para onde mandar quando detectar 'active/intermediario'
    const MAX_POLL = 30;  // tentativas pós-update (segundos)

    const logBox = document.getElementById("log");
    const pill = document.getElementById("pill");
    const log = (line) => {
      const ts = new Date().toLocaleTimeString();
      console.log(`[${ts}] ${line}`);
      logBox.textContent += `[${ts}] ${line}\n`;
      logBox.scrollTop = logBox.scrollHeight;
    };
    const setPill = (txt, cls = "") => {
      pill.textContent = txt;
      pill.className = "status " + cls;
    };

    // Verifica config.js
    if (!window.CONFIG?.SUPABASE_URL || !window.CONFIG?.SUPABASE_ANON_KEY) {
      setPill("CONFIG AUSENTE", "err");
      log("✖ Falha: Não encontrei SUPABASE_URL/ANON_KEY no window.CONFIG (confira config.js).");
      throw new Error("CONFIG ausente");
    } else {
      log("✓ CONFIG ok: SUPABASE_URL/ANON_KEY presentes.");
    }

    // Cria o client
    const supabase = createClient(window.CONFIG.SUPABASE_URL, window.CONFIG.SUPABASE_ANON_KEY);

    // === Fluxo principal ===
    let sessionUserId = null;

    async function getSessionOrRedirect() {
      const { data: { session }, error } = await supabase.auth.getSession();
      if (error) {
        setPill("ERRO SESSÃO", "err");
        log("✖ Erro ao obter sessão: " + (error?.message || error));
        return null;
      }
      if (!session) {
        setPill("SEM SESSÃO", "err");
        log("✖ Sem sessão ativa. Redirecionando para login…");
        window.location.href = "/index.html";
        return null;
      }
      sessionUserId = session.user.id;
      log(`✓ Sessão ok. user.id=${session.user.id}, email=${session.user.email}`);
      return session.user;
    }

    async function fetchProfile() {
      const { data, error } = await supabase
        .from("profiles")
        .select("plan, subscription_status, updated_at")
        .eq("id", sessionUserId)
        .maybeSingle();
      if (error) {
        log("✖ Erro ao consultar profiles: " + error.message);
        return null;
      }
      return data;
    }

    async function applyUpgrade() {
      // Aplica o update que você já validou no console
      setPill("ATUALIZANDO…");
      log(`• Atualizando perfil → plan=${TARGET_PLAN}, subscription_status=active`);
      const { data, error } = await supabase
        .from("profiles")
        .update({
          plan: TARGET_PLAN,
          subscription_status: "active",
          updated_at: new Date().toISOString(),
        })
        .eq("id", sessionUserId)
        .select();

      if (error) {
        setPill("ERRO UPDATE", "err");
        log("✖ Falha no update: " + error.message);
        return false;
      }
      log("✓ Update executado. Retorno: " + JSON.stringify(data));
      return true;
    }

    async function pollUntilApplied() {
      // Polling curto, apenas para confirmar e redirecionar
      setPill("VALIDANDO…");
      for (let i = 1; i <= MAX_POLL; i++) {
        const p = await fetchProfile();
        if (p) {
          log(`• Tentativa ${i}: plan=${p.plan} | subscription_status=${p.subscription_status} | updated_at=${p.updated_at}`);
          if (p.subscription_status === "active" && p.plan === TARGET_PLAN) {
            setPill("OK", "ok");
            log("✓ Upgrade detectado! Redirecionando…");
            window.location.href = REDIRECT_OK;
            return;
          }
        } else {
          log("• Tentativa falhou ao ler perfil (verifique rede/RLS).");
        }
        await new Promise(r => setTimeout(r, 1000));
      }
      setPill("SEM MUDANÇA", "err");
      log("• Polling esgotado sem detectar mudança. Você pode clicar em 'Repetir atualização'.");
    }

    // === Inicialização ===
    setPill("INICIALIZANDO");
    const user = await getSessionOrRedirect();
    if (user) {
      // Mostra estado atual
      const now = await fetchProfile();
      if (now) {
        log(`• Perfil atual → plan=${now.plan} | subscription_status=${now.subscription_status} | updated_at=${now.updated_at}`);
        // Se já estiver OK, redireciona direto
        if (now.subscription_status === "active" && now.plan === TARGET_PLAN) {
          setPill("OK", "ok");
          log("✓ Já está ativo/intermediario. Redirecionando…");
          window.location.href = REDIRECT_OK;
        } else {
          // Aplica upgrade e valida
          const ok = await applyUpgrade();
          if (ok) await pollUntilApplied();
        }
      } else {
        setPill("ERRO PERFIL", "err");
        log("✖ Não foi possível ler o perfil atual.");
      }
    }

    // === Ações manuais ===
    document.getElementById("btnRepetir").onclick = async () => {
      setPill("ATUALIZANDO…");
      const ok = await applyUpgrade();
      if (ok) await pollUntilApplied();
    };
    document.getElementById("btnIrDashboard").onclick = () => {
      window.location.href = REDIRECT_OK;
    };
  </script>
</body>
</html>
