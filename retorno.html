<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Retorno do Pagamento</title>
<style>
  :root{color-scheme:dark}body{background:#121212;color:#fff;font-family:Arial,sans-serif;margin:0;padding:24px}
  .container{max-width:760px;margin:0 auto}.card{background:#0f0f0f;border:1px solid #2a2a2a;border-radius:14px;padding:18px}
  .btn{display:inline-flex;align-items:center;gap:8px;background:#00b140;border:none;color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer}
  .btn:hover{background:#009b38}.muted{color:#9aa0a6}
</style>
<script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<script src="/config.js"></script>
</head>
<body>
<main class="container">
  <h1>Confirmação</h1>
  <div class="card">
    <div id="status">Verificando…</div>
    <div id="det" class="muted"></div>
    <div style="display:flex;gap:10px;margin-top:12px">
      <a class="btn" href="dashboard.html">Dashboard</a>
      <a class="btn" style="background:#333" href="planos.html">Planos</a>
    </div>
  </div>
</main>

<script>
const CFG=window.CONFIG||{};
const sb = supabase.createClient(CFG.SUPABASE_URL, CFG.SUPABASE_ANON_KEY,{auth:{persistSession:true,autoRefreshToken:true,detectSessionInUrl:true}});
const qs=new URLSearchParams(location.search);
const statusEl=document.getElementById('status');const det=document.getElementById('det');

(async function init(){
  const {data:{session}}=await sb.auth.getSession(); if(!session){statusEl.textContent='Faça login novamente.';return}
  // parâmetros que o MP manda na volta (variáveis conforme fluxo)
  const payment_id = qs.get('payment_id') || qs.get('paymentId') || '';
  const preference_id = qs.get('preference_id') || '';
  const payment_status = qs.get('status') || qs.get('collection_status') || '';

  try{
    const body={ payment_id, preference_id };
    const { data, error } = await sb.functions.invoke('mp-verify',{ body });
    if(error){ statusEl.textContent='Não foi possível confirmar com o provedor.'; det.textContent=error.message||JSON.stringify(error); return; }

    statusEl.textContent = (data?.final==='approved') ? '✅ Pagamento aprovado' :
                           (data?.final==='authorized' || data?.final==='pending') ? '⏳ Pagamento em análise/pendente' :
                           '❌ Pagamento não aprovado';
    det.textContent = `status provedor: ${data?.status||payment_status||'desconhecido'} • preference: ${data?.preference_id||preference_id}`;

    // se aprovado, atualiza o chip de plano nas páginas seguintes
    if (data?.final==='approved'){ setTimeout(()=>location.href='planos.html', 2500); }
  }catch(e){
    statusEl.textContent='Erro inesperado no retorno.'; det.textContent=String(e);
  }finally{
    localStorage.removeItem('mm_last_preference');
  }
})();
</script>
</body>
</html>
