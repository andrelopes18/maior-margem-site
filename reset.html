<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Redefinir Senha - MaiorMargem</title>
<style>
  body { margin:0; font-family:'Segoe UI', Arial, sans-serif; background:#121212; color:#fff; display:flex; align-items:center; justify-content:center; height:100vh; }
  .card { width: 360px; background:#1c1c1c; border:1px solid #2a2a2a; border-radius:10px; padding:24px; text-align:center; }
  h1 { font-size:20px; color:#00b140; margin:0 0 12px; }
  input { width:100%; padding:10px; margin:8px 0; border:1px solid #2a2a2a; border-radius:4px; background:#121212; color:#fff; }
  button { width:100%; background:#00b140; color:#fff; padding:10px; border:none; border-radius:4px; cursor:pointer; }
  button[disabled] { opacity:.6; cursor:not-allowed; }
  button:hover:not([disabled]) { background:#009b38; }
  .hint { font-size:12px; color:#aaa; margin-top:6px; }
  .err { color:#ff7676; font-size:12px; margin-top:8px; display:none; }
</style>
</head>
<body>
<div class="card">
  <h1>Definir nova senha</h1>
  <p class="hint">Abrindo sessão de recuperação…</p>
  <input id="novaSenha" type="password" placeholder="Nova senha" disabled />
  <input id="confSenha" type="password" placeholder="Confirmar nova senha" disabled />
  <button id="btnSalvar" onclick="salvarNovaSenha()" disabled>Salvar nova senha</button>
  <p id="msg" class="hint" style="display:none; margin-top:10px;"></p>
  <p id="err" class="err"></p>
</div>

<script src="https://unpkg.com/@supabase/supabase-js"></script>
<script>
const SUPABASE_URL = "https://maprezivxfitqyifmepq.supabase.co"; // troque pelo seu
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1hcHJleml2eGZpdHF5aWZtZXBxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM2MTc4OTcsImV4cCI6MjA2OTE5Mzg5N30.qz8iMEZY0mkh5QgeBKh8lYLITRjcAADbApJkGFwACJI";             // troque pelo seu
const HOME_URL = "https://maior-margem-site.vercel.app";      // troque pelo seu
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const input1 = document.getElementById('novaSenha');
const input2 = document.getElementById('confSenha');
const btn    = document.getElementById('btnSalvar');
const msg    = document.getElementById('msg');
const errBox = document.getElementById('err');

function enableForm() {
  document.querySelector('.hint').textContent = 'Defina sua nova senha abaixo.';
  input1.disabled = false; input2.disabled = false; btn.disabled = false;
}

function showError(m) {
  errBox.style.display = 'block';
  errBox.textContent = m;
}

(async function bootstrap() {
  try {
    // 1) Tente pegar tokens do hash (#access_token&refresh_token)
    const hash = window.location.hash?.startsWith('#') ? window.location.hash.slice(1) : '';
    const params = new URLSearchParams(hash);
    const access_token  = params.get('access_token');
    const refresh_token = params.get('refresh_token');
    const type          = params.get('type'); // geralmente "recovery"

    if (access_token && refresh_token) {
      // 2) Estabelece sessão com os tokens do link
      const { data, error } = await sb.auth.setSession({ access_token, refresh_token });
      if (error) throw error;
      enableForm();
      return;
    }

    // 3) Se não veio no hash, talvez a sessão já esteja ativa (ex.: voltou da mesma aba)
    const { data: { session } } = await sb.auth.getSession();
    if (session && session.user) {
      enableForm();
      return;
    }

    // 4) Sem tokens e sem sessão ativa → não dá pra redefinir
    showError('Não foi possível iniciar a sessão de recuperação. Abra o link de recuperação que enviamos ao seu e-mail. Se o erro persistir, solicite um novo link.');
    document.querySelector('.hint').textContent = 'Erro ao abrir sessão de recuperação.';
  } catch (e) {
    showError('Falha ao iniciar a recuperação: ' + (e?.message || e));
    document.querySelector('.hint').textContent = 'Erro ao abrir sessão de recuperação.';
  }
})();

async function salvarNovaSenha() {
  const nova = input1.value;
  const conf = input2.value;

  if (!nova || !conf) { alert('Preencha os dois campos.'); return; }
  if (nova !== conf)  { alert('As senhas não conferem.'); return; }
  if (nova.length < 6){ alert('A senha deve ter pelo menos 6 caracteres.'); return; }

  const old = btn.textContent;
  btn.disabled = true; btn.textContent = 'Salvando...';

  try {
    // Confirma que temos sessão antes de atualizar
    const { data: { session } } = await sb.auth.getSession();
    if (!session) throw new Error('Sessão de recuperação ausente ou expirada. Abra novamente o link enviado ao seu e-mail.');

    const { error } = await sb.auth.updateUser({ password: nova });
    if (error) throw error;

    msg.style.display = 'block';
    msg.textContent = 'Senha alterada com sucesso! Redirecionando...';
    setTimeout(() => { window.location.href = HOME_URL; }, 1800);

  } catch (e) {
    alert('Erro ao redefinir senha: ' + (e?.message || e));
    btn.disabled = false; btn.textContent = old;
  }
}
</script>
</body>
</html>
