<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Redefinir Senha</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f5f5f5; display:flex; justify-content:center; align-items:center; height:100vh; margin:0; }
    .container { background:white; padding:2rem; border-radius:10px; width:100%; max-width:400px; box-shadow:0 4px 8px rgba(0,0,0,0.1); }
    h2 { margin-top:0; text-align:center; }
    label { display:block; margin-top:1rem; }
    input { width:100%; padding:0.5rem; margin-top:0.25rem; border:1px solid #ccc; border-radius:5px; }
    button { width:100%; padding:0.75rem; margin-top:1.5rem; border:none; border-radius:5px; background:#4CAF50; color:white; font-size:1rem; cursor:pointer; }
    button:disabled { background:#aaa; cursor:not-allowed; }
    .msg { margin-top:1rem; text-align:center; font-size:0.9rem; }
    .success { color:green; }
    .error { color:red; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Redefinir Senha</h2>
    <label>Nova Senha</label>
    <input type="password" id="newPassword" disabled>
    <label>Confirmar Senha</label>
    <input type="password" id="confirmPassword" disabled>
    <button id="btnReset" disabled>Salvar Nova Senha</button>
    <div class="msg" id="msg"></div>
  </div>

  <!-- Config e Supabase -->
  <script src="config.js?v=2"></script>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <script>
    const { SUPABASE_URL, SUPABASE_ANON_KEY, HOME_URL } = window.CONFIG;
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const newPassword = document.getElementById("newPassword");
    const confirmPassword = document.getElementById("confirmPassword");
    const btnReset = document.getElementById("btnReset");
    const msg = document.getElementById("msg");

    // Função para capturar tokens da URL
    function getFragmentParams() {
      const hash = window.location.hash.substr(1);
      return Object.fromEntries(new URLSearchParams(hash));
    }

    // Tenta setar sessão ao abrir a página
    async function init() {
      const params = getFragmentParams();
      if (params.access_token && params.refresh_token) {
        const { data, error } = await sb.auth.setSession({
          access_token: params.access_token,
          refresh_token: params.refresh_token,
        });
        if (error) {
          msg.textContent = "Erro ao validar sessão: " + error.message;
          msg.className = "msg error";
          return;
        }
        // Libera os campos
        newPassword.disabled = false;
        confirmPassword.disabled = false;
        btnReset.disabled = false;
      } else {
        msg.textContent = "Não foi possível iniciar a sessão de recuperação. Solicite um novo link.";
        msg.className = "msg error";
      }
    }

    // Clique para redefinir senha
    btnReset.addEventListener("click", async () => {
      msg.textContent = "";
      if (newPassword.value !== confirmPassword.value) {
        msg.textContent = "As senhas não conferem!";
        msg.className = "msg error";
        return;
      }
      const { data, error } = await sb.auth.updateUser({ password: newPassword.value });
      if (error) {
        msg.textContent = "Erro: " + error.message;
        msg.className = "msg error";
      } else {
        msg.textContent = "Senha redefinida com sucesso! Redirecionando...";
        msg.className = "msg success";
        setTimeout(() => { window.location.href = HOME_URL; }, 2000);
      }
    });

    init();
  </script>
</body>
</html>
