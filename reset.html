<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Redefinir Senha - MaiorMargem</title>
<style>
  body { margin:0; font-family:'Segoe UI', Arial, sans-serif; background:#121212; color:#fff; display:flex; align-items:center; justify-content:center; min-height:100vh; }
  .card { width: 380px; background:#1c1c1c; border:1px solid #2a2a2a; border-radius:10px; padding:24px; text-align:center; }
  h1 { font-size:20px; color:#00b140; margin:0 0 12px; }
  input { width:100%; padding:10px; margin:8px 0; border:1px solid #2a2a2a; border-radius:4px; background:#121212; color:#fff; }
  button { width:100%; background:#00b140; color:#fff; padding:10px; border:none; border-radius:4px; cursor:pointer; margin-top:10px; }
  button[disabled]{ opacity:.6; cursor:not-allowed; }
  button:hover:not([disabled]){ background:#009b38; }
  .hint { font-size:12px; color:#aaa; margin-top:6px; }
  .err  { color:#ff7b7b; font-size:12px; margin-top:8px; display:none; white-space:pre-wrap; text-align:left; }
</style>
</head>
<body>
<div class="card">
  <h1>Definir nova senha</h1>
  <p id="status" class="hint">Iniciando…</p>

  <input id="novaSenha" type="password" placeholder="Nova senha" disabled />
  <input id="confSenha" type="password" placeholder="Confirmar nova senha" disabled />
  <button id="btnSalvar" disabled>Salvar nova senha</button>

  <p id="msg" class="hint" style="display:none; margin-top:10px;"></p>
  <pre id="err" class="err"></pre>
</div>

<!-- 1) Config central (MESMO NÍVEL DO ARQUIVO) -->
<script src="config.js?v=4"></script>
<!-- 2) Biblioteca Supabase -->
<script src="https://unpkg.com/@supabase/supabase-js"></script>
<!-- 3) App -->
<script>
/* ======== LÊ DO config.js ======== */
const CFG = window.CONFIG || {};
const SUPABASE_URL = CFG.SUPABASE_URL;
const SUPABASE_ANON_KEY = CFG.SUPABASE_ANON_KEY;
const HOME_URL = CFG.HOME_URL || '/';

if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
  alert("Erro de configuração: config.js não carregou ou está incompleto.");
  throw new Error("CONFIG ausente");
}

/* ======== Supabase client (igual ao que funcionou) ======== */
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  auth: {
    detectSessionInUrl: true,
    autoRefreshToken: true,
    persistSession: true,
    flowType: 'pkce'
  }
});

// UI helpers
const $ = (id)=>document.getElementById(id);
const input1 = $('novaSenha');
const input2 = $('confSenha');
const btn    = $('btnSalvar');
const msg    = $('msg');
const errBox = $('err');
const status = $('status');

function setStatus(t) { status.textContent = t; }
function showErr(e)   { errBox.style.display='block'; errBox.textContent = String(e || '').trim(); }
function hideErr()    { errBox.style.display='none'; errBox.textContent=''; }
function enableForm() { input1.disabled=false; input2.disabled=false; btn.disabled=false; }

// Lê tokens do hash (#...) e/ou da query (?...)
function tokensFrom(urlLike) {
  try {
    const u = new URL(urlLike, location.origin);
    const hash = u.hash?.startsWith('#') ? u.hash.slice(1) : '';
    const all  = new URLSearchParams(hash);
    // fallback: alguns provedores movem o hash para a querystring
    u.searchParams.forEach((v,k)=>all.set(k,v));
    return {
      access_token: all.get('access_token'),
      refresh_token: all.get('refresh_token'),
      error: all.get('error'),
      error_code: all.get('error_code'),
      error_description: all.get('error_description')
    };
  } catch { return {}; }
}

async function trySetSessionFrom(urlLike) {
  const { access_token, refresh_token, error, error_code, error_description } = tokensFrom(urlLike);
  if (error || error_code) {
    showErr(`${error_code || error}: ${decodeURIComponent(error_description || '')}`);
    return false;
  }
  if (access_token && refresh_token) {
    const { error } = await sb.auth.setSession({ access_token, refresh_token });
    if (error) { showErr('setSession: ' + error.message); return false; }
    return true;
  }
  return false;
}

async function checkAndEnable(reason='') {
  const { data: { session }, error } = await sb.auth.getSession();
  if (error) showErr('getSession: ' + error.message);
  if (session && session.user) {
    hideErr();
    enableForm();
    setStatus('Sessão de recuperação ativa. Defina sua nova senha.');
    return true;
  }
  if (reason) setStatus(reason);
  return false;
}

sb.auth.onAuthStateChange((event) => {
  if (event === 'SIGNED_IN' || event === 'PASSWORD_RECOVERY' || event === 'TOKEN_REFRESHED') {
    checkAndEnable('Sessão detectada.');
  }
});

(async function bootstrap(){
  setStatus('Verificando sessão…');

  // 1) Detecta sessão já ativa (detectSessionInUrl pode resolver sozinho)
  if (await checkAndEnable('Aguardando tokens…')) return;

  // 2) Fallback manual a partir da URL atual
  const didSet = await trySetSessionFrom(location.href);
  if (didSet && await checkAndEnable('Sessão configurada.')) return;

  // 3) Se nada deu, informe e aguarde ação do usuário (gerar novo link)
  setStatus('Não foi possível validar automaticamente. Gere um novo link e abra novamente.');
  showErr('Dica: copie o endereço do link do e-mail e abra direto no navegador. Se o e-mail removeu o #, tente colar a URL completa na barra do navegador.');
})();

// Botão salvar
btn.addEventListener('click', async () => {
  hideErr();
  msg.style.display='none';
  const nova = input1.value.trim();
  const conf = input2.value.trim();

  if (!nova || !conf) { alert('Preencha os dois campos.'); return; }
  if (nova !== conf)  { alert('As senhas não conferem.'); return; }
  if (nova.length < 6){ alert('A senha deve ter pelo menos 6 caracteres.'); return; }

  const { data: { session }, error } = await sb.auth.getSession();
  if (error) { showErr('getSession no submit: ' + error.message); return; }
  if (!session) { showErr('Sessão de recuperação ausente ou expirada. Gere um novo link e tente novamente.'); return; }

  btn.disabled = true; const old = btn.textContent; btn.textContent = 'Salvando...';
  try {
    const { error } = await sb.auth.updateUser({ password: nova });
    if (error) throw error;
    msg.style.display = 'block';
    msg.textContent = 'Senha alterada com sucesso! Redirecionando...';
    setTimeout(() => { window.location.href = HOME_URL; }, 1500);
  } catch (e) {
    showErr('updateUser: ' + (e?.message || e));
    btn.disabled = false; btn.textContent = old;
  }
});
</script>
</body>
</html>
