<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Redefinir Senha</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    .container {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      width: 320px;
    }
    h2 { margin-bottom: 16px; }
    input {
      width: 100%;
      padding: 10px;
      margin-bottom: 12px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    button {
      width: 100%;
      padding: 10px;
      background: #0070f3;
      border: none;
      color: #fff;
      border-radius: 4px;
      cursor: pointer;
    }
    button:disabled { background: #999; cursor: not-allowed; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Redefinir Senha</h2>
    <input type="password" id="novaSenha" placeholder="Nova Senha" disabled>
    <input type="password" id="confSenha" placeholder="Confirmar Senha" disabled>
    <button id="btnSalvar" disabled>Salvar Nova Senha</button>
  </div>

  <!-- Biblioteca Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <script>
    // üîë Substitua pelas suas chaves reais:
    const SUPABASE_URL = "https://maprezivxfitqyifmepq.supabase.co"; // troque pelo seu
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1hcHJleml2eGZpdHF5aWZtZXBxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM2MTc4OTcsImV4cCI6MjA2OTE5Mzg5N30.qz8iMEZY0mkh5QgeBKh8lYLITRjcAADbApJkGFwACJI";             // troque pelo seu
const SITE_URL = "https://maior-margem-site.vercel.app";      // troque pelo seu

    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    function parseTokensFrom(urlLike) {
      const u = new URL(urlLike, location.origin);
      const hash = u.hash?.startsWith('#') ? u.hash.slice(1) : '';
      const all = new URLSearchParams(hash);
      u.searchParams.forEach((v,k)=>all.set(k,v));
      return { access_token: all.get('access_token'), refresh_token: all.get('refresh_token') };
    }

    (async function bootstrap(){
      const { access_token, refresh_token } = parseTokensFrom(location.href);
      if (access_token && refresh_token) {
        const { error } = await sb.auth.setSession({ access_token, refresh_token });
        if (!error) {
          document.getElementById('novaSenha').disabled = false;
          document.getElementById('confSenha').disabled = false;
          document.getElementById('btnSalvar').disabled = false;
          return;
        } else {
          alert("Erro ao iniciar sess√£o de recupera√ß√£o: " + error.message);
        }
      } else {
        alert("Link inv√°lido ou expirado. Solicite novamente.");
      }
    })();

    document.getElementById('btnSalvar').addEventListener('click', async ()=>{
      const nova = document.getElementById('novaSenha').value;
      const conf = document.getElementById('confSenha').value;
      if (!nova || !conf) return alert('Preencha os dois campos.');
      if (nova !== conf) return alert('As senhas n√£o conferem.');
      if (nova.length < 6) return alert('M√≠nimo 6 caracteres.');

      const { data: { session } } = await sb.auth.getSession();
      if (!session) return alert('Sess√£o ausente ou expirada. Solicite novo link.');

      const { error } = await sb.auth.updateUser({ password: nova });
      if (error) alert('Erro: ' + error.message);
      else {
        alert('Senha alterada com sucesso!');
        window.location.href = "index.html"; // redireciona para login
      }
    });
  </script>
</body>
</html>
