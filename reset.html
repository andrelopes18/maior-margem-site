<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Redefinir Senha - MaiorMargem</title>
<style>
  body { margin:0; font-family:'Segoe UI', Arial, sans-serif; background:#121212; color:#fff; display:flex; align-items:center; justify-content:center; min-height:100vh; }
  .card { width: 380px; background:#1c1c1c; border:1px solid #2a2a2a; border-radius:10px; padding:24px; text-align:center; }
  h1 { font-size:20px; color:#00b140; margin:0 0 12px; }
  input { width:100%; padding:10px; margin:8px 0; border:1px solid #2a2a2a; border-radius:4px; background:#121212; color:#fff; }
  button { width:100%; background:#00b140; color:#fff; padding:10px; border:none; border-radius:4px; cursor:pointer; }
  button[disabled]{ opacity:.6; cursor:not-allowed; }
  button:hover:not([disabled]){ background:#009b38; }
  .hint { font-size:12px; color:#aaa; margin-top:6px; }
  .err  { color:#ff7b7b; font-size:12px; margin-top:8px; display:none; }
  .manual { margin-top:14px; text-align:left; }
  .manual summary { cursor:pointer; color:#9cf; }
  .manual textarea { width:100%; height:76px; }
</style>
</head>
<body>
<div class="card">
  <h1>Definir nova senha</h1>
  <p id="status" class="hint">Abrindo sessão de recuperação…</p>

  <input id="novaSenha" type="password" placeholder="Nova senha" disabled />
  <input id="confSenha" type="password" placeholder="Confirmar nova senha" disabled />
  <button id="btnSalvar" onclick="salvarNovaSenha()" disabled>Salvar nova senha</button>

  <p id="msg" class="hint" style="display:none; margin-top:10px;"></p>
  <p id="err" class="err"></p>

  <div class="manual">
    <details>
      <summary>Problemas? Clique aqui para colar o link do email manualmente</summary>
      <p class="hint">No seu e-mail, copie o <b>endereço do link</b> (incluindo tudo após <code>#</code> ou <code>?</code>) e cole abaixo:</p>
      <textarea id="linkManual" placeholder="Cole aqui a URL completa recebida por email"></textarea>
      <button id="btnAplicar" onclick="aplicarLinkManual()">Usar este link</button>
    </details>
  </div>
</div>

<!-- ORDEM IMPORTA: 1) config → 2) supabase lib → 3) app -->
<script src="config.js?v=1"></script>
<script src="https://unpkg.com/@supabase/supabase-js"></script>
<script>
const { SUPABASE_URL, SUPABASE_ANON_KEY, HOME_URL } = window.CONFIG || {};
if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
  alert("Erro de configuração: o arquivo config.js não carregou.");
  throw new Error("CONFIG ausente");
}
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const $ = (id)=>document.getElementById(id);
const input1 = $('novaSenha');
const input2 = $('confSenha');
const btn    = $('btnSalvar');
const msg    = $('msg');
const errBox = $('err');
const status = $('status');

function enableForm() {
  status.textContent = 'Defina sua nova senha abaixo.';
  input1.disabled = false; input2.disabled = false; btn.disabled = false;
  errBox.style.display = 'none'; errBox.textContent = '';
}
function showError(m) { errBox.style.display = 'block'; errBox.textContent = m; }

function parseTokensFrom(urlLike) {
  try {
    const u = new URL(urlLike, window.location.origin);
    const hash = u.hash?.startsWith('#') ? u.hash.slice(1) : '';
    const allParams = new URLSearchParams(hash);
    // fallback: alguns e-mails movem o hash para a querystring
    u.searchParams.forEach((v,k)=>allParams.set(k,v));
    return { access_token: allParams.get('access_token'), refresh_token: allParams.get('refresh_token') };
  } catch { return {}; }
}

async function tryOpenSessionFrom(urlLike) {
  const { access_token, refresh_token } = parseTokensFrom(urlLike);
  if (access_token && refresh_token) {
    const { error } = await sb.auth.setSession({ access_token, refresh_token });
    if (error) throw error;
    enableForm();
    return true;
  }
  return false;
}

async function bootstrap() {
  try {
    // 1) Tenta com a URL atual
    if (await tryOpenSessionFrom(window.location.href)) return;

    // 2) Se já houver sessão ativa
    const { data: { session } } = await sb.auth.getSession();
    if (session && session.user) { enableForm(); return; }

    // 3) Orienta a colar o link manualmente
    status.textContent = 'Não foi possível iniciar a sessão de recuperação.';
    showError('Abra o link diretamente do e-mail. Se o cliente removeu o #, cole o endereço do link no campo "Usar este link".');
  } catch (e) {
    status.textContent = 'Erro ao iniciar a recuperação.';
    showError('Falha: ' + (e?.message || e));
  }
}

async function aplicarLinkManual() {
  const raw = $('linkManual').value.trim();
  if (!raw) { alert('Cole a URL completa do e-mail.'); return; }
  try {
    const ok = await tryOpenSessionFrom(raw);
    if (!ok) showError('Não encontrei tokens na URL colada. Confirme que ela contém "access_token" e "refresh_token".');
  } catch(e) { showError('Erro ao aplicar link: ' + (e?.message || e)); }
}

async function salvarNovaSenha() {
  const nova = input1.value, conf = input2.value;
  if (!nova || !conf) { alert('Preencha os dois campos.'); return; }
  if (nova !== conf)  { alert('As senhas não conferem.'); return; }
  if (nova.length < 6){ alert('A senha deve ter pelo menos 6 caracteres.'); return; }

  const old = btn.textContent; btn.disabled = true; btn.textContent = 'Salvando...';
  try {
    const { data: { session } } = await sb.auth.getSession();
    if (!session) throw new Error('Sessão ausente/expirada. Gere um novo link e tente novamente.');
    const { error } = await sb.auth.updateUser({ password: nova });
    if (error) throw error;
    msg.style.display = 'block'; msg.textContent = 'Senha alterada com sucesso! Redirecionando...';
    setTimeout(() => { window.location.href = HOME_URL; }, 1800);
  } catch(e) {
    alert('Erro ao redefinir senha: ' + (e?.message || e));
    btn.disabled = false; btn.textContent = old;
  }
}

bootstrap();
</script>
</body>
</html>
