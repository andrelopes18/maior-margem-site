<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Planos de Assinatura</title>

<style>
  :root { color-scheme: dark; }
  *{ box-sizing:border-box }
  body{background:#121212;color:#fff;font-family:Arial,sans-serif;margin:0}
  a{color:#00b140;text-decoration:none}
  header{display:flex;align-items:center;justify-content:space-between;padding:20px}
  h1{margin:0;color:#00b140}
  .user{font-size:12px;color:#9aa0a6}

  .btn{display:inline-flex;align-items:center;gap:8px;background:#00b140;color:#fff;border:none;padding:10px 14px;border-radius:8px;text-decoration:none;cursor:pointer;transition:background .2s,opacity .2s}
  .btn:hover{background:#009b38}
  .btn[disabled]{opacity:.7;cursor:not-allowed}
  .btn.ghost{background:transparent;border:1px solid #2a2a2a;color:#ddd}
  .btn.ghost:hover{background:#1b1b1b}

  .container{max-width:1100px;margin:0 auto;padding:0 20px 32px}

  .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:18px;margin-top:10px}
  @media (max-width:1000px){ .grid{grid-template-columns:repeat(2,1fr)} }
  @media (max-width:560px){ .grid{grid-template-columns:1fr} }

  .card{background:#0f0f0f;border:1px solid #2a2a2a;border-radius:14px;padding:18px;display:flex;flex-direction:column;position:relative;overflow:hidden}
  .badge{position:absolute;top:10px;right:-38px;transform:rotate(35deg);background:#1c3b1c;color:#bfffc1;padding:4px 60px;font-size:12px;border:1px solid #2a2a2a}
  .plan-name{font-weight:800;font-size:16px;letter-spacing:.3px}
  .price{display:flex;align-items:flex-end;gap:6px;margin:10px 0 2px}
  .price .amount{font-size:34px;font-weight:900;line-height:1}
  .price .period{font-size:12px;color:#9aa0a6;margin-bottom:6px}
  .price-note{font-size:12px;color:#9aa0a6;margin-bottom:8px}
  .feat{display:flex;gap:8px;align-items:flex-start;margin:6px 0;color:#cfcfcf}
  .feat:before{content:"✓";opacity:.9}
  .spacer{flex:1}
  .actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .small{font-size:12px;color:#9aa0a6}

  .banner{border:1px solid #2a2a2a;border-radius:10px;padding:10px 12px;margin:12px 0;background:#111;display:none}
  .banner.warn{border-color:#5c3f00;background:#1b1300;color:#ffc966;display:block}
  .banner.ok{border-color:#214d21;background:#0e1a0e;color:#b7fbb7;display:block}
  .banner.err{border-color:#5c1e1e;background:#190d0d;color:#ff9a9a;display:block}

  .foot{margin-top:14px;display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}

  .pill{display:inline-block;padding:2px 8px;border:1px solid #2a2a2a;border-radius:999px;font-size:11px;color:#bfbfbf;margin-left:8px}
  .spinner{width:14px;height:14px;border:2px solid rgba(255,255,255,.4);border-top-color:#fff;border-radius:50%;display:inline-block;animation:spin .7s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
</style>

<!-- Supabase + suas configs -->
<script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<script src="./config.js"></script>
</head>
<body>
<header class="container">
  <h1>Planos</h1>
  <div style="display:flex;gap:10px;align-items:center">
    <span id="userInfo" class="user">Carregando…</span>
    <a href="dashboard.html" class="btn ghost">← Voltar</a>
  </div>
</header>

<main class="container">
  <div id="banner" class="banner"></div>
  <div id="plansGrid" class="grid"></div>
  <div class="foot">
    <div class="small">Valores mensais com cobrança recorrente. Cancele quando quiser.</div>
    <div><a href="meusdados.html" class="btn ghost">Meus dados</a></div>
  </div>
</main>

<script>
// ====== Supabase client ======
const CFG = window.CONFIG || {};
const sb = supabase.createClient(CFG.SUPABASE_URL, CFG.SUPABASE_ANON_KEY, {
  auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
});

// ====== UI helpers ======
const userInfo = document.getElementById('userInfo');
const banner = document.getElementById('banner');
const grid = document.getElementById('plansGrid');

function moneyBR(cents){ return (cents/100).toLocaleString('pt-BR',{style:'currency',currency:'BRL'}); }
function showBanner(msg, type='ok'){ banner.textContent = msg; banner.className = 'banner ' + type; }
function clearBanner(){ banner.className = 'banner'; banner.style.display='none'; banner.textContent=''; }

// ====== Util ======
function getFunctionsBaseFromSupabaseUrl(urlStr){
  try{
    const u = new URL(urlStr);
    const projectRef = u.host.split('.supabase.co')[0];
    return `https://${projectRef}.functions.supabase.co`;
  }catch{ return '/functions/v1'; }
}
const FUNCTIONS_BASE = getFunctionsBaseFromSupabaseUrl(CFG.SUPABASE_URL);
const CREATE_CHECKOUT_ENDPOINT = `${FUNCTIONS_BASE}/create-checkout`;

// ====== Sessão & Perfil ======
async function ensureSession(){
  const { data: { session } } = await sb.auth.getSession();
  if (!session) { window.location.href = CFG.SITE_URL || 'index.html'; return null; }
  return session;
}

async function fetchProfilePlanType(userId){
  const { data, error } = await sb
    .from('profiles')
    .select('plan_type')
    .eq('id', userId)
    .maybeSingle();
  if (error) throw error;
  return data?.plan_type || 'trial';
}

// ====== Carregar planos (apenas ativos) ======
async function loadPlans(){
  const { data, error } = await sb
    .from('billing_plans')
    .select('id,name,plan_key,price_cents,active')
    .eq('active', true)
    .order('price_cents', { ascending: true });
  if (error) throw error;
  return (data||[]).map(p => ({...p, _key: p.plan_key || 'trial'}));
}

// (Opcional) features por plano
function featuresFor(key){
  switch(String(key)){
    case 'trial': return ['Acesso limitado','Sem custo'];
    case 'basico': return ['Dashboard básico','Suporte por e-mail'];
    case 'intermediario': return ['Tudo do Básico','Relatórios adicionais'];
    case 'premium': return ['Tudo do Intermediário','Suporte prioritário'];
    default: return ['Cobrança recorrente mensal'];
  }
}

// ====== Render ======
function renderPlans(plans, currentKey){
  grid.innerHTML = '';

  const currentPlan = plans.find(p => p.plan_key === currentKey) || null;
  const currentPrice = currentPlan?.price_cents ?? 0;

  for (const p of plans){
    const card = document.createElement('div');
    card.className = 'card';

    const priceFmt = moneyBR(p.price_cents);
    const feats = featuresFor(p.plan_key);

    let btnLabel = 'Assinar';
    let btnDisabled = false;
    let pill = '';

    if (p.plan_key === currentKey){
      btnLabel = 'Seu plano atual';
      btnDisabled = true;
      pill = '<span class="pill">ativo</span>';
    } else {
      if (p.price_cents > currentPrice) btnLabel = 'Upgrade';
      else if (p.price_cents < currentPrice) btnLabel = 'Downgrade';
      else btnLabel = 'Mudar para este';
    }

    card.innerHTML = `
      <div class="plan-name">${p.name} ${pill}</div>
      <div class="price">
        <span class="amount">${priceFmt}</span>
        <span class="period">/mês</span>
      </div>
      <div class="price-note">${priceFmt} por mês</div>
      ${feats.map(f => `<div class="feat">${f}</div>`).join('')}
      <div class="spacer"></div>
      <div class="actions">
        <button class="btn" data-plan="${p.id}" ${btnDisabled?'disabled':''}>${btnLabel}</button>
        <span class="small">renova automaticamente</span>
      </div>
    `;

    const btn = card.querySelector('.btn');
    if (!btnDisabled) btn.addEventListener('click', () => startCheckout(p.id, p.name, btn));

    grid.appendChild(card);
  }
}

// ====== Iniciar checkout ======
async function startCheckout(planId, planName, btnEl){
  const original = btnEl.innerHTML;
  btnEl.innerHTML = '<span class="spinner"></span> Processando...';
  btnEl.disabled = true;
  showBanner(`Criando checkout para "${planName}"…`, 'ok');

  const { data: { session } } = await sb.auth.getSession();

  try {
    const resp = await fetch(CREATE_CHECKOUT_ENDPOINT, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${session?.access_token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ plan_id: planId })
    });

    const text = await resp.text();
    let json = {};
    try { json = text ? JSON.parse(text) : {}; } catch { json = { error: text }; }

    if (!resp.ok || !json.pay_url) {
      console.error('create-checkout error:', json);
      showBanner(`Não foi possível iniciar o pagamento. ${json.error || ''}`, 'err');
      btnEl.innerHTML = original;
      btnEl.disabled = false;
      return;
    }

    showBanner('Redirecionando para o pagamento…', 'ok');
    window.location.href = json.pay_url;
  } catch (e) {
    console.error(e);
    showBanner(`Não foi possível iniciar o pagamento. ${e?.message ?? ''}`, 'err');
    btnEl.innerHTML = original;
    btnEl.disabled = false;
  }
}

// ====== Init ======
(async function init(){
  const session = await ensureSession(); if (!session) return;

  try {
    const planType = await fetchProfilePlanType(session.user.id); // 'trial'|'basico'|'intermediario'|'premium'
    userInfo.textContent = `${session.user?.email || 'Logado'} • Plano: ${planType}`;

    const plans = await loadPlans();
    if (!plans.length) { showBanner('Nenhum plano ativo encontrado.', 'warn'); return; }

    renderPlans(plans, planType);
  } catch (err){
    console.error(err);
    showBanner('Erro ao carregar planos. Confira as políticas RLS ou sua conexão.', 'err');
  }
})();
</script>
</body>
</html>
