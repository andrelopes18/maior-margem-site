<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Planos</title>
<script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<script src="https://unpkg.com/imask"></script>
<script src="/config.js?v=1"></script>
<style>
  :root{color-scheme:dark}
  body{background:#121212;color:#fff;font-family:Arial,sans-serif;margin:0;padding:24px}
  a{color:#00b140}
  .container{max-width:980px;margin:0 auto}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;margin-bottom:18px}
  h1{margin:0;color:#00b140}
  .grid{display:grid;gap:16px;grid-template-columns:repeat(4,1fr)}
  @media(max-width:980px){.grid{grid-template-columns:repeat(2,1fr)}}
  @media(max-width:560px){.grid{grid-template-columns:1fr}}
  .card{background:#0f0f0f;border:1px solid #2a2a2a;border-radius:14px;padding:16px}
  .muted{color:#9aa0a6;font-size:13px}
  .price{font-size:26px;font-weight:700}
  .btn{display:inline-flex;align-items:center;gap:8px;background:#00b140;border:none;color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer}
  .btn:hover{background:#009b38}
  .btn.ghost{background:transparent;border:1px solid #2a2a2a;color:#ddd}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .chip{font-size:12px;background:#1e1e1e;border:1px solid #333;padding:6px 10px;border-radius:999px}
  .chip.plan{color:#bfffc1;border-color:#2f5a2f;background:#132313}
  .checkout{margin-top:24px;background:#0f0f0f;border:1px solid #2a2a2a;border-radius:14px;padding:18px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px}
  label{display:block;margin:4px 0 8px;color:#9aa0a6}
  input,select{width:100%;padding:12px 14px;border-radius:10px;border:1px solid #2a2a2a;background:#1a1a1a;color:#fff}
  input[disabled], select[disabled]{background:#171717;border-color:#2a2a2a;color:#b5b5b5}
  .stack{display:flex;gap:8px;flex-wrap:wrap}
  .badge{font-size:12px;border:1px solid #2a3350;background:#0e1322;padding:4px 8px;border-radius:999px}
  .ok{color:#6ef06e}
  .sep{height:1px;background:#2a2a2a;margin:18px 0}
  .banner{border:1px solid #2a2a2a;border-radius:10px;padding:10px 12px;margin-bottom:14px;background:#111;display:none}
  .banner.warn{border-color:#5c3f00;background:#1b1300;color:#ffc966;display:block}
  .banner.ok{border-color:#214d21;background:#0e1a0e;color:#b7fbb7;display:block}
  .banner.err{border-color:#5c1e1e;background:#190d0d;color:#ff9a9a;display:block}
  .diag-only{display:none} body.show-diag .diag-only{display:block}
  .log{white-space:pre-wrap;background:#0b0f1a;border:1px solid #1b2133;padding:12px;border-radius:8px;min-height:120px;max-height:320px;overflow:auto}
  small.mono{font-family:ui-monospace,Consolas,monospace;opacity:.85}
  #btnDiag{position:fixed;right:16px;bottom:16px;z-index:9999;width:38px;height:38px;border-radius:999px;border:1px solid #2a2a2a;background:#131313;color:#bdbdbd;opacity:.5;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:18px}
  #btnDiag:hover{opacity:.9}
</style>
</head>
<body>
<header class="container">
  <h1>Planos</h1>
  <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
    <span id="planChip" class="chip plan">Plano: —</span>
    <a class="btn ghost" href="dashboard.html">← Voltar</a>
    <a class="btn ghost" href="meusdados.html">Meus dados</a>
    <button id="btnSair" class="btn">Sair</button>
  </div>
</header>

<main class="container">
  <section id="cards" class="grid"></section>

  <section id="checkout" class="checkout" style="display:none">
    <div id="banner" class="banner"></div>

    <div class="stack" style="justify-content:space-between;align-items:center">
      <div>
        <div><b>Plano:</b> <span id="planoNome">—</span> • <b>Valor:</b> R$ <span id="planoValor">—</span></div>
        <div><b>Conta:</b> <span id="contaEmail">—</span></div>
      </div>
      <div class="stack" id="badges"></div>
    </div>

    <div class="sep"></div>

    <div class="stack" style="align-items:center;margin-bottom:8px">
      <input id="recorrente" type="checkbox" />
      <label for="recorrente" style="margin:0">Cobrança recorrente (assinatura)</label>
    </div>

    <div class="row">
      <div>
        <label>Nome impresso no cartão</label>
        <input id="cardholder" value="APRO" disabled />
      </div>
      <div>
        <label>E-mail do pagador</label>
        <input id="payerEmail" value="comprador@test.com" disabled />
      </div>
    </div>

    <div class="row">
      <div>
        <label>CPF</label>
        <input id="payerCPF" value="19119119100" disabled />
      </div>
      <div>
        <label>Parcelas</label>
        <select id="installments" disabled>
          <option value="1" selected>1x</option>
          <option value="2">2x</option>
          <option value="3">3x</option>
        </select>
      </div>
    </div>

    <div class="row-3">
      <div>
        <label>Número do cartão (teste aprovado)</label>
        <input id="cardNumber" value="5031 4332 1540 6351" disabled />
      </div>
      <div>
        <label>Validade (MM/AAAA)</label>
        <input id="cardExp" value="11/2029" disabled />
      </div>
      <div>
        <label>CVV</label>
        <input id="cardCVV" value="123" disabled />
      </div>
    </div>

    <div class="sep"></div>
    <div class="stack" style="justify-content:space-between;align-items:center">
      <div class="stack">
        <button id="btnUnlock" class="btn">Desbloquear campos</button>
        <!-- Diagnósticos -->
        <button id="btnHealthSubs" class="btn ghost diag-only">/health da assinatura</button>
        <button id="btnInspectToken" class="btn ghost diag-only">Inspecionar token</button>
        <button id="btnTestCors" class="btn ghost diag-only">Testar CORS/URL</button>
        <button id="btnTestPost" class="btn ghost diag-only">Testar POST assíncrono</button>
      </div>
      <button id="btnPagar" class="btn" disabled>Pagar</button>
    </div>

    <div class="diag-only">
      <div class="sep"></div><h3>Logs</h3><div id="logs" class="log"></div>
      <div class="sep"></div><h3>Resposta</h3><div id="resp" class="log"></div>
      <div style="margin-top:6px">
        <small class="mono">EDGE_FUNCTION_NAME: <span id="fnName">—</span></small> ·
        <small class="mono">FUNCTIONS_URL: <span id="fnUrl">—</span></small> ·
        <small class="mono">MP_PUBLIC_KEY is TEST?: <span id="pkIsTest">—</span></small>
      </div>
    </div>
  </section>
</main>

<button id="btnDiag" title="Modo diagnóstico (mostrar/ocultar)">⚙︎</button>

<script>
const CFG = window.CONFIG||{};
let FUNCTIONS_URL = CFG.FUNCTIONS_URL;
if (!FUNCTIONS_URL) { try { const ref = new URL(CFG.SUPABASE_URL).host.split(".")[0]; FUNCTIONS_URL = `https://${ref}.functions.supabase.co`; } catch {} }

const sb  = supabase.createClient(CFG.SUPABASE_URL, CFG.SUPABASE_ANON_KEY,{auth:{persistSession:true,autoRefreshToken:true,detectSessionInUrl:true}});
const $ = s=>document.querySelector(s);
const planChip = $('#planChip'), cardsEl = $('#cards');
const checkoutEl = $('#checkout'), banner = $('#banner'), logs = $('#logs'), resp = $('#resp');

function money(c){return (Number(c||0)/100).toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}
function label(k){return (CFG.PLAN_LABELS||{})[k]||k.charAt(0).toUpperCase()+k.slice(1)}
function addBadge(text, ok=false){ const b=document.createElement('span'); b.className='badge '+(ok?'ok':''); b.textContent=text; $('#badges').appendChild(b); }
function showBanner(text, type='ok', autohideMs=4200){ banner.textContent=text; banner.className='banner '+(type==='warn'?'warn':type==='err'?'err':'ok'); banner.style.display='block'; if(autohideMs>0){ setTimeout(()=>{ banner.style.display='none'; }, autohideMs);} }
function log(...args){ if(!logs) return; const line=args.map(a=>{ try{return typeof a==='string'?a:JSON.stringify(a,null,2);}catch{ return String(a);} }).join(" "); logs.textContent+=(logs.textContent? "\n":"")+line; logs.scrollTop=logs.scrollHeight; }
function showResp(obj){ if(!resp) return; try{ resp.textContent=JSON.stringify(obj,null,2);}catch{ resp.textContent=String(obj);} }
function digitsOnly(s){ return (s||'').replace(/\D+/g,""); }
function detectBrand(num){ const n=digitsOnly(num); if(n.startsWith('4'))return'visa'; if(n.startsWith('5'))return'master'; if(n.startsWith('34')||n.startsWith('37'))return'amex'; return undefined; }

IMask($('#cardExp'), { mask: '00/0000' });
IMask($('#cardNumber'), { mask: '0000 0000 0000 0000' });
IMask($('#cardCVV'), { mask: '000[0]' });

let user=null, currentPlanKey='trial', plans=[];
let CURRENT_PLAN=null;
let LAST_CARD_TOKEN=null;
let LAST_TOKEN_TS=0;

document.getElementById('btnSair').onclick = async()=>{ await sb.auth.signOut(); location.href=CFG.SITE_URL||'index.html'; };
document.getElementById('btnDiag').onclick = ()=>{ document.body.classList.toggle('show-diag'); };

(async function init(){
  const {data:{session}}=await sb.auth.getSession(); if(!session){location.href=CFG.SITE_URL||'index.html';return}
  user=session.user;
  const prof=await sb.from('profiles').select('plan').eq('id',user.id).maybeSingle();
  currentPlanKey=(prof.data?.plan||'trial'); planChip.textContent=`Plano: ${label(currentPlanKey)}`;

  const {data}=await sb.from('billing_plans')
    .select('id,name,plan_key,price_cents,interval_unit,interval_length,active,sort_order')
    .eq('active',true).order('sort_order',{ascending:true});
  plans=(data||[]); renderCards();

  $('#fnName').textContent = CFG.EDGE_FUNCTION_NAME || "—";
  $('#fnUrl').textContent  = FUNCTIONS_URL || "(não deduzida)";
  $('#contaEmail').textContent = user.email || "—";
  $('#payerEmail').value   = user.email || "";
  addBadge("Sessão: ON", true);
  addBadge("MP_PUBLIC_KEY: " + (CFG.MP_PUBLIC_KEY?.slice(0,5) || "—"));
  document.getElementById('pkIsTest').textContent = CFG.MP_PUBLIC_KEY?.startsWith("TEST-") ? "SIM" : "NÃO";
})();

function renderCards(){
  cardsEl.innerHTML='';
  const order=['trial','basico','intermediario','premium'];
  for(const k of order){
    const p=plans.find(x=>String(x.plan_key).toLowerCase()===k); if(!p) continue;
    const el=document.createElement('div');el.className='card';
    el.innerHTML=`<h3>${p.name||label(k)}</h3>
      <div class="price">${money(p.price_cents||0)}</div>
      <div class="muted">Cobrança: ${p.interval_length||1}× / ${p.interval_unit||'month'}</div>
      <div class="muted">${k==='trial'?'Plano gratuito para conhecer a plataforma.':'Acesso aos recursos do plano selecionado.'}</div>`;
    const btn=document.createElement('button');
    const isCurrent=(k===String(currentPlanKey).toLowerCase());
    btn.className=isCurrent?'btn ghost':'btn'; btn.textContent=isCurrent?'Plano atual':'Escolher'; btn.disabled=isCurrent;
    btn.onclick=()=>openCheckout(p);
    el.appendChild(btn); cardsEl.appendChild(el);
  }
}
function openCheckout(plan){
  CURRENT_PLAN = plan;
  $('#planoNome').textContent = plan?.name || plan?.plan_key || '—';
  $('#planoValor').textContent = (Number(plan?.price_cents||0)/100).toFixed(2);
  checkoutEl.style.display = 'block';
  document.getElementById('btnPagar').disabled = false;
  checkoutEl.scrollIntoView({behavior:'smooth', block:'start'});
}
function buildHeaders(sessionAccessToken){
  const h = { "Content-Type":"application/json", "apikey": CFG.SUPABASE_ANON_KEY, "x-supabase-url": CFG.SUPABASE_URL, "x-supabase-anon-key": CFG.SUPABASE_ANON_KEY };
  if (sessionAccessToken) h["Authorization"] = `Bearer ${sessionAccessToken}`;
  return h;
}

document.getElementById('btnUnlock').onclick = ()=>{
  for (const id of ["cardholder","payerEmail","payerCPF","installments","cardNumber","cardExp","cardCVV"])
    document.getElementById(id).disabled = false;
  showBanner("Campos desbloqueados.", "ok");
};

/* ==== util: inspecionar token no backend ==== */
async function inspectToken(tokenId){
  const { data: { session } } = await sb.auth.getSession();
  const r = await fetch(`${FUNCTIONS_URL}/mercado-pago-subscription`, {
    method:"POST", headers: buildHeaders(session?.access_token),
    body: JSON.stringify({ inspect_card_token: true, card_token: tokenId })
  });
  const txt = await r.text(); let j=null; try{ j = JSON.parse(txt) }catch{ j = { raw: txt } }
  return { status: r.status, data: j };
}

/* ==== botões de diagnóstico ==== */
document.getElementById('btnHealthSubs')?.addEventListener('click', async ()=>{
  if (logs) logs.textContent = ""; if (resp) resp.textContent = "";
  try{
    const r = await fetch(`${FUNCTIONS_URL}/mercado-pago-subscription`, { method:"GET" });
    const t = await r.text(); let j=null; try{ j=JSON.parse(t)}catch{ j={raw:t} }
    showResp({ health_subscription: j });
  }catch(e){ showResp({ error_health: String(e) }); }
});
document.getElementById('btnTestCors')?.addEventListener('click', async ()=>{
  if (logs) logs.textContent = ""; if (resp) resp.textContent = "";
  const base = `${FUNCTIONS_URL}/mercado-pago-subscription`;
  try { const r1 = await fetch(base, { method:"GET" }); log("GET /health status:", r1.status);
    const r2 = await fetch(base, { method:"OPTIONS" }); log("OPTIONS status:", r2.status, "ACAO:", r2.headers.get("access-control-allow-origin"));
  } catch (e) { showResp({ test_cors_error: String(e) }); showBanner("Falha no teste CORS/URL.", "err"); }
});
document.getElementById('btnTestPost')?.addEventListener('click', async ()=>{
  if (logs) logs.textContent = ""; if (resp) resp.textContent = "";
  const { data: { session } } = await sb.auth.getSession();
  if (!session){ showBanner("Sem sessão.", "warn"); return; }
  try{
    const r = await fetch(`${FUNCTIONS_URL}/mercado-pago-subscription`, {
      method:"POST", headers: buildHeaders(session.access_token),
      body: JSON.stringify({ plan_key:"premium", card_token:"FAKE", payer:{email:"x@y.com"} })
    });
    const t = await r.text(); let j=null; try{ j=JSON.parse(t)}catch{ j={raw:t} }
    showResp({ status:r.status, data:j });
  }catch(e){ showResp({ post_error: String(e) }); showBanner("Falha de rede no POST.", "err"); }
});
document.getElementById('btnInspectToken')?.addEventListener('click', async ()=>{
  if (!LAST_CARD_TOKEN){ showBanner("Gere o token primeiro (clique Pagar até a etapa de tokenizar).", "warn"); return; }
  const res = await inspectToken(LAST_CARD_TOKEN);
  showResp({ inspect: res });
  if (res?.data?.status === 404 || res?.data?.token_lookup?.message?.includes("could not get")) {
    showBanner("Token não encontrado pelo backend (mismatch/expirado).", "err");
  } else if (res?.data?.status === 200) {
    showBanner("Token OK no backend (200).", "ok");
  }
});

/* ==== pagamento ==== */
document.getElementById('btnPagar').onclick = async ()=>{
  if (logs) logs.textContent = ""; if (resp) resp.textContent = "";
  if (!CURRENT_PLAN){ showBanner("Escolha um plano antes de pagar.", "warn"); return; }
  const cents = Number(CURRENT_PLAN.price_cents || 0);
  if (!cents || cents<=0){ showBanner("Este plano não requer pagamento.", "warn"); return; }

  try{
    // tokenizar SEMPRE que for pagar
    const [mm,yyyy] = ($('#cardExp').value||"").split("/");
    const payloadToken = {
      card_number: digitsOnly($('#cardNumber').value),
      expiration_month: Number((mm||"").padStart(2,"0")),
      expiration_year: Number(yyyy),
      security_code: $('#cardCVV').value.trim(),
      cardholder: { name: $('#cardholder').value.trim(), identification: { type: "CPF", number: digitsOnly($('#payerCPF').value) } }
    };
    const tokRes = await fetch("https://api.mercadopago.com/v1/card_tokens?public_key=" + encodeURIComponent(CFG.MP_PUBLIC_KEY), {
      method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payloadToken)
    });
    const tokTxt = await tokRes.text(); let token=null; try{ token = tokTxt?JSON.parse(tokTxt):null; }catch{ token={raw:tokTxt}; }
    if (!tokRes.ok || !token?.id){ showResp({ status: tokRes.status, data: token }); showBanner("Falha ao tokenizar cartão.", "err"); return; }
    LAST_CARD_TOKEN = token.id; LAST_TOKEN_TS = Date.now();

    const { data: { session } } = await sb.auth.getSession();
    if (!session){ showBanner("Faça login antes de pagar.", "warn"); return; }
    const isRecurring = document.getElementById('recorrente').checked;

    // helper: chama assinatura com auto-retry de token 1x
    const trySubscription = async (cardToken) => {
      const bodyBase = {
        plan_key: CURRENT_PLAN.plan_key,
        card_token: cardToken,
        payer: { email: $('#payerEmail').value.trim(), cpf: $('#payerCPF').value.trim(), name: $('#cardholder').value.trim() },
        recur: { frequency: CURRENT_PLAN.interval_length || 1, frequency_type: "months" }
      };
      const r = await fetch(`${FUNCTIONS_URL}/mercado-pago-subscription`, {
        method:"POST", headers: buildHeaders(session.access_token), body: JSON.stringify(bodyBase)
      });
      const t = await r.text(); let j=null; try{ j=JSON.parse(t)}catch{ j={raw:t} };
      return { ok: r.ok, status: r.status, data: j };
    };

    if (isRecurring) {
      // 1) checa “idade” do token
      const age = (Date.now() - LAST_TOKEN_TS)/1000;
      if (age > 60) {
        showBanner("Token antigo, gerando novamente…", "warn");
        // re-tokeniza:
        const tokRes2 = await fetch("https://api.mercadopago.com/v1/card_tokens?public_key=" + encodeURIComponent(CFG.MP_PUBLIC_KEY), {
          method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payloadToken)
        });
        const tokTxt2 = await tokRes2.text(); let token2=null; try{ token2 = tokTxt2?JSON.parse(tokTxt2):null; }catch{ token2={raw:tokTxt2}; }
        if (!tokRes2.ok || !token2?.id){ showResp({ status: tokRes2.status, data: token2 }); showBanner("Falha ao tokenizar novamente.", "err"); return; }
        LAST_CARD_TOKEN = token2.id; LAST_TOKEN_TS = Date.now();
      }

      // 2) diagnostica o token AGORA
      const diag = await inspectToken(LAST_CARD_TOKEN);
      if (diag?.data?.status === 404 || diag?.data?.token_lookup?.message?.includes("could not get")) {
        // token invisível pro backend: re-tokeniza UMA VEZ e tenta
        showBanner("Atualizando token do cartão…", "warn");
        const tokRes3 = await fetch("https://api.mercadopago.com/v1/card_tokens?public_key=" + encodeURIComponent(CFG.MP_PUBLIC_KEY), {
          method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payloadToken)
        });
        const tokTxt3 = await tokRes3.text(); let token3=null; try{ token3 = tokTxt3?JSON.parse(tokTxt3):null; }catch{ token3={raw:tokTxt3}; }
        if (!tokRes3.ok || !token3?.id){ showResp({ status: tokRes3.status, data: token3 }); showBanner("Falha ao atualizar token.", "err"); return; }
        LAST_CARD_TOKEN = token3.id; LAST_TOKEN_TS = Date.now();
      }

      // 3) chama assinatura (pode já ser o token 3)
      const r1 = await trySubscription(LAST_CARD_TOKEN);
      showResp({ sub_try_1: r1 });
      if (r1.ok && (r1.data?.ok)) {
        showBanner("Assinatura criada com sucesso! Redirecionando…", "ok", 0);
        setTimeout(()=>{ window.location.href = "dashboard.html"; }, 1000);
      } else if ((r1.data?.status === 404 && String(r1.data?.provider?.message||'').toLowerCase().includes('card token')) ){
        // 4) fallback extremo: re-tokeniza de novo e tenta uma ÚNICA vez
        showBanner("Atualizando token e tentando novamente…", "warn");
        const tokRes4 = await fetch("https://api.mercadopago.com/v1/card_tokens?public_key=" + encodeURIComponent(CFG.MP_PUBLIC_KEY), {
          method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payloadToken)
        });
        const tokTxt4 = await tokRes4.text(); let token4=null; try{ token4 = tokTxt4?JSON.parse(tokTxt4):null; }catch{ token4={raw:tokTxt4}; }
        if (!tokRes4.ok || !token4?.id){ showResp({ status: tokRes4.status, data: token4 }); showBanner("Falha ao gerar novo token.", "err"); return; }
        LAST_CARD_TOKEN = token4.id; LAST_TOKEN_TS = Date.now();
        const r2 = await trySubscription(LAST_CARD_TOKEN);
        showResp({ sub_try_2: r2 });
        if (r2.ok && (r2.data?.ok)) {
          showBanner("Assinatura criada com sucesso! Redirecionando…", "ok", 0);
          setTimeout(()=>{ window.location.href = "dashboard.html"; }, 1000);
        } else {
          showBanner("Não foi possível criar a assinatura.", "err");
        }
      } else {
        // outro erro qualquer
        showBanner("Não foi possível criar a assinatura.", "err");
      }
    } else {
      // pagamento 1x (sem mudanças)
      const body = {
        mode: "card",
        plan_key: CURRENT_PLAN.plan_key,
        amount_cents: cents,
        card_token: LAST_CARD_TOKEN,
        payer: { name: $('#cardholder').value.trim(), email: $('#payerEmail').value.trim(), cpf: $('#payerCPF').value.trim() },
        installments: Number($('#installments').value || 1),
        payment_method_id: detectBrand($('#cardNumber').value)
      };
      const r = await fetch(`${FUNCTIONS_URL}/${CFG.EDGE_FUNCTION_NAME}`, {
        method:"POST", headers: buildHeaders((await sb.auth.getSession()).data.session.access_token), body: JSON.stringify(body)
      });
      const t = await r.text(); let j=null; try{ j=JSON.parse(t)}catch{ j={raw:t} };
      showResp({ status:r.status, data:j });
      if (r.ok && (j?.data?.ok || j?.ok)) {
        showBanner("Pagamento concluído com sucesso! Redirecionando…", "ok", 0);
        setTimeout(()=>{ window.location.href = "dashboard.html"; }, 1000);
      } else {
        showBanner("Não foi possível concluir o pagamento.", "err");
      }
    }
  }catch(e){
    showResp({ name:e.name, message:e.message, stack:e.stack });
    showBanner("Erro inesperado no pagamento.", "err");
  }
};
</script>
</body>
</html>
