// supabase/functions/create-checkout/index.ts
// Edge Function: cria um checkout no PagSeguro e retorna pay_url

import { serve } from "https://deno.land/std@0.224.0/http/server.ts";
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
import { v4 as uuidv4 } from "https://esm.sh/uuid@9.0.1";

// Client com Service Role (ignora RLS)
const supabaseAdmin = createClient(
  Deno.env.get("SUPABASE_URL")!,
  Deno.env.get("SUPABASE_SERVICE_ROLE_KEY")!
);

// Config do PagSeguro (coloque em Secrets no dashboard)
const PAGSEGURO_BASE = Deno.env.get("PAGSEGURO_BASE") ?? "https://sandbox.api.pagseguro.com"; // sandbox por padrão
const PAGSEGURO_TOKEN = Deno.env.get("PAGSEGURO_TOKEN")!;

// URL do webhook
const PROJECT_REF = new URL(Deno.env.get("SUPABASE_URL")!).host.split(".supabase.co")[0];
const WEBHOOK_URL = `https://${PROJECT_REF}.functions.supabase.co/pagseguro-webhook`;

serve(async (req) => {
  try {
    if (req.method !== "POST") {
      return new Response("Method not allowed", { status: 405 });
    }

    // === Autenticação do usuário ===
    const authHeader = req.headers.get("authorization") || "";
    const accessToken = authHeader.startsWith("Bearer ") ? authHeader.slice(7) : null;
    if (!accessToken) {
      return new Response(JSON.stringify({ error: "Missing Bearer token" }), { status: 401 });
    }

    // Cliente "user" para pegar sessão do usuário
    const supabaseUser = createClient(
      Deno.env.get("SUPABASE_URL")!,
      Deno.env.get("SUPABASE_ANON_KEY")!,
      { global: { headers: { Authorization: `Bearer ${accessToken}` } } }
    );

    const { data: { user } } = await supabaseUser.auth.getUser();
    if (!user) {
      return new Response(JSON.stringify({ error: "Not authenticated" }), { status: 401 });
    }

    // === Lendo body ===
    const { plan_id } = await req.json();
    if (!plan_id) {
      return new Response(JSON.stringify({ error: "plan_id required" }), { status: 400 });
    }

    // Busca informações do plano
    const { data: plan, error: e1 } = await supabaseAdmin
      .from("billing_plans")
      .select("id, name, price_cents, plan_key")
      .eq("id", plan_id)
      .eq("active", true)
      .single();

    if (e1 || !plan) {
      return new Response(JSON.stringify({ error: "Plano inválido" }), { status: 400 });
    }

    // Gera referência única
    const reference_id = uuidv4();

    // === Monta body para PagSeguro ===
    const body = {
      reference_id,
      items: [
        {
          name: plan.name,
          quantity: 1,
          unit_amount: plan.price_cents
        }
      ],
      notification_urls: [WEBHOOK_URL],
      payment_notification_urls: [WEBHOOK_URL],
      customer: { email: user.email } // opcional, mas ajuda
    };

    // === Chama PagSeguro ===
    const psResp = await fetch(`${PAGSEGURO_BASE}/orders`, {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${PAGSEGURO_TOKEN}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify(body)
    });

    const text = await psResp.text();
    let json: any = {};
    try { json = text ? JSON.parse(text) : {}; } catch { json = { error: text }; }

    if (!psResp.ok) {
      console.error("Erro PagSeguro:", json);
      return new Response(JSON.stringify({
        error: "Falha ao criar pedido no PagSeguro",
        provider_status: psResp.status,
        provider_body: json
      }), { status: 502 });
    }

    // O pay_url pode estar em "links" ou dentro de "charges"
    const pay_url =
      json?.links?.find?.((l: any) => l.rel === "PAY")?.href ||
      json?.charges?.[0]?.links?.find?.((l: any) => l.rel === "PAY")?.href ||
      json?.links?.[0]?.href;

    if (!pay_url) {
      return new Response(JSON.stringify({
        error: "Checkout criado mas não encontrei pay_url",
        provider_body: json
      }), { status: 500 });
    }

    // (opcional) salva checkout_sessions no Supabase
    await supabaseAdmin.from("checkout_sessions").insert({
      user_id: user.id,
      plan_id: plan.id,
      plan_key: plan.plan_key,
      reference_id,
      pay_url,
      status: "created"
    });

    return new Response(JSON.stringify({ pay_url, reference_id }), { status: 200 });

  } catch (err) {
    console.error("Erro create-checkout:", err);
    return new Response(JSON.stringify({ error: err?.message || String(err) }), { status: 500 });
  }
});
