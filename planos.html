<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Planos</title>

<script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<script src="https://unpkg.com/imask"></script>
<script src="/config.js?v=1"></script>

<style>
  :root{color-scheme:dark}
  body{background:#121212;color:#fff;font-family:Arial,sans-serif;margin:0;padding:24px}
  a{color:#00b140}
  .container{max-width:980px;margin:0 auto}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;margin-bottom:12px}
  h1{margin:0;color:#00b140}

  .vigencia-bar{margin:6px auto 18px;background:#0f0f0f;border:1px solid #2a2a2a;border-radius:12px;
    padding:10px 14px;display:flex;align-items:center;justify-content:space-between;gap:10px}
  .vigencia-bar .left{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .vigencia-title{font-weight:700}
  .vigencia-info{color:#cfe8ff}
  .vigencia-warn{color:#ffc966}
  .vigencia-mute{color:#9aa0a6}

  .grid{display:grid;gap:16px;grid-template-columns:repeat(4,1fr)}
  @media(max-width:980px){.grid{grid-template-columns:repeat(2,1fr)}}
  @media(max-width:560px){.grid{grid-template-columns:1fr}}
  .card{background:#0f0f0f;border:1px solid #2a2a2a;border-radius:14px;padding:16px}
  .muted{color:#9aa0a6;font-size:13px}
  .price{font-size:26px;font-weight:700}
  .btn{display:inline-flex;align-items:center;gap:8px;background:#00b140;border:none;color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer;text-decoration:none}
  .btn:hover{background:#009b38}
  .btn.ghost{background:transparent;border:1px solid #2a2a2a;color:#ddd}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .chip{font-size:12px;background:#1e1e1e;border:1px solid #333;padding:6px 10px;border-radius:999px}
  .chip.plan{color:#bfffc1;border-color:#2f5a2f;background:#132313}
  .chip.time{color:#cfe8ff;border-color:#2f435a;background:#0f1a24}
  .chip.pending{color:#ffe2bf;border-color:#5c3f00;background:#1b1300}
  .checkout{margin-top:24px;background:#0f0f0f;border:1px solid #2a2a2a;border-radius:14px;padding:18px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px}
  label{display:block;margin:4px 0 8px;color:#9aa0a6}
  input,select{width:100%;padding:12px 14px;border-radius:10px;border:1px solid #2a2a2a;background:#1a1a1a;color:#fff}
  input[disabled], select[disabled]{background:#171717;border-color:#2a2a2a;color:#b5b5b5}
  .stack{display:flex;gap:8px;flex-wrap:wrap}
  .badge{font-size:12px;border:1px solid #2a3350;background:#0e1322;padding:4px 8px;border-radius:999px}
  .ok{color:#6ef06e}
  .sep{height:1px;background:#2a2a2a;margin:18px 0}
  .banner{border:1px solid #2a2a2a;border-radius:10px;padding:10px 12px;margin-bottom:14px;background:#111;display:none}
  .banner.warn{border-color:#5c3f00;background:#1b1300;color:#ffc966;display:block}
  .banner.ok{border-color:#214d21;background:#0e1a0e;color:#b7fbb7;display:block}
  .banner.err{border-color:#5c1e1e;background:#190d0d;color:#ff9a9a;display:block}
  .diag-only{display:none} body.show-diag .diag-only{display:block}
  .log{white-space:pre-wrap;background:#0b0f1a;border:1px solid #1b2133;padding:12px;border-radius:8px;min-height:120px;max-height:320px;overflow:auto}
  small.mono{font-family:ui-monospace,Consolas,monospace;opacity:.85}
  #btnDiag{position:fixed;right:16px;bottom:16px;z-index:9999;width:38px;height:38px;border-radius:999px;border:1px solid #2a2a2a;background:#131313;color:#bdbdbd;opacity:.5;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:18px}
  #btnDiag:hover{opacity:.9}
</style>
</head>
<body>
<header class="container">
  <h1>Planos</h1>
  <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
    <span id="planChip" class="chip plan">Plano: —</span>
    <span id="timeChip" class="chip time" style="display:none"></span>
    <span id="pendingChip" class="chip pending" style="display:none"></span>
    <a class="btn ghost" href="dashboard.html">← Voltar</a>
    <a class="btn ghost" href="meusdados.html">Meus dados</a>
    <button id="btnSair" class="btn">Sair</button>
  </div>
</header>

<div class="container vigencia-bar" id="vigenciaBar" style="display:none">
  <div class="left">
    <span class="vigencia-title">Vigência:</span>
    <span id="vigenciaTexto" class="vigencia-info">—</span>
  </div>
  <div class="right">
    <span id="vigenciaObs" class="vigencia-mute"></span>
  </div>
</div>

<main class="container">
  <section id="cards" class="grid"></section>

  <section id="checkout" class="checkout" style="display:none">
    <div id="banner" class="banner"></div>

    <div class="stack" style="justify-content:space-between;align-items:center">
      <div>
        <div><b>Plano:</b> <span id="planoNome">—</span> • <b>Valor:</b> R$ <span id="planoValor">—</span></div>
        <div><b>Conta:</b> <span id="contaEmail">—</span></div>
        <div class="muted" id="vigenciaInfo" style="margin-top:6px;display:none"></div>
        <div class="muted" id="prorataInfo" style="margin-top:6px;display:none"></div>
      </div>
      <div class="stack" id="badges"></div>
    </div>

    <div class="sep"></div>

    <div class="stack" style="align-items:center;margin-bottom:8px">
      <input id="recorrente" type="checkbox" />
      <label for="recorrente" style="margin:0">Cobrança recorrente (assinatura)</label>
    </div>

    <div class="row">
      <div>
        <label>Nome impresso no cartão</label>
        <input id="cardholder" value="APRO" disabled />
      </div>
      <div>
        <label>E-mail do pagador</label>
        <input id="payerEmail" value="comprador@test.com" disabled />
      </div>
    </div>

    <div class="row">
      <div>
        <label>CPF</label>
        <input id="payerCPF" value="19119119100" disabled />
      </div>
      <div>
        <label>Parcelas</label>
        <select id="installments" disabled>
          <option value="1" selected>1x</option>
          <option value="2">2x</option>
          <option value="3">3x</option>
        </select>
      </div>
    </div>

    <div class="row-3">
      <div>
        <label>Número do cartão (teste aprovado)</label>
        <input id="cardNumber" value="5031 4332 1540 6351" disabled />
      </div>
      <div>
        <label>Validade (MM/AAAA)</label>
        <input id="cardExp" value="11/2029" disabled />
      </div>
      <div>
        <label>CVV</label>
        <input id="cardCVV" value="123" disabled />
      </div>
    </div>

    <div class="sep"></div>
    <div class="stack" style="justify-content:space-between;align-items:center">
      <div class="stack">
        <button id="btnUnlock" class="btn">Desbloquear campos</button>
      </div>
      <button id="btnPagar" class="btn" disabled>Pagar</button>
    </div>

    <div class="diag-only">
      <div class="sep"></div><h3>Logs</h3><div id="logs" class="log"></div>
      <div class="sep"></div><h3>Resposta</h3><div id="resp" class="log"></div>
    </div>
  </section>
</main>

<button id="btnDiag" title="Modo diagnóstico (mostrar/ocultar)">⚙︎</button>

<script>
const CFG = window.CONFIG||{};
let FUNCTIONS_URL = CFG.FUNCTIONS_URL;
if (!FUNCTIONS_URL) { try { const ref = new URL(CFG.SUPABASE_URL).host.split(".")[0]; FUNCTIONS_URL = `https://${ref}.functions.supabase.co`; } catch {} }
const sb = supabase.createClient(CFG.SUPABASE_URL, CFG.SUPABASE_ANON_KEY, {auth:{persistSession:true,autoRefreshToken:true,detectSessionInUrl:true}});

const $ = s=>document.querySelector(s);
const planChip=$('#planChip'), timeChip=$('#timeChip'), pendingChip=$('#pendingChip');
const cardsEl=$('#cards'); const checkoutEl=$('#checkout'), banner=$('#banner'), logs=$('#logs'), resp=$('#resp');
const vigenciaBar=$('#vigenciaBar'), vigenciaTexto=$('#vigenciaTexto'), vigenciaObs=$('#vigenciaObs');
const vigenciaInfo=$('#vigenciaInfo'), prorataInfo=$('#prorataInfo');

function moneyBRL(cents){return (Number(cents||0)/100).toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}
function label(k){return (CFG.PLAN_LABELS||{})[k]||k.charAt(0).toUpperCase()+k.slice(1)}
function showBanner(text,type='ok',ms=4200){ banner.textContent=text; banner.className='banner '+(type==='warn'?'warn':type==='err'?'err':'ok'); banner.style.display='block'; if(ms>0) setTimeout(()=>banner.style.display='none',ms); }
function fmtDate(d){try{const dt=new Date(d);return dt.toLocaleDateString('pt-BR')}catch{return'—'}}
function daysLeft(expiresAt){ if(!expiresAt) return 0; const now=new Date(); const end=new Date(expiresAt); const diff=Math.ceil((end-now)/86400000); return diff>0?diff:0; }

IMask($('#cardExp'), { mask:'00/0000' }); IMask($('#cardNumber'), { mask:'0000 0000 0000 0000' }); IMask($('#cardCVV'), { mask:'000[0]' });

let user=null, currentPlanKey='trial', plans=[];
let PLAN_EXPIRES_AT=null, PENDING_PLAN=null;
let CURRENT_PLAN=null, QUOTE=null;

document.getElementById('btnSair').onclick=async()=>{ await sb.auth.signOut(); location.href=CFG.SITE_URL||'index.html'; };
document.getElementById('btnDiag').onclick=()=>{ document.body.classList.toggle('show-diag'); };
document.getElementById('btnUnlock').onclick=()=>{ for(const id of ["cardholder","payerEmail","payerCPF","installments","cardNumber","cardExp","cardCVV"]) document.getElementById(id).disabled=false; showBanner('Campos desbloqueados.','ok'); };

function updateVigenciaUI(){
  planChip.textContent = `Plano: ${label(currentPlanKey)}`;
  const dleft=daysLeft(PLAN_EXPIRES_AT);
  if(dleft>0){ timeChip.style.display='inline-block'; timeChip.textContent=`Faltam ${dleft} dia${dleft>1?'s':''} • até ${fmtDate(PLAN_EXPIRES_AT)}`; }
  else{ timeChip.style.display='none'; }
  if(PENDING_PLAN){ pendingChip.style.display='inline-block'; pendingChip.textContent=`Downgrade agendado: ${label(PENDING_PLAN)} (após a vigência)`; }
  else{ pendingChip.style.display='none'; }

  if(PLAN_EXPIRES_AT){
    vigenciaBar.style.display='flex';
    vigenciaTexto.textContent=`até ${fmtDate(PLAN_EXPIRES_AT)} • faltam ${dleft} dia${dleft>1?'s':''}`;
    vigenciaObs.textContent=PENDING_PLAN?`Downgrade agendado para ${label(PENDING_PLAN)}.`:'';
    vigenciaObs.className=PENDING_PLAN?'vigencia-warn':'vigencia-mute';
  }else{
    vigenciaBar.style.display='flex';
    vigenciaTexto.textContent='sem vigência ativa';
    vigenciaObs.textContent='Selecione um plano pago para iniciar a vigência.';
    vigenciaObs.className='vigencia-mute';
  }
}

async function reloadProfile(){
  const prof=await sb.from('profiles').select('plan, plan_expires_at, pending_plan').maybeSingle();
  if(prof.error) { console.warn(prof.error); return; }
  currentPlanKey=prof.data?.plan||'trial';
  PLAN_EXPIRES_AT=prof.data?.plan_expires_at||null;
  PENDING_PLAN=prof.data?.pending_plan||null;
  updateVigenciaUI();
}

(async function init(){
  const {data:{session}}=await sb.auth.getSession(); if(!session){ location.href=CFG.SITE_URL||'index.html'; return; }
  user=session.user;
  await reloadProfile();

  const bp=await sb.from('billing_plans').select('id,name,plan_key,price_cents,interval_unit,interval_length,active,sort_order').eq('active',true).order('sort_order',{ascending:true});
  plans=bp.data||[];
  renderCards();

  $('#contaEmail').textContent=user.email||'—';
  $('#payerEmail').value=user.email||'';
})();

function renderCards(){
  cardsEl.innerHTML='';
  const order=['trial','basico','intermediario','premium'];
  for(const key of order){
    const p=plans.find(x=>String(x.plan_key).toLowerCase()===key); if(!p) continue;
    const el=document.createElement('div'); el.className='card';
    el.innerHTML=`<h3>${p.name||label(key)}</h3>
      <div class="price">${moneyBRL(p.price_cents||0)}</div>
      <div class="muted">Cobrança: ${p.interval_length||1}× / ${p.interval_unit||'month'}</div>
      <div class="muted">${key==='trial'?'Plano gratuito para conhecer a plataforma.':'Acesso aos recursos do plano selecionado.'}</div>`;
    const isCurrent=(key===String(currentPlanKey).toLowerCase());
    const btn=document.createElement('button');
    btn.className=isCurrent?'btn ghost':'btn';
    btn.textContent=isCurrent?'Plano atual':'Escolher';
    btn.disabled=isCurrent;
    btn.onclick=()=>openCheckout(p);
    el.appendChild(btn);
    cardsEl.appendChild(el);
  }
}

async function openCheckout(plan){
  CURRENT_PLAN=plan;
  QUOTE=null;
  $('#planoNome').textContent=plan?.name||plan?.plan_key||'—';
  $('#planoValor').textContent=(Number(plan?.price_cents||0)/100).toFixed(2);

  // Quote pró-rata
  const q = await sb.rpc('quote_plan_change', { p_user_id: user.id, p_new_plan: plan.plan_key });
  if(q.error){ showBanner('Erro ao calcular pró-rata.','err',6000); console.error(q.error); return; }
  QUOTE = q.data;

  const dleft=daysLeft(PLAN_EXPIRES_AT);
  if(dleft>0){
    vigenciaInfo.style.display='block';
    vigenciaInfo.textContent=`Vigência atual: faltam ${dleft} dia${dleft>1?'s':''} • até ${fmtDate(PLAN_EXPIRES_AT)}.`;
  }else{
    vigenciaInfo.style.display='none';
  }

  // Mostrar pró-rata
  prorataInfo.style.display='block';
  if(QUOTE.action==='upgrade_now'){
    const cred = moneyBRL(QUOTE.credit_cents||0);
    const price = moneyBRL(QUOTE.new_price_cents||0);
    const due = moneyBRL(QUOTE.amount_due_cents||0);
    prorataInfo.textContent = `Upgrade imediato: preço do novo plano ${price} − crédito pró-rata ${cred} = total a pagar ${due}. Nova vigência: ${fmtDate(QUOTE.effective_from)} até ${fmtDate(QUOTE.new_expires_at)}.`;
    document.getElementById('btnPagar').disabled = (Number(QUOTE.amount_due_cents||0)===0);
    if(Number(QUOTE.amount_due_cents||0)===0){
      showBanner('Sem cobrança: aplicando troca agora…','ok',2500);
      // aplica direto sem pagar
      const ap = await sb.rpc('apply_plan_change_after_payment', { p_user_id: user.id, p_new_plan: plan.plan_key });
      if(ap.error){ showBanner('Falha ao aplicar troca.','err'); return; }
      await reloadProfile();
      showBanner('Plano alterado com sucesso.','ok');
      renderCards();
      return;
    }
  }else if(QUOTE.action==='schedule_downgrade'){
    prorataInfo.textContent = `Downgrade agendado para ${fmtDate(QUOTE.effective_from)}. Você manterá o plano atual até o fim da vigência. A partir dessa data, inicia 1 ciclo do novo plano.`;
    document.getElementById('btnPagar').disabled = true;
    // aplica o agendamento agora (sem pagamento)
    const ap = await sb.rpc('apply_plan_change_after_payment', { p_user_id: user.id, p_new_plan: plan.plan_key });
    if(ap.error){ showBanner('Falha ao agendar downgrade.','err'); return; }
    await reloadProfile(); renderCards();
    showBanner('Downgrade agendado com sucesso.','ok');
  }else{
    prorataInfo.textContent = `Nenhuma alteração necessária.`;
    document.getElementById('btnPagar').disabled = true;
  }

  checkoutEl.style.display='block';
  checkoutEl.scrollIntoView({behavior:'smooth',block:'start'});
}

// ====== Pagamento (apenas quando upgrade_now com amount_due_cents > 0) ======
function digitsOnly(s){return (s||'').replace(/\D+/g,"");}
function detectBrand(num){const n=digitsOnly(num); if(n.startsWith('4'))return'visa'; if(n.startsWith('5'))return'master'; if(n.startsWith('34')||n.startsWith('37'))return'amex';}
document.getElementById('btnPagar').onclick = async ()=>{
  if(!CURRENT_PLAN||!QUOTE||QUOTE.action!=='upgrade_now'){ showBanner('Nada a pagar.','warn'); return; }
  const amountCents = Number(QUOTE.amount_due_cents||0);
  if(amountCents<=0){ showBanner('Nada a pagar.','warn'); return; }

  try{
    const [mm,yyyy]=($('#cardExp').value||"").split("/");
    const payloadToken={
      card_number:digitsOnly($('#cardNumber').value),
      expiration_month:Number((mm||"").padStart(2,"0")),
      expiration_year:Number(yyyy),
      security_code:$('#cardCVV').value.trim(),
      cardholder:{ name:$('#cardholder').value.trim(), identification:{ type:"CPF", number:digitsOnly($('#payerCPF').value) } }
    };
    const tokRes=await fetch("https://api.mercadopago.com/v1/card_tokens?public_key="+encodeURIComponent(CFG.MP_PUBLIC_KEY),{
      method:"POST",headers:{ "Content-Type":"application/json" },body:JSON.stringify(payloadToken)
    });
    const tok=await tokRes.json();
    if(!tokRes.ok || !tok?.id){ showBanner('Falha ao tokenizar cartão.','err'); return; }

    const { data:{ session } } = await sb.auth.getSession();
    const body={
      mode:"card",
      plan_key:CURRENT_PLAN.plan_key,
      amount_cents:amountCents,  // <<< cobrando apenas a DIFERENÇA
      card_token:tok.id,
      payer:{ name:$('#cardholder').value.trim(), email:$('#payerEmail').value.trim(), cpf:$('#payerCPF').value.trim() },
      installments:Number($('#installments').value||1),
      payment_method_id:detectBrand($('#cardNumber').value)
    };
    const r=await fetch(`${FUNCTIONS_URL}/${CFG.EDGE_FUNCTION_NAME}`,{
      method:"POST", headers:{
        "Content-Type":"application/json",
        "Authorization":"Bearer "+session.access_token,
        "apikey":CFG.SUPABASE_ANON_KEY
      }, body:JSON.stringify(body)
    });
    const j=await r.json();
    if(!(r.ok && (j?.data?.ok||j?.ok))){ showBanner('Pagamento não aprovado.','err'); return; }

    // aplica a troca agora (upgrade_now)
    const ap = await sb.rpc('apply_plan_change_after_payment', { p_user_id: user.id, p_new_plan: CURRENT_PLAN.plan_key });
    if(ap.error){ showBanner('Falha ao aplicar troca após pagamento.','err'); return; }
    await reloadProfile(); renderCards();
    showBanner('Plano alterado com sucesso!','ok',4000);
  }catch(e){
    console.error(e);
    showBanner('Erro inesperado no pagamento.','err');
  }
};
</script>
</body>
</html>
