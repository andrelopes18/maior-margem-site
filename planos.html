<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Planos - MaiorMargem</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Config com SUPABASE_URL e SUPABASE_ANON_KEY -->
  <script src="config.js"></script>
  <!-- supabase-js v2 -->
  <script type="module" src="https://esm.sh/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --bg: #0b1220;
      --card: #111827;
      --muted: #94a3b8;
      --text: #e5e7eb;
      --primary: #22c55e;
      --primary-weak: rgba(34,197,94,.15);
      --ring: rgba(255,255,255,.08);
    }
    body {
      margin:0; padding:32px;
      font-family: Inter, system-ui, sans-serif;
      background: radial-gradient(1200px 800px at 20% -10%, #0b1530 0%, var(--bg) 60%);
      color: var(--text);
    }
    .wrap { max-width: 1100px; margin: 0 auto; }
    header { display:flex; justify-content:space-between; align-items:center; margin-bottom:24px; }
    .brand { font-weight:800; font-size:18px; }
    .user { font-size:12px; color:var(--muted); padding:6px 12px; border-radius:999px; background:rgba(255,255,255,.05); border:1px solid var(--ring); }
    h1 { margin:8px 0 4px; font-size:28px; }
    p.lead { margin:0 0 24px; color:var(--muted); }

    .grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:18px; }
    .card { background:var(--card); border:1px solid var(--ring); border-radius:16px; padding:18px; display:flex; flex-direction:column; gap:12px; position:relative; }
    .tag { font-size:11px; background:var(--primary-weak); color:#72f3a5; border:1px solid rgba(34,197,94,.35); padding:4px 8px; border-radius:999px; font-weight:700; }
    .title { font-weight:800; font-size:18px; }
    .price { font-size:24px; font-weight:900; }
    .per { font-size:12px; color:var(--muted); }
    .btn { cursor:pointer; padding:10px 14px; border:0; border-radius:12px; font-weight:800; background:linear-gradient(180deg,#27d17f 0%,#1fb766 100%); color:#0b1220; }
    .btn:disabled { opacity:.6; cursor:not-allowed; background:#333; color:#999; }
    .current-pill { position:absolute; top:12px; right:12px; font-size:11px; padding:4px 8px; border-radius:999px; background:rgba(16,185,129,.15); border:1px solid rgba(16,185,129,.35); color:#a7f3d0; font-weight:800; }
    .panel { background:rgba(255,255,255,.03); border:1px solid var(--ring); border-radius:12px; padding:12px; margin-bottom:20px; }
    .mono { font-family:monospace; font-size:12px; color:#9acdff; white-space:pre-wrap; }
    .err { color:#fecaca; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">MaiorMargem • Planos</div>
      <div id="userTag" class="user">Carregando…</div>
    </header>

    <h1>Escolha seu plano</h1>
    <p class="lead">Clique em “Assinar” para iniciar o pagamento via PagBank. Após o pagamento, você será redirecionado para <code>retorno.html</code>.</p>

    <div class="panel">
      <div><b>Plano atual:</b> <span id="currentPlan">—</span> • <b>Status:</b> <span id="currentStatus">—</span></div>
      <div id="log" class="mono"></div>
    </div>

    <div class="grid">
      <div class="card" data-plan="trial">
        <div class="current-pill" hidden>SEU PLANO</div>
        <div class="tag">Início</div>
        <div class="title">Trial</div>
        <div class="price">R$ 0<span class="per">/mês</span></div>
        <button class="btn btn-choose" data-plan="trial">Assinar Trial</button>
      </div>
      <div class="card" data-plan="basico">
        <div class="current-pill" hidden>SEU PLANO</div>
        <div class="tag">Essencial</div>
        <div class="title">Básico</div>
        <div class="price">R$ 29,90<span class="per">/mês</span></div>
        <button class="btn btn-choose" data-plan="basico">Assinar Básico</button>
      </div>
      <div class="card" data-plan="intermediario">
        <div class="current-pill" hidden>SEU PLANO</div>
        <div class="tag">Mais usado</div>
        <div class="title">Intermediário</div>
        <div class="price">R$ 69,90<span class="per">/mês</span></div>
        <button class="btn btn-choose" data-plan="intermediario">Assinar Intermediário</button>
      </div>
      <div class="card" data-plan="premium">
        <div class="current-pill" hidden>SEU PLANO</div>
        <div class="tag">Profissional</div>
        <div class="title">Premium</div>
        <div class="price">R$ 129,90<span class="per">/mês</span></div>
        <button class="btn btn-choose" data-plan="premium">Assinar Premium</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const CREATE_CHECKOUT_URL = "https://maprezivxfitqyifmepq.functions.supabase.co/create-checkout";
    const SUCCESS_URL = `${location.origin}/retorno.html`;
    const CANCEL_URL = `${location.origin}/planos.html`;

    const logBox = document.getElementById("log");
    const log = (msg, cls) => {
      const ts = new Date().toLocaleTimeString();
      const line = `[${ts}] ${msg}`;
      console[cls === "err" ? "error" : "log"](line);
      const div = document.createElement("div");
      div.textContent = line;
      if (cls) div.classList.add(cls);
      logBox.appendChild(div);
      logBox.scrollTop = logBox.scrollHeight;
    };

    if (!window.CONFIG?.SUPABASE_URL || !window.CONFIG?.SUPABASE_ANON_KEY) {
      log("✖ CONFIG ausente", "err");
      alert("CONFIG ausente: verifique config.js");
      throw new Error("CONFIG ausente");
    }

    const supabase = createClient(window.CONFIG.SUPABASE_URL, window.CONFIG.SUPABASE_ANON_KEY);
    let session, user, currentPlan, currentStatus;

    async function loadSession() {
      const { data, error } = await supabase.auth.getSession();
      if (error) { log("✖ Erro getSession: "+error.message,"err"); return; }
      if (!data.session) { log("✖ Sem sessão. Redirecionando…","err"); location.href="/index.html"; return; }
      session = data.session; user = session.user;
      document.getElementById("userTag").textContent = user.email;
      log("✓ Sessão ok");
    }

    async function loadProfile() {
      const { data, error } = await supabase.from("profiles").select("plan,subscription_status").eq("id", user.id).maybeSingle();
      if (error) { log("✖ Erro perfil: "+error.message,"err"); return; }
      currentPlan = data?.plan; currentStatus = data?.subscription_status;
      document.getElementById("currentPlan").textContent = currentPlan||"—";
      document.getElementById("currentStatus").textContent = currentStatus||"—";
      document.querySelectorAll(".card").forEach(card=>{
        const pill=card.querySelector(".current-pill");
        const plan=card.dataset.plan;
        if(plan===currentPlan){ pill.hidden=false; card.querySelector("button").disabled=true;}
        else{ pill.hidden=true; card.querySelector("button").disabled=false;}
      });
    }

    async function startCheckout(planSlug) {
      try {
        log(`• Iniciando checkout (${planSlug})`);
        const res = await fetch(CREATE_CHECKOUT_URL, {
          method:"POST",
          headers:{
            "Authorization":`Bearer ${session.access_token}`, // ESSENCIAL
            "Content-Type":"application/json"
          },
          body:JSON.stringify({ plan:planSlug, success_url:SUCCESS_URL, cancel_url:CANCEL_URL })
        });
        const data=await res.json().catch(()=>({}));
        if(!res.ok){ log(`✖ Falha checkout (${res.status}): ${data?.error||""}`,"err"); if(data?.raw) log("RAW:"+data.raw,"err"); alert("Erro ao iniciar pagamento."); return; }
        const url=data.checkout_url||data.payment_url;
        if(!url){ log("✖ Checkout sem URL","err"); alert("Checkout sem URL. Veja logs."); return; }
        location.href=url;
      } catch(e){ log("✖ Erro: "+e.message,"err"); alert("Erro inesperado."); }
    }

    function wireButtons() {
      document.querySelectorAll(".btn-choose").forEach(btn=>{
        btn.addEventListener("click",()=>{ const plan=btn.dataset.plan; startCheckout(plan); });
      });
    }

    (async()=>{
      await loadSession();
      await loadProfile();
      wireButtons();
    })();
  </script>
</body>
</html>
