<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Planos</title>
<style>
  :root { color-scheme: dark; }
  *{ box-sizing: border-box }
  body{ background:#121212; color:#fff; font-family: Arial, sans-serif; margin:0; padding:24px }
  a{ color:#00b140 }

  header{ display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; margin-bottom:18px }
  h1{ color:#00b140; margin:0 }
  .chip{ font-size:12px; background:#1e1e1e; border:1px solid #333; padding:6px 10px; border-radius:999px }
  .chip.plan{ color:#bfffc1; border-color:#2f5a2f; background:#132313 }
  .btn{ display:inline-flex; align-items:center; gap:8px; background:#00b140; color:#fff; border:none; padding:10px 14px; border-radius:10px; cursor:pointer }
  .btn:hover{ background:#009b38 }
  .btn.ghost{ background:transparent; border:1px solid #2a2a2a; color:#ddd }
  .btn.ghost:hover{ background:#1a1a1a }
  .btn.warn{ background:#6b2a2a }
  .btn.warn:hover{ background:#7a2f2f }

  .container{ max-width:980px; margin:0 auto }
  .grid{ display:grid; grid-template-columns: repeat(4, 1fr); gap:16px }
  @media (max-width: 980px){ .grid{ grid-template-columns: repeat(2, 1fr) } }
  @media (max-width: 560px){ .grid{ grid-template-columns: 1fr } }

  .card{ background:#0f0f0f; border:1px solid #2a2a2a; border-radius:16px; padding:16px; display:flex; flex-direction:column; gap:12px }
  .price{ font-size:28px; font-weight:700 }
  .per{ font-size:12px; color:#9aa0a6 }
  .muted{ color:#9aa0a6; font-size:13px }

  .banner{ border:1px solid #2a2a2a; border-radius:10px; padding:10px 12px; margin-bottom:16px; background:#111; display:none }
  .banner.ok{ border-color:#214d21; background:#0e1a0e; color:#b7fbb7; display:block }
  .banner.err{ border-color:#5c1e1e; background:#190d0d; color:#ff9a9a; display:block }
  .banner.warn{ border-color:#5c3f00; background:#1b1300; color:#ffc966; display:block }

  /* Diagn√≥stico */
  details.diag{ margin-top:18px }
  details.diag summary{ cursor:pointer; user-select:none; padding:8px 10px; background:#0f0f0f; border:1px solid #2a2a2a; border-radius:10px }
  .diag-wrap{ margin-top:10px; display:grid; grid-template-columns: 1fr; gap:8px }
  .kv{ display:flex; gap:8px; flex-wrap:wrap; font-size:13px; color:#ddd }
  .kv b{ color:#b5ffd1 }
  pre.log{ margin:0; background:#0b0b0b; border:1px solid #2a2a2a; border-radius:10px; padding:10px; max-height:260px; overflow:auto; font-size:12px; line-height:1.45 }

  .row-actions{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:flex-end; margin: 6px 0 2px }

  .sep{ height:1px; background:#262626; margin:10px 0 }
</style>
<script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<script src="./config.js"></script>
</head>
<body>
<header class="container">
  <h1>Planos</h1>
  <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap">
    <span id="planChip" class="chip plan">Plano: ‚Äî</span>
    <a href="dashboard.html" class="btn ghost">‚Üê Voltar</a>
    <a href="meusdados.html" class="btn ghost">Meus dados</a>
    <button id="btnSair" class="btn">Sair</button>
  </div>
</header>

<main class="container">
  <div id="banner" class="banner"></div>

  <section id="cards" class="grid" aria-live="polite"></section>

  <details class="diag">
    <summary>Diagn√≥stico / Logs (clique para abrir)</summary>
    <div class="diag-wrap">
      <div class="kv"><b>Usu√°rio:</b><span id="kvUser">‚Äî</span></div>
      <div class="kv"><b>Plano atual (profiles.plan):</b><span id="kvCurrentPlan">‚Äî</span></div>
      <div class="kv"><b>Edge Functions base:</b><span id="kvFnBase">‚Äî</span></div>
      <div class="row-actions">
        <button id="btnSync" class="btn ghost" title="For√ßa leitura de checkout_sessions e aplica o plano pago mais recente.">üîÑ Sincronizar agora</button>
        <button id="btnCopy" class="btn ghost">üìã Copiar logs</button>
        <button id="btnClear" class="btn ghost">üßπ Limpar logs</button>
      </div>
      <pre id="log" class="log" aria-live="polite"></pre>
    </div>
  </details>
</main>

<script>
/* ================== Setup Supabase / Config ================== */
const CFG = window.CONFIG || {};
const SUPABASE_URL = CFG.SUPABASE_URL;
const SUPABASE_ANON_KEY = CFG.SUPABASE_ANON_KEY;
if (!SUPABASE_URL || !SUPABASE_ANON_KEY) { alert('Erro: config.js n√£o carregado.'); throw new Error('CONFIG ausente'); }

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
});

/* ======================== DOM refs ========================== */
const bannerEl = document.getElementById('banner');
const cardsEl  = document.getElementById('cards');
const logEl    = document.getElementById('log');
const planChip = document.getElementById('planChip');
const kvUser   = document.getElementById('kvUser');
const kvCurrentPlan = document.getElementById('kvCurrentPlan');
const kvFnBase = document.getElementById('kvFnBase');

const btnSair  = document.getElementById('btnSair');
const btnCopy  = document.getElementById('btnCopy');
const btnClear = document.getElementById('btnClear');
const btnSync  = document.getElementById('btnSync');

/* ======================== Utils ============================= */
function brlFromCents(c){ if (typeof c !== 'number') return 'R$ 0,00'; return (c/100).toLocaleString('pt-BR',{style:'currency',currency:'BRL'}) }
function showBanner(msg, type='ok'){ bannerEl.textContent = msg; bannerEl.className = 'banner ' + (type==='err'?'err': (type==='warn'?'warn':'ok')); bannerEl.style.display='block'; }
function hideBanner(){ bannerEl.style.display='none'; bannerEl.textContent=''; }
function log(...args){
  const ts = new Date().toLocaleString('pt-BR');
  const line = `[${ts}] ` + args.map(a=>{
    if (a instanceof Error) return a.message;
    if (typeof a === 'object') try { return JSON.stringify(a, null, 2) } catch { return String(a)}
    return String(a);
  }).join(' ');
  logEl.textContent += line + "\n";
  logEl.scrollTop = logEl.scrollHeight;
}
function getFunctionsBase(){
  try{
    const u = new URL(SUPABASE_URL);
    // https://xxx.supabase.co  -> https://xxx.functions.supabase.co
    return `${u.protocol}//${u.host.replace('.supabase.co','.functions.supabase.co')}`;
  }catch{ return '(desconhecido)' }
}

/* ============= Estado global dessa p√°gina =================== */
let sessionUser = null;         // objeto de sess√£o
let currentPlanKey = 'trial';   // profiles.plan
let plansByKey = new Map();     // Map<'trial'|'basico'|'intermediario'|'premium', planRow>
let lastCheckoutKey = 'mm_last_checkout';  // guarda info da tentativa de compra p/ p√≥s-retorno

/* ===================== Sess√£o & Header ====================== */
async function ensureSession(){
  const { data: { session } } = await sb.auth.getSession();
  if (!session){ window.location.href = CFG.SITE_URL || 'index.html'; return null; }
  sessionUser = session.user;
  kvUser.textContent = `${session.user.email} (${session.user.id})`;
  kvFnBase.textContent = getFunctionsBase();
  return session;
}

async function loadCurrentPlan(){
  try{
    const { data, error } = await sb.from('profiles').select('plan').eq('id', sessionUser.id).maybeSingle();
    if (error) throw error;
    currentPlanKey = (data?.plan || 'trial').toString();
    planChip.textContent = `Plano: ${ucfirstBR(currentPlanKey)}`;
    kvCurrentPlan.textContent = currentPlanKey;
  }catch(e){
    log('Erro ao ler profiles.plan:', e);
    showBanner('Falha ao ler seu plano atual (tabela "profiles").', 'warn');
  }
}
function ucfirstBR(s){ const m = {basico:'B√°sico', intermediario:'Intermedi√°rio', premium:'Premium', trial:'Trial'}; return m[s] || (s?.charAt(0)?.toUpperCase()+s?.slice(1)); }

/* ===================== Carregar Planos ====================== */
async function loadPlans(){
  log('Carregando planos em billing_plans (active=true)‚Ä¶');
  const { data, error } = await sb
    .from('billing_plans')
    .select('id,name,price_cents,interval_unit,interval_length,active,plan_key')
    .eq('active', true)
    .order('price_cents', { ascending: true });

  if (error) { log('Erro billing_plans:', error); showBanner('Erro ao carregar planos. Verifique RLS/colunas.', 'err'); return; }
  if (!data || !data.length){ showBanner('Nenhum plano ativo encontrado em billing_plans.', 'warn'); return; }

  // Deduplicar por plan_key e manter s√≥ os 4 esperados
  const allowed = new Set(['trial','basico','intermediario','premium']);
  plansByKey.clear();
  for (const row of data){
    const k = (row.plan_key || '').toString().toLowerCase();
    if (!allowed.has(k)) continue;
    if (!plansByKey.has(k)) plansByKey.set(k, row);
  }

  renderCards();
}

/* ====================== Render Cards ======================== */
function renderCards(){
  cardsEl.innerHTML = '';
  const order = ['trial','basico','intermediario','premium'];
  for (const k of order){
    const p = plansByKey.get(k);
    if (!p) continue;

    const card = document.createElement('div');
    card.className = 'card';

    const h2 = document.createElement('h2');
    h2.textContent = p.name || ucfirstBR(k);
    card.appendChild(h2);

    const price = document.createElement('div');
    price.className = 'price';
    price.textContent = brlFromCents(p.price_cents || 0);
    card.appendChild(price);

    const per = document.createElement('div');
    per.className = 'per';
    per.textContent = `Cobran√ßa: ${p.interval_length||1}√ó / ${p.interval_unit||'month'}`;
    card.appendChild(per);

    const features = document.createElement('div');
    features.className = 'muted';
    features.innerHTML = (k==='trial')
      ? 'Plano gratuito para conhecer a plataforma.'
      : 'Acesso aos recursos do plano selecionado. Cancelamento a qualquer momento.';
    card.appendChild(features);

    const actions = document.createElement('div');
    actions.className = 'row-actions';

    // Cancelar (aparece nos pagos quando √© o plano atual)
    if (k !== 'trial' && k === currentPlanKey){
      const btnCancel = document.createElement('button');
      btnCancel.className = 'btn warn';
      btnCancel.textContent = 'Cancelar assinatura (Trial)';
      btnCancel.addEventListener('click', () => cancelSubscription());
      actions.appendChild(btnCancel);
    }

    // Chamar checkout (desativado se j√° √© o plano atual)
    const btn = document.createElement('button');
    btn.className = (k===currentPlanKey) ? 'btn ghost' : 'btn';
    btn.disabled = (k===currentPlanKey);
    btn.textContent = (k===currentPlanKey) ? 'Plano atual' : 'Assinar / Migrar';
    btn.addEventListener('click', () => startCheckout(p));
    actions.appendChild(btn);

    card.appendChild(actions);
    cardsEl.appendChild(card);
  }
}

/* =================== Iniciar Checkout ======================= */
async function getCustomerData(){
  // L√™ dados do cliente para enviar √† fun√ß√£o
  const { data, error } = await sb
    .from('profiles')
    .select('first_name,last_name,cpf_cnpj,cpf_cnpj_type,razao_social,phone,email')
    .eq('id', sessionUser.id).maybeSingle();
  if (error) throw error;
  return {
    first_name: data?.first_name || '',
    last_name : data?.last_name  || '',
    cpf_cnpj  : data?.cpf_cnpj   || '',
    cpf_cnpj_type: data?.cpf_cnpj_type || '',
    razao_social : data?.razao_social || '',
    phone        : data?.phone || '',
    email        : sessionUser.email || ''
  };
}
function ensureCustomerReady(cust){
  // Regras m√≠nimas para PagSeguro: nome e documento
  if (!cust.first_name || !cust.last_name) return 'Informe seu nome e sobrenome em "Meus dados".';
  if (!cust.cpf_cnpj) return 'Informe CPF ou CNPJ em "Meus dados".';
  if (!cust.cpf_cnpj_type) return 'Selecione o tipo (CPF/CNPJ) em "Meus dados".';
  if (cust.cpf_cnpj_type === 'cnpj' && !cust.razao_social) return 'Para CNPJ, informe a Raz√£o social em "Meus dados".';
  if (!cust.phone) return 'Informe um telefone com DDD em "Meus dados".';
  return null;
}

async function startCheckout(planRow){
  hideBanner();
  const plan_id = planRow.id;
  log('> startCheckout para', planRow);

  try{
    const customer = await getCustomerData();
    const missing = ensureCustomerReady(customer);
    if (missing){ showBanner(missing, 'warn'); log('Dados incompletos:', customer); return; }

    // Guarda tentativa para p√≥s-retorno
    localStorage.setItem(lastCheckoutKey, JSON.stringify({ when: Date.now(), plan_id }));

    // Chama a Edge Function
    log('Chamando create-checkout‚Ä¶');
    const { data, error } = await sb.functions.invoke('create-checkout', {
      body: { plan_id, user_id: sessionUser.id, customer }
    });

    if (error) {
      log('create-checkout ERRO:', error);
      showBanner('Falha ao criar checkout. Veja os logs abaixo.', 'err');
      return;
    }
    log('create-checkout OK. Resposta:', data);

    const payUrl = data?.pay_url || data?.link || data?.url;
    if (!payUrl){
      showBanner('A fun√ß√£o respondeu sem pay_url/link. Confira os logs.', 'err');
      return;
    }

    // Redireciona para o pagamento
    window.location.href = payUrl;
  }catch(e){
    log('Exce√ß√£o em startCheckout:', e);
    showBanner('Erro inesperado ao iniciar o pagamento.', 'err');
  }
}

/* ====================== P√≥s-retorno ========================= */
// Tenta aplicar plano com base na checkout_sessions paga mais recente do usu√°rio
async function tryApplyPaidPlan(){
  log('Sincronizando‚Ä¶ lendo checkout_sessions do usu√°rio');
  // Busca a √∫ltima sess√£o do usu√°rio
  const { data, error } = await sb
    .from('checkout_sessions')
    .select('id,plan_id,status,external_id,created_at')
    .eq('user_id', sessionUser.id)
    .order('created_at', { descending: true })
    .limit(1);

  if (error){ log('checkout_sessions erro:', error); showBanner('Erro ao ler checkout_sessions.', 'err'); return false; }
  if (!data || !data.length){ log('Nenhuma checkout_session encontrada.'); showBanner('Nenhuma compra encontrada para sincronizar.', 'warn'); return false; }

  const sess = data[0];
  log('√öltima sess√£o:', sess);

  const paidStatuses = new Set(['paid','authorized','settled','approved','succeeded','success']);
  if (!paidStatuses.has((sess.status||'').toLowerCase())){
    showBanner(`Aguardando confirma√ß√£o do pagamento (status atual: ${sess.status}).`, 'warn');
    return false;
  }

  // Pega o plano e aplica em profiles
  const planRow = plansByKey.get(await planKeyFromId(sess.plan_id));
  if (!planRow){
    log('Plano n√£o encontrado em cache; lendo diretamente‚Ä¶');
    const { data: one, error: e2 } = await sb.from('billing_plans')
      .select('id, name, price_cents, plan_key').eq('id', sess.plan_id).maybeSingle();
    if (e2){ log('Erro lendo billing_plans:', e2); showBanner('Erro ao ler o plano para aplicar.', 'err'); return false; }
    planRow = one;
  }

  const newKey = (planRow.plan_key||'').toString();
  log('Aplicando plano no profiles:', { plan: newKey, plan_id: planRow.id });

  const { error: upErr } = await sb
    .from('profiles')
    .update({
      plan: newKey,
      plan_id: planRow.id,
      plan_name: planRow.name,
      plan_price_cents: planRow.price_cents,
      plan_status: 'active',
      subscription_status: 'active',
      updated_at: new Date().toISOString()
    })
    .eq('id', sessionUser.id);

  if (upErr){ log('Falha ao atualizar profiles:', upErr); showBanner('Falha ao atualizar o plano no seu cadastro.', 'err'); return false; }

  currentPlanKey = newKey;
  planChip.textContent = `Plano: ${ucfirstBR(currentPlanKey)}`;
  showBanner('Assinatura confirmada e aplicada ao seu perfil. ‚úÖ', 'ok');
  renderCards();
  return true;
}

// Mapeia id -> plan_key
async function planKeyFromId(id){
  for (const [k,v] of plansByKey.entries()) if (v.id === id) return k;
  const { data, error } = await sb.from('billing_plans').select('plan_key').eq('id', id).maybeSingle();
  if (error) { log('Erro lendo plan_key por id:', error); return 'trial'; }
  return (data?.plan_key || 'trial').toString();
}

// Dispara sincroniza√ß√£o manual (ou p√≥s-retorno)
async function syncNow(){
  hideBanner();
  log('--- SINCRONIZAR (manual) ---');

  // Tentativa opcional: chamar fun√ß√£o 'sync-subscription', se existir
  try{
    log('Tentando sb.functions.invoke("sync-subscription")‚Ä¶');
    const { data, error } = await sb.functions.invoke('sync-subscription', { body: { user_id: sessionUser.id }});
    if (error) log('sync-subscription retornou erro (pode n√£o existir):', error);
    if (data) log('sync-subscription retorno:', data);
  }catch(e){
    log('sync-subscription exce√ß√£o (ignorada se fun√ß√£o n√£o existe):', e);
  }

  // Fallback: checa checkout_sessions e aplica
  await tryApplyPaidPlan();
}

/* ============== Cancelar Assinatura (downgrade) ============= */
async function cancelSubscription(){
  if (!confirm('Confirmar cancelamento e voltar ao plano Trial?')) return;
  hideBanner();
  log('Chamando cancel-subscription‚Ä¶');

  try{
    const { data, error } = await sb.functions.invoke('cancel-subscription', {
      body: { user_id: sessionUser.id }
    });
    if (error){ log('cancel-subscription ERRO:', error); showBanner('Falha ao cancelar assinatura. Veja os logs.', 'err'); return; }
    log('cancel-subscription OK:', data);

    // Backup do downgrade direto no profiles
    const { error: upErr } = await sb
      .from('profiles')
      .update({ plan: 'trial', plan_status: 'canceled', subscription_status: 'canceled', updated_at: new Date().toISOString() })
      .eq('id', sessionUser.id);
    if (upErr){ log('Falha ao marcar Trial no profiles:', upErr); }

    currentPlanKey = 'trial';
    planChip.textContent = 'Plano: Trial';
    showBanner('Assinatura cancelada. Voc√™ est√° em Trial.', 'ok');
    renderCards();
  }catch(e){
    log('Exce√ß√£o em cancelSubscription:', e);
    showBanner('Erro inesperado ao cancelar.', 'err');
  }
}

/* ====================== UI: bot√µes diag ===================== */
btnCopy.addEventListener('click', async ()=>{
  try{ await navigator.clipboard.writeText(logEl.textContent); showBanner('Logs copiados para a √°rea de transfer√™ncia.', 'ok'); }catch{}
});
btnClear.addEventListener('click', ()=>{ logEl.textContent=''; });
btnSync.addEventListener('click', ()=>{ syncNow(); });

btnSair.addEventListener('click', async ()=>{
  try{ await sb.auth.signOut(); }catch{}
  window.location.href = CFG.SITE_URL || 'index.html';
});

/* ========================= INIT ============================= */
(async function init(){
  const session = await ensureSession(); if (!session) return;

  await loadCurrentPlan();
  await loadPlans();

  // Se voltou do provedor, tenta sincronizar automaticamente
  const sp = new URLSearchParams(location.search);
  const hintedReturn = sp.has('success') || sp.has('paid') || sp.get('status')==='success';
  const last = JSON.parse(localStorage.getItem(lastCheckoutKey) || 'null');
  if (hintedReturn || last){
    log('P√≥s-retorno detectado. Iniciando sincroniza√ß√£o autom√°tica‚Ä¶');
    await syncNow();
    localStorage.removeItem(lastCheckoutKey);
  }
})();
</script>
</body>
</html>
