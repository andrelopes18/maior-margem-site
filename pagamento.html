<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Pagar</title>
<style>
  :root{color-scheme:dark}body{background:#121212;color:#fff;font-family:Arial,sans-serif;margin:0;padding:24px}
  .container{max-width:860px;margin:0 auto}
  .card{background:#0f0f0f;border:1px solid #2a2a2a;border-radius:14px;padding:18px}
  .btn{display:inline-flex;align-items:center;gap:8px;background:#00b140;border:none;color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer}
  .btn:hover{background:#009b38}.muted{color:#9aa0a6}
  pre{background:#0b0b0b;border:1px solid #2a2a2a;border-radius:10px;padding:10px;max-height:300px;overflow:auto}
</style>
<script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<script src="/config.js?v=1"></script>
</head>
<body>
<main class="container">
  <h1>Pagamento</h1>
  <div class="card">
    <div id="resume" class="muted">Carregando…</div>
    <div style="display:flex;gap:10px;margin-top:12px;flex-wrap:wrap">
      <button id="btnPagar" class="btn">Pagar com Mercado Pago</button>
      <a class="btn" style="background:#333" href="planos.html">← Voltar</a>
    </div>
    <h3 style="margin:14px 0 6px">Logs</h3>
    <pre id="log"></pre>
    <h3 style="margin:14px 0 6px">Resposta HTTP (fallback)</h3>
    <pre id="raw"></pre>
  </div>
</main>

<script>
const CFG=window.CONFIG||{};
const sb = supabase.createClient(CFG.SUPABASE_URL, CFG.SUPABASE_ANON_KEY,{auth:{persistSession:true,autoRefreshToken:true,detectSessionInUrl:true}});
const planKey=new URLSearchParams(location.search).get('plan')||'basico';
const logEl=document.getElementById('log'), rawEl=document.getElementById('raw'), resumeEl=document.getElementById('resume');
function log(...a){ logEl.textContent += a.map(x=>typeof x==='object'?JSON.stringify(x,null,2):String(x)).join(' ') + "\n"; logEl.scrollTop=logEl.scrollHeight; }

let plan=null, user=null;
(async function init(){
  const {data:{session}}=await sb.auth.getSession(); if(!session){location.href=CFG.SITE_URL;return}
  user=session.user;
  const r=await sb.from('billing_plans').select('id,name,price_cents,plan_key').eq('plan_key',planKey).maybeSingle();
  if (r.error || !r.data){ resumeEl.textContent='Plano não encontrado.'; log('Erro plano:', r.error); return; }
  plan=r.data;
  resumeEl.innerHTML=`Plano: <b>${plan.name}</b> • Valor: ${(plan.price_cents/100).toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}<br>Conta: ${user.email}`;
})();

async function invokeCreate() {
  const body={ 
    plan_key: planKey, 
    user_id: (await sb.auth.getUser()).data.user.id, 
    return_url: CFG.RETURN_URL,
    srk: CFG.SERVICE_ROLE_KEY,
    mp_token: CFG.MP_ACCESS_TOKEN
  };
  const { data, error } = await sb.functions.invoke('mp-create-preference',{ body });
  if (error) { log('Erro invoke:', error); throw error; }
  return data;
}

document.getElementById('btnPagar').onclick = async () => {
  rawEl.textContent = '';
  try{
    const data = await invokeCreate();
    log('Preference criada:', data);
    const pay=data.init_point || data.sandbox_init_point || data.pay_url;
    if(!pay){ alert('Sem URL de pagamento.'); return; }
    localStorage.setItem('mm_last_preference', JSON.stringify({preference_id:data.id, plan_key:planKey, when:Date.now()}));
    location.href=pay;
  }catch(e){
    log('Falha create-preference (invoke). Tentando fetch direto…', e);
    try{
      const fnBase = CFG.SUPABASE_URL.replace('.supabase.co','.functions.supabase.co');
      const token = (await sb.auth.getSession()).data.session?.access_token || '';
      const res = await fetch(`${fnBase}/mp-create-preference`, {
        method:'POST',
        headers:{ 'Content-Type':'application/json', 'Authorization': token ? `Bearer ${token}` : undefined },
        body: JSON.stringify({ plan_key: planKey, user_id: (await sb.auth.getUser()).data.user.id, return_url: CFG.RETURN_URL, srk: CFG.SERVICE_ROLE_KEY, mp_token: CFG.MP_ACCESS_TOKEN })
      });
      const text = await res.text(); rawEl.textContent = `HTTP ${res.status} ${res.statusText}\n` + text;
    }catch(ex){ rawEl.textContent = 'Exceção no fetch direto: ' + (ex?.message||String(ex)); }
  }
};
</script>
</body>
</html>
