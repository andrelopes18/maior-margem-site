<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Pagar</title>
<style>
  :root{color-scheme:dark}body{background:#121212;color:#fff;font-family:Arial,sans-serif;margin:0;padding:24px}
  .container{max-width:760px;margin:0 auto}.card{background:#0f0f0f;border:1px solid #2a2a2a;border-radius:14px;padding:18px}
  .btn{display:inline-flex;align-items:center;gap:8px;background:#00b140;border:none;color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer}
  .btn:hover{background:#009b38}.muted{color:#9aa0a6}
</style>
<script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<script src="/config.js"></script>
</head>
<body>
<main class="container">
  <h1>Pagamento</h1>
  <div class="card">
    <div id="resume" class="muted">Carregando…</div>
    <div style="display:flex;gap:10px;margin-top:12px">
      <button id="btnPagar" class="btn">Pagar com Mercado Pago</button>
      <a class="btn" style="background:#333" href="planos.html">← Voltar</a>
    </div>
    <pre id="log" style="white-space:pre-wrap;font-size:12px;color:#bbb;margin-top:12px"></pre>
  </div>
</main>

<script>
const CFG=window.CONFIG||{};
const sb = supabase.createClient(CFG.SUPABASE_URL, CFG.SUPABASE_ANON_KEY,{auth:{persistSession:true,autoRefreshToken:true,detectSessionInUrl:true}});
const planKey=new URLSearchParams(location.search).get('plan')||'basico';
const logEl=document.getElementById('log'); const resumeEl=document.getElementById('resume');

function log(...a){logEl.textContent+=a.map(x=>typeof x==='object'?JSON.stringify(x,null,2):String(x)).join(' ')+"\n"}

let plan = null, user=null;
(async function init(){
  const {data:{session}}=await sb.auth.getSession(); if(!session){location.href=CFG.SITE_URL;return}
  user=session.user;
  const r=await sb.from('billing_plans').select('id,name,price_cents,plan_key').eq('plan_key',planKey).maybeSingle();
  plan=r.data; if(!plan){resumeEl.textContent='Plano não encontrado.';return}
  resumeEl.innerHTML=`Plano: <b>${plan.name}</b> • Valor: ${(plan.price_cents/100).toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}<br>Conta: ${user.email}`;
})();

document.getElementById('btnPagar').onclick=async()=>{
  try{
    const body={ plan_key: planKey, user_id: (await sb.auth.getUser()).data.user.id, return_url: CFG.RETURN_URL };
    const { data, error } = await sb.functions.invoke('mp-create-preference',{ body });
    if(error){ log('Erro create-preference:', error); alert('Falha ao iniciar pagamento'); return; }
    log('Preference criada:', data);
    const pay=data.init_point || data.sandbox_init_point || data.pay_url;
    if(!pay){ alert('Sem URL de pagamento na resposta.'); return; }
    // guarda para a volta
    localStorage.setItem('mm_last_preference', JSON.stringify({preference_id:data.id, plan_key:planKey, when:Date.now()}));
    location.href=pay;
  }catch(e){ log('Exceção:', e); alert('Erro inesperado');}
};
</script>
</body>
</html>
