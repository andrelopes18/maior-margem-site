<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Planos — Teste Assinaturas (link único)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --bg:#0b0f14; --card:#10161d; --muted:#7a8a9a; --text:#e6eef6; --accent:#22c55e; --border:#1f2a37; }
    *{ box-sizing:border-box } body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto}
    header{padding:16px;border-bottom:1px solid var(--border);background:#0d1218;position:sticky;top:0;z-index:10}
    h1{margin:0 0 6px;font-size:20px}.subtitle{color:var(--muted);font-size:13px}
    main{max-width:1050px;margin:20px auto;padding:0 16px 48px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;margin-top:14px}
    .row{display:flex;gap:10px}.row>*{flex:1}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    .plans{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
    .price{font-size:26px;font-weight:800;color:#d1fae5}.small{font-size:12px;color:var(--muted)}
    .kv{font-size:12px;background:#0d141a;border:1px solid var(--border);padding:6px 8px;border-radius:8px;color:#c3d4e5;display:inline-block;margin:6px 6px 0 0}
    .tag{display:inline-block;padding:2px 8px;border-radius:999px;background:#0e171f;border:1px solid var(--border);color:#9fb3c8;font-size:12px}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:10px;padding:12px 14px;border-radius:12px;border:1px solid var(--border);background:var(--accent);color:#052e16;font-weight:700;cursor:pointer;text-decoration:none}
    .btn.secondary{background:#11161c;color:var(--text)}
    pre{background:#0a0f13;border:1px solid var(--border);border-radius:12px;padding:12px;overflow:auto;max-height:420px}
    .pill{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;background:#0e171f;border:1px solid var(--border);color:#a7c0d8;font-size:12px}
    .muted{color:var(--muted);font-size:12px}
    .ok{color:#86efac}.bad{color:#fca5a5}
  </style>

  <!-- usa o mesmo config da sua outra página -->
  <script src="./config.js"></script>
</head>
<body>
  <header>
    <h1>Planos — Assinaturas (link único)</h1>
    <div class="subtitle">Todos os botões “ASSINAR” abrem o mesmo checkout de assinatura (preapproval_plan_id fixo).</div>
  </header>

  <main>
    <section class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3>Configurações</h3>
        <span class="pill" id="cfgStatus">lendo config…</span>
      </div>
      <div class="row" style="margin-top:8px">
        <div>
          <label>SUPABASE_URL</label>
          <input id="cfg_supabase_url" placeholder="https://xxxx.supabase.co">
        </div>
        <div>
          <label>SUPABASE_ANON_KEY</label>
          <input id="cfg_supabase_key" placeholder="eyJhbGciOi...">
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <div>
          <label>Checkout de assinatura (aplicado em todos os planos)</label>
          <input id="cfg_sub_link" value="https://www.mercadopago.com.br/subscriptions/checkout?preapproval_plan_id=65aa0a173adc4eb49ce3927a0211dd9c">
        </div>
        <div>
          <label>URL do botão (somente leitura)</label>
          <input id="cfg_sub_link_ro" disabled>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <button id="btn_save" class="btn secondary">Salvar config</button>
        <a id="btn_test_link" class="btn" href="#" target="_blank" rel="noopener">Abrir checkout agora</a>
      </div>
      <div class="muted" style="margin-top:6px">
        Dica: Se preferir, deixe sem Supabase e use apenas os cards de fallback. O link será o mesmo.
      </div>
    </section>

    <section class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3>Planos (<span id="plans_count">0</span>)</h3>
        <span class="pill">billing_plans</span>
      </div>
      <div id="plans" class="plans"></div>
      <div class="muted" style="margin-top:6px">Se falhar a leitura da tabela, será usado o fallback local.</div>
    </section>

    <section class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3>Logs</h3>
        <div class="row" style="max-width:420px">
          <button id="btn_clear" class="btn secondary">Limpar</button>
          <button id="btn_copy" class="btn secondary">Copiar</button>
        </div>
      </div>
      <pre id="log"></pre>
    </section>
  </main>

  <!-- Supabase UMD (para ler billing_plans e usuário, se quiser) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <script>
  (function(){
    const $ = s => document.querySelector(s);
    const logEl = $("#log");
    const log = (...a)=>{ const t=a.map(x=>typeof x==='string'?x:JSON.stringify(x,null,2)).join(" "); logEl.textContent += t+"\n"; logEl.scrollTop = logEl.scrollHeight; };
    const money = c => (c/100).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});

    const FALLBACK_PLANS = [
      { id:"trial",          plan_key:"trial",          name:"Trial",          price_cents:0,     interval_unit:"month", interval_length:1, active:true },
      { id:"basico",         plan_key:"basico",         name:"Básico",         price_cents:9900,  interval_unit:"month", interval_length:1, active:true },
      { id:"intermediario",  plan_key:"intermediario",  name:"Intermediário",  price_cents:19900, interval_unit:"month", interval_length:1, active:true },
      { id:"premium",        plan_key:"premium",        name:"Premium",        price_cents:49900, interval_unit:"month", interval_length:1, active:true }
    ];

    // ===== config via ./config.js + localStorage =====
    const CFG = window.CONFIG || {};
    function loadCfg(){
      const stored = JSON.parse(localStorage.getItem("plans_subtest_cfg") || "{}");
      const cfg = {
        SUPABASE_URL: stored.SUPABASE_URL || CFG.SUPABASE_URL || "",
        SUPABASE_ANON_KEY: stored.SUPABASE_ANON_KEY || CFG.SUPABASE_ANON_KEY || CFG.SUPABASE_ANON || "",
        SUB_LINK: stored.SUB_LINK || $("#cfg_sub_link")?.value || "https://www.mercadopago.com.br/subscriptions/checkout?preapproval_plan_id=65aa0a173adc4eb49ce3927a0211dd9c"
      };
      $("#cfg_supabase_url").value = cfg.SUPABASE_URL;
      $("#cfg_supabase_key").value = cfg.SUPABASE_ANON_KEY;
      $("#cfg_sub_link").value   = cfg.SUB_LINK;
      $("#cfg_sub_link_ro").value = cfg.SUB_LINK;
      $("#btn_test_link").href = cfg.SUB_LINK;

      const okCfg = cfg.SUPABASE_URL && cfg.SUPABASE_ANON_KEY ? "✅ Supabase configurado" : "ℹ️ Supabase não configurado (usando fallback)";
      $("#cfgStatus").textContent = okCfg;
      $("#cfgStatus").style.color = cfg.SUPABASE_URL && cfg.SUPABASE_ANON_KEY ? "#86efac" : "#facc15";
      return cfg;
    }
    function saveCfg(){
      const cfg = {
        SUPABASE_URL: $("#cfg_supabase_url").value.trim(),
        SUPABASE_ANON_KEY: $("#cfg_supabase_key").value.trim(),
        SUB_LINK: $("#cfg_sub_link").value.trim()
      };
      localStorage.setItem("plans_subtest_cfg", JSON.stringify(cfg));
      $("#cfg_sub_link_ro").value = cfg.SUB_LINK;
      $("#btn_test_link").href = cfg.SUB_LINK;
      $("#cfgStatus").textContent = (cfg.SUPABASE_URL && cfg.SUPABASE_ANON_KEY) ? "✅ Supabase configurado" : "ℹ️ Supabase não configurado (usando fallback)";
      $("#cfgStatus").style.color = (cfg.SUPABASE_URL && cfg.SUPABASE_ANON_KEY) ? "#86efac" : "#facc15";
      log("Config salva:", cfg);
      return cfg;
    }

    $("#btn_save").addEventListener("click", saveCfg);
    $("#btn_clear").addEventListener("click", ()=> logEl.textContent="");
    $("#btn_copy").addEventListener("click", async ()=>{
      await navigator.clipboard.writeText(logEl.textContent||"");
      log("Logs copiados.");
    });

    // ===== supabase opcional =====
    let sb = null;
    async function trySupabase(cfg){
      if (!cfg.SUPABASE_URL || !cfg.SUPABASE_ANON_KEY) return null;
      try{
        sb = window.supabase.createClient(cfg.SUPABASE_URL, cfg.SUPABASE_ANON_KEY);
        return sb;
      }catch(e){
        log("Falha ao criar client Supabase:", String(e));
        return null;
      }
    }

    async function loadPlansDB(){
      if (!sb) return { ok:false, rows:[] };
      try{
        const { data, error } = await sb
          .from("billing_plans")
          .select("id,plan_key,name,price_cents,interval_unit,interval_length,active")
          .eq("active", true)
          .order("price_cents", { ascending:true });
        if (error) { log("billing_plans erro:", error.message); return { ok:false, rows:[] }; }
        return { ok:true, rows:data||[] };
      }catch(e){
        log("billing_plans falhou:", String(e));
        return { ok:false, rows:[] };
      }
    }

    // ===== render =====
    function renderPlans(rows, link){
      const wrap = $("#plans"); wrap.innerHTML = ""; $("#plans_count").textContent = rows.length;
      rows.forEach(p=>{
        const div = document.createElement("div"); div.className="card";
        const price = (typeof p.price_cents === "number") ? money(p.price_cents) : "—";
        const per   = p.interval_unit==='month' ? 'mês' : (p.interval_unit||'período');
        div.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center">
            <h3>${p.name || p.plan_key}</h3><span class="tag">${p.plan_key}</span>
          </div>
          <div class="price">${price} <span class="small">/ ${p.interval_length||1} ${per}</span></div>
          <div class="kv">ID: <code>${p.id}</code></div>
          <div class="kv">Status: <span>${p.active ? 'Ativo' : 'Inativo'}</span></div>
          <div style="margin-top:10px" class="row">
            <a class="btn" href="${link}" target="_blank" rel="noopener">ASSINAR</a>
          </div>
          <div class="muted" style="margin-top:8px">Este botão abre o mesmo checkout de assinatura para todos os planos.</div>
        `;
        wrap.appendChild(div);
      });
    }

    // ===== boot =====
    (async function boot(){
      const cfg = loadCfg();
      await trySupabase(cfg);
      let rows = [];
      if (sb){
        const got = await loadPlansDB();
        if (got.ok && got.rows.length) rows = got.rows;
        else {
          log("Carregando fallback de planos…");
          rows = FALLBACK_PLANS;
        }
      } else {
        rows = FALLBACK_PLANS;
      }
      renderPlans(rows, $("#cfg_sub_link").value.trim());
      log("Página pronta. Todos os botões usarão:", $("#cfg_sub_link").value.trim());
    })();

  })();
  </script>
</body>
</html>
