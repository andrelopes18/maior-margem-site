<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MaiorMargem — Indicadores & Tendências</title>
  <style>
    :root { color-scheme: dark; }
    *{ box-sizing: border-box; }
    body { margin:0; font-family: Arial, sans-serif; background:#0a0d10; color:#fff; }
    header { display:flex; align-items:center; justify-content:space-between; gap:12px; padding:20px; flex-wrap:wrap; }
    h1 { color:#00b140; margin:0; font-size:22px; }
    .userbox { display:flex; gap:12px; align-items:center; }
    .chip { font-size:12px; background:#0e141b; border:1px solid #263241; padding:6px 10px; border-radius:999px; }
    .chip.plan { color:#bfffc1; border-color:#2f5a2f; background:#122416; }
    .btn { background:#00b140; color:#fff; border:none; padding:8px 14px; border-radius:8px; cursor:pointer; text-decoration:none; display:inline-block; }
    .btn:hover { background:#009b38; }
    .btn.ghost { background:transparent; border:1px solid #2d3b4a; }
    .btn.ghost:hover { background:#0f1620; }
    .btn-min { width:32px; padding:6px 0; text-align:center; font-weight:700; }

    main { padding:0 20px 24px; }

    .toolbar { display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin: 0 0 14px; }
    .toolbar .group { display:flex; gap:8px; align-items:center; background:#0e141b; border:1px solid #263241; padding:8px 10px; border-radius:10px; box-shadow: 0 4px 10px rgba(0,0,0,.25); }
    .toolbar input, .toolbar select { background:#0a0f14; color:#fff; border:1px solid #263241; border-radius:8px; padding:8px 10px; }
    .toolbar label { font-size:12px; color:#cfd8dc; }

    /* Combobox de sites (multiselect custom) */
    .combo { position:relative; }
    .combo-btn {
      display:flex; align-items:center; gap:8px;
      background:#0a0f14; color:#fff; border:1px solid #263241; border-radius:8px; padding:8px 10px; cursor:pointer;
      min-width:260px;
    }
    .combo-btn .tags { display:flex; gap:6px; flex-wrap:wrap; max-width:360px; overflow:hidden; }
    .combo-btn .tags .t { font-size:12px; background:#12202b; border:1px solid #2b3b4b; border-radius:999px; padding:2px 8px; }
    .combo-list {
      position:absolute; top:calc(100% + 6px); left:0; z-index:999;
      width:320px; max-height:240px; overflow:auto;
      background:#0c1218; border:1px solid #2d3b4a; border-radius:10px; padding:8px;
      box-shadow: 0 10px 26px rgba(0,0,0,.45);
      display:none;
    }
    .combo-list .row { display:flex; align-items:center; gap:8px; padding:6px 4px; border-radius:8px; cursor:pointer; }
    .combo-list .row:hover { background:#111a23; }
    .combo-list input[type="checkbox"]{ accent-color:#00b140; }
    .combo-list .row .name { flex:1; }
    .combo-actions { display:flex; gap:8px; justify-content:flex-end; margin-top:8px; }
    .muted { color:#9aa0a6; font-size:12px; }

    /* KPIs */
    .kpis { display:grid; grid-template-columns: repeat(4, minmax(220px, 1fr)); gap:14px; }
    @media (max-width:1200px){ .kpis{ grid-template-columns: repeat(2, minmax(220px, 1fr)); } }
    @media (max-width:640px){ .kpis{ grid-template-columns: 1fr; } }

    .card { background:#111823; border:1px solid #2d3b4a; border-radius:14px; padding:14px; box-shadow: 0 8px 18px rgba(0,0,0,.35); }
    .card h3 { margin:0; font-size:14px; color:#bfe3ff; font-weight:600; display:flex; align-items:center; gap:8px; }
    .kpi { display:flex; align-items:flex-end; justify-content:space-between; margin-top:8px; gap:12px; }
    .kpi .val { font-size:28px; font-weight:800; letter-spacing: .3px; }
    .spark { width:100%; height:54px; display:block; }

    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:14px; margin-top:14px; }
    @media (max-width:1200px){ .grid{ grid-template-columns: 1fr; } }

    /* Painéis */
    .panel { background:#141c27; border:1px solid #314457; border-radius:14px; box-shadow: 0 10px 22px rgba(0,0,0,.40); }
    .panel header { padding:12px 14px; border-bottom:1px solid #2b3b4b; display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .panel header h2 { margin:0; font-size:16px; color:#d5ffd5; }
    .panel .content { padding:12px 14px; }
    .panel .empty { color:#9aa0a6; font-size:13px; }

    /* Tabelas */
    .tablewrap { overflow:auto; border:1px solid #2d3b4a; border-radius:10px; }
    table { width:100%; border-collapse:separate; border-spacing:0; }
    thead th { position:sticky; top:0; background:#0c1218; z-index:1; }
    th, td { border-bottom:1px solid #243344; padding:10px; text-align:left; font-size:14px; vertical-align:top; }
    tbody tr:hover { background:#111924; }
    tbody tr:nth-child(even){ background:#0f1620; }

    .mono { font-family: ui-monospace,Consolas,monospace; }
    .price { font-weight:700; display:inline-block; }
    .price.min { color:#00d084; }
    .price.max { color:#ff5d5d; }
    .pill { font-size:12px; padding:2px 8px; border-radius:999px; border:1px solid #2d3b4a; background:#0f1620; color:#ddd; display:inline-block; }

    .status { margin:8px 0; color:#aaa; font-size:12px; }
    .err { display:none; color:#ff5d5d; margin:8px 0; font-size:13px; }

    .right { text-align:right; }
    .center { text-align:center; }

    /* Ordenação visual */
    th.sortable { cursor:pointer; user-select:none; white-space:nowrap; }
    th.sortable .arrow { display:inline-block; width:0; height:0; border-left:5px solid transparent; border-right:5px solid transparent; margin-left:6px; border-top:7px solid #7b8ca1; opacity:.7; transform:rotate(0deg); }
    th.sortable.asc  .arrow { border-top-color:#fff; transform:rotate(180deg); }
    th.sortable.desc .arrow { border-top-color:#fff; transform:rotate(0deg); }

    /* Ocultar fontes (rodapés dos relatórios) */
    .source { display:none !important; }

    /* ===== NUVEM DE PALAVRAS (nova) ===== */
    .wordcloud-wrap{
      position:relative;
      border:1px solid #2d3b4a; border-radius:12px;
      background: radial-gradient(1000px 300px at 50% 0%, rgba(0,255,200,.06), rgba(0,0,0,0));
      padding:18px; overflow:hidden;
    }
    .wordcloud{
      position:relative;
      min-height:260px;
      display:flex; flex-wrap:wrap; justify-content:center; align-content:center; gap:12px;
    }
    .wordcloud .w{
      position:relative; display:inline-block; line-height:1.1; user-select:none; cursor:pointer;
      font-weight:800; letter-spacing:.2px;
      background: linear-gradient(90deg, #00e676, #00d0ff);
      -webkit-background-clip:text; background-clip:text; color:transparent;
      filter: drop-shadow(0 6px 18px rgba(0,255,200,.20));
      text-shadow: 0 2px 8px rgba(0,0,0,.35);
      transform: translateZ(0) rotate(var(--rot, 0deg));
      animation: pop .6s ease both, drift 12s ease-in-out infinite;
      animation-delay: var(--delay, 0s);
      transition: transform .25s ease, filter .25s ease;
      border-radius:8px; padding:2px 6px;
    }
    .wordcloud .w:hover{
      transform: scale(1.08) rotate(var(--rot, 0deg));
      filter: drop-shadow(0 10px 26px rgba(0,255,200,.35));
    }
    .wordcloud .w.top1{ text-shadow: 0 4px 16px rgba(0,0,0,.45); }
    .wordcloud .w.top1::after{
      content:""; position:absolute; inset:-2px; border-radius:10px; pointer-events:none;
      box-shadow: 0 0 0 0 rgba(0,224,176,.0); animation: pulse 2.6s ease-in-out infinite;
    }
    @keyframes pulse{
      0%,100%{ box-shadow: 0 0 0 0 rgba(0,224,176,.0); }
      50%{ box-shadow: 0 0 0 8px rgba(0,224,176,.10); }
    }
    @keyframes pop{
      0%{ opacity:0; transform: scale(.85) rotate(var(--rot, 0deg)); }
      100%{ opacity:1; transform: scale(1) rotate(var(--rot, 0deg)); }
    }
    @keyframes drift{
      0%,100%{ transform: translate(0,0) rotate(var(--rot,0deg)); }
      50%{ transform: translate(var(--dx, 4px), var(--dy, -4px)) rotate(calc(var(--rot,0deg) * 1.02)); }
    }
    .tooltip{
      position:fixed; pointer-events:none; z-index:9999;
      padding:6px 8px; background:rgba(14,20,27,.96); color:#d9fff1;
      border:1px solid #2d3b4a; border-radius:8px; font-size:12px;
      display:none; box-shadow: 0 8px 22px rgba(0,0,0,.55);
    }
  
    /* ===== Brand (logo + título) ===== */
    header { position: relative; }
    .brand { display:flex; align-items:center; gap:10px; }
    .brand .mm-logo { height:36px; width:auto; display:block; }

    /* ===== Atalho central (mini gráfico → Dashboard) ===== */
    .center-shortcut { position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); }
    .ind-link{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px; text-decoration:none;
      background:#121212; border:1px solid #2a2a2a; color:#eaeaea;
      box-shadow: 0 6px 18px rgba(0,0,0,.25);
    }
    .ind-link:hover{ background:#1a1a1a; border-color:#3a3a3a; }
    .ind-link svg{ width:18px; height:18px; display:block; }


    /* ===== Dropdown do usuário (igual ao Dashboard) ===== */
    .userChipWrap { position: relative; display:inline-block; }
    .dropdown {
      position:absolute; right:0; top:calc(100% + 6px);
      display:none; min-width:180px; padding:6px;
      background:#0f0f0f; border:1px solid #2d3b4a; border-radius:10px;
      box-shadow:0 10px 30px rgba(0,0,0,.5); z-index:9999;
    }
    .userChipWrap:hover .dropdown, .userChipWrap.open .dropdown { display:block; }
    .dd-item {
      width:100%; background:transparent; border:none; color:#eee;
      text-align:left; padding:10px 12px; border-radius:8px; cursor:pointer; font-size:14px;
    }
    .dd-item:hover { background:#111a23; }

</style>
  <script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <script src="./config.js"></script>
</head>
<body>
<header>
  
<div class="brand">
  <img src="logo_maiormargem.png" alt="MaiorMargem" class="mm-logo">
  <h1>Indicadores</h1>
</div>
<div class="center-shortcut">
  <a class="ind-link" href="dashboard.html" title="Ir para o Dashboard">
    <svg viewBox="0 0 24 24" aria-hidden="true">
      <rect x="3" y="13" width="3" height="6" rx="1" fill="#2d2d2d" stroke="#3b3b3b" stroke-width="1"></rect>
      <rect x="9" y="9"  width="3" height="10" rx="1" fill="#2d2d2d" stroke="#3b3b3b" stroke-width="1"></rect>
      <rect x="15" y="5" width="3" height="14" rx="1" fill="#2d2d2d" stroke="#3b3b3b" stroke-width="1"></rect>
      <path d="M3,18 L7,14 L12,15 L17,8 L21,10" fill="none" stroke="#00d084" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"></path>
    </svg>
    <span>Dashboard</span>
  </a>
</div>

  <div class="userbox">
    <span id="planChip" class="chip plan">Plano: —</span>
    <div class="userChipWrap">
      <span id="userChip" class="chip">Usuário</span>
      <div class="dropdown" role="menu" aria-hidden="true">
        <button class="dd-item" id="ddMeusDados" type="button">Meus dados</button>
        <button class="dd-item" id="ddPlanos" type="button">Planos</button>
      </div>
    </div>
    <button id="btnSair" class="btn" type="button">Sair</button>
  </div>
</header>

<main>
  <!-- BARRA DE CONTROLES -->
  <div class="toolbar">
    <div class="group">
      <label for="dateFrom">Período:</label>
      <input id="dateFrom" type="date" />
      <span class="muted">a</span>
      <input id="dateTo" type="date" />
      <select id="quickRange">
        <option value="7">Últimos 7 dias</option>
        <option value="30" selected>Últimos 30 dias</option>
        <option value="90">Últimos 90 dias</option>
        <option value="365">Últimos 12 meses</option>
        <option value="custom">Personalizado…</option>
      </select>
    </div>

    <!-- Filtro de descrição (server-side) -->
    <div class="group">
      <label for="qOportunidades">Descrição:</label>
      <input id="qOportunidades" type="text" placeholder="Filtrar por descrição…" />
    </div>

    <!-- Combobox de sites -->
    <div class="group combo" id="comboSites">
      <button type="button" class="combo-btn" id="btnComboSites" aria-haspopup="listbox" aria-expanded="false">
        <span class="muted">Sites na comparação:</span>
        <span class="tags" id="comboTags"><span class="t">Todos</span></span>
      </button>
      <div class="combo-list" id="comboList" role="listbox" aria-multiselectable="true">
        <div class="row" data-id="__ALL__">
          <input type="checkbox" id="opt_all" checked />
          <label class="name" for="opt_all">Todos (padrão)</label>
        </div>
        <div id="comboSitesRows"></div>
        <div class="combo-actions">
          <button type="button" class="btn ghost" id="btnComboCancel">Cancelar</button>
          <button type="button" class="btn" id="btnComboApply">Aplicar</button>
        </div>
      </div>
    </div>

    <button id="btnRecarregar" class="btn" type="button">Recarregar</button>
    <div id="status" class="status"></div>
  </div>

  <!-- KPIs -->
  <section class="kpis">
    <div class="card">
      <h3>Nº de produtos monitorados</h3>
      <div class="kpi">
        <div class="val" id="kpiProdutos">—</div>
        <canvas id="sparkProdutos" class="spark" width="300" height="54" aria-hidden="true"></canvas>
      </div>
      <div class="muted">Total em <code>cadastro_produtos</code> (tendência usa a view).</div>
    </div>
    <div class="card">
      <h3>Nº de sites</h3>
      <div class="kpi">
        <div class="val" id="kpiSites">—</div>
        <canvas id="sparkSites" class="spark" width="300" height="54" aria-hidden="true"></canvas>
      </div>
      <div class="muted">Total liberado p/ você.</div>
    </div>
    <div class="card">
      <h3>Economia estimada (baseado em vendas)</h3>
      <div class="kpi">
        <div class="val" id="kpiEconomia">—</div>
      </div>
      <div class="muted">Conecte vendas para estimativa real</div>
    </div>
    <div class="card">
      <h3>Variação média de preços</h3>
      <div class="kpi">
        <div class="val" id="kpiVariacao">—</div>
        <canvas id="sparkVariacao" class="spark" width="300" height="54" aria-hidden="true"></canvas>
      </div>
      <div class="muted">Δ médio diário (amostra)</div>
    </div>
  </section>

  <!-- OPORTUNIDADES -->
  <section class="grid" style="margin-top:14px;">
    <div class="panel">
      <header>
        <h2 id="titleBaratos">Oportunidades — Eu sou o mais barato</h2>
        <div><span class="pill">Critério: <code>meu_preco &lt; menor_concorrente</code></span></div>
      </header>
      <div class="content">
        <div class="tablewrap" id="wrapBaratos">
          <table id="tblMaisBaratos">
            <thead>
              <tr>
                <th class="sortable" data-col="desc"  data-table="baratos">Descrição<span class="arrow"></span></th>
                <th class="sortable" data-col="ean"   data-table="baratos">EAN<span class="arrow"></span></th>
                <th class="right sortable" data-col="my"    data-table="baratos">Meu preço<span class="arrow"></span></th>
                <th class="right sortable" data-col="next"  data-table="baratos">Próximo acima (conc.)<span class="arrow"></span></th>
                <th class="right sortable" data-col="gap_up" data-table="baratos">Gap p/ recuperar<span class="arrow"></span></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="panel">
      <header>
        <h2 id="titleCaros">Oportunidades — Eu estou mais caro</h2>
        <div><span class="pill">Critério: <code>meu_preco &gt; menor_concorrente</code></span></div>
      </header>
      <div class="content">
        <div class="tablewrap" id="wrapCaros">
          <table id="tblMaisCaros">
            <thead>
              <tr>
                <th class="sortable" data-col="desc"  data-table="caros">Descrição<span class="arrow"></span></th>
                <th class="sortable" data-col="ean"   data-table="caros">EAN<span class="arrow"></span></th>
                <th class="right sortable" data-col="my"    data-table="caros">Meu preço<span class="arrow"></span></th>
                <th class="right sortable" data-col="minc"  data-table="caros">Menor concorrente<span class="arrow"></span></th>
                <th class="right sortable" data-col="diff"  data-table="caros">Δ (R$)<span class="arrow"></span></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <!-- Abaixo do custo + Alterações + Região -->
  <section class="grid">
    <div class="panel">
      <header><h2>Produtos abaixo do preço de custo</h2></header>
      <div class="content" id="blocoAbaixoCusto">
        <div class="empty">Para ativar, inclua <span class="pill">meu_custo</span> e <span class="pill">meu_preco</span> na view (<code>vw_precos_dinamica</code>).</div>
        <div class="tablewrap" style="margin-top:10px; display:none;" id="wrapAbaixoCusto">
          <table id="tblAbaixoCusto">
            <thead>
              <tr>
                <th class="sortable" data-col="desc" data-table="abaixo">Descrição<span class="arrow"></span></th>
                <th class="sortable" data-col="ean"  data-table="abaixo">EAN<span class="arrow"></span></th>
                <th class="right sortable" data-col="meu_custo" data-table="abaixo">Custo<span class="arrow"></span></th>
                <th class="right sortable" data-col="meu_preco" data-table="abaixo">Meu preço<span class="arrow"></span></th>
                <th class="right sortable" data-col="delta" data-table="abaixo">Δ<span class="arrow"></span></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="panel">
      <header><h2 id="titleAlt">Maiores alterações de preço</h2></header>
      <div class="content">
        <div class="tablewrap" id="wrapAlt">
          <table id="tblMaioresAlt">
            <thead>
              <tr>
                <th class="sortable" data-col="desc"  data-table="alt">Descrição<span class="arrow"></span></th>
                <th class="sortable" data-col="ean"   data-table="alt">EAN<span class="arrow"></span></th>
                <th class="sortable" data-col="site"  data-table="alt">Site<span class="arrow"></span></th>
                <th class="right sortable" data-col="prev" data-table="alt">Preço Ant.<span class="arrow"></span></th>
                <th class="right sortable" data-col="curr" data-table="alt">Preço Atual<span class="arrow"></span></th>
                <th class="right sortable" data-col="delta" data-table="alt">Δ Abs.<span class="arrow"></span></th>
                <th class="right sortable" data-col="perc"  data-table="alt">Δ %<span class="arrow"></span></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <section class="grid">
    <div class="panel">
      <header><h2>Preços por região</h2></header>
      <div class="content" id="blocoRegiao">
        <div class="empty">Inclua <span class="pill">regiao</span> na tabela <code>sites</code> (ou crie view <code>vw_preco_regiao</code>).</div>
        <canvas id="chartRegiao" width="640" height="240" style="display:none;"></canvas>
      </div>
    </div>
  </section>

  <!-- =================== RELATÓRIOS DE BUSCA (search_logs) =================== -->
  <section class="grid">
    <div class="panel">
      <header>
        <h2>Produtos mais pesquisados</h2>
        <div>
          <button id="btnAtualizarPesquisas" class="btn" type="button">Atualizar</button>
        </div>
      </header>
      <div class="content">
        <div class="tablewrap" id="wrapTopSearches">
          <table id="tblPesquisas">
            <thead>
              <tr>
                <th>EAN</th>
                <th>Descrição</th>
                <th class="right">Qtd Pesquisas</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="panel">
      <header>
        <h2>Nuvem de Palavras (pesquisas)</h2>
        <div style="display:flex; gap:10px; align-items:center;">
          <button id="btnListaPalavras" class="btn" type="button">Ver palavras em ordem</button>
          <span class="muted">máx. 30 palavras</span>
        </div>
      </header>
      <div class="content">
        <div class="wordcloud-wrap">
          <div id="wordCloud" class="wordcloud" aria-live="polite"></div>
          <div id="wcTooltip" class="tooltip" role="tooltip"></div>
        </div>
        <div id="listaPalavras" style="display:none; margin-top:16px;">
          <div class="tablewrap" id="wrapWordList">
            <table id="tblPalavras" style="width:100%;">
              <thead><tr><th>Palavra</th><th class="right">Frequência</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
        <div class="hint">Dica: clique em uma palavra para filtrar a seção “Oportunidades”.</div>
      </div>
    </div>
  </section>
  <!-- =================== FIM RELATÓRIOS =================== -->

  <div id="err" class="err"></div>
</main>

<script>
/* ========= Config / Supabase ========= */
const CFG = window.CONFIG || {};
if(!CFG.SUPABASE_URL || !CFG.SUPABASE_ANON_KEY){ alert('CONFIG ausente (config.js)'); throw new Error('CONFIG ausente'); }
const sb = supabase.createClient(CFG.SUPABASE_URL, CFG.SUPABASE_ANON_KEY, { auth:{ persistSession:true, autoRefreshToken:true, detectSessionInUrl:true }});
const VIEW = 'vw_precos_dinamica';

/* ========= Defaults de filtros ocultos ========= */
const DEFAULT_TOP_LIMIT = 100;
const DEFAULT_OUTLIER_TOL = 0.50; // filtro não-visível para outliers (±50% da mediana)
const DEFAULT_VISIBLE_ROWS = 15;  // manter 15 linhas visíveis nas Oportunidades

/* ========= Util ========= */
const NA = '---';
const planChip = document.getElementById('planChip');
const userChip = document.getElementById('userChip');
const btnSair  = document.getElementById('btnSair');
const statusEl = document.getElementById('status');
const errEl    = document.getElementById('err');
const ddMeusDados = document.getElementById('ddMeusDados');
const ddPlanos    = document.getElementById('ddPlanos');

function setStatus(t){ statusEl.textContent = t||''; }
function showErr(msg){ errEl.style.display = 'block'; errEl.textContent = msg; console.error(msg); }
function hideErr(){ errEl.style.display = 'none'; errEl.textContent = ''; }
function formatBRL(n){ try { return Number(n).toLocaleString('pt-BR', { style:'currency', currency:'BRL' }); } catch { return String(n); } }
function isFiniteNum(n){ return typeof n === 'number' && isFinite(n); }

/* ========= Controles ========= */
const dateFrom = document.getElementById('dateFrom');
const dateTo   = document.getElementById('dateTo');
const quickRange  = document.getElementById('quickRange');
document.getElementById('btnRecarregar').addEventListener('click', reloadAll);
quickRange.addEventListener('change', ()=>{
  const v = quickRange.value;
  if (v==='custom') return;
  const today = new Date();
  const from = new Date(today.getTime() - Number(v)*24*3600*1000);
  dateTo.value   = today.toISOString().slice(0,10);
  dateFrom.value = from.toISOString().slice(0,10);
});
const qOportunidades = document.getElementById('qOportunidades');

// filtro de descrição com debounce
let qDebounce = 0;
if (qOportunidades){
  qOportunidades.addEventListener('input', ()=>{
    clearTimeout(qDebounce);
    qDebounce = setTimeout(()=>{
      loadOportunidadesVsMin(true);
    }, 400);
  });
}

/* ========= Combobox state ========= */
const comboBtn   = document.getElementById('btnComboSites');
const comboList  = document.getElementById('comboList');
const comboRows  = document.getElementById('comboSitesRows');
const comboTags  = document.getElementById('comboTags');
const optAll     = document.getElementById('opt_all');

let siteMap = new Map();
let selectedSites = new Set();
let allowedSiteIds = []; // << NOVO: sites permitidos para o usuário

comboBtn.addEventListener('click', ()=>{
  const open = comboList.style.display === 'block';
  comboList.style.display = open ? 'none' : 'block';
  comboBtn.setAttribute('aria-expanded', String(!open));
});
document.getElementById('btnComboCancel').addEventListener('click', ()=>{
  comboList.style.display = 'none';
  comboBtn.setAttribute('aria-expanded','false');
});
document.getElementById('btnComboApply').addEventListener('click', async ()=>{
  comboList.style.display = 'none';
  comboBtn.setAttribute('aria-expanded','false');
  updateComboTags();
  await Promise.all([ loadOportunidadesVsMin(true), loadMaioresAlt() ]);
});
optAll.addEventListener('change', ()=>{
  if (optAll.checked){
    selectedSites.clear();
    comboRows.querySelectorAll('input[type="checkbox"]').forEach(ch=> ch.checked = false);
  }
});
document.addEventListener('click', (e)=>{
  if (!comboList.contains(e.target) && !comboBtn.contains(e.target)){
    comboList.style.display = 'none';
    comboBtn.setAttribute('aria-expanded','false');
  }
});

function updateComboTags(){
  comboTags.innerHTML = '';
  if (selectedSites.size === 0){
    comboTags.innerHTML = '<span class="t">Todos</span>';
    return;
  }
  const names = Array.from(selectedSites).map(id => siteMap.get(id) || String(id)).slice(0, 3);
  names.forEach(n=>{
    const span = document.createElement('span'); span.className='t'; span.textContent=n; comboTags.appendChild(span);
  });
  if (selectedSites.size > 3){
    const more = document.createElement('span'); more.className='t'; more.textContent = `+${selectedSites.size-3}`; comboTags.appendChild(more);
  }
}
function getSelectedSiteIds(){
  // "Todos" agora significa "todos os sites liberados ao usuário"
  if (selectedSites.size>0) return Array.from(selectedSites);
  return allowedSiteIds.slice();
}

/* ========= Dados em memória ========= */
let lastBaratos = [];
let lastCaros   = [];
let lastAlt     = [];
let lastAbaixo  = [];
let lastTopSearches = [];
let lastWordList   = [];

const sortState = {
  baratos: { key:'gap_up', dir:'desc' },
  caros:   { key:'diff',   dir:'desc' },
  alt:     { key:'perc',   dir:'desc' },
  abaixo:  { key:'delta',  dir:'asc'  }
};
const collator = new Intl.Collator('pt-BR', { sensitivity:'base', numeric:true });

/* ========= INIT ========= */
(async function init(){
  const { data:{ session } } = await sb.auth.getSession();
  if (!session){ location.href = CFG.SITE_URL || 'index.html'; return; }
  userChip.textContent = session.user?.email || 'Logado';

  try{
    const rs = await sb.from('profiles').select('plan').eq('id', session.user.id).maybeSingle();
    const raw = (rs.data?.plan ?? 'básico').toString();
    planChip.textContent = 'Plano: ' + raw.charAt(0).toUpperCase()+raw.slice(1);
  }catch{}

  await fetchAllowedSitesAndBuildCombo(); // << NOVO

  const today = new Date(); const from = new Date(today.getTime() - 30*24*3600*1000);
  dateTo.value   = today.toISOString().slice(0,10);
  dateFrom.value = from.toISOString().slice(0,10);

  bindSortingHandlers();
  installMinimizeButtons();
  await reloadAll();
})();

/* ========= SCOPE POR SITE (NOVO) ========= */
function applySiteScope(q){
  if (Array.isArray(allowedSiteIds) && allowedSiteIds.length){
    return q.in('site_id', allowedSiteIds);
  }
  return q;
}

/* ========= Sites permitidos e combo ========= */
async function fetchAllowedSitesAndBuildCombo(){
  // pega o usuário atual
  const { data:{ session } } = await sb.auth.getSession();
  const uid = session?.user?.id || '';

  // busca as permissões do usuário
  allowedSiteIds = [];
  try{
    const { data: us } = await sb.from('user_sites').select('site_id').eq('user_id', uid).order('site_id', {ascending:true});
    if (Array.isArray(us) && us.length){
      allowedSiteIds = Array.from(new Set(us.map(r => Number(r.site_id)).filter(Number.isFinite)));
    }
  }catch(e){
    console.warn('user_sites falhou:', e?.message||e);
  }

  // carrega nomes/ids dos sites liberados
  let sitesData = [];
  if (allowedSiteIds.length){
    const { data: sdata } = await sb.from('sites').select('id, nome').in('id', allowedSiteIds).order('nome', {ascending:true});
    sitesData = sdata || [];
  } else {
    // Sem permissões explícitas → mantém vazio (nenhum site)
    sitesData = [];
  }

  // preenche mapa e constrói combo
  siteMap = new Map((sitesData).map(s => [Number(s.id), s.nome || String(s.id)]));
  await buildComboFromSites(sitesData);
}

async function buildComboFromSites(data){
  comboRows.innerHTML = '';
  (data||[]).forEach(s=>{
    const row = document.createElement('div');
    row.className = 'row';
    row.dataset.id = String(s.id);
    row.innerHTML = `
      <input type="checkbox" id="site_${s.id}" />
      <label class="name" for="site_${s.id}">${(s.nome||String(s.id)).replace(/</g,'&lt;')}</label>
    `;
    const chk = row.querySelector('input');
    chk.addEventListener('change', ()=>{
      const id = Number(s.id);
      if (chk.checked){ selectedSites.add(id); optAll.checked = (selectedSites.size===0); }
      else { selectedSites.delete(id); optAll.checked = (selectedSites.size===0); }
    });
    row.addEventListener('click', (e)=>{ if (e.target.tagName !== 'INPUT') { chk.checked = !chk.checked; chk.dispatchEvent(new Event('change')); } });
    comboRows.appendChild(row);
  });

  // estado inicial = "Todos" (todos os permitidos)
  optAll.checked = true;
  selectedSites.clear();
  updateComboTags();
}

/* ========= Período ========= */
function getPeriod(){
  const f = dateFrom.value ? new Date(dateFrom.value+'T00:00:00') : null;
  const t = dateTo.value   ? new Date(dateTo.value  +'T23:59:59') : null;
  return { from: f, to: t };
}
function applyDateFilter(q){
  const {from,to} = getPeriod();
  if (from) q = q.gte('data', from.toISOString());
  if (to)   q = q.lte('data', to.toISOString());
  return q;
}

/* ========= Carregamento ========= */
async function reloadAll(){
  hideErr();
  try{
    setStatus('Carregando KPIs…');
    await loadKpis();
    setStatus('Carregando Oportunidades e Relatórios…');
    await Promise.all([
      loadOportunidadesVsMin(true),
      loadMaioresAlt(),
      loadRegiao(),
      watchAbaixoCusto(),
      loadTopSearches(),
      loadWordCloud()
    ]);
    applyVisibleHeights();
    setStatus('Pronto.');
  }catch(e){
    console.error(e);
    showErr('Falha ao carregar indicadores: '+(e.message||e));
  }
}

/* ========= KPIs ========= */
async function countRows(table){
  const { count, error } = await sb.from(table).select('*', { count:'exact', head:true });
  if (error) throw error;
  return count ?? 0;
}
async function seriesCountByDay(distinctField){
  const {from,to} = getPeriod();
  const days =  Math.max(1, Math.ceil((to - from)/(24*3600*1000)));
  const map = new Map();
  for (let i=0;i<=days;i++){
    const d = new Date(from.getTime() + i*24*3600*1000);
    map.set(d.toISOString().slice(0,10), new Set());
  }
  const { data, error } = await applyDateFilter(
    applySiteScope(
      sb.from(VIEW).select('data,'+distinctField).not(''+distinctField,'is',null).order('data',{ascending:true}).limit(5000)
    )
  );
  if (error) throw error;
  for (const r of (data||[])){
    const day = new Date(r.data).toISOString().slice(0,10);
    if (map.has(day)) map.get(day).add(r[distinctField]);
  }
  return Array.from(map.values()).map(set=>set.size);
}
/* ========= KPI Variação média (apenas itens enviados pelo usuário) ========= */
async function getUserEANs(){
  const cols = ['ean13','ean','ean_norm','nrocodbarr','codigo_barras'];
  try{
    const { data:{ session } } = await sb.auth.getSession();
    const uid = session?.user?.id || '';
    let q = sb.from('produtos_cliente').select('*');
    if (uid) q = q.eq('user_id', uid);
    const { data, error } = await q.limit(10000);
    if (error || !data) return [];
    const set = new Set();
    for (const r of data){
      const col = cols.find(c => Object.prototype.hasOwnProperty.call(r,c));
      const v = col ? (r[col] ?? '') : '';
      const digits = String(v).replace(/\D+/g,'');
      if (digits && digits.length >= 8) set.add(digits);
    }
    return Array.from(set);
  }catch(_){ return []; }
}
async function mostRecentDateChunked(eans, from, to){
  let best = null;
  const chunk = 200;
  for (let i=0;i<eans.length;i+=chunk){
    const sub = eans.slice(i,i+chunk);
    let q = sb.from(VIEW).select('data').in('ean', sub)
      .gte('data', from.toISOString()).lte('data', to.toISOString());
    q = applySiteScope(q).order('data', { ascending:false }).limit(1);
    const { data } = await q;
    if (data && data.length){
      const d = new Date(data[0].data);
      if (!best || d > best) best = d;
    }
  }
  return best;
}
async function pricesAtDateForEANs(eans, targetDate){
  const out = [];
  const chunk = 200;
  const start = new Date(targetDate.getTime() - 12*3600*1000).toISOString();
  const end   = new Date(targetDate.getTime() + 12*3600*1000).toISOString();
  for (let i=0;i<eans.length;i+=chunk){
    const sub = eans.slice(i,i+chunk);
    const { data } = await applySiteScope(
      sb.from(VIEW)
        .select('ean, site_id, preco_num, data')
        .in('ean', sub).gte('data', start).lte('data', end)
        .not('preco_num','is',null).order('data', { ascending:false }).limit(20000)
    );
    if (data) out.push(...data);
  }
  return out;
}
async function prevPricesBeforeDate(eans, from){
  const out = [];
  const chunk = 150;
  for (let i=0;i<eans.length;i+=chunk){
    const sub = eans.slice(i,i+chunk);
    const { data } = await applySiteScope(
      sb.from(VIEW)
        .select('ean, site_id, preco_num, data')
        .in('ean', sub).lt('data', from.toISOString())
        .not('preco_num','is',null).order('data', { ascending:false }).limit(20000)
    );
    if (data) out.push(...data);
  }
  const best = new Map();
  for (const r of out){
    const k = String(r.ean)+'|'+String(r.site_id);
    if (!best.has(k)) best.set(k, r);
  }
  return Array.from(best.values());
}
function computeDeltaPercentUser(recentRows, prevRows){
  const cur = new Map();
  for (const r of recentRows){
    const k = String(r.ean)+'|'+String(r.site_id);
    if (!cur.has(k)){
      const v = Number(r.preco_num);
      if (isFinite(v) && v > 0) cur.set(k, v);
    }
  }
  const deltas = [];
  for (const p of prevRows){
    const k = String(p.ean)+'|'+String(p.site_id);
    if (!cur.has(k)) continue;
    const prev = Number(p.preco_num);
    const now  = Number(cur.get(k));
    if (isFinite(prev) && isFinite(now) && prev>0 && now>0){
      deltas.push((now - prev) / prev * 100.0);
    }
  }
  const avg = deltas.length ? deltas.reduce((a,b)=>a+b,0)/deltas.length : NaN;
  return { avg, deltas };
}
async function recomputeKpiVariacaoUser(){
  try{
    const { from, to } = getPeriod();
    const eans = await getUserEANs();
    if (!eans.length){
      document.getElementById('kpiVariacao').textContent = '—';
      drawSpark(document.getElementById('sparkVariacao').getContext('2d'), []);
      return;
    }
    const most = await mostRecentDateChunked(eans, from, to);
    if (!most){
      document.getElementById('kpiVariacao').textContent = '—';
      drawSpark(document.getElementById('sparkVariacao').getContext('2d'), []);
      return;
    }
    const rec = await pricesAtDateForEANs(eans, most);
    const prv = await prevPricesBeforeDate(eans, from);
    const { avg, deltas } = computeDeltaPercentUser(rec, prv);
    if (isFinite(avg)){
      document.getElementById('kpiVariacao').textContent = (avg>=0?'+':'') + avg.toFixed(1) + '%';
      drawSpark(document.getElementById('sparkVariacao').getContext('2d'), deltas.slice(-30).map(Math.abs));
    }else{
      document.getElementById('kpiVariacao').textContent = '—';
      drawSpark(document.getElementById('sparkVariacao').getContext('2d'), []);
    }
  }catch(e){
    document.getElementById('kpiVariacao').textContent = '—';
  }
}

async function loadKpis(){
  try{
    const totalProdutos = await countRows('cadastro_produtos');
    kpiProdutos.textContent = totalProdutos.toLocaleString('pt-BR');
  }catch(e){ kpiProdutos.textContent = '—'; }

  try{
    // Agora mostra apenas a contagem de sites liberados ao usuário
    const totalSites = Array.isArray(allowedSiteIds) ? allowedSiteIds.length : 0;
    kpiSites.textContent = totalSites.toLocaleString('pt-BR');
  }catch(e){ kpiSites.textContent = '—'; }

  try{ const s1 = await seriesCountByDay('ean');     drawSpark(document.getElementById('sparkProdutos').getContext('2d'), s1); }catch{}
  try{ const s2 = await seriesCountByDay('site_id'); drawSpark(document.getElementById('sparkSites').getContext('2d'),    s2); }catch{}

  try{
    const { data } = await applyDateFilter(
      applySiteScope(
        sb.from(VIEW).select('ean, site_id, preco_num, data')
          .not('preco_num','is',null).order('data',{ascending:true}).limit(8000)
      )
    );
    if (data && data.length){
      const key = (r)=> String(r.ean)+'|'+String(r.site_id);
      const first = new Map(), last = new Map();
      for (const r of data){
        const k=key(r), pn=Number(r.preco_num); if(!isFinite(pn)) continue;
        if (!first.has(k)) first.set(k, pn);
        last.set(k, pn);
      }
      let sum=0, cnt=0, series=[];
      for (const [k, fa] of first){
        const la = last.get(k); if(isFiniteNum(la)){ sum += (la-fa)/Math.max(1e-9, fa); cnt++; series.push(Math.abs((la-fa)/Math.max(1e-9, fa))); }
      }
      const avg = cnt ? (sum/cnt)*100 : 0;
      document.getElementById('kpiVariacao').textContent = (avg>=0?'+':'')+avg.toFixed(1)+'%';
      drawSpark(document.getElementById('sparkVariacao').getContext('2d'), series.slice(-30));
    }else{
      document.getElementById('kpiVariacao').textContent = '—';
    }
  }catch(e){ document.getElementById('kpiVariacao').textContent = '—'; }

  document.getElementById('kpiEconomia').textContent = '—';
  await recomputeKpiVariacaoUser();
}

/* ========= Desenho spark simples ========= */
function drawSpark(ctx, arr){
  if (!ctx || !arr || !arr.length) return;
  const W = ctx.canvas.width, H = ctx.canvas.height, pad=6;
  const max = Math.max(...arr), min = Math.min(...arr);
  ctx.clearRect(0,0,W,H);
  ctx.beginPath(); ctx.moveTo(pad, H-pad);
  arr.forEach((v,i)=>{
    const x = pad + i*(W-2*pad)/Math.max(1,arr.length-1);
    const y = pad + (1 - (v-min)/Math.max(1,(max-min))) * (H-2*pad);
    if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.strokeStyle = '#00b140';
  ctx.lineWidth = 2;
  ctx.stroke();
}


/* === Fallback: busca "meu_preco" mais recente por EAN (sem filtro de período) === */
async function fetchMyPriceMap(eanList){
  const map = new Map();
  if (!eanList || !eanList.length) return map;

  const { data, error } = await applySiteScope(
    sb
      .from(VIEW)
      .select('ean, meu_preco, data, site_id')
      .in('ean', eanList)
      .not('meu_preco','is',null)
      .order('data', { ascending:false })
      .limit(eanList.length * 10)
  );

  if (error){ console.warn('fetchMyPriceMap error:', error.message||error); return map; }
  for (const r of (data||[])){
    const e = String(r.ean);
    if (!map.has(e)){
      const mp = Number(r.meu_preco);
      if (isFiniteNum(mp) && mp>0) map.set(e, mp);
    }
  }
  return map;
}

/* ========= Normalização / descrições por EAN ========= */
const onlyDigits = (s)=> (String(s||'')).replace(/\D+/g,'');
function toCandidates(code){
  const d = onlyDigits(code);
  const out = new Set();
  if (!d) return out;
  out.add(d);
  if (d.length === 12) out.add('0'+d);
  if (d.length === 14 && d.startsWith('0')) out.add(d.slice(1));
  if (d.length < 13) out.add(d.padStart(13,'0'));
  if (d.length > 13) out.add(d.slice(-13));
  return out;
}
async function getDescriptionsByEan(eanList){
  const map = new Map();
  if (!eanList || !eanList.length) return map;

  const candidateToOriginal = new Map();
  const candidates = new Set();
  eanList.forEach(e=> toCandidates(e).forEach(c=>{ candidates.add(c); if(!candidateToOriginal.has(c)) candidateToOriginal.set(c,e); }));
  const candArr = Array.from(candidates);

  try{
    const { data:{ session } } = await sb.auth.getSession();
    let q = sb.from('produtos_cliente').select('ean13, descricao');
    try { q = q.eq('user_id', session?.user?.id || ''); } catch(_){}
    const rs = await q.in('ean13', candArr);
    (rs.data||[]).forEach(r=>{
      const orig = candidateToOriginal.get(String(r.ean13)) || String(r.ean13);
      if (!map.has(orig)) map.set(orig, r.descricao || '');
    });
  }catch(e){ console.warn('produtos_cliente lookup falhou:', e?.message||e); }

  const missing = eanList.filter(e => !map.has(String(e)));
  if (missing.length){
    const more = new Set(); missing.forEach(e=> toCandidates(e).forEach(c=> more.add(c)));
    try{
      const { data: cp } = await sb.from('cadastro_produtos').select('ean1, descricao').in('ean1', Array.from(more));
      (cp||[]).forEach(r=>{
        const orig = candidateToOriginal.get(String(r.ean1)) || String(r.ean1);
        if (!map.has(orig)) map.set(orig, r.descricao || '');
      });
    }catch(e){ console.warn('cadastro_produtos lookup falhou:', e?.message||e); }
  }
  return map;
}

/* ========= Oportunidades ========= */
function median(nums){
  if (!nums.length) return NaN;
  const arr = nums.slice().sort((a,b)=>a-b);
  const m = Math.floor(arr.length/2);
  return arr.length%2 ? arr[m] : (arr[m-1]+arr[m])/2;
}
function filterOutliersAroundMedian(list, tol){
  if (!list.length) return list;
  const med = median(list.map(x=>x.price));
  const lo = med*(1-tol), hi = med*(1+tol);
  const filtered = list.filter(x => x.price>=lo && x.price<=hi);
  return filtered.length ? filtered : list;
}
function filterValidCompetitors(list){
  return list.filter(x => isFiniteNum(x.price) && x.price > 0);
}
function currentQuery(){ const el = document.getElementById('qOportunidades'); return el ? (el.value||'').trim() : ''; }

async function loadOportunidadesVsMin(){
  const lim = DEFAULT_TOP_LIMIT;
  const tol = DEFAULT_OUTLIER_TOL;
  const siteIds = getSelectedSiteIds(); // já retorna só permitidos ou um subconjunto

  let qry = applyDateFilter(
    sb.from(VIEW).select('ean, descricao, site_id, site_nome, preco_num, meu_preco, data')
      .not('preco_num','is',null)
      .order('data', { ascending:false })
  );
  qry = qry.in('site_id', siteIds); // força escopo permitido
  const qDesc = currentQuery();
  if (qDesc)   qry = qry.ilike('descricao', `%${qDesc}%`);

  const { data, error } = await qry.limit(Math.max(30000, lim*200));
  if (error) throw error;

  const byEan = new Map();
  for (const r of (data||[])){
    const e = String(r.ean);
    if (!byEan.has(e)) byEan.set(e, { ean:e, desc:r.descricao||'', my:null, market:[] });
    const obj = byEan.get(e);

    const sid = Number(r.site_id);
    const pn  = Number(r.preco_num);
    if (isFiniteNum(pn) && pn>0){
      obj.market.push({ price: pn, site: r.site_nome || sid });
    }

    const mp = Number(r.meu_preco);
    if (obj.my===null && isFiniteNum(mp) && mp>0) obj.my = mp;
  }

  const missingEans = Array.from(byEan.values()).filter(x=>x.my===null).map(x=>x.ean);
  let myMap = new Map();
  if (missingEans.length){
    myMap = await fetchMyPriceMap(missingEans);
  }

  const baratos=[], caros=[];
  for (const obj of byEan.values()){
    if (!isFiniteNum(obj.my) || obj.my<=0){
      const mp = myMap.get(obj.ean);
      if (isFiniteNum(mp) && mp>0) obj.my = mp;
    }
    if (!isFiniteNum(obj.my) || obj.my<=0) continue;
    let market = filterValidCompetitors(obj.market);
    if (!market.length) continue;

    // filtro padrão por mediana (mantido para a aba 'Eu sou o mais barato')
    market = filterOutliersAroundMedian(market, tol).sort((a,b)=>a.price-b.price);
    if (!market.length) continue;

    const minc = market[0];
    const nextAbove = market.find(x => x.price > obj.my) || null;

    // Para a aba 'Eu estou mais caro', usamos apenas preços dentro de ±tol do MEU PREÇO
    let mincCaros = minc;
    if (isFiniteNum(obj.my) && obj.my>0 && obj.my > minc.price){
      const lo = obj.my * (1 - tol), hi = obj.my * (1 + tol);
      const band = market.filter(x => x.price >= lo && x.price <= hi).sort((a,b)=>a.price-b.price);
      if (!band.length) { continue; }
      mincCaros = band[0];
    }
    if (obj.my < minc.price){
      const prox = nextAbove || minc;
      const gapUp = prox.price - obj.my;
      baratos.push({ ean: obj.ean, desc: obj.desc, my: obj.my, next: prox.price, next_site: prox.site, gap_up: gapUp });
    } else if (obj.my > mincCaros.price){
      const diff = obj.my - mincCaros.price;
      caros.push({ ean: obj.ean, desc: obj.desc, my: obj.my, minc: mincCaros.price, min_site: mincCaros.site, diff });
    }
  }

  baratos.sort((a,b)=> b.gap_up - a.gap_up);
  caros.sort((a,b)=> b.diff   - a.diff);

  lastBaratos = baratos.slice(0, lim);
  lastCaros   = caros.slice(0, lim);
  renderBaratos();
  renderCaros();
  // Atualiza KPI de Economia estimada (nesse momento: soma do gap onde sou mais barato)
  const economiaTotal = baratos.reduce((acc, it) => acc + (isFiniteNum(it.gap_up) ? Math.max(0, Number(it.gap_up)) : 0), 0);
  const elKpiEco = document.getElementById('kpiEconomia');
  if (elKpiEco) elKpiEco.textContent = formatBRL(economiaTotal);

}


/* ========= Render + Ordenação ========= */
function sortArray(arr, key, dir){
  const m = dir==='desc' ? -1 : 1;
  return arr.slice().sort((a,b)=>{
    const va = a[key], vb = b[key];
    if (typeof va === 'number' && typeof vb === 'number'){
      return (va - vb) * m;
    }
    return collator.compare(String(va??''), String(vb??'')) * m;
  });
}
function renderBaratos(){
  const st = sortState.baratos;
  const data = sortArray(lastBaratos, st.key, st.dir);
  const tb = document.querySelector('#tblMaisBaratos tbody'); tb.innerHTML='';
  data.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td>${(r.desc||'').replace(/</g,'&lt;')}</td>
      <td class="mono">${r.ean}</td>
      <td class="right"><span class="price min">${formatBRL(r.my)}</span></td>
      <td class="right" title="${r.next_site||''}">${formatBRL(r.next)}</td>
      <td class="right">${formatBRL(r.gap_up)}</td>
    `;
    tb.appendChild(tr);
  });
  const t_titleBaratos = document.getElementById('titleBaratos'); if (t_titleBaratos) t_titleBaratos.textContent = 'Oportunidades — Eu sou o mais barato (' + data.length.toLocaleString('pt-BR') + ')';
    applyVisibleHeights();
  decorateHeaders('baratos');
}
function renderCaros(){
  const st = sortState.caros;
  const data = sortArray(lastCaros, st.key, st.dir);
  const tb = document.querySelector('#tblMaisCaros tbody'); tb.innerHTML='';
  data.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td>${(r.desc||'').replace(/</g,'&lt;')}</td>
      <td class="mono">${r.ean}</td>
      <td class="right"><span class="price max">${formatBRL(r.my)}</span></td>
      <td class="right" title="${r.min_site||''}">${formatBRL(r.minc)}</td>
      <td class="right">${formatBRL(r.diff)}</td>
    `;
    tb.appendChild(tr);
  });
  const t_titleCaros = document.getElementById('titleCaros'); if (t_titleCaros) t_titleCaros.textContent = 'Oportunidades — Eu estou mais caro (' + data.length.toLocaleString('pt-BR') + ')';
    applyVisibleHeights();
  decorateHeaders('caros');
}

/* ========= Maiores alterações (com descrição por EAN) ========= */

async function loadMaioresAlt(){
  const lim = DEFAULT_TOP_LIMIT;
  const siteIds = getSelectedSiteIds();
  let q = sb.from('v_maiores_diferencas_preco')
    .select('site_id, ean, ultimo_preco, penultimo_preco, diff_preco')
    .not('diff_preco','is',null)
    .neq('diff_preco', 0)
    .order('diff_preco', { ascending:false })
    .limit(Math.max(4000, lim*50));

  // força escopo permitido (ou subconjunto selecionado)
  q = q.in('site_id', siteIds);

  const { data, error } = await q;
  if (error){ console.error(error); lastAlt=[]; renderAlt(); return; }

  const rows = data || [];
  const eans = Array.from(new Set(rows.map(r => String(r.ean||'')).filter(Boolean)));
  let descMap = new Map();
  try {
    descMap = await getDescriptionsByEan(eans);
  } catch(e){
    console.warn('Descrição por EAN falhou:', e?.message||e);
  }

  lastAlt = rows.map(r => {
    const prev = Number(r.penultimo_preco);
    const curr = Number(r.ultimo_preco);
    const delta = Number(r.diff_preco);
    const perc = (prev && isFinite(prev) && prev !== 0) ? ( (curr - prev) / prev * 100 ) : 0;
    const eanStr = String(r.ean||'');
    const desc = descMap.get(eanStr) || '';
    return {
      desc: desc || eanStr,
      ean: eanStr,
      site: siteMap.get(Number(r.site_id)) || String(r.site_id||''),
      prev, curr, delta, perc
    };
  });
  renderAlt();
}

function renderAlt(){
  const st = sortState.alt;
  const data = sortArray(lastAlt, st.key, st.dir);
  const tb = document.querySelector('#tblMaioresAlt tbody'); tb.innerHTML='';
  data.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td>${(r.desc||'').replace(/</g,'&lt;')}</td>
      <td class="mono">${r.ean}</td>
      <td>${(r.site||NA).toString().replace(/</g,'&lt;')}</td>
      <td class="right">${formatBRL(r.prev)}</td>
      <td class="right">${formatBRL(r.curr)}</td>
      <td class="right">${formatBRL(r.delta)}</td>
      <td class="right">${(r.perc>=0?'+':'')+r.perc.toFixed(1)}%</td>
    `;
    tb.appendChild(tr);
  });
  const t_titleAlt = document.getElementById('titleAlt'); if (t_titleAlt) t_titleAlt.textContent = 'Maiores alterações de preço (' + data.length.toLocaleString('pt-BR') + ')';
    applyVisibleHeights();
  decorateHeaders('alt');
}

/* ========= Região ========= */
async function loadRegiao(){
  try{
    // apenas se houver 'regiao' e sites permitidos
    if (!allowedSiteIds.length) return;
    const { data: rs } = await sb.from('sites').select('id, regiao').in('id', allowedSiteIds).limit(1);
    if (!(rs && rs.length && rs[0].regiao)) return;

    const {from,to} = getPeriod();
    const { data } = await sb.from(VIEW).select('preco_num, site_id, data')
      .gte('data',from.toISOString()).lte('data',to.toISOString())
      .in('site_id', allowedSiteIds)
      .not('preco_num','is',null).limit(10000);

    const { data: allSites } = await sb.from('sites').select('id, regiao').in('id', allowedSiteIds).not('regiao','is',null);
    const m = new Map((allSites||[]).map(s=>[Number(s.id), String(s.regiao)]));

    const mapReg = new Map();
    (data||[]).forEach(r=>{
      const reg = m.get(Number(r.site_id)); if(!reg) return;
      const pn = Number(r.preco_num); if(!isFinite(pn)) return;
      if(!mapReg.has(reg)) mapReg.set(reg, []); mapReg.get(reg).push(pn);
    });
    if (!mapReg.size) return;

    const pares = Array.from(mapReg.entries()).map(([reg, arr])=>[reg, arr.reduce((a,b)=>a+b,0)/arr.length]);
    const canvas = document.getElementById('chartRegiao');
    const ctx = canvas.getContext('2d');
    document.querySelector('#blocoRegiao .empty').style.display='none';
    canvas.style.display='block';
    const W=canvas.width, H=canvas.height, pad=30;
    ctx.clearRect(0,0,W,H);
    ctx.fillStyle='#00b140';
    const max = Math.max(...pares.map(p=>p[1]));
    const bw = (W - pad*2)/Math.max(1,pares.length);
    pares.forEach((p,i)=>{
      const h = (p[1]/(max||1))*(H-pad*2);
      ctx.fillRect(pad + i*bw + 6, H-pad - h, bw-12, h);
      ctx.fillStyle='#9aa0a6'; ctx.font='12px Arial';
      ctx.fillText(p[0], pad + i*bw + 6, H-pad+14);
      ctx.fillStyle='#00b140';
    });
  }catch(e){
    console.warn('regiao falhou:', e?.message||e);
  }
}

/* ========= Abaixo do custo ========= */
async function watchAbaixoCusto(){
  try{
    const { data: probe } = await sb.from(VIEW).select('ean, meu_custo, meu_preco').limit(1);
    if (probe && probe.length && (probe[0].meu_custo!=null || probe[0].meu_preco!=null)){
      const {from,to} = getPeriod();
      const { data } = await sb.from(VIEW).select('ean, descricao, meu_custo, meu_preco, data')
        .gte('data',from.toISOString()).lte('data',to.toISOString()).limit(10000);
      const rows = (data||[]).filter(r=>isFiniteNum(r.meu_custo)&&isFiniteNum(r.meu_preco)&&r.meu_preco<r.meu_custo)
        .map(r=>({ ean:r.ean, desc:r.descricao||'', meu_custo:Number(r.meu_custo), meu_preco:Number(r.meu_preco), delta:Number(r.meu_preco)-Number(r.meu_custo) }));
      lastAbaixo = rows;
      renderAbaixo();
    }
  }catch{}
}
function renderAbaixo(){
  const st = sortState.abaixo;
  const data = sortArray(lastAbaixo, st.key, st.dir);
  const wrap = document.getElementById('wrapAbaixoCusto');
  const empty = document.querySelector('#blocoAbaixoCusto .empty');
  if (!data.length){ wrap.style.display='none'; empty.style.display='block'; return; }
  empty.style.display='none'; wrap.style.display='block';
  const tb = document.querySelector('#tblAbaixoCusto tbody'); tb.innerHTML='';
  data.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td>${(r.desc||'').replace(/</g,'&lt;')}</td>
      <td class="mono">${r.ean}</td>
      <td class="right">${formatBRL(r.meu_custo)}</td>
      <td class="right">${formatBRL(r.meu_preco)}</td>
      <td class="right">${formatBRL(r.delta)}</td>
    `;
    tb.appendChild(tr);
  });
  applyVisibleHeights();
  decorateHeaders('abaixo');
}

/* ========= Ordenação (UI) ========= */
function bindSortingHandlers(){
  document.querySelectorAll('th.sortable').forEach(th=>{
    th.addEventListener('click', ()=>{
      const table = th.getAttribute('data-table');
      const col   = th.getAttribute('data-col');
      const st = sortState[table];
      if (!st) return;
      if (st.key === col){
        st.dir = st.dir==='asc' ? 'desc' : 'asc';
      } else {
        st.key = col;
        st.dir = (col==='desc' || col==='ean') ? 'asc' : 'desc';
      }
      switch(table){
        case 'baratos': renderBaratos(); break;
        case 'caros':   renderCaros();   break;
        case 'alt':     renderAlt();     break;
        case 'abaixo':  renderAbaixo();  break;
      }
    });
  });
}
function decorateHeaders(tableKey){
  document.querySelectorAll(`th.sortable[data-table="${tableKey}"]`).forEach(th=>{
    th.classList.remove('asc','desc');
  });
  const st = sortState[tableKey];
  const th = document.querySelector(`th.sortable[data-table="${tableKey}"][data-col="${st.key}"]`);
  if (th) th.classList.add(st.dir);
}

/* ========= Limite visual com rolagem (CORRIGIDO) ========= */
function applyVisibleHeights(){
  const vis = DEFAULT_VISIBLE_ROWS;
  const wraps = ['wrapBaratos','wrapCaros','wrapAlt','wrapAbaixoCusto','wrapTopSearches','wrapWordList'];
  for (const id of wraps){
    const wrap = document.getElementById(id);
    if (!wrap || wrap.style.display==='none') continue;
    const table = wrap ? wrap.querySelector('table') : null;
    const thead = table ? table.querySelector('thead') : null;
    const row   = table ? table.querySelector('tbody tr') : null;
    const headH = thead ? thead.getBoundingClientRect().height : 40;
    const rowH  = row ? row.getBoundingClientRect().height : 38;
    wrap.style.maxHeight = (headH + rowH * vis + 6) + 'px';
    wrap.style.overflow = 'auto';
  }
  // equalizar alturas entre "Mais baratos" e "Mais caros"
  const wb = document.getElementById('wrapBaratos');
  const wc = document.getElementById('wrapCaros');
  if (wb && wc && wb.style.display !== 'none' && wc.style.display !== 'none') {
    const getH = (wrap) => {
      const table = wrap.querySelector('table');
      const thead = table ? table.querySelector('thead') : null;
      const row   = table ? table.querySelector('tbody tr') : null;
      const headH = thead ? thead.getBoundingClientRect().height : 40;
      const rowH  = row ? row.getBoundingClientRect().height : 38;
      return (headH + rowH * vis + 6);
    };
    const h = Math.max(getH(wb), getH(wc));
    wb.style.maxHeight = h + 'px';
    wc.style.maxHeight = h + 'px';
    wb.style.overflow = wc.style.overflow = 'auto';
  }
}

/* ================= RELATÓRIOS DE BUSCA ================= */
document.getElementById('btnAtualizarPesquisas').addEventListener('click', loadTopSearches);
document.getElementById('btnListaPalavras').addEventListener('click', toggleWordList);

/* === Produtos mais pesquisados (TOP 30) com enriquecimento por EAN === */
async function loadTopSearches(){
  const lim = 8000;
  const { data, error } = await sb.from('search_logs')
    .select('ean_query, desc_query, id')
    .order('id', { ascending:false })
    .limit(lim);
  if (error){ console.error(error); return; }

  const byEan = new Map();
  const byDesc = new Map();
  for (const r of (data||[])){
    const e = (r.ean_query||'').trim();
    const d = (r.desc_query||'').trim().toLowerCase();
    if (e && /^\\d{8,14}$/.test(e)){
      const curr = byEan.get(e) || { ean: e, n: 0 };
      curr.n++; byEan.set(e, curr);
    } else if (d){
      const curr = byDesc.get(d) || { term: d, n: 0 };
      curr.n++; byDesc.set(d, curr);
    }
  }

  const merged = [
    ...Array.from(byEan.values()).map(x=>({ type:'ean', key:x.ean, n:x.n })),
    ...Array.from(byDesc.values()).map(x=>({ type:'desc', key:x.term, n:x.n }))
  ].sort((a,b)=> b.n - a.n).slice(0, 30);

  const uniqueEansRaw = merged.filter(x=>x.type==='ean').map(x=>x.key);
  const candidateToOriginal = new Map();
  const candidates = new Set();
  uniqueEansRaw.forEach(e=>{
    toCandidates(e).forEach(c=>{ candidates.add(c); if(!candidateToOriginal.has(c)) candidateToOriginal.set(c, e); });
  });

  const descByEan = new Map();
  if (candidates.size){
    const candArr = Array.from(candidates);
    try{
      const { data: pc } = await sb.from('produtos_cliente').select('ean13, descricao').in('ean13', candArr);
      (pc||[]).forEach(r=>{
        if (r && r.ean13){
          const orig = candidateToOriginal.get(String(r.ean13)) || String(r.ean13);
          if (!descByEan.has(orig)) descByEan.set(orig, r.descricao || '');
        }
      });
    }catch{}
    const missing = uniqueEansRaw.filter(e => !descByEan.has(String(e)));
    if (missing.length){
      const moreCandidates = new Set();
      missing.forEach(e=> toCandidates(e).forEach(c=> moreCandidates.add(c)));
      const moreArr = Array.from(moreCandidates);
      try{
        const { data: cp } = await sb.from('cadastro_produtos').select('ean1, descricao').in('ean1', moreArr);
        (cp||[]).forEach(r=>{
          if (r && r.ean1){
            const orig = candidateToOriginal.get(String(r.ean1)) || String(r.ean1);
            if (!descByEan.has(orig)) descByEan.set(orig, r.descricao || '');
          }
        });
      }catch{}
    }
  }

  const tb = document.querySelector('#tblPesquisas tbody'); tb.innerHTML='';
  merged.forEach(item=>{
    let ean='', desc='', n=item.n;
    if (item.type==='ean'){
      ean = item.key;
      desc = descByEan.get(String(item.key)) || '';
    } else {
      ean = '—';
      desc = item.key;
    }
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="mono">${ean}</td>
      <td>${desc ? desc.replace(/</g,'&lt;') : ''}</td>
      <td class="right">${n.toLocaleString('pt-BR')}</td>
    `;
    tb.appendChild(tr);
  });
  applyVisibleHeights();
}

/* ========= NUVEM DE PALAVRAS ========= */
async function loadWordCloud(){
  const lim = 10000;
  const { data, error } = await sb.from('search_logs')
    .select('desc_query, id')
    .order('id', { ascending:false })
    .limit(lim);
  if (error){ console.error(error); return; }

  const stop = new Set(['de','da','do','das','dos','para','com','sem','por','uma','uns','umas','que','e','ou','em','na','no','nas','nos']);
  const freq = new Map();
  (data||[]).forEach(r=>{
    const txt = (r.desc_query||'').toLowerCase();
    txt.split(/[\\s,.;:/\\\\\\-+()]+/).forEach(w=>{
      if(!w || w.length<3 || stop.has(w)) return;
      freq.set(w, (freq.get(w)||0)+1);
    });
  });

  const entries = Array.from(freq.entries()).sort((a,b)=> b[1]-a[1]).slice(0, 30);
  lastWordList = entries;

  const cloud = document.getElementById('wordCloud');
  cloud.innerHTML='';

  const max = entries.length ? entries[0][1] : 1;
  entries.forEach(([w,c], idx)=>{
    const span = document.createElement('span');
    span.className = 'w'+(idx===0?' top1':'');
    const size = 16 + Math.round((c/max)*30);
    span.style.fontSize = size+'px';

    const rot  = (Math.random()*10-5).toFixed(2) + 'deg';
    const dx   = (Math.random()*8-4).toFixed(1) + 'px';
    const dy   = (Math.random()*8-4).toFixed(1) + 'px';
    const delay= (Math.random()*0.45).toFixed(2) + 's';
    span.style.setProperty('--rot', rot);
    span.style.setProperty('--dx', dx);
    span.style.setProperty('--dy', dy);
    span.style.setProperty('--delay', delay);

    span.textContent = w;
    span.dataset.count = c;

    span.addEventListener('click', ()=>{
      const el = document.getElementById('qOportunidades');
      if (el){ el.value = w; }
      loadOportunidadesVsMin(true);
      document.querySelector('.grid').scrollIntoView({ behavior:'smooth', block:'start' });
    });

    attachTooltip(span, `${w} — ${c.toLocaleString('pt-BR')} ocorrências`);

    cloud.appendChild(span);
  });
}

/* ========= Lista ordenada alternável ========= */
function toggleWordList(){
  const box = document.getElementById('listaPalavras');
  const tb = document.querySelector('#tblPalavras tbody');
  if (box.style.display === 'none'){
    box.style.display = 'block';
    tb.innerHTML='';
    lastWordList.forEach(([w,c])=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${w}</td><td class="right">${c.toLocaleString('pt-BR')}</td>`;
      tb.appendChild(tr);
    });
    applyVisibleHeights();
  }else{
    box.style.display = 'none';
  }
}

/* ========= Tooltip util ========= */
function attachTooltip(el, text){
  const tip = document.getElementById('wcTooltip');
  let visible = false;

  function show(e){
    tip.textContent = text;
    tip.style.display = 'block';
    visible = true;
    move(e);
  }
  function hide(){
    tip.style.display = 'none';
    visible = false;
  }
  function move(e){
    if (!visible) return;
    const pad = 12;
    const x = (e.clientX||0) + pad;
    const y = (e.clientY||0) + pad;
    tip.style.left = x + 'px';
    tip.style.top  = y + 'px';
  }

  el.addEventListener('mouseenter', show);
  el.addEventListener('mousemove', move);
  el.addEventListener('mouseleave', hide);
}

/* ========= Botão de minimizar ========= */
function installMinimizeButtons(){
  document.querySelectorAll('.panel').forEach(panel=>{
    const hdr = panel.querySelector('header');
    const content = panel.querySelector('.content');
    if (!hdr || !content) return;

    let right = hdr.children[1];
    if (!right || right.tagName === 'H2'){
      right = document.createElement('div');
      hdr.appendChild(right);
    }

    const btn = document.createElement('button');
    btn.className = 'btn btn-min';
    btn.type = 'button';
    btn.title = 'Minimizar/expandir';
    btn.setAttribute('aria-expanded','true');
    btn.textContent = '–';
    btn.addEventListener('click', ()=>{
      const collapsed = content.style.display !== 'none' && content.offsetParent !== null;
      if (collapsed){
        content.style.display = 'none';
        btn.textContent = '+';
        btn.setAttribute('aria-expanded','false');
      } else {
        content.style.display = 'block';
        btn.textContent = '–';
        btn.setAttribute('aria-expanded','true');
        applyVisibleHeights();
      }
    });
    right.appendChild(btn);
  });
}

/* ===== Logout ===== */
async function sair(){
  try{
    await sb.auth.signOut();
  }catch(_){}
  const base = (window.CONFIG && window.CONFIG.SITE_URL) ? window.CONFIG.SITE_URL.replace(/\\/+$/,'') : '';
  const url = base ? (base + '/index.html') : 'index.html';
  window.location.assign(url);
}
if (ddMeusDados) ddMeusDados.addEventListener('click', ()=> location.href='meusdados.html');
if (ddPlanos) ddPlanos.addEventListener('click', ()=> location.href='planos.html');

if (btnSair){
  btnSair.addEventListener('click', sair);
}

</script>
<footer style="text-align:center; padding:14px 0; font-size:13px; color:#aaa; border-top:1px solid #1a1a1a; background:#000;">
  © 2025 MaiorMargem · <a href="termos.html" style="color:#9cf; text-decoration:none;">Termos de Uso</a>
</footer>

</body>
</html>
