<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Meus dados</title>
<style>
  :root { color-scheme: dark; }
  * { box-sizing: border-box; }
  body{background:#121212;color:#fff;font-family:Arial,sans-serif;padding:24px;margin:0}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;gap:12px;flex-wrap:wrap}
  h1{color:#00b140;margin:0}
  a{color:#00b140;text-decoration:none}
  a:hover{text-decoration:underline}

  .btn{display:inline-flex;align-items:center;gap:8px;background:#00b140;color:#fff;border:none;padding:10px 14px;border-radius:8px;text-decoration:none;cursor:pointer}
  .btn:hover{background:#009b38}
  .btn.outline{background:transparent;border:1px solid #2a2a2a;color:#ddd}
  .btn.outline:hover{background:#1b1b1b}
  .btn.muted{background:#2a2a2a}
  .btn.muted:hover{background:#333}

  .chip{font-size:12px;background:#1e1e1e;border:1px solid #333;padding:6px 10px;border-radius:999px}
  .chip.plan{color:#bfffc1;border-color:#2f5a2f;background:#132313}

  .container{max-width:980px;margin:0 auto}
  .card{background:#0f0f0f;border:1px solid #2a2a2a;border-radius:12px;padding:18px;margin-bottom:16px}

  .grid{display:grid;grid-template-columns:1fr 1fr;column-gap:16px;row-gap:22px}
  .col-1{grid-column: span 1}
  .col-2{grid-column: span 2}
  @media (max-width: 720px){ .grid{grid-template-columns:1fr} .col-2{grid-column:span 1} }

  label{display:block;margin:4px 0 8px;color:#9aa0a6}

  input,select{
    width:100%;padding:12px 14px;border-radius:8px;border:1px solid #3a3a3a;
    background:#242424;color:#fff;font-size:15px;line-height:1.2
  }
  input[disabled], select[disabled]{
    background:#171717;border-color:#2a2a2a;color:#b5b5b5;cursor:not-allowed;
  }

  .help{font-size:12px;color:#9aa0a6;margin-top:6px}
  .help.error{color:#ff6666}

  .banner{border:1px solid #2a2a2a;border-radius:10px;padding:10px 12px;margin-bottom:14px;background:#111;display:none}
  .banner.warn{border-color:#5c3f00;background:#1b1300;color:#ffc966}
  .banner.ok{border-color:#214d21;background:#0e1a0e;color:#b7fbb7}
  .banner.err{border-color:#5c1e1e;background:#190d0d;color:#ff9a9a}

  /* ===== Se√ß√£o de sites ===== */
  .sites-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width: 840px){ .sites-grid{grid-template-columns:1fr} }
  .site-item{display:flex;align-items:flex-start;gap:12px;padding:12px;border:1px solid #232323;border-radius:10px;background:#121212}
  .site-item.disabled{opacity:0.55}
  .site-title{font-weight:bold;margin-bottom:4px}
  .site-url{font-size:12px;color:#9aa0a6;word-break:break-all}
  .muted{color:#9aa0a6;font-size:13px}
  .limit-info{font-size:13px;color:#b7fbb7;margin:6px 0 10px}
  .footer-actions{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-top:14px}
  .counter{font-size:13px;color:#9aa0a6}
  input[type="checkbox"]{width:18px;height:18px;margin-top:2px}

  /* ===== Upload Excel (sem armazenar) ===== */
  .dz{
    border:1px dashed #2a2a2a;border-radius:12px;background:#0e0e0e;
    padding:18px;text-align:center;transition:all .15s ease-in-out
  }
  .dz:hover{background:#121212}
  .dz.dragover{border-color:#00b140;background:#0d170f}
  .dz small{display:block;color:#9aa0a6;margin-top:8px}
  .file-row{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-top:10px;flex-wrap:wrap}
  .file-name{font-size:14px;color:#ddd;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .spinner{width:16px;height:16px;border:2px solid #2a2a2a;border-top-color:#00b140;border-radius:50%;display:inline-block;animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}

  table.preview{width:100%;border-collapse:collapse;margin-top:10px;font-size:13px}
  table.preview th, table.preview td{border:1px solid #2a2a2a;padding:6px 8px;text-align:left}
  table.preview th{background:#161616;color:#bdbdbd}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid #2a2a2a;color:#bdbdbd}
  .ok{color:#b7fbb7}
  .warn{color:#ffc966}
  .err{color:#ff9a9a}
</style>
<!-- Supabase -->
<script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<script src="./config.js"></script>
<!-- SheetJS (XLSX) para ler Excel no browser -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
<header class="container">
  <h1>Meus dados</h1>
  <div class="actions" style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
    <span id="planChip" class="chip plan" title="Plano atual">Plano: ‚Äî</span>
    <a class="btn outline" href="dashboard.html">‚Üê Voltar ao dashboard</a>
    <button id="btnSair" class="btn">Sair</button>
  </div>
</header>

<main class="container">
  <div id="banner" class="banner"></div>

  <!-- ===== Cart√£o original: dados do perfil ===== -->
  <div class="card">
    <div class="grid">
      <div class="col-2">
        <label for="email">Email</label>
        <input id="email" type="email" placeholder="usuario@exemplo.com" disabled>
      </div>

      <div class="col-1">
        <label for="nome">Nome</label>
        <input id="nome" type="text" placeholder="Seu nome" autocomplete="given-name">
      </div>

      <div class="col-1">
        <label for="sobrenome">Sobrenome</label>
        <input id="sobrenome" type="text" placeholder="Seu sobrenome" autocomplete="family-name">
      </div>

      <div class="col-1">
        <label for="cpfCnpj">CPF ou CNPJ</label>
        <input id="cpfCnpj" type="text" inputmode="numeric" placeholder="CPF ou CNPJ">
        <div id="docHelp" class="help">Digite apenas n√∫meros; a formata√ß√£o aparece sozinha.</div>
      </div>

      <div id="razaoWrap" class="col-1" style="display:none">
        <label for="razaoSocial">Raz√£o social</label>
        <input id="razaoSocial" type="text" placeholder="Raz√£o social (para CNPJ)">
      </div>

      <div class="col-1">
        <label for="telefone">Telefone</label>
        <input id="telefone" type="tel" inputmode="tel" placeholder="(11) 91234-5678">
        <div id="telHelp" class="help">Formato BR (com DDD). Ex.: (11) 91234-5678</div>
      </div>

      <div class="col-1">
        <label for="plano">Plano escolhido</label>
        <select id="plano" disabled>
          <option value="trial">Trial</option>
          <option value="basico">B√°sico</option>
          <option value="intermediario">Intermedi√°rio</option>
          <option value="premium">Premium</option>
        </select>
        <div class="help">O plano √© alterado ao adquirir/alterar a assinatura nos <a href="planos.html">Planos</a>.</div>
      </div>

      <div class="col-2">
        <button id="btnSalvar" class="btn">üíæ Salvar</button>
      </div>
    </div>
  </div>

  <!-- ===== NOVA SE√á√ÉO: Importar produtos (Excel) -> Gravar na base ===== -->
  <div class="card" id="importCard">
    <h2 style="margin:0 0 8px 0;">Importar produtos (Excel) ‚Üí Gravar na base</h2>
    <p class="muted" style="margin-top:0">
      Envie uma planilha com as colunas <strong>EAN</strong>, <strong>Descricao</strong>, <strong>PrecoCusto</strong>, <strong>PrecoVenda</strong>.
      Suporte a <em>.xlsx, .xls ou .csv</em>. Nada ser√° armazenado; o conte√∫do √© lido no navegador e inserido diretamente na tabela <code>produtos_cliente</code>.
    </p>

    <div class="dz" id="dropArea" aria-label="√Årea para arrastar e soltar arquivo">
      <div>Arraste e solte o arquivo aqui</div>
      <small>ou</small>
      <div style="margin-top:8px">
        <input id="fileExcel" type="file" accept=".xlsx,.xls,.csv" />
      </div>
      <small>Formatos: .xlsx, .xls, .csv ‚Ä¢ Tamanho sugerido ‚â§ 5 MB</small>
    </div>

    <div class="file-row" id="fileRow" style="display:none">
      <div class="file-name" id="fileName">Nenhum arquivo selecionado</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button id="btnPrever" class="btn outline" disabled>üëÅÔ∏è Pr√©-visualizar</button>
        <button id="btnInserir" class="btn" disabled>‚¨áÔ∏è Gravar na base</button>
        <button id="btnLimparImport" class="btn muted" disabled>Limpar</button>
      </div>
    </div>

    <div id="importStats" class="help" style="margin-top:8px"></div>
    <div id="previewWrap" style="margin-top:10px; display:none">
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <span class="badge">Pr√©via (primeiras 12 linhas)</span>
        <span id="mapInfo" class="help"></span>
      </div>
      <table class="preview" id="previewTable" aria-label="Pr√©-visualiza√ß√£o"></table>
    </div>
  </div>

  <!-- ===== Se√ß√£o existente: Sele√ß√£o de sites ===== -->
  <div class="card" id="sitesCard">
    <h2 style="margin-top:0;margin-bottom:8px">Selecionar sites para monitorar</h2>
    <p class="muted" id="introSites">
      Marque os sites que deseja monitorar. O limite depende do seu plano.
      <a href="planos.html">Atualize o plano</a> para liberar mais sites.
    </p>
    <p class="limit-info" id="limitInfo">Limite do plano: ‚Äî</p>

    <div id="sitesWrap" class="sites-grid" aria-live="polite" aria-busy="true">
      <!-- Lista renderizada aqui -->
    </div>

    <div class="footer-actions">
      <div class="counter" id="counter">Selecionados: 0 / ‚Äî</div>
      <div style="display:flex; gap:10px; flex-wrap:wrap">
        <button id="btnLimparSites" class="btn outline">Limpar</button>
        <button id="btnSalvarSites" class="btn">üíæ Salvar sele√ß√£o</button>
      </div>
    </div>
  </div>
</main>

<script>
/* =========================
   Config / Supabase Client
   ========================= */
const CFG = window.CONFIG || {};
const SUPABASE_URL = CFG.SUPABASE_URL;
const SUPABASE_ANON_KEY = CFG.SUPABASE_ANON_KEY;
if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
  alert("Erro de configura√ß√£o: config.js n√£o carregado.");
  throw new Error("CONFIG ausente");
}
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
});

/* =========================
   Utilidades e UI
   ========================= */
const bannerEl = document.getElementById('banner');
function showBanner(text, type = 'ok', timeoutMs = 4200) {
  bannerEl.textContent = text;
  bannerEl.className = 'banner ' + (type === 'warn' ? 'warn' : (type === 'err' ? 'err' : 'ok'));
  bannerEl.style.display = 'block';
  if (timeoutMs > 0) setTimeout(() => { bannerEl.style.display = 'none'; }, timeoutMs);
}
function digitsOnly(s){ return (s||'').replace(/\D+/g, ''); }

/* ======== CPF/CNPJ/Telefone helpers (iguais √† sua base) ======== */
const emailEl = document.getElementById('email');
const nomeEl = document.getElementById('nome');
const sobrenomeEl = document.getElementById('sobrenome');
const cpfCnpjEl = document.getElementById('cpfCnpj');
const telefoneEl = document.getElementById('telefone');
const planoEl = document.getElementById('plano');
const razaoWrap = document.getElementById('razaoWrap');
const razaoSocialEl = document.getElementById('razaoSocial');
const btnSalvar = document.getElementById('btnSalvar');
const btnSair = document.getElementById('btnSair');
const telHelp = document.getElementById('telHelp');
const docHelp = document.getElementById('docHelp');
const planChip = document.getElementById('planChip');

function formatCPF(d) {
  d = d.slice(0,11);
  if (d.length <= 3) return d;
  if (d.length <= 6) return d.replace(/(\d{3})(\d+)/, "$1.$2");
  if (d.length <= 9) return d.replace(/(\d{3})(\d{3})(\d+)/, "$1.$2.$3");
  return d.replace(/(\d{3})(\d{3})(\d{3})(\d{0,2}).*/, "$1.$2.$3-$4");
}
function validateCPF(d) {
  if (!d || d.length !== 11) return false;
  if (/^(\d)\1{10}$/.test(d)) return false;
  let sum = 0;
  for (let i=0;i<9;i++) sum += parseInt(d.charAt(i))*(10-i);
  let r = sum % 11; let dv1 = (r<2)?0:(11-r);
  if (dv1 !== parseInt(d.charAt(9))) return false;
  sum = 0;
  for (let i=0;i<10;i++) sum += parseInt(d.charAt(i))*(11-i);
  r = sum % 11; let dv2 = (r<2)?0:(11-r);
  return dv2 === parseInt(d.charAt(10));
}

function formatCNPJ(d) {
  d = d.slice(0,14);
  if (d.length <= 2) return d;
  if (d.length <= 5) return d.replace(/(\d{2})(\d+)/, "$1.$2");
  if (d.length <= 8) return d.replace(/(\d{2})(\d{3})(\d+)/, "$1.$2.$3");
  if (d.length <= 12) return d.replace(/(\d{2})(\d{3})(\d{3})(\d+)/, "$1.$2.$3/$4");
  return d.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{0,2}).*/, "$1.$2.$3/$4-$5");
}
function validateCNPJ(d) {
  if (!d || d.length !== 14) return false;
  if (/^(\d)\1{13}$/.test(d)) return false;
  const w1 = [5,4,3,2,9,8,7,6,5,4,3,2];
  const w2 = [6,5,4,3,2,9,8,7,6,5,4,3,2];
  let sum = 0;
  for (let i=0;i<12;i++) sum += parseInt(d[i]) * w1[i];
  let r = sum % 11; let dv1 = (r<2)?0:(11-r);
  if (dv1 !== parseInt(d[12])) return false;
  sum = 0;
  for (let i=0;i<13;i++) sum += parseInt(d[i]) * w2[i];
  r = sum % 11; let dv2 = (r<2)?0:(11-r);
  return dv2 === parseInt(d[13]);
}

function formatPhone(d) {
  d = d.slice(0,11);
  if (d.length <= 2) return `(${d}`;
  if (d.length <= 6) return `(${d.slice(0,2)}) ${d.slice(2)}`;
  if (d.length <= 10) return `(${d.slice(0,2)}) ${d.slice(2,6)}-${d.slice(6)}`;
  return `(${d.slice(0,2)}) ${d.slice(2,7)}-${d.slice(7)}`;
}
function validatePhone(d){ return d.length === 10 || d.length === 11; }

function updateDocUI() {
  let d = digitsOnly(cpfCnpjEl.value);
  const isCNPJ = d.length > 11;
  if (isCNPJ) {
    cpfCnpjEl.value = formatCNPJ(d);
    const ok = validateCNPJ(d);
    document.getElementById('docHelp').textContent = ok ? 'CNPJ v√°lido.' : 'Digite 14 d√≠gitos para um CNPJ v√°lido.';
    document.getElementById('docHelp').className = 'help' + (ok ? '' : ' error');
    razaoWrap.style.display = 'block';
  } else {
    cpfCnpjEl.value = formatCPF(d);
    const ok = validateCPF(d);
    document.getElementById('docHelp').textContent = ok ? 'CPF v√°lido.' : 'Digite 11 d√≠gitos para um CPF v√°lido.';
    document.getElementById('docHelp').className = 'help' + (ok ? '' : ' error');
    razaoWrap.style.display = 'none';
    razaoSocialEl.value = '';
  }
}
cpfCnpjEl.addEventListener('input', updateDocUI);

telefoneEl.addEventListener('input', () => {
  const d = digitsOnly(telefoneEl.value);
  telefoneEl.value = formatPhone(d);
  const ok = d.length === 0 || validatePhone(d);
  document.getElementById('telHelp').textContent = ok ? 'Formato BR (com DDD).' : 'Telefone inv√°lido. Use 10 ou 11 d√≠gitos.';
  document.getElementById('telHelp').className = 'help' + (ok ? '' : ' error');
});

/* =========================
   Sess√£o + Perfil + Plano
   ========================= */
let sessionUser = null;
let currentPlan = 'trial';

(async function initPerfil(){
  const { data: { session } } = await sb.auth.getSession();
  if (!session) { window.location.href = CFG.SITE_URL || 'index.html'; return; }
  sessionUser = session.user;
  emailEl.value = session.user.email || '';

  try{
    const { data: prof, error: e1 } = await sb
      .from('profiles')
      .select('first_name,last_name,cpf_cnpj,phone,plan,razao_social,cpf_cnpj_type')
      .eq('id', sessionUser.id)
      .maybeSingle();
    if (e1) throw e1;

    if (prof){
      nomeEl.value = prof.first_name || '';
      sobrenomeEl.value = prof.last_name || '';
      if (prof.cpf_cnpj) {
        cpfCnpjEl.value = (prof.cpf_cnpj_type === 'cnpj') ? formatCNPJ(prof.cpf_cnpj) : formatCPF(prof.cpf_cnpj);
        updateDocUI();
      }
      if (prof.razao_social) { razaoSocialEl.value = prof.razao_social; razaoWrap.style.display = 'block'; }
      if (prof.phone) telefoneEl.value = formatPhone(prof.phone);

      currentPlan = (prof.plan || 'basico').toString();
      planoEl.value = currentPlan;
      const pretty = currentPlan.charAt(0).toUpperCase() + currentPlan.slice(1);
      const prettyBR = pretty.replace('Basico','B√°sico').replace('Intermediario','Intermedi√°rio');
      planChip.textContent = `Plano: ${prettyBR}`;
    }

    await initSitesSection();       // carrega lista + sele√ß√£o sites
    initExcelImport();              // ativa importador de Excel
  }catch(e){
    console.error(e);
    showBanner('Erro ao carregar dados (tabela "profiles").', 'err');
    await initSitesSection();
    initExcelImport();
  }
})();

btnSair.addEventListener('click', async ()=>{
  await sb.auth.signOut();
  window.location.href = CFG.SITE_URL || 'index.html';
});

btnSalvar.addEventListener('click', async ()=>{
  const first_name = nomeEl.value.trim();
  const last_name  = sobrenomeEl.value.trim();
  const docDigits  = digitsOnly(cpfCnpjEl.value);
  const phoneDigits= digitsOnly(telefoneEl.value);

  if (!first_name){ showBanner('Informe o Nome.', 'warn'); nomeEl.focus(); return; }
  if (!last_name){ showBanner('Informe o Sobrenome.', 'warn'); sobrenomeEl.focus(); return; }

  let docType = null, docOK = false;
  if (docDigits.length > 0 && docDigits.length <= 11) {
    docType = 'cpf'; docOK = validateCPF(docDigits);
  } else if (docDigits.length >= 12) {
    docType = 'cnpj'; docOK = validateCNPJ(docDigits);
  }
  if (!docOK){ showBanner('CPF/CNPJ inv√°lido.', 'warn'); cpfCnpjEl.focus(); return; }

  let razao_social = null;
  if (docType === 'cnpj') {
    razao_social = (razaoSocialEl.value || '').trim();
    if (!razao_social) { showBanner('Informe a Raz√£o social para CNPJ.', 'warn'); razaoSocialEl.focus(); return; }
  }

  if (phoneDigits && !validatePhone(phoneDigits)){
    showBanner('Telefone inv√°lido (use 10 ou 11 d√≠gitos).', 'warn'); telefoneEl.focus(); return;
  }

  const payload = {
    id: sessionUser.id,
    email: sessionUser.email,
    first_name,
    last_name,
    cpf_cnpj: docDigits,
    cpf_cnpj_type: docType,
    razao_social,
    phone: phoneDigits
  };

  try {
    const { error } = await sb.from('profiles').upsert(payload, { onConflict: 'id' });
    if (error) throw error;
    showBanner('Dados salvos com sucesso!', 'ok');
  } catch (e) {
    console.error(e);
    showBanner('Falha ao salvar na base. Verifique a tabela/privilegios.', 'err');
  }
});

/* =========================================================
   SE√á√ÉO: Importar Excel -> Inserir direto na tabela
   ========================================================= */
function initExcelImport(){
  const input = document.getElementById('fileExcel');
  const dropArea = document.getElementById('dropArea');
  const fileRow = document.getElementById('fileRow');
  const fileNameEl = document.getElementById('fileName');
  const btnPrever = document.getElementById('btnPrever');
  const btnInserir = document.getElementById('btnInserir');
  const btnLimparImport = document.getElementById('btnLimparImport');
  const importStats = document.getElementById('importStats');
  const previewWrap = document.getElementById('previewWrap');
  const previewTable = document.getElementById('previewTable');
  const mapInfo = document.getElementById('mapInfo');

  let selectedFile = null;
  let parsedRows = []; // linhas normalizadas {ean, descricao, preco_custo, preco_venda}

  function resetImport(){
    selectedFile = null;
    parsedRows = [];
    fileNameEl.textContent = 'Nenhum arquivo selecionado';
    fileRow.style.display = 'none';
    btnPrever.disabled = true;
    btnInserir.disabled = true;
    btnLimparImport.disabled = true;
    importStats.textContent = '';
    previewWrap.style.display = 'none';
    previewTable.innerHTML = '';
    mapInfo.textContent = '';
    input.value = '';
  }

  function setFile(file){
    if (!file){ resetImport(); return; }
    const okExt = /\.(xlsx|xls|csv)$/i.test(file.name);
    if (!okExt){ showBanner('Formato inv√°lido. Use .xlsx, .xls ou .csv', 'warn'); return; }
    if (file.size > 8*1024*1024){ showBanner('Arquivo grande (> 8MB). Considere dividir.', 'warn'); }
    selectedFile = file;
    fileNameEl.textContent = `${file.name} ‚Ä¢ ${(file.size/1024/1024).toFixed(2)} MB`;
    fileRow.style.display='flex';
    btnPrever.disabled = false;
    btnLimparImport.disabled = false;
    importStats.textContent = 'Pronto para ler o arquivo.';
  }

  input.addEventListener('change', (e)=>{
    const f = e.target.files && e.target.files[0];
    setFile(f || null);
  });

  ;['dragenter','dragover'].forEach(evt=>{
    dropArea.addEventListener(evt, (e)=>{ e.preventDefault(); e.stopPropagation(); dropArea.classList.add('dragover'); });
  });
  ;['dragleave','drop'].forEach(evt=>{
    dropArea.addEventListener(evt, (e)=>{ e.preventDefault(); e.stopPropagation(); dropArea.classList.remove('dragover'); });
  });
  dropArea.addEventListener('drop', (e)=>{
    const dt = e.dataTransfer;
    const f = dt && dt.files && dt.files[0];
    setFile(f || null);
  });

  btnLimparImport.addEventListener('click', resetImport);

  // Normaliza nomes de colunas para os campos-alvo
  function normalizeHeader(h){
    h = (h||'').toString().trim().toLowerCase();
    h = h.normalize('NFD').replace(/[\u0300-\u036f]/g,''); // remove acentos
    return h;
  }
  function mapColumnName(h){
    const n = normalizeHeader(h);
    if (/(^ean$|ean13|codigo\s*ean|codbarras|cod\.?barras)/.test(n)) return 'ean';
    if (/(^descricao$|descri√ß√£o|nome\s*produto|produto|item)/.test(n)) return 'descricao';
    if (/(^precocusto$|preco\s*custo|custo|pcusto)/.test(n)) return 'preco_custo';
    if (/(^precovenda$|preco\s*venda|venda|pvenda)/.test(n)) return 'preco_venda';
    return null;
  }
  function toNumberBR(v){
    if (v==null) return null;
    if (typeof v === 'number') return v;
    let s = String(v).trim();
    if (s==='') return null;
    // trata formatos "1.234,56" ou "1234,56" ou "1234.56"
    if (/,\d{1,2}$/.test(s)) { // tem centavos com v√≠rgula
      s = s.replace(/\./g,'').replace(',','.');
    } else {
      s = s.replace(',','.');
    }
    const num = Number(s);
    return Number.isFinite(num) ? num : null;
  }

  async function parseSelectedFile(previewOnly=false){
    if (!selectedFile){ showBanner('Selecione um arquivo primeiro.', 'warn'); return; }
    importStats.innerHTML = '<span class="spinner" aria-hidden="true"></span> Lendo planilha...';

    try{
      const data = await selectedFile.arrayBuffer();
      const wb = XLSX.read(data, { type:'array' });
      const sheetName = wb.SheetNames[0];
      const ws = wb.Sheets[sheetName];

      // SheetJS -> array de objetos a partir do cabe√ßalho
      const rowsRaw = XLSX.utils.sheet_to_json(ws, { defval:null, raw:true });
      if (!rowsRaw.length){ importStats.textContent = 'Planilha vazia.'; return; }

      // Mapeia colunas do cabe√ßalho
      const headers = Object.keys(rowsRaw[0]);
      const map = {};
      headers.forEach(h=>{
        const dest = mapColumnName(h);
        if (dest) map[dest] = h;
      });

      // Verifica colunas requeridas
      const required = ['ean','descricao','preco_custo','preco_venda'];
      const missing = required.filter(k=>!map[k]);
      mapInfo.textContent = missing.length
        ? `Mapeamento parcial. Colunas ausentes: ${missing.join(', ')}`
        : 'Mapeamento OK: EAN, Descricao, PrecoCusto, PrecoVenda.';

      // Normaliza linhas
      const normalized = [];
      for (const r of rowsRaw){
        const ean = map.ean ? String(r[map.ean] ?? '').trim() : '';
        const eanDigits = digitsOnly(ean);
        const descricao = map.descricao ? String(r[map.descricao] ?? '').trim() : '';
        const preco_custo = toNumberBR(map.preco_custo ? r[map.preco_custo] : null);
        const preco_venda = toNumberBR(map.preco_venda ? r[map.preco_venda] : null);

        if (!eanDigits || !descricao) continue; // pula linhas incompletas
        normalized.push({ ean: eanDigits, descricao, preco_custo, preco_venda });
      }

      parsedRows = normalized;
      importStats.innerHTML = `Linhas lidas: <strong>${rowsRaw.length}</strong> ‚Ä¢ Linhas v√°lidas: <strong>${parsedRows.length}</strong>`;

      // Pr√©-visualiza√ß√£o (primeiras 12)
      const sample = parsedRows.slice(0, 12);
      if (sample.length){
        previewWrap.style.display = 'block';
        previewTable.innerHTML = '';
        const thead = document.createElement('thead');
        thead.innerHTML = '<tr><th>#</th><th>EAN</th><th>Descri√ß√£o</th><th>Pre√ßo custo</th><th>Pre√ßo venda</th></tr>';
        previewTable.appendChild(thead);
        const tbody = document.createElement('tbody');
        sample.forEach((r, i)=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${i+1}</td><td>${r.ean}</td><td>${r.descricao}</td><td>${r.preco_custo ?? ''}</td><td>${r.preco_venda ?? ''}</td>`;
          tbody.appendChild(tr);
        });
        previewTable.appendChild(tbody);
      } else {
        previewWrap.style.display = 'none';
        previewTable.innerHTML = '';
      }

      btnInserir.disabled = parsedRows.length === 0;
      showBanner(missing.length ? 'Algumas colunas n√£o foram encontradas; somente linhas completas ser√£o gravadas.' : 'Arquivo lido com sucesso!', missing.length ? 'warn' : 'ok');
    }catch(e){
      console.error(e);
      showBanner('Falha ao ler planilha. Verifique o arquivo.', 'err');
      importStats.textContent = 'Erro ao ler planilha.';
    }
  }

  btnPrever.addEventListener('click', ()=>parseSelectedFile(true));

  async function insertBatches(){
    if (!parsedRows.length){ showBanner('Nada para inserir. Fa√ßa a leitura primeiro.', 'warn'); return; }
    btnInserir.disabled = true;
    btnPrever.disabled = true;
    btnLimparImport.disabled = true;

    const BATCH = 500; // lote
    let ok = 0, fail = 0, pos = 0;

    showBanner('Inserindo registros em lotes...', 'ok', 3000);
    while (pos < parsedRows.length){
      const batch = parsedRows.slice(pos, pos + BATCH).map(r => ({
        user_id: sessionUser.id,
        ean: r.ean,
        descricao: r.descricao,
        preco_custo: r.preco_custo,
        preco_venda: r.preco_venda
      }));

      try{
        // Se voc√™ criar a UNIQUE (user_id, ean), pode trocar para upsert({ onConflict: 'user_id,ean' })
        const { error } = await sb.from('produtos_cliente').upsert(batch, { onConflict: 'user_id,ean' });
        if (error) throw error;
        ok += batch.length;
      }catch(err){
        console.error('Erro no lote', err);
        fail += batch.length;
      }
      pos += BATCH;
      importStats.innerHTML = `Progresso: ${Math.min(pos, parsedRows.length)} / ${parsedRows.length} ‚Ä¢ Sucesso: <span class="ok">${ok}</span> ‚Ä¢ Erros: <span class="err">${fail}</span>`;
    }

    if (fail === 0){
      showBanner(`Importa√ß√£o conclu√≠da: ${ok} registros inseridos/atualizados.`, 'ok', 6000);
    } else {
      showBanner(`Importa√ß√£o com falhas: ${ok} OK, ${fail} erros. Veja o console.`, 'warn', 8000);
    }

    btnPrever.disabled = false;
    btnLimparImport.disabled = false;
    btnInserir.disabled = false;
  }

  btnInserir.addEventListener('click', insertBatches);

  // Atalho: ao escolher arquivo, j√° habilita pr√©via
  fileRow.style.display = 'none';
  input.addEventListener('change', ()=>{ btnPrever.disabled = !input.files?.length; });

  // Inicial
  resetImport();
}

</script>

<script>
/* =========================================================
   SE√á√ÉO: Sele√ß√£o de Sites (tabela: sites; v√≠nculo: user_sites)
   ========================================================= */
const PLAN_LIMIT = { trial: 2, basico: 4, intermediario: 6, premium: 8 };

const sitesWrap  = document.getElementById('sitesWrap');
const limitInfo  = document.getElementById('limitInfo');
const counterEl  = document.getElementById('counter');
const btnSalvarSites = document.getElementById('btnSalvarSites');
const btnLimparSites = document.getElementById('btnLimparSites');

let planLimit = PLAN_LIMIT[currentPlan] ?? PLAN_LIMIT.trial;
let allSites = [];             // [{id, nome, site}]
let selectedIds = new Set();   // Set<number>

function cap(s){ return (s||'').charAt(0).toUpperCase() + (s||'').slice(1); }

async function initSitesSection(){
  planLimit = PLAN_LIMIT[currentPlan] ?? PLAN_LIMIT.trial;
  const pretty = cap(currentPlan).replace('Basico','B√°sico').replace('Intermediario','Intermedi√°rio');
  limitInfo.textContent = `Limite do plano (${pretty}): ${planLimit} site${planLimit>1?'s':''}`;

  await loadSites();
  await loadUserSelection();
  renderSites();
  updateCounter();
}

async function loadSites(){
  try{
    const { data, error } = await sb
      .from('sites')
      .select('id,nome,site')
      .order('nome', { ascending: true });
    if (error) throw error;
    allSites = data || [];
  }catch(e){
    console.error(e);
    allSites = [];
    showBanner('Erro ao carregar lista de sites (tabela "sites").', 'err');
  }
}

async function loadUserSelection(){
  try{
    const { data, error } = await sb
      .from('user_sites')           // (user_id uuid, site_id int)
      .select('site_id')
      .eq('user_id', sessionUser.id);
    if (error) throw error;
    selectedIds = new Set((data||[]).map(r => r.site_id));
  }catch(e){
    console.error(e);
    selectedIds = new Set();
    if (allSites.length) showBanner('N√£o foi poss√≠vel carregar sua sele√ß√£o anterior (tabela "user_sites").', 'warn', 5000);
  }
}

function renderSites(){
  sitesWrap.innerHTML = '';
  sitesWrap.setAttribute('aria-busy', 'true');

  if (!allSites.length){
    const empty = document.createElement('div');
    empty.className = 'muted';
    empty.textContent = 'Nenhum site dispon√≠vel cadastrado.';
    sitesWrap.appendChild(empty);
    sitesWrap.setAttribute('aria-busy', 'false');
    return;
  }

  const reached = selectedIds.size >= planLimit;

  for (const s of allSites){
    const checked = selectedIds.has(s.id);
    const disabled = !checked && reached;

    const wrap = document.createElement('label');
    wrap.className = 'site-item' + (disabled ? ' disabled' : '');
    wrap.htmlFor = `chk_${s.id}`;

    const chk = document.createElement('input');
    chk.type = 'checkbox';
    chk.id = `chk_${s.id}`;
    chk.value = String(s.id);
    chk.checked = checked;
    chk.disabled = disabled;
    chk.addEventListener('change', onToggleSite);

    const block = document.createElement('div');
    const title = document.createElement('div');
    title.className = 'site-title';
    title.textContent = s.nome || '(sem nome)';

    const url = document.createElement('div');
    url.className = 'site-url';
    const a = document.createElement('a');
    a.href = s.site || '#';
    a.target = '_blank';
    a.rel = 'noopener';
    a.textContent = s.site || '(sem URL)';
    url.appendChild(a);

    block.appendChild(title);
    block.appendChild(url);

    wrap.appendChild(chk);
    wrap.appendChild(block);
    sitesWrap.appendChild(wrap);
  }

  if (reached){
    showBanner(`Voc√™ atingiu o limite do seu plano (${planLimit}). Para marcar mais, desmarque algum ou atualize seu plano.`, 'warn', 3000);
  }

  sitesWrap.setAttribute('aria-busy', 'false');
}

function onToggleSite(ev){
  const id = Number(ev.target.value);
  if (ev.target.checked){
    if (selectedIds.size >= planLimit){
      ev.target.checked = false;
      showBanner(`Limite do plano (${planLimit}) atingido.`, 'warn', 2500);
      return;
    }
    selectedIds.add(id);
  } else {
    selectedIds.delete(id);
  }
  renderSites();
  updateCounter();
}

function updateCounter(){
  counterEl.textContent = `Selecionados: ${selectedIds.size} / ${planLimit}`;
}

btnLimparSites.addEventListener('click', ()=>{
  selectedIds.clear();
  renderSites();
  updateCounter();
});

btnSalvarSites.addEventListener('click', async ()=>{
  try{
    btnSalvarSites.disabled = true;

    // Apaga sele√ß√£o anterior do usu√°rio
    const { error: delErr } = await sb
      .from('user_sites')
      .delete()
      .eq('user_id', sessionUser.id);
    if (delErr) throw delErr;

    // Insere a sele√ß√£o atual (respeitando o limite)
    const ids = Array.from(selectedIds).slice(0, planLimit);
    if (ids.length){
      const payload = ids.map(site_id => ({ user_id: sessionUser.id, site_id }));
      const { error: insErr } = await sb.from('user_sites').insert(payload);
      if (insErr) throw insErr;
    }

    showBanner('Sele√ß√£o salva com sucesso!', 'ok');
  }catch(e){
    console.error(e);
    showBanner('Falha ao salvar sua sele√ß√£o. Verifique permiss√µes/RLS de "user_sites".', 'err');
  }finally{
    btnSalvarSites.disabled = false;
  }
});
</script>
</body>
</html>
