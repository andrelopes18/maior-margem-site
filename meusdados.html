<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Meus dados</title>
<style>
  :root { color-scheme: dark; }
  * { box-sizing: border-box; }
  body{background:#121212;color:#fff;font-family:Arial,sans-serif;padding:24px;margin:0}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;gap:12px;flex-wrap:wrap}
  h1{color:#00b140;margin:0}
  a{color:#00b140}
  .btn{display:inline-flex;align-items:center;gap:8px;background:#00b140;color:#fff;border:none;padding:10px 14px;border-radius:8px;text-decoration:none;cursor:pointer}
  .btn:hover{background:#009b38}
  .btn.outline{background:transparent;border:1px solid #2a2a2a;color:#ddd}
  .btn.outline:hover{background:#1b1b1b}

  .container{max-width:880px;margin:0 auto}
  .card{background:#0f0f0f;border:1px solid #2a2a2a;border-radius:12px;padding:18px}

  /* grade com mais respiro vertical */
  .grid{display:grid;grid-template-columns:1fr 1fr;column-gap:16px;row-gap:22px}

  .col-1{grid-column: span 1}
  .col-2{grid-column: span 2}
  @media (max-width: 720px){ .grid{grid-template-columns:1fr} .col-2{grid-column:span 1} }

  label{display:block;margin:4px 0 8px;color:#9aa0a6}

  /* campos: e-mail mais escuro (bloqueado), demais um pouco mais claros */
  input,select{
    width:100%;padding:12px 14px;border-radius:8px;border:1px solid #3a3a3a;
    background:#242424;color:#fff;font-size:15px;line-height:1.2
  }
  input[disabled]{
    background:#171717;border-color:#2a2a2a;color:#b5b5b5;cursor:not-allowed;
  }

  .help{font-size:12px;color:#9aa0a6;margin-top:6px}
  .help.error{color:#ff6666}

  .banner{border:1px solid #2a2a2a;border-radius:10px;padding:10px 12px;margin-bottom:14px;background:#111}
  .banner.warn{border-color:#5c3f00;background:#1b1300;color:#ffc966}
  .banner.ok{border-color:#214d21;background:#0e1a0e;color:#b7fbb7}
  .banner.err{border-color:#5c1e1e;background:#190d0d;color:#ff9a9a}
</style>
<script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<script src="./config.js"></script>
</head>
<body>
<header class="container">
  <h1>Meus dados</h1>
  <div class="actions" style="display:flex;gap:10px;flex-wrap:wrap">
    <a class="btn outline" href="dashboard.html">‚Üê Voltar ao dashboard</a>
    <button id="btnSair" class="btn">Sair</button>
  </div>
</header>

<main class="container">
  <div id="banner" class="banner" style="display:none"></div>

  <div class="card">
    <div class="grid">
      <div class="col-2">
        <label for="email">Email</label>
        <input id="email" type="email" placeholder="usuario@exemplo.com" disabled>
      </div>

      <div class="col-1">
        <label for="nome">Nome</label>
        <input id="nome" type="text" placeholder="Seu nome" autocomplete="given-name">
      </div>

      <div class="col-1">
        <label for="sobrenome">Sobrenome</label>
        <input id="sobrenome" type="text" placeholder="Seu sobrenome" autocomplete="family-name">
      </div>

      <div class="col-1">
        <label for="cpfCnpj">CPF ou CNPJ</label>
        <input id="cpfCnpj" type="text" inputmode="numeric" placeholder="CPF ou CNPJ">
        <div id="docHelp" class="help">Digite apenas n√∫meros; a formata√ß√£o aparece sozinha.</div>
      </div>

      <!-- Raz√£o Social (s√≥ aparece para CNPJ) -->
      <div id="razaoWrap" class="col-1" style="display:none">
        <label for="razaoSocial">Raz√£o social</label>
        <input id="razaoSocial" type="text" placeholder="Raz√£o social (para CNPJ)">
      </div>

      <div class="col-1">
        <label for="telefone">Telefone</label>
        <input id="telefone" type="tel" inputmode="tel" placeholder="(11) 91234-5678">
        <div id="telHelp" class="help">Formato BR (com DDD). Ex.: (11) 91234-5678</div>
      </div>

      <div class="col-1">
        <label for="plano">Plano escolhido</label>
        <select id="plano">
          <option value="trial">Trial</option>
          <option value="basico">B√°sico</option>
          <option value="intermediario">Intermedi√°rio</option>
          <option value="premium">Premium</option>
        </select>
      </div>

      <div class="col-2">
        <button id="btnSalvar" class="btn">üíæ Salvar</button>
      </div>
    </div>
  </div>
</main>

<script>
/* ========= Config & Supabase ========= */
const CFG = window.CONFIG || {};
const SUPABASE_URL = CFG.SUPABASE_URL;
const SUPABASE_ANON_KEY = CFG.SUPABASE_ANON_KEY;
if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
  alert("Erro de configura√ß√£o: config.js n√£o carregado.");
  throw new Error("CONFIG ausente");
}
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
});

/* ========= Refs ========= */
const emailEl = document.getElementById('email');
const nomeEl = document.getElementById('nome');
const sobrenomeEl = document.getElementById('sobrenome');
const cpfCnpjEl = document.getElementById('cpfCnpj');
const telefoneEl = document.getElementById('telefone');
const planoEl = document.getElementById('plano');
const razaoWrap = document.getElementById('razaoWrap');
const razaoSocialEl = document.getElementById('razaoSocial');

const btnSalvar = document.getElementById('btnSalvar');
const btnSair = document.getElementById('btnSair');

const bannerEl = document.getElementById('banner');
const telHelp = document.getElementById('telHelp');
const docHelp = document.getElementById('docHelp');

/* ========= Helpers UI ========= */
function showBanner(text, type = 'ok') {
  bannerEl.textContent = text;
  bannerEl.className = 'banner ' + (type === 'warn' ? 'warn' : (type === 'err' ? 'err' : 'ok'));
  bannerEl.style.display = 'block';
  setTimeout(() => { bannerEl.style.display = 'none'; }, 4200);
}
function digitsOnly(s){ return (s||'').replace(/\D+/g, ''); }

/* ========= M√°scaras e valida√ß√µes ========= */
// CPF
function formatCPF(d) {
  d = d.slice(0,11);
  if (d.length <= 3) return d;
  if (d.length <= 6) return d.replace(/(\d{3})(\d+)/, "$1.$2");
  if (d.length <= 9) return d.replace(/(\d{3})(\d{3})(\d+)/, "$1.$2.$3");
  return d.replace(/(\d{3})(\d{3})(\d{3})(\d{0,2}).*/, "$1.$2.$3-$4");
}
function validateCPF(d) {
  if (!d || d.length !== 11) return false;
  if (/^(\d)\1{10}$/.test(d)) return false;
  let sum = 0;
  for (let i=0;i<9;i++) sum += parseInt(d.charAt(i))*(10-i);
  let r = sum % 11; let dv1 = (r<2)?0:(11-r);
  if (dv1 !== parseInt(d.charAt(9))) return false;
  sum = 0;
  for (let i=0;i<10;i++) sum += parseInt(d.charAt(i))*(11-i);
  r = sum % 11; let dv2 = (r<2)?0:(11-r);
  return dv2 === parseInt(d.charAt(10));
}

// CNPJ
function formatCNPJ(d) {
  d = d.slice(0,14);
  if (d.length <= 2) return d;
  if (d.length <= 5) return d.replace(/(\d{2})(\d+)/, "$1.$2");
  if (d.length <= 8) return d.replace(/(\d{2})(\d{3})(\d+)/, "$1.$2.$3");
  if (d.length <= 12) return d.replace(/(\d{2})(\d{3})(\d{3})(\d+)/, "$1.$2.$3/$4");
  return d.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{0,2}).*/, "$1.$2.$3/$4-$5");
}
function validateCNPJ(d) {
  if (!d || d.length !== 14) return false;
  if (/^(\d)\1{13}$/.test(d)) return false;
  const w1 = [5,4,3,2,9,8,7,6,5,4,3,2];
  const w2 = [6,5,4,3,2,9,8,7,6,5,4,3,2];
  let sum = 0;
  for (let i=0;i<12;i++) sum += parseInt(d[i]) * w1[i];
  let r = sum % 11; let dv1 = (r<2)?0:(11-r);
  if (dv1 !== parseInt(d[12])) return false;
  sum = 0;
  for (let i=0;i<13;i++) sum += parseInt(d[i]) * w2[i];
  r = sum % 11; let dv2 = (r<2)?0:(11-r);
  return dv2 === parseInt(d[13]);
}

// Telefone BR (10 ou 11 d√≠gitos)
function formatPhone(d) {
  d = d.slice(0,11);
  if (d.length <= 2) return `(${d}`;
  if (d.length <= 6) return `(${d.slice(0,2)}) ${d.slice(2)}`;
  if (d.length <= 10) return `(${d.slice(0,2)}) ${d.slice(2,6)}-${d.slice(6)}`;
  return `(${d.slice(0,2)}) ${d.slice(2,7)}-${d.slice(7)}`;
}
function validatePhone(d){ return d.length === 10 || d.length === 11; }

/* CPF/CNPJ + m√°scara + mostrar/ocultar Raz√£o Social */
function updateDocUI() {
  let d = digitsOnly(cpfCnpjEl.value);
  const isCNPJ = d.length > 11;
  if (isCNPJ) {
    cpfCnpjEl.value = formatCNPJ(d);
    const ok = validateCNPJ(d);
    docHelp.textContent = ok ? 'CNPJ v√°lido.' : 'Digite 14 d√≠gitos para um CNPJ v√°lido.';
    docHelp.className = 'help' + (ok ? '' : ' error');
    razaoWrap.style.display = 'block';
  } else {
    cpfCnpjEl.value = formatCPF(d);
    const ok = validateCPF(d);
    docHelp.textContent = ok ? 'CPF v√°lido.' : 'Digite 11 d√≠gitos para um CPF v√°lido.';
    docHelp.className = 'help' + (ok ? '' : ' error');
    razaoWrap.style.display = 'none';
    razaoSocialEl.value = '';
  }
}
cpfCnpjEl.addEventListener('input', updateDocUI);

/* M√°scara telefone */
telefoneEl.addEventListener('input', () => {
  const d = digitsOnly(telefoneEl.value);
  telefoneEl.value = formatPhone(d);
  const ok = d.length === 0 || validatePhone(d);
  telHelp.textContent = ok ? 'Formato BR (com DDD).' : 'Telefone inv√°lido. Use 10 ou 11 d√≠gitos.';
  telHelp.className = 'help' + (ok ? '' : ' error');
});

/* ========= Auth + carregamento ========= */
let sessionUser = null;
(async function init(){
  const { data: { session } } = await sb.auth.getSession();
  if (!session) { window.location.href = CFG.SITE_URL || 'index.html'; return; }
  sessionUser = session.user;
  emailEl.value = session.user.email || '';

  try {
    const { data, error } = await sb
      .from('profiles')
      .select('first_name,last_name,cpf_cnpj,phone,plan,razao_social,cpf_cnpj_type')
      .eq('id', sessionUser.id)
      .maybeSingle();
    if (error) throw error;

    if (data) {
      nomeEl.value = data.first_name || '';
      sobrenomeEl.value = data.last_name || '';
      if (data.cpf_cnpj) {
        cpfCnpjEl.value = (data.cpf_cnpj_type === 'cnpj')
          ? formatCNPJ(data.cpf_cnpj) : formatCPF(data.cpf_cnpj);
        updateDocUI();
      }
      if (data.razao_social) {
        razaoSocialEl.value = data.razao_social;
        razaoWrap.style.display = 'block';
      }
      if (data.phone) telefoneEl.value = formatPhone(data.phone);
      if (data.plan)  planoEl.value = data.plan;
    } else {
      // Se n√£o existe registro, apenas mostra o formul√°rio vazio
    }
  } catch (e) {
    console.error(e);
    showBanner('Erro ao carregar dados (tabela "profiles" ausente?).', 'err');
  }
})();

/* ========= Sair ========= */
btnSair.addEventListener('click', async ()=>{
  await sb.auth.signOut();
  window.location.href = CFG.SITE_URL || 'index.html';
});

/* ========= Salvar (sempre na base) ========= */
btnSalvar.addEventListener('click', async ()=>{
  const first_name = nomeEl.value.trim();
  const last_name  = sobrenomeEl.value.trim();
  const docDigits  = digitsOnly(cpfCnpjEl.value);
  const phoneDigits= digitsOnly(telefoneEl.value);
  const plan       = planoEl.value;

  if (!first_name){ showBanner('Informe o Nome.', 'warn'); nomeEl.focus(); return; }
  if (!last_name){ showBanner('Informe o Sobrenome.', 'warn'); sobrenomeEl.focus(); return; }

  let docType = null, docOK = false;
  if (docDigits.length > 0 && docDigits.length <= 11) {
    docType = 'cpf'; docOK = validateCPF(docDigits);
  } else if (docDigits.length >= 12) {
    docType = 'cnpj'; docOK = validateCNPJ(docDigits);
  }
  if (!docOK){ showBanner('CPF/CNPJ inv√°lido.', 'warn'); cpfCnpjEl.focus(); return; }

  let razao_social = null;
  if (docType === 'cnpj') {
    razao_social = (razaoSocialEl.value || '').trim();
    if (!razao_social) { showBanner('Informe a Raz√£o social para CNPJ.', 'warn'); razaoSocialEl.focus(); return; }
  }

  if (phoneDigits && !validatePhone(phoneDigits)){
    showBanner('Telefone inv√°lido (use 10 ou 11 d√≠gitos).', 'warn'); telefoneEl.focus(); return;
  }

  const payload = {
    id: sessionUser.id,
    email: sessionUser.email,
    first_name,
    last_name,
    cpf_cnpj: docDigits,
    cpf_cnpj_type: docType,
    razao_social,
    phone: phoneDigits,
    plan
  };

  try {
    const { error } = await sb
      .from('profiles')
      .upsert(payload, { onConflict: 'id' });
    if (error) throw error;
    showBanner('Dados salvos com sucesso!', 'ok');
  } catch (e) {
    console.error(e);
    showBanner('Falha ao salvar na base. Verifique a tabela/privilegios.', 'err');
  }
});
</script>
</body>
</html>
