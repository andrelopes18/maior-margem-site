<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Meus dados</title>
<style>
  :root { color-scheme: dark; }
  * { box-sizing: border-box; }
  body{background:#121212;color:#fff;font-family:Arial,sans-serif;padding:24px;margin:0}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;gap:12px;flex-wrap:wrap}
  h1{color:#00b140;margin:0}
  a{color:#00b140;text-decoration:none}
  a:hover{text-decoration:underline}

  .btn{display:inline-flex;align-items:center;gap:8px;background:#00b140;color:#fff;border:none;padding:10px 14px;border-radius:8px;text-decoration:none;cursor:pointer}
  .btn:hover{background:#009b38}
  .btn.outline{background:transparent;border:1px solid #2a2a2a;color:#ddd}
  .btn.outline:hover{background:#1b1b1b}
  .btn.muted{background:#2a2a2a}
  .btn.muted:hover{background:#333}

  .chip{font-size:12px;background:#1e1e1e;border:1px solid #333;padding:6px 10px;border-radius:999px}
  .chip.plan{color:#bfffc1;border-color:#2f5a2f;background:#132313}

  .container{max-width:980px;margin:0 auto}
  .card{background:#0f0f0f;border:1px solid #2a2a2a;border-radius:12px;padding:18px;margin-bottom:16px}

  .grid{display:grid;grid-template-columns:1fr 1fr;column-gap:16px;row-gap:22px}
  .col-1{grid-column: span 1}
  .col-2{grid-column: span 2}
  @media (max-width: 720px){ .grid{grid-template-columns:1fr} .col-2{grid-column:span 1} }

  label{display:block;margin:4px 0 8px;color:#9aa0a6}

  input,select{
    width:100%;padding:12px 14px;border-radius:8px;border:1px solid #3a3a3a;
    background:#242424;color:#fff;font-size:15px;line-height:1.2
  }
  input[disabled], select[disabled]{
    background:#171717;border-color:#2a2a2a;color:#b5b5b5;cursor:not-allowed;
  }

  .help{font-size:12px;color:#9aa0a6;margin-top:6px}
  .help.error{color:#ff6666}

  .banner{border:1px solid #2a2a2a;border-radius:10px;padding:10px 12px;margin-bottom:14px;background:#111;display:none}
  .banner.warn{border-color:#5c3f00;background:#1b1300;color:#ffc966}
  .banner.ok{border-color:#214d21;background:#0e1a0e;color:#b7fbb7}
  .banner.err{border-color:#5c1e1e;background:#190d0d;color:#ff9a9a}

  /* ===== Se√ß√£o de sites ===== */
  .sites-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width: 840px){ .sites-grid{grid-template-columns:1fr} }
  .site-item{display:flex;align-items:flex-start;gap:12px;padding:12px;border:1px solid #232323;border-radius:10px;background:#121212}
  .site-item.disabled{opacity:0.55}
  .site-title{font-weight:bold;margin-bottom:4px}
  .site-url{font-size:12px;color:#9aa0a6;word-break:break-all}
  .muted{color:#9aa0a6;font-size:13px}
  .limit-info{font-size:13px;color:#b7fbb7;margin:6px 0 10px}
  .footer-actions{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-top:14px}
  .counter{font-size:13px;color:#9aa0a6}
  input[type="checkbox"]{width:18px;height:18px;margin-top:2px}

  /* ===== Importar Excel ===== */
  .dz{
    border:1px dashed #2a2a2a;border-radius:12px;background:#0e0e0e;
    padding:18px;text-align:center;transition:all .15s ease-in-out
  }
  .dz:hover{background:#121212}
  .dz.dragover{border-color:#00b140;background:#0d170f}
  .file-row{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-top:10px;flex-wrap:wrap}
  .file-name{font-size:14px;color:#ddd;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .spinner{width:16px;height:16px;border:2px solid #2a2a2a;border-top-color:#00b140;border-radius:50%;display:inline-block;animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}

  table.preview{width:100%;border-collapse:collapse;margin-top:10px;font-size:13px}
  table.preview th, table.preview td{border:1px solid #2a2a2a;padding:6px 8px;text-align:left}
  table.preview th{background:#161616;color:#bdbdbd}

  .map-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
  .map-item{border:1px solid #2a2a2a;border-radius:10px;padding:10px;background:#101010}
  .map-item h4{margin:0 0 8px 0;font-size:14px;color:#bdbdbd}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid #2a2a2a;color:#bdbdbd}
  .ok{color:#b7fbb7}
  .warn{color:#ffc966}
  .err{color:#ff9a9a}
</style>

<!-- Supabase -->
<script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<script src="./config.js"></script>
<!-- SheetJS (XLSX) -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
<header class="container">
  <h1>Meus dados</h1>
  <div class="actions" style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
    <span id="planChip" class="chip plan" title="Plano atual">Plano: ‚Äî</span>
    <a class="btn outline" href="dashboard.html">‚Üê Voltar ao dashboard</a>
    <button id="btnSair" class="btn">Sair</button>
  </div>
</header>

<main class="container">
  <div id="banner" class="banner"></div>

  <!-- ===== Perfil ===== -->
  <div class="card">
    <div class="grid">
      <div class="col-2">
        <label for="email">Email</label>
        <input id="email" type="email" placeholder="usuario@exemplo.com" disabled>
      </div>

      <div class="col-1">
        <label for="nome">Nome</label>
        <input id="nome" type="text" placeholder="Seu nome" autocomplete="given-name">
      </div>

      <div class="col-1">
        <label for="sobrenome">Sobrenome</label>
        <input id="sobrenome" type="text" placeholder="Seu sobrenome" autocomplete="family-name">
      </div>

      <div class="col-1">
        <label for="cpfCnpj">CPF ou CNPJ</label>
        <input id="cpfCnpj" type="text" inputmode="numeric" placeholder="CPF ou CNPJ">
        <div id="docHelp" class="help">Digite apenas n√∫meros; a formata√ß√£o aparece sozinha.</div>
      </div>

      <div id="razaoWrap" class="col-1" style="display:none">
        <label for="razaoSocial">Raz√£o social</label>
        <input id="razaoSocial" type="text" placeholder="Raz√£o social (para CNPJ)">
      </div>

      <div class="col-1">
        <label for="telefone">Telefone</label>
        <input id="telefone" type="tel" inputmode="tel" placeholder="(11) 91234-5678">
        <div id="telHelp" class="help">Formato BR (com DDD). Ex.: (11) 91234-5678</div>
      </div>

      <div class="col-1">
        <label for="plano">Plano escolhido</label>
        <select id="plano" disabled>
          <option value="trial">Trial</option>
          <option value="basico">B√°sico</option>
          <option value="intermediario">Intermedi√°rio</option>
          <option value="premium">Premium</option>
        </select>
        <div class="help">O plano √© alterado ao adquirir/alterar a assinatura nos <a href="planos.html">Planos</a>.</div>
      </div>

      <div class="col-2">
        <button id="btnSalvar" class="btn">üíæ Salvar</button>
      </div>
    </div>
  </div>

  <!-- ===== Importar produtos (Excel) ===== -->
  <div class="card" id="importCard">
    <h2 style="margin:0 0 8px 0;">Importar produtos (Excel) ‚Üí Gravar na base</h2>
    <p class="muted" style="margin-top:0">
      Esperado: <strong>ID Produto</strong>, <strong>EAN13</strong>, <strong>Descricao</strong>,
      <strong>Preco Custo</strong>, <strong>Preco Venda</strong>, <strong>Qtde Vendida</strong>.
      Obrigat√≥rias: <strong>EAN13</strong>, <strong>Descricao</strong>, <strong>Preco Venda</strong>.
    </p>

    <div class="dz" id="dropArea" aria-label="√Årea para arrastar e soltar arquivo">
      <div>Arraste e solte o arquivo aqui</div>
      <small>ou</small>
      <div style="margin-top:8px">
        <input id="fileExcel" type="file" accept=".xlsx,.xls,.csv" />
      </div>
      <small>Formatos: .xlsx, .xls, .csv ‚Ä¢ Usaremos as primeiras 10 linhas para detectar as colunas.</small>
    </div>

    <div class="file-row" id="fileRow" style="display:none">
      <div class="file-name" id="fileName">Nenhum arquivo selecionado</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button id="btnPrever" class="btn outline" disabled>üëÅÔ∏è Pr√©-visualizar & Detectar</button>
        <button id="btnInserir" class="btn" disabled>‚¨áÔ∏è Gravar na base</button>
        <button id="btnLimparImport" class="btn muted" disabled>Limpar</button>
      </div>
    </div>

    <div id="importStats" class="help" style="margin-top:8px"></div>

    <!-- Painel de mapeamento -->
    <div id="mapWrap" class="map-grid" style="display:none">
      <div class="map-item">
        <h4>Mapeamento de colunas</h4>
        <div class="row">
          <label class="help">ID Produto</label>
          <select id="sel_id_produto"></select>
        </div>
        <div class="row">
          <label class="help">EAN13 (obrigat√≥rio)</label>
          <select id="sel_ean13"></select>
        </div>
        <div class="row">
          <label class="help">Descri√ß√£o (obrigat√≥rio)</label>
          <select id="sel_descricao"></select>
        </div>
        <div class="row">
          <label class="help">Pre√ßo Custo</label>
          <select id="sel_preco_custo"></select>
        </div>
        <div class="row">
          <label class="help">Pre√ßo Venda (obrigat√≥rio)</label>
          <select id="sel_preco_venda"></select>
        </div>
        <div class="row">
          <label class="help">Qtde Vendida</label>
          <select id="sel_qtde_vendida"></select>
        </div>
        <div id="mapHints" class="help" style="margin-top:8px"></div>
      </div>
      <div class="map-item">
        <h4>Observa√ß√µes & Alertas</h4>
        <div id="mapAlerts" class="help"></div>
      </div>
    </div>

    <!-- Pr√©via -->
    <div id="previewWrap" style="margin-top:10px; display:none">
      <span class="badge">Pr√©via (primeiras 12 linhas)</span>
      <table class="preview" id="previewTable" aria-label="Pr√©-visualiza√ß√£o"></table>
    </div>
  </div>

  <!-- ===== Sele√ß√£o de sites ===== -->
  <div class="card" id="sitesCard">
    <h2 style="margin-top:0;margin-bottom:8px">Selecionar sites para monitorar</h2>
    <p class="muted" id="introSites">
      Marque os sites que deseja monitorar. O limite depende do seu plano.
      <a href="planos.html">Atualize o plano</a> para liberar mais sites.
    </p>
    <p class="limit-info" id="limitInfo">Limite do plano: ‚Äî</p>

    <div id="sitesWrap" class="sites-grid" aria-live="polite" aria-busy="true"></div>

    <div class="footer-actions">
      <div class="counter" id="counter">Selecionados: 0 / ‚Äî</div>
      <div style="display:flex; gap:10px; flex-wrap:wrap">
        <button id="btnLimparSites" class="btn outline">Limpar</button>
        <button id="btnSalvarSites" class="btn">üíæ Salvar sele√ß√£o</button>
      </div>
    </div>
  </div>
</main>

<script>
/* =========================
   Config / Supabase Client
   ========================= */
const CFG = window.CONFIG || {};
const SUPABASE_URL = CFG.SUPABASE_URL;
const SUPABASE_ANON_KEY = CFG.SUPABASE_ANON_KEY;
if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
  alert("Erro de configura√ß√£o: config.js n√£o carregado.");
  throw new Error("CONFIG ausente");
}
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
});

/* =========================
   Utilidades
   ========================= */
const bannerEl = document.getElementById('banner');
function showBanner(text, type = 'ok', timeoutMs = 4200) {
  bannerEl.textContent = text;
  bannerEl.className = 'banner ' + (type === 'warn' ? 'warn' : (type === 'err' ? 'err' : 'ok'));
  bannerEl.style.display = 'block';
  if (timeoutMs > 0) setTimeout(() => { bannerEl.style.display = 'none'; }, timeoutMs);
}
function digitsOnly(s){ return (s||'').replace(/\D+/g, ''); }
function toNumberBR(v){
  if (v==null) return null;
  if (typeof v === 'number') return v;
  let s = String(v).trim();
  if (s==='') return null;
  if (/,\d{1,3}$/.test(s)) { s = s.replace(/\./g,'').replace(',','.'); }
  else { s = s.replace(',','.'); }
  const num = Number(s);
  return Number.isFinite(num) ? num : null;
}

/* ======== Perfil ======== */
const emailEl = document.getElementById('email');
const nomeEl = document.getElementById('nome');
const sobrenomeEl = document.getElementById('sobrenome');
const cpfCnpjEl = document.getElementById('cpfCnpj');
const telefoneEl = document.getElementById('telefone');
const planoEl = document.getElementById('plano');
const razaoWrap = document.getElementById('razaoWrap');
const razaoSocialEl = document.getElementById('razaoSocial');
const btnSalvar = document.getElementById('btnSalvar');
const btnSair = document.getElementById('btnSair');
const planChip = document.getElementById('planChip');
const telHelp = document.getElementById('telHelp');
const docHelp = document.getElementById('docHelp');

function formatCPF(d){ d=d.slice(0,11); if(d.length<=3)return d; if(d.length<=6)return d.replace(/(\d{3})(\d+)/,"$1.$2"); if(d.length<=9)return d.replace(/(\d{3})(\d{3})(\d+)/,"$1.$2.$3"); return d.replace(/(\d{3})(\d{3})(\d{3})(\d{0,2}).*/,"$1.$2.$3-$4"); }
function validateCPF(d){ if(!d||d.length!==11)return false; if(/^(\d)\1{10}$/.test(d))return false; let s=0; for(let i=0;i<9;i++)s+=parseInt(d[i])*(10-i); let r=s%11; let dv1=(r<2)?0:(11-r); if(dv1!==parseInt(d[9]))return false; s=0; for(let i=0;i<10;i++)s+=parseInt(d[i])*(11-i); r=s%11; let dv2=(r<2)?0:(11-r); return dv2===parseInt(d[10]); }
function formatCNPJ(d){ d=d.slice(0,14); if(d.length<=2)return d; if(d.length<=5)return d.replace(/(\d{2})(\d+)/,"$1.$2"); if(d.length<=8)return d.replace(/(\d{2})(\d{3})(\d+)/,"$1.$2.$3"); if(d.length<=12)return d.replace(/(\d{2})(\d{3})(\d{3})(\d+)/,"$1.$2.$3/$4"); return d.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{0,2}).*/,"$1.$2.$3/$4-$5"); }
function validateCNPJ(d){ if(!d||d.length!==14)return false; if(/^(\d)\1{13}$/.test(d))return false; const w1=[5,4,3,2,9,8,7,6,5,4,3,2], w2=[6,5,4,3,2,9,8,7,6,5,4,3,2]; let s=0; for(let i=0;i<12;i++)s+=parseInt(d[i])*w1[i]; let r=s%11; let dv1=(r<2)?0:(11-r); if(dv1!==parseInt(d[12]))return false; s=0; for(let i=0;i<13;i++)s+=parseInt(d[i])*w2[i]; r=s%11; let dv2=(r<2)?0:(11-r); return dv2===parseInt(d[13]); }
function formatPhone(d){ d=d.slice(0,11); if(d.length<=2)return `(${d}`; if(d.length<=6)return `(${d.slice(0,2)}) ${d.slice(2)}`; if(d.length<=10)return `(${d.slice(0,2)}) ${d.slice(2,6)}-${d.slice(6)}`; return `(${d.slice(0,2)}) ${d.slice(2,7)}-${d.slice(7)}`; }
function validatePhone(d){ return d.length===10||d.length===11; }
function updateDocUI(){
  let d = digitsOnly(cpfCnpjEl.value);
  const isCNPJ = d.length>11;
  if(isCNPJ){ cpfCnpjEl.value = formatCNPJ(d); const ok=validateCNPJ(d); docHelp.textContent= ok?'CNPJ v√°lido.':'Digite 14 d√≠gitos para um CNPJ v√°lido.'; docHelp.className='help'+(ok?'':' error'); razaoWrap.style.display='block'; }
  else { cpfCnpjEl.value = formatCPF(d); const ok=validateCPF(d); docHelp.textContent= ok?'CPF v√°lido.':'Digite 11 d√≠gitos para um CPF v√°lido.'; docHelp.className='help'+(ok?'':' error'); razaoWrap.style.display='none'; razaoSocialEl.value=''; }
}
cpfCnpjEl.addEventListener('input', updateDocUI);
telefoneEl.addEventListener('input', ()=>{ const d=digitsOnly(telefoneEl.value); telefoneEl.value=formatPhone(d); const ok=d.length===0||validatePhone(d); telHelp.textContent= ok?'Formato BR (com DDD).':'Telefone inv√°lido. Use 10 ou 11 d√≠gitos.'; telHelp.className='help'+(ok?'':' error'); });

let sessionUser = null;
let currentPlan = 'trial';

(async function initPerfil(){
  const { data: { session } } = await sb.auth.getSession();
  if (!session) { window.location.href = CFG.SITE_URL || 'index.html'; return; }
  sessionUser = session.user;
  emailEl.value = session.user.email || '';
  try{
    const { data: prof, error: e1 } = await sb
      .from('profiles')
      .select('first_name,last_name,cpf_cnpj,phone,plan,razao_social,cpf_cnpj_type')
      .eq('id', sessionUser.id)
      .maybeSingle();
    if (e1) throw e1;

    if (prof){
      nomeEl.value = prof.first_name || '';
      sobrenomeEl.value = prof.last_name || '';
      if (prof.cpf_cnpj) { cpfCnpjEl.value = (prof.cpf_cnpj_type === 'cnpj') ? formatCNPJ(prof.cpf_cnpj) : formatCPF(prof.cpf_cnpj); updateDocUI(); }
      if (prof.razao_social) { razaoSocialEl.value = prof.razao_social; razaoWrap.style.display = 'block'; }
      if (prof.phone) telefoneEl.value = formatPhone(prof.phone);
      currentPlan = (prof.plan || 'basico').toString();
      planoEl.value = currentPlan;
      const pretty = currentPlan.charAt(0).toUpperCase() + currentPlan.slice(1);
      const prettyBR = pretty.replace('Basico','B√°sico').replace('Intermediario','Intermedi√°rio');
      planChip.textContent = `Plano: ${prettyBR}`;
    }

    await initSitesSection();
    initExcelImport();
  }catch(e){
    console.error(e);
    showBanner('Erro ao carregar dados (tabela "profiles").', 'err');
    await initSitesSection();
    initExcelImport();
  }
})();

btnSair.addEventListener('click', async ()=>{ await sb.auth.signOut(); window.location.href = CFG.SITE_URL || 'index.html'; });
btnSalvar.addEventListener('click', async ()=>{
  const first_name = nomeEl.value.trim();
  const last_name  = sobrenomeEl.value.trim();
  const docDigits  = digitsOnly(cpfCnpjEl.value);
  const phoneDigits= digitsOnly(telefoneEl.value);
  if (!first_name){ showBanner('Informe o Nome.', 'warn'); nomeEl.focus(); return; }
  if (!last_name){ showBanner('Informe o Sobrenome.', 'warn'); sobrenomeEl.focus(); return; }
  let docType=null, docOK=false;
  if (docDigits.length>0 && docDigits.length<=11){ docType='cpf'; docOK=validateCPF(docDigits); }
  else if (docDigits.length>=12){ docType='cnpj'; docOK=validateCNPJ(docDigits); }
  if (!docOK){ showBanner('CPF/CNPJ inv√°lido.', 'warn'); cpfCnpjEl.focus(); return; }
  let razao_social=null;
  if (docType==='cnpj'){ razao_social=(razaoSocialEl.value||'').trim(); if(!razao_social){ showBanner('Informe a Raz√£o social para CNPJ.', 'warn'); razaoSocialEl.focus(); return; } }
  if (phoneDigits && !validatePhone(phoneDigits)){ showBanner('Telefone inv√°lido (use 10 ou 11 d√≠gitos).', 'warn'); telefoneEl.focus(); return; }

  const payload={ id:sessionUser.id, email:sessionUser.email, first_name, last_name, cpf_cnpj:docDigits, cpf_cnpj_type:docType, razao_social, phone:phoneDigits };
  try{ const { error } = await sb.from('profiles').upsert(payload,{onConflict:'id'}); if(error) throw error; showBanner('Dados salvos com sucesso!','ok'); }
  catch(e){ console.error(e); showBanner('Falha ao salvar na base. Verifique a tabela/privilegios.','err'); }
});

/* =========================================================
   Importar Excel ‚Üí detec√ß√£o inteligente ‚Üí UPSERT
   ========================================================= */
function initExcelImport(){
  const input = document.getElementById('fileExcel');
  const dropArea = document.getElementById('dropArea');
  const fileRow = document.getElementById('fileRow');
  const fileNameEl = document.getElementById('fileName');
  const btnPrever = document.getElementById('btnPrever');
  const btnInserir = document.getElementById('btnInserir');
  const btnLimparImport = document.getElementById('btnLimparImport');
  const importStats = document.getElementById('importStats');
  const previewWrap = document.getElementById('previewWrap');
  const previewTable = document.getElementById('previewTable');
  const mapWrap = document.getElementById('mapWrap');
  const mapAlerts = document.getElementById('mapAlerts');
  const mapHints = document.getElementById('mapHints');

  const sel_id_produto   = document.getElementById('sel_id_produto');
  const sel_ean13        = document.getElementById('sel_ean13');
  const sel_descricao    = document.getElementById('sel_descricao');
  const sel_preco_custo  = document.getElementById('sel_preco_custo');
  const sel_preco_venda  = document.getElementById('sel_preco_venda');
  const sel_qtde_vendida = document.getElementById('sel_qtde_vendida');

  let selectedFile = null;
  let rowsAll = [];     // objetos da planilha
  let headers = [];     // nomes das colunas
  let mapping = {};     // mapeamento atual
  let parsedRows = [];  // normalizados

  function resetImport(){
    selectedFile = null; rowsAll=[]; headers=[]; mapping={}; parsedRows=[];
    fileNameEl.textContent = 'Nenhum arquivo selecionado';
    fileRow.style.display = 'none';
    btnPrever.disabled = true; btnInserir.disabled = true; btnLimparImport.disabled = true;
    importStats.textContent = ''; previewWrap.style.display = 'none'; previewTable.innerHTML = '';
    mapWrap.style.display = 'none'; mapAlerts.innerHTML = ''; mapHints.textContent = '';
    input.value = '';
  }

  function setFile(file){
    if (!file){ resetImport(); return; }
    const okExt = /\.(xlsx|xls|csv)$/i.test(file.name);
    if (!okExt){ showBanner('Formato inv√°lido. Use .xlsx, .xls ou .csv', 'warn'); return; }
    selectedFile = file;
    fileNameEl.textContent = `${file.name} ‚Ä¢ ${(file.size/1024/1024).toFixed(2)} MB`;
    fileRow.style.display='flex';
    btnPrever.disabled = false; btnLimparImport.disabled = true; btnInserir.disabled = true;
    importStats.textContent = 'Pronto para ler e detectar colunas.';
  }

  input.addEventListener('change', e=>{ setFile(e.target.files?.[0] || null); });
  ;['dragenter','dragover'].forEach(evt=> dropArea.addEventListener(evt, e=>{ e.preventDefault(); e.stopPropagation(); dropArea.classList.add('dragover'); }));
  ;['dragleave','drop'].forEach(evt=> dropArea.addEventListener(evt, e=>{ e.preventDefault(); e.stopPropagation(); dropArea.classList.remove('dragover'); }));
  dropArea.addEventListener('drop', e=>{ const f = e.dataTransfer?.files?.[0]; setFile(f||null); });
  btnLimparImport.addEventListener('click', resetImport);

  /* ---------- Heur√≠sticas & auxiliares ---------- */
  function normHeader(h){ return String(h||'').trim(); }
  const RX_ID  = /(^|\W)(id|sku|codigo|c[o√≥]digo|ref|referencia)(\W|$)/i;
  const RX_QTY = /(qtde|qtd|quant|quantidade|vendid[ao]|volume|vol\.)/i;
  const RX_VENDA = /(venda|preco\s*venda|p\.?\s*venda|pvenda)/i;
  const RX_CUSTO = /(custo|preco\s*custo|p\.?\s*custo|pcusto|compra)/i;

  function headerGuessMap(h){
    const n = normHeader(h).toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
    if (/(^id(\s|_|-)*produto$|^id$|codigo(\s|_|-)*(interno)?$|sku|ref(erencia)?)/.test(n)) return 'id_produto';
    if (/^(ean13|ean|codigo(\s|_|-)*barras|cod(\.|igo)?(\s|_|-)*barras)$/.test(n)) return 'ean13';
    if (/^(descricao|descri√ß√£o|produto|item|nome(\s|_|-)*produto)$/.test(n)) return 'descricao';
    if (RX_CUSTO.test(n)) return 'preco_custo';
    if (RX_VENDA.test(n) || /^preco$/.test(n)) return 'preco_venda';
    if (RX_QTY.test(n)) return 'qtde_vendida';
    return null;
  }

  function isLetters(val){ return /[A-Za-z√Å-√ö√°-√∫]/.test(String(val||'')); }
  function isIntegerLike(val){
    if (val==null || val==='') return false;
    if (typeof val==='number') return Number.isInteger(val);
    const s=String(val).replace(/\s+/g,'');
    return /^-?\d+$/.test(s);
  }
  function isDecimalLike(val){
    if (val==null || val==='') return false;
    if (typeof val==='number') return !Number.isNaN(val) && !Number.isInteger(val);
    const s=String(val).trim();
    return /^-?\d[\d\.]*,\d{1,3}$/.test(s) || /^-?\d[\d,]*\.\d{1,3}$/.test(s);
  }
  function asDigits(val){ return digitsOnly(String(val||'')); }
  function looksEAN13(val){ const d=asDigits(val); return d.length===13; }
  function looksPrice(val){ const n=toNumberBR(val); return n!=null && n>=0 && n<=1e7; }
  function looksQty(val){ const n=toNumberBR(val); return n!=null && n>=0 && n<=1e6; }
  function distinctRatio(values){
    const valid = values.filter(v => v!=null && String(v).trim()!=='');
    if (!valid.length) return 0;
    const set = new Set(valid.map(v => String(v)));
    return set.size / valid.length;
  }

  function detectMapping(sampleRows){
    const cols = headers;
    const stats = cols.map((h,idx)=>{
      let letters=0,intLike=0,decLike=0,eanLike=0,priceLike=0,qtyLike=0,nonEmpty=0, samples=[];
      for (const r of sampleRows){
        const v = r[h];
        if (v!==null && v!==undefined && String(v).trim()!=='') nonEmpty++;
        if (isLetters(v)) letters++;
        if (isIntegerLike(v)) intLike++;
        if (isDecimalLike(v)) decLike++;
        if (looksEAN13(v)) eanLike++;
        if (looksPrice(v)) priceLike++;
        if (looksQty(v)) qtyLike++;
        samples.push(v);
      }
      const hdr = normHeader(h);
      return {
        h, idx, nonEmpty, letters, intLike, decLike, eanLike, priceLike, qtyLike, samples,
        isIdHeader: RX_ID.test(hdr),
        isQtyHeader: RX_QTY.test(hdr),
        isVendaHeader: RX_VENDA.test(hdr),
        isCustoHeader: RX_CUSTO.test(hdr),
        distinct: distinctRatio(samples)
      };
    });

    const result = { id_produto:null, ean13:null, descricao:null, preco_custo:null, preco_venda:null, qtde_vendida:null, alerts:[], hints:[] };

    // 1) mapeamento imediato por nome
    for (const s of stats){
      const g = headerGuessMap(s.h);
      if (g && !result[g]) result[g]=s.h;
    }

    // 2) descri√ß√£o: mais "letters"
    if (!result.descricao){
      const cand = [...stats].sort((a,b)=> (b.letters - a.letters) || (b.nonEmpty - a.nonEmpty))[0];
      if (cand && cand.letters>0) result.descricao = cand.h;
    }

    // 3) EAN13: mais matches de 13 d√≠gitos
    if (!result.ean13){
      const cand = [...stats].sort((a,b)=> (b.eanLike - a.eanLike) || (b.nonEmpty - a.nonEmpty))[0];
      if (cand && cand.eanLike>0) result.ean13 = cand.h;
    }

    // 4) pre√ßos: honrar cabe√ßalho primeiro
    if (!result.preco_venda){
      const vendaHdr = stats.filter(s=> s.isVendaHeader);
      if (vendaHdr[0]) result.preco_venda = vendaHdr[0].h;
    }
    if (!result.preco_custo){
      const custoHdr = stats.filter(s=> s.isCustoHeader);
      if (custoHdr[0]) result.preco_custo = custoHdr[0].h;
    }
    // fallback: price-like
    const prices = stats.filter(s=> s.priceLike>0 && s.h!==result.ean13);
    prices.sort((a,b)=> (b.priceLike - a.priceLike) || (b.decLike - a.decLike));
    if (!result.preco_venda && prices[0]) result.preco_venda = prices[0].h;
    if (!result.preco_custo && prices[1]) result.preco_custo = prices[1].h;

    // 5) ID vs Qtde: usar cabe√ßalho primeiro, depois heur√≠stica de "distintos"
    if (!result.id_produto){
      const idHdrs = stats.filter(s=> s.isIdHeader && s.eanLike===0);
      if (idHdrs[0]) result.id_produto = idHdrs.sort((a,b)=> b.distinct - a.distinct)[0].h;
    }
    if (!result.qtde_vendida){
      const qtyHdrs = stats.filter(s=> s.isQtyHeader && s.h!==result.preco_venda && s.h!==result.preco_custo);
      if (qtyHdrs[0]) result.qtde_vendida = qtyHdrs[0].h;
    }
    // se ainda amb√≠guo, decidir pelos num√©ricos
    if (!result.id_produto || !result.qtde_vendida){
      const numericCols = stats.filter(s=> s.eanLike===0 && (s.intLike>0 || s.qtyLike>0) && s.h!==result.preco_venda && s.h!==result.preco_custo);
      // ordenar por "mais distintos" para ID
      const byDistinct = [...numericCols].sort((a,b)=> (b.distinct - a.distinct) || (b.intLike - a.intLike));
      if (!result.id_produto && byDistinct[0]) result.id_produto = byDistinct[0].h;
      // para qty: descartar o j√° escolhido como id e pegar resto com mais qtyLike / menos distintos
      const forQty = numericCols.filter(s=> s.h!==result.id_produto).sort((a,b)=> (b.qtyLike - a.qtyLike) || (a.distinct - b.distinct));
      if (!result.qtde_vendida && forQty[0]) result.qtde_vendida = forQty[0].h;
    }

    // obrigat√≥rios
    if (!result.ean13) result.alerts.push('N√£o foi poss√≠vel identificar com seguran√ßa a coluna EAN13 (13 d√≠gitos). Selecione manualmente.');
    if (!result.descricao) result.alerts.push('N√£o foi poss√≠vel identificar com seguran√ßa a coluna Descri√ß√£o. Selecione manualmente.');
    if (!result.preco_venda) result.alerts.push('N√£o foi poss√≠vel identificar com seguran√ßa a coluna Pre√ßo de Venda. Selecione manualmente.');

    // dica custo ‚â§ venda
    if (result.preco_custo && result.preco_venda){
      let inversoes = 0, comp = 0;
      for (const r of sampleRows){
        const vc = toNumberBR(r[result.preco_custo]);
        const vv = toNumberBR(r[result.preco_venda]);
        if (vc!=null && vv!=null){ comp++; if (vc>vv) inversoes++; }
      }
      if (comp>0 && inversoes/comp>0.3){
        result.hints.push('Mais de 30% dos exemplos t√™m Custo > Venda. Verifique se as colunas de pre√ßo foram trocadas.');
      }
    }
    return result;
  }

  function fillSelectOptions(select, items, selected){
    select.innerHTML = '';
    const opNone = document.createElement('option'); opNone.value=''; opNone.textContent='(n√£o usar)';
    select.appendChild(opNone);
    for (const h of items){
      const o = document.createElement('option');
      o.value = h; o.textContent = h;
      if (selected && selected===h) o.selected = true;
      select.appendChild(o);
    }
  }
  function buildMappingUI(map){
    mapWrap.style.display = 'grid';
    mapAlerts.innerHTML = map.alerts.length
      ? ('<ul>'+map.alerts.map(a=>`<li class="warn">${a}</li>`).join('')+'</ul>')
      : '<span class="ok">Mapeamento autom√°tico parece consistente.</span>';
    mapHints.textContent = map.hints.join(' ‚Ä¢ ');

    const H = headers;
    fillSelectOptions(sel_id_produto,   H, map.id_produto||'');
    fillSelectOptions(sel_ean13,        H, map.ean13||'');
    fillSelectOptions(sel_descricao,    H, map.descricao||'');
    fillSelectOptions(sel_preco_custo,  H, map.preco_custo||'');
    fillSelectOptions(sel_preco_venda,  H, map.preco_venda||'');
    fillSelectOptions(sel_qtde_vendida, H, map.qtde_vendida||'');

    function onChange(){
      mapping = {
        id_produto  : sel_id_produto.value || null,
        ean13       : sel_ean13.value || null,
        descricao   : sel_descricao.value || null,
        preco_custo : sel_preco_custo.value || null,
        preco_venda : sel_preco_venda.value || null,
        qtde_vendida: sel_qtde_vendida.value || null,
      };
      const okRequired = !!(mapping.ean13 && mapping.descricao && mapping.preco_venda);
      btnInserir.disabled = !okRequired || !rowsAll.length;
      btnLimparImport.disabled = false;
    }
    [sel_id_produto, sel_ean13, sel_descricao, sel_preco_custo, sel_preco_venda, sel_qtde_vendida]
      .forEach(el=> el.addEventListener('change', onChange));
    onChange();
  }

  async function parseAndDetect(){
    if (!selectedFile){ showBanner('Selecione um arquivo primeiro.','warn'); return; }
    importStats.innerHTML = '<span class="spinner"></span> Lendo planilha...';
    try{
      const data = await selectedFile.arrayBuffer();
      const wb = XLSX.read(data, { type:'array' });
      const ws = wb.Sheets[wb.SheetNames[0]];
      rowsAll = XLSX.utils.sheet_to_json(ws, { defval:null, raw:true });
      if (!rowsAll.length){ importStats.textContent = 'Planilha vazia.'; return; }
      headers = Object.keys(rowsAll[0]).map(normHeader);
      importStats.innerHTML = `Linhas totais: <strong>${rowsAll.length}</strong> | Colunas: <strong>${headers.length}</strong>`;

      const sample = rowsAll.slice(0, 10);
      const detected = detectMapping(sample);
      mapping = detected;
      buildMappingUI(detected);

      // pr√©via
      const samplePreview = rowsAll.slice(0, 12);
      previewWrap.style.display = 'block';
      previewTable.innerHTML = '';
      const thead = document.createElement('thead');
      thead.innerHTML = '<tr>'+headers.map(h=>`<th>${h}</th>`).join('')+'</tr>';
      previewTable.appendChild(thead);
      const tbody = document.createElement('tbody');
      samplePreview.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = headers.map(h=>`<td>${r[h]??''}</td>`).join('');
        tbody.appendChild(tr);
      });
      previewTable.appendChild(tbody);

      btnLimparImport.disabled = false;
      const okRequired = !!(mapping.ean13 && mapping.descricao && mapping.preco_venda);
      btnInserir.disabled = !okRequired;
      showBanner(detected.alerts.length ? 'Mapeamento parcial detectado ‚Äî ajuste nos selects.' : 'Mapeamento detectado com sucesso!', detected.alerts.length ? 'warn' : 'ok');
    }catch(e){
      console.error(e);
      showBanner('Falha ao ler planilha. Verifique o arquivo.','err');
      importStats.textContent = 'Erro ao ler planilha.';
    }
  }
  btnPrever.addEventListener('click', parseAndDetect);

  function normalizeRows(){
    const M = mapping;
    const out = [];
    for (const r of rowsAll){
      const ean = M.ean13 ? digitsOnly(r[M.ean13]) : '';
      const descricao = M.descricao ? String(r[M.descricao] ?? '').trim() : '';
      const preco_venda = M.preco_venda ? toNumberBR(r[M.preco_venda]) : null;
      const preco_custo = M.preco_custo ? toNumberBR(r[M.preco_custo]) : null;
      const id_produto  = M.id_produto ? String(r[M.id_produto] ?? '').trim() : null;
      const qtde_vendida= M.qtde_vendida ? toNumberBR(r[M.qtde_vendida]) : null;

      if (!ean || ean.length!==13) continue;
      if (!descricao) continue;
      if (preco_venda==null) continue;

      let pv = preco_venda, pc = preco_custo;
      if (pc!=null && pv!=null && pc>pv){ [pc,pv] = [pv,pc]; }

      out.push({
        user_id: sessionUser.id,
        ean13: ean,
        descricao,
        preco_custo: pc,
        preco_venda: pv,
        id_produto: id_produto && id_produto!=='' ? id_produto : null,
        qtde_vendida: qtde_vendida
      });
    }
    return out;
  }

  async function insertBatches(){
    try{
      if (!rowsAll.length){ showBanner('Nada para inserir. Fa√ßa a leitura primeiro.','warn'); return; }
      const requiredOk = !!(mapping.ean13 && mapping.descricao && mapping.preco_venda);
      if (!requiredOk){ showBanner('Mapeie EAN13, Descri√ß√£o e Pre√ßo de Venda para prosseguir.','warn'); return; }

      parsedRows = normalizeRows();
      if (!parsedRows.length){
        showBanner('Nenhuma linha v√°lida ap√≥s normaliza√ß√£o (verifique EAN13/Descri√ß√£o/Pre√ßo de Venda).','warn', 6000);
        return;
      }

      btnInserir.disabled = true; btnPrever.disabled = true; btnLimparImport.disabled = true;
      showBanner(`Inserindo ${parsedRows.length} registro(s) em lotes...`, 'ok', 3000);

      const BATCH = 500;
      let ok = 0, fail = 0, pos = 0, lastErr = null;

      while (pos < parsedRows.length){
        const batch = parsedRows.slice(pos, pos+BATCH);
        try{
          const { error } = await sb
            .from('produtos_cliente')
            .upsert(batch, { onConflict: 'user_id,ean13', returning: 'minimal' });
          if (error) throw error;
          ok += batch.length;
        }catch(err){
          console.error('Erro no lote:', err);
          lastErr = err;
          fail += batch.length;
        }
        pos += BATCH;
        importStats.innerHTML = `Progresso: ${Math.min(pos, parsedRows.length)} / ${parsedRows.length} ‚Ä¢ Sucesso: <span class="ok">${ok}</span> ‚Ä¢ Erros: <span class="err">${fail}</span>`;
      }

      if (fail===0){
        showBanner(`Importa√ß√£o conclu√≠da: ${ok} registro(s) inserido(s)/atualizado(s).`, 'ok', 7000);
      } else {
        const msg = lastErr?.message || 'Erro n√£o informado';
        showBanner(`Importa√ß√£o com falhas: ${ok} OK, ${fail} erro(s). Detalhe: ${msg}`, 'err', 9000);
      }
    }catch(e){
      console.error('Falha geral na importa√ß√£o:', e);
      showBanner(`Falha geral: ${e?.message || e}`, 'err', 9000);
    }finally{
      btnInserir.disabled = false; btnPrever.disabled = false; btnLimparImport.disabled = false;
    }
  }
  btnInserir.addEventListener('click', insertBatches);
}

/* =========================================================
   Sele√ß√£o de Sites
   ========================================================= */
const PLAN_LIMIT = { trial: 2, basico: 4, intermediario: 6, premium: 8 };
const sitesWrap  = document.getElementById('sitesWrap');
const limitInfo  = document.getElementById('limitInfo');
const counterEl  = document.getElementById('counter');
const btnSalvarSites = document.getElementById('btnSalvarSites');
const btnLimparSites = document.getElementById('btnLimparSites');

let planLimit = PLAN_LIMIT[currentPlan] ?? PLAN_LIMIT.trial;
let allSites = [];
let selectedIds = new Set();

function cap(s){ return (s||'').charAt(0).toUpperCase() + (s||'').slice(1); }

async function initSitesSection(){
  planLimit = PLAN_LIMIT[currentPlan] ?? PLAN_LIMIT.trial;
  const pretty = cap(currentPlan).replace('Basico','B√°sico').replace('Intermediario','Intermedi√°rio');
  limitInfo.textContent = `Limite do plano (${pretty}): ${planLimit} site${planLimit>1?'s':''}`;

  await loadSites(); await loadUserSelection(); renderSites(); updateCounter();
}
async function loadSites(){
  try{
    const { data, error } = await sb.from('sites').select('id,nome,site').order('nome',{ascending:true});
    if (error) throw error;
    allSites = data||[];
  }catch(e){ console.error(e); allSites=[]; showBanner('Erro ao carregar lista de sites (tabela "sites").','err'); }
}
async function loadUserSelection(){
  try{
    const { data, error } = await sb.from('user_sites').select('site_id').eq('user_id', sessionUser.id);
    if (error) throw error;
    selectedIds = new Set((data||[]).map(r=>r.site_id));
  }catch(e){ console.error(e); selectedIds=new Set(); if (allSites.length) showBanner('N√£o foi poss√≠vel carregar sua sele√ß√£o anterior (tabela "user_sites").','warn', 5000); }
}
function renderSites(){
  sitesWrap.innerHTML = '';
  sitesWrap.setAttribute('aria-busy','true');
  if (!allSites.length){
    const empty=document.createElement('div'); empty.className='muted'; empty.textContent='Nenhum site dispon√≠vel cadastrado.'; sitesWrap.appendChild(empty);
    sitesWrap.setAttribute('aria-busy','false'); return;
  }
  const reached = selectedIds.size >= planLimit;
  for (const s of allSites){
    const checked = selectedIds.has(s.id); const disabled = !checked && reached;
    const wrap=document.createElement('label'); wrap.className='site-item'+(disabled?' disabled':''); wrap.htmlFor=`chk_${s.id}`;
    const chk=document.createElement('input'); chk.type='checkbox'; chk.id=`chk_${s.id}`; chk.value=String(s.id); chk.checked=checked; chk.disabled=disabled; chk.addEventListener('change', onToggleSite);
    const block=document.createElement('div');
    const title=document.createElement('div'); title.className='site-title'; title.textContent=s.nome||'(sem nome)';
    const url=document.createElement('div'); url.className='site-url'; const a=document.createElement('a'); a.href=s.site||'#'; a.target='_blank'; a.rel='noopener'; a.textContent=s.site||'(sem URL)'; url.appendChild(a);
    block.appendChild(title); block.appendChild(url); wrap.appendChild(chk); wrap.appendChild(block); sitesWrap.appendChild(wrap);
  }
  if (reached) showBanner(`Voc√™ atingiu o limite do seu plano (${planLimit}). Para marcar mais, desmarque algum ou atualize seu plano.`,'warn', 3000);
  sitesWrap.setAttribute('aria-busy','false');
}
function onToggleSite(ev){
  const id = Number(ev.target.value);
  if (ev.target.checked){
    if (selectedIds.size >= planLimit){ ev.target.checked=false; showBanner(`Limite do plano (${planLimit}) atingido.`,'warn',2500); return; }
    selectedIds.add(id);
  } else selectedIds.delete(id);
  renderSites(); updateCounter();
}
function updateCounter(){ counterEl.textContent = `Selecionados: ${selectedIds.size} / ${planLimit}`; }
btnLimparSites.addEventListener('click', ()=>{ selectedIds.clear(); renderSites(); updateCounter(); });
btnSalvarSites.addEventListener('click', async ()=>{
  try{
    btnSalvarSites.disabled=true;
    const { error: delErr } = await sb.from('user_sites').delete().eq('user_id', sessionUser.id);
    if (delErr) throw delErr;
    const ids = Array.from(selectedIds).slice(0, planLimit);
    if (ids.length){
      const payload = ids.map(site_id => ({ user_id: sessionUser.id, site_id }));
      const { error: insErr } = await sb.from('user_sites').insert(payload);
      if (insErr) throw insErr;
    }
    showBanner('Sele√ß√£o salva com sucesso!','ok');
  }catch(e){ console.error(e); showBanner('Falha ao salvar sua sele√ß√£o. Verifique permiss√µes/RLS de "user_sites".','err'); }
  finally{ btnSalvarSites.disabled=false; }
});
</script>
</body>
</html>
