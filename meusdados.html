<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sele√ß√£o de Sites para Monitorar</title>
<style>
  :root { color-scheme: dark; }
  * { box-sizing: border-box; }
  body{background:#121212;color:#fff;font-family:Arial,system-ui,-apple-system,sans-serif;padding:24px;margin:0}
  a{color:#00b140;text-decoration:none}
  a:hover{text-decoration:underline}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;gap:12px;flex-wrap:wrap}
  h1{color:#00b140;margin:0}
  .chip{font-size:12px;background:#1e1e1e;border:1px solid #333;padding:6px 10px;border-radius:999px}
  .chip.plan{color:#bfffc1;border-color:#2f5a2f;background:#132313}
  .btn{display:inline-flex;align-items:center;gap:8px;background:#00b140;color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer}
  .btn:hover{background:#009b38}
  .btn.outline{background:transparent;border:1px solid #2a2a2a;color:#ddd}
  .btn.outline:hover{background:#1b1b1b}
  .container{max-width:960px;margin:0 auto}
  .card{background:#0f0f0f;border:1px solid #2a2a2a;border-radius:12px;padding:18px}
  .row{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
  .banner{border:1px solid #2a2a2a;border-radius:10px;padding:10px 12px;margin-bottom:14px;background:#111;display:none}
  .banner.warn{border-color:#5c3f00;background:#1b1300;color:#ffc966}
  .banner.ok{border-color:#214d21;background:#0e1a0e;color:#b7fbb7}
  .banner.err{border-color:#5c1e1e;background:#190d0d;color:#ff9a9a}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width: 840px){ .grid{grid-template-columns:1fr} }
  .site-item{display:flex;align-items:flex-start;gap:12px;padding:12px;border:1px solid #232323;border-radius:10px;background:#121212}
  .site-item.disabled{opacity:0.55}
  .site-title{font-weight:bold;margin-bottom:4px}
  .site-url{font-size:12px;color:#9aa0a6;word-break:break-all}
  .muted{color:#9aa0a6;font-size:13px}
  .limit-info{font-size:13px;color:#b7fbb7}
  .footer-actions{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-top:14px}
  .counter{font-size:13px;color:#9aa0a6}
  input[type="checkbox"]{width:18px;height:18px;margin-top:2px}
</style>
<script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<script src="./config.js"></script>
</head>
<body>
<header class="container">
  <h1>Selecionar sites para monitorar</h1>
  <div class="row">
    <span id="planChip" class="chip plan" title="Plano atual">Plano: ‚Äî</span>
    <a class="btn outline" href="dashboard.html">‚Üê Voltar ao dashboard</a>
  </div>
</header>

<main class="container">
  <div id="banner" class="banner"></div>

  <div class="card" id="card">
    <p class="muted" id="intro">
      Marque os sites que deseja monitorar. O limite depende do seu plano. 
      <a href="planos.html">Atualize o plano</a> para liberar mais sites.
    </p>
    <p class="limit-info" id="limitInfo">Limite do plano: ‚Äî</p>

    <div id="sitesWrap" class="grid" aria-live="polite" aria-busy="true">
      <!-- Lista de sites renderizada aqui -->
    </div>

    <div class="footer-actions">
      <div class="counter" id="counter">Selecionados: 0 / ‚Äî</div>
      <div class="row">
        <button id="btnLimpar" class="btn outline">Limpar</button>
        <button id="btnSalvar" class="btn">üíæ Salvar sele√ß√£o</button>
      </div>
    </div>
  </div>
</main>

<script>
/* =========================
   Config / Supabase Client
   ========================= */
const CFG = window.CONFIG || {};
const SUPABASE_URL = CFG.SUPABASE_URL;
const SUPABASE_ANON_KEY = CFG.SUPABASE_ANON_KEY;
if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
  alert("Erro de configura√ß√£o: config.js n√£o carregado.");
  throw new Error("CONFIG ausente");
}
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
});

/* =========================
   Elementos
   ========================= */
const planChip   = document.getElementById('planChip');
const bannerEl   = document.getElementById('banner');
const sitesWrap  = document.getElementById('sitesWrap');
const counterEl  = document.getElementById('counter');
const limitInfo  = document.getElementById('limitInfo');
const btnSalvar  = document.getElementById('btnSalvar');
const btnLimpar  = document.getElementById('btnLimpar');

/* =========================
   Utilit√°rios
   ========================= */
function showBanner(text, type = 'ok', timeoutMs = 4000) {
  bannerEl.textContent = text;
  bannerEl.className = 'banner ' + (type === 'warn' ? 'warn' : (type === 'err' ? 'err' : 'ok'));
  bannerEl.style.display = 'block';
  if (timeoutMs > 0) setTimeout(() => { bannerEl.style.display = 'none'; }, timeoutMs);
}
function capitalize(s){ return (s||'').charAt(0).toUpperCase() + (s||'').slice(1); }

const PLAN_LIMIT = {
  trial: 2,
  basico: 4,
  intermediario: 6,
  premium: 8
};

/* =========================
   Estado
   ========================= */
let sessionUser = null;
let userPlan = 'trial';
let planLimit = PLAN_LIMIT[userPlan];
let allSites = [];         // [{id, nome, site}]
let selectedIds = new Set(); // Set<number>

/* =========================
   Fluxo principal
   ========================= */
(async function init(){
  // Sess√£o
  const { data: { session } } = await sb.auth.getSession();
  if (!session) { window.location.href = CFG.SITE_URL || 'index.html'; return; }
  sessionUser = session.user;

  // Perfil (obter plano)
  try {
    const { data: prof, error: e1 } = await sb
      .from('profiles')
      .select('plan')
      .eq('id', sessionUser.id)
      .maybeSingle();
    if (e1) throw e1;

    userPlan = (prof && prof.plan) ? String(prof.plan) : 'trial';
    planLimit = PLAN_LIMIT[userPlan] ?? PLAN_LIMIT.trial;

    const pretty = capitalize(userPlan)
      .replace('Basico','B√°sico')
      .replace('Intermediario','Intermedi√°rio');
    planChip.textContent = `Plano: ${pretty}`;
    limitInfo.textContent = `Limite do plano: ${planLimit} site${planLimit>1?'s':''}`;
  } catch (e) {
    console.error(e);
    showBanner('N√£o foi poss√≠vel ler seu plano. Usando limite do Trial (2).', 'warn');
    userPlan = 'trial';
    planLimit = PLAN_LIMIT.trial;
  }

  // Carregar sites dispon√≠veis
  await loadSitesDisponiveis();

  // Carregar sele√ß√£o atual do usu√°rio
  await loadUserSelection();

  // Renderizar UI
  renderSites();
  updateCounter();
})();

/* =========================
   Carregamentos
   ========================= */
async function loadSitesDisponiveis(){
  try{
    // Tabela esperada: sites_disponiveis (id int, nome text, site text)
    const { data, error } = await sb
      .from('sites_disponiveis')
      .select('id,nome,site')
      .order('nome', { ascending: true });
    if (error) throw error;
    allSites = data || [];
  }catch(e){
    console.error(e);
    allSites = [];
    showBanner('Erro ao carregar lista de sites. Verifique a tabela "sites_disponiveis".', 'err');
  }
}

async function loadUserSelection(){
  try{
    // Tabela esperada: user_sites (user_id uuid, site_id int)
    const { data, error } = await sb
      .from('user_sites')
      .select('site_id')
      .eq('user_id', sessionUser.id);
    if (error) throw error;
    selectedIds = new Set((data||[]).map(r => r.site_id));
  }catch(e){
    console.error(e);
    selectedIds = new Set();
    // Aviso suave apenas se existirem sites para marcar
    if (allSites.length) {
      showBanner('N√£o foi poss√≠vel carregar sua sele√ß√£o anterior (tabela "user_sites").', 'warn', 5000);
    }
  }
}

/* =========================
   Render / Intera√ß√£o
   ========================= */
function renderSites(){
  sitesWrap.innerHTML = '';
  sitesWrap.setAttribute('aria-busy', 'true');

  if (!allSites.length){
    const empty = document.createElement('div');
    empty.className = 'muted';
    empty.textContent = 'Nenhum site dispon√≠vel cadastrado.';
    sitesWrap.appendChild(empty);
    sitesWrap.setAttribute('aria-busy', 'false');
    return;
  }

  const reached = selectedIds.size >= planLimit;

  for (const s of allSites){
    const checked = selectedIds.has(s.id);
    const disabled = !checked && reached; // se atingiu o limite, desabilita os que n√£o est√£o marcados

    const wrap = document.createElement('label');
    wrap.className = 'site-item' + (disabled ? ' disabled' : '');
    wrap.htmlFor = `chk_${s.id}`;

    const chk = document.createElement('input');
    chk.type = 'checkbox';
    chk.id = `chk_${s.id}`;
    chk.value = String(s.id);
    chk.checked = checked;
    chk.disabled = disabled;
    chk.addEventListener('change', onToggle);

    const block = document.createElement('div');
    const title = document.createElement('div');
    title.className = 'site-title';
    title.textContent = s.nome || '(sem nome)';

    const url = document.createElement('div');
    url.className = 'site-url';
    const a = document.createElement('a');
    a.href = s.site || '#';
    a.target = '_blank';
    a.rel = 'noopener';
    a.textContent = s.site || '(sem URL)';
    url.appendChild(a);

    block.appendChild(title);
    block.appendChild(url);

    wrap.appendChild(chk);
    wrap.appendChild(block);
    sitesWrap.appendChild(wrap);
  }

  // Mensagem discreta quando limite atingido
  if (reached){
    showBanner(`Voc√™ atingiu o limite do seu plano (${planLimit}). Para marcar mais, desmarque algum ou atualize seu plano.`, 'warn', 3000);
  }

  sitesWrap.setAttribute('aria-busy', 'false');
}

function onToggle(ev){
  const id = Number(ev.target.value);
  if (ev.target.checked){
    if (selectedIds.size >= planLimit){
      // N√£o permite ultrapassar; desfaz e informa
      ev.target.checked = false;
      showBanner(`Limite do plano (${planLimit}) atingido.`, 'warn', 2500);
      return;
    }
    selectedIds.add(id);
  } else {
    selectedIds.delete(id);
  }
  // Re-render para aplicar/retirar "disabled" dos demais
  renderSites();
  updateCounter();
}

function updateCounter(){
  counterEl.textContent = `Selecionados: ${selectedIds.size} / ${planLimit}`;
}

/* =========================
   A√ß√µes
   ========================= */
btnLimpar.addEventListener('click', ()=>{
  selectedIds.clear();
  renderSites();
  updateCounter();
});

btnSalvar.addEventListener('click', async ()=>{
  try{
    btnSalvar.disabled = true;

    // Apaga sele√ß√£o anterior do usu√°rio
    const { error: delErr } = await sb
      .from('user_sites')
      .delete()
      .eq('user_id', sessionUser.id);
    if (delErr) throw delErr;

    // Insere a sele√ß√£o atual (at√© o limite)
    const ids = Array.from(selectedIds).slice(0, planLimit);
    if (ids.length){
      const payload = ids.map(site_id => ({ user_id: sessionUser.id, site_id }));
      const { error: insErr } = await sb.from('user_sites').insert(payload);
      if (insErr) throw insErr;
    }

    showBanner('Sele√ß√£o salva com sucesso!', 'ok');
  }catch(e){
    console.error(e);
    showBanner('Falha ao salvar sua sele√ß√£o. Verifique permiss√µes/RLS de "user_sites".', 'err');
  }finally{
    btnSalvar.disabled = false;
  }
});
</script>
</body>
</html>
